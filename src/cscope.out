cscope 15 $HOME/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src -q 0000001555 0000359648
	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/GenIC.c

45 
	~"pšocchio.h
"

49 #ifdeà
DPRINT


50 
	#D´štf
(...è
	`´štf
(
__VA_ARGS__
);

	)

52 
	#D´štf
(...)

	)

56 
	#GRID
 
MyGrids
[
ThisGrid
]

	)

58 
	$G’IC
(
ThisGrid
)

60 
i
, 
j
, 
k
;

61 
Nmesh
, 
N§m¶e
, 
VeùÜL’gth
;

62 
loÿl_n
[3], 
loÿl_¡¬t
[3];

63 
Box
, 
çc
;

64 *
SEEDTABLE
;

66 
SEEDTABLE
 = (*è
	`m®loc
Ğ(è* 
GRID
.
GSglob®
[
_x_
] * GRID.GSglob®[
_y_
]);

75 
loÿl_n
[0] = 
GRID
.
GSloÿl_k
[
_x_
];

76 
loÿl_¡¬t
[0] = 
GRID
.
GS¡¬t_k
[
_x_
];

78 
loÿl_n
[1] = 
GRID
.
GSloÿl_k
[
_y_
];

79 
loÿl_¡¬t
[1] = 
GRID
.
GS¡¬t_k
[
_y_
];

81 
loÿl_n
[2] = 
GRID
.
GSloÿl_k
[
_z_
];

82 
loÿl_¡¬t
[2] = 
GRID
.
GS¡¬t_k
[
_z_
];

84 
VeùÜL’gth
 = 
GRID
.
tÙ®_loÿl_size_fá
;

85 
Nmesh
 = 
GRID
.
GSglob®
[
_x_
];

86 
N§m¶e
 = 
GRID
.
GSglob®
[
_x_
];

87 
Box
 = 
GRID
.
BoxSize
;

89 
çc
 = 
	`pow
(1./
Box
,1.5);

91 
	`D´štf
(" Task %d: %d -> %d | %d -> %d | %d -> %d | %d %g | %g %g %g %g\n", 
ThisTask
,

92 
loÿl_¡¬t
[0],†oÿl_¡¬t[0]+
loÿl_n
[0],

93 
loÿl_¡¬t
[1],†oÿl_¡¬t[1]+
loÿl_n
[1],

94 
loÿl_¡¬t
[2],†oÿl_¡¬t[2]+
loÿl_n
[2],

95 
VeùÜL’gth
, 
çc
,

96 
	`Pow”S³ùrum
(0.0001),

97 
	`Pow”S³ùrum
(0.001),

98 
	`Pow”S³ùrum
(0.01),

99 
	`Pow”S³ùrum
(0.1));

101 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
·¿ms
.
RªdomS“d
);

103 
i
 = 0; i < 
Nmesh
 / 2; i++)

105 
j
 = 0; j < 
i
; j++)

106 
SEEDTABLE
[
i
 * 
Nmesh
 + 
j
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

108 
j
 = 0; j < 
i
 + 1; j++)

109 
SEEDTABLE
[
j
 * 
Nmesh
 + 
i
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

111 
j
 = 0; j < 
i
; j++)

112 
SEEDTABLE
[(
Nmesh
 - 1 - 
i
è* Nmesh + 
j
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

114 
j
 = 0; j < 
i
 + 1; j++)

115 
SEEDTABLE
[(
Nmesh
 - 1 - 
j
è* Nmesh + 
i
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

117 
j
 = 0; j < 
i
; j++)

118 
SEEDTABLE
[
i
 * 
Nmesh
 + (Nmesh - 1 - 
j
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

120 
j
 = 0; j < 
i
 + 1; j++)

121 
SEEDTABLE
[
j
 * 
Nmesh
 + (Nmesh - 1 - 
i
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

123 
j
 = 0; j < 
i
; j++)

124 
SEEDTABLE
[(
Nmesh
 - 1 - 
i
è* Nmesh + (Nmesh - 1 - 
j
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

126 
j
 = 0; j < 
i
 + 1; j++)

127 
SEEDTABLE
[(
Nmesh
 - 1 - 
j
è* Nmesh + (Nmesh - 1 - 
i
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

130 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
·¿ms
.
RªdomS“d
);

133 
i
 = 0; i < 
VeùÜL’gth
; i++)

134 
kd’s™y
[
ThisGrid
][
i
]=0.;

137 
ii
, 
jj
, 
kk
, 
RR
;

138 
iii
, 
jjj
;

139 
addr
, 
addr_j
, 
Nmesh_2
, 
Nmesh_odd
;

140 
sign
;

141 
kvec
[3];

142 
d–
, 
pha£
, 
am¶
;

144 
p_of_k
, 
kmag
, 
kmag2_i
, 
kmag2_ij
, 
kmag2_loÿl
;

146 
g¦_ºg
 *
k0_g’”©Ü
;

148 
Nmesh_2
 = 
Nmesh
 / 2;

149 
Nmesh_odd
 = (
Nmesh
 % 2);

153 
k0_g’”©Ü
 = 
	`g¦_ºg_®loc
(
g¦_ºg_¿Æxd1
);

157 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

161 
ii
 = 
loÿl_¡¬t
[
_x_
] + 
i
;

162 if(
ii
 =ğ
Nmesh_2
)

165 if(
ii
 < 
Nmesh_2
)

166 
kvec
[0] = 
ii
 * 2 * 
PI
 / 
Box
;

168 
kvec
[0] = -(
Nmesh
 - 
ii
è* 2 * 
PI
 / 
Box
;

170 
kmag2_i
 = 
kvec
[0] * kvec[0];

171 
iii
 = 
ii
;

174 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

178 
jj
 = 
loÿl_¡¬t
[
_y_
] + 
j
;

179 if(
jj
 =ğ
Nmesh_2
)

181 
jjj
 = 
jj
;

183 if(
jj
 < 
Nmesh_2
)

184 
kvec
[1] = 
jj
 * 2 * 
PI
 / 
Box
;

186 
kvec
[1] = -(
Nmesh
 - 
jj
è* 2 * 
PI
 / 
Box
;

188 
kmag2_ij
 = 
kmag2_i
 + 
kvec
[1] * kvec[1];

193 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
SEEDTABLE
[
ii
 * 
Nmesh
 + 
jj
]);

200 if(
loÿl_¡¬t
[
_z_
] > 0)

201 
RR
 = 0; RR < 
loÿl_¡¬t
[
_z_
]; RR++)

203 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

205 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

206 
pha£
 == 0);

210 
k
 = 0; (k < 
loÿl_n
[
_z_
]è&& (k+
loÿl_¡¬t
[_z_] < 
Nmesh_2
); k++)

213 
kk
 = 
loÿl_¡¬t
[
_z_
] + 
k
;

216 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
è* 2 * 
PI
;

218 
am¶
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

219 
am¶
 == 0);

222 if(
ii
 =ğ0 && 
jj
 =ğ0 && 
kk
 == 0)

224 if(
kk
 =ğ
Nmesh_2
)

227 if(
kk
 < 
Nmesh_2
)

228 
kvec
[2] = 
kk
 * 2 * 
PI
 / 
Box
;

230 
kvec
[2] = -(
Nmesh
 - 
kk
è* 2 * 
PI
 / 
Box
;

232 
kmag2_loÿl
 = 
kmag2_ij
 + 
kvec
[2] * kvec[2];

233 
kmag
 = 
	`sq¹
(
kmag2_loÿl
);

235 if(
kmag
 * 
Box
 / (2 * 
PI
è> 
NYQUIST
 * 
N§m¶e
 / 2)

238 
p_of_k
 = 
	`Pow”S³ùrum
(
kmag
);

240 
sign
 = 1.0;

241 
addr_j
 = 
j
;

244 ifĞ
kk
 == 0 )

248 ifĞ(
ii
 =ğ0è&& (
jj
 =ğ
Nmesh_2
 || jj =ğNmesh_2 + 
Nmesh_odd
) )

250 ifĞ(
ii
 =ğ
Nmesh_2
 + 
Nmesh_odd
) )

255 ifĞ(
ii
 > 
Nmesh_2
) ||

256 Ğ
ii
 =ğ0 && 
jj
 > 
Nmesh
/2) )

259 
jjj
 = 
Nmesh
 -
jj
;

260 if(
jjj
 =ğ
Nmesh
)

261 
jjj
 = 0;

263 if(
Nmesh_odd
 && 
jj
 =ğ
Nmesh_2
+1)

265 
jjj
 = 
Nmesh_2
+1;

266 
addr_j
 = 
Nmesh_2
;

270 if(
ii
 > 
Nmesh_2
)

271 
iii
 = 
Nmesh
 - 
ii
;

273 
sign
 = -1.0;

276 
	`g¦_ºg_£t
(
k0_g’”©Ü
, 
SEEDTABLE
[
iii
 * 
Nmesh
 + 
jjj
]);

277 
pha£
 = 
	`g¦_ºg_unifÜm
(
k0_g’”©Ü
è* 2 * 
PI
;

279 
am¶
 = 
	`g¦_ºg_unifÜm
(
k0_g’”©Ü
);

280 
am¶
 == 0);

282 
	`D´štf
("\t (+) @ %d :: %d %d %d :: %u :: kmag: %g…h: %g A: %g D: %g P: %g PS: %g\n",

283 
ThisTask
, 
ii
, 
jj
, 
kk
, 
SEEDTABLE
[
iii
*
Nmesh
 + 
jjj
],

284 
kmag
, 
pha£
, 
am¶
, 
d–
, 
p_of_k
, 
	`Pow”S³ùrum
(kmag)); 
	`fæush
(
¡dout
);

288 
	`D´štf
("\t (+) @ %d :: %d %d %d :: %u :: kmag: %g…h: %g A: %g D: %g P: %g PS: %g\n",

289 
ThisTask
, 
ii
, 
jj
, 
kk
, 
SEEDTABLE
[i˜* 
Nmesh
 + jj],

290 
kmag
, 
pha£
, 
am¶
, 
d–
, 
p_of_k
, 
	`Pow”S³ùrum
(kmag)); 
	`fæush
(
¡dout
);

293 #iâdeà
NO_RANDOM_MODULES


294 
p_of_k
 *ğ-
	`log
(
am¶
);

296 
d–
 = 
çc
 * 
	`sq¹
(
p_of_k
);

299 
addr
 = 2*((
i
 * 
loÿl_n
[
_y_
] + 
addr_j
è*†oÿl_n[
_z_
] + 
k
);

301 
kd’s™y
[
ThisGrid
][
addr
 ] = 
d–
 * 
	`cos
(
pha£
);

302 
kd’s™y
[
ThisGrid
][
addr
 + 1] = 
sign
 * 
d–
 * 
	`sš
(
pha£
);

309 if(
loÿl_¡¬t
[
_z_
]+
loÿl_n
[_z_] < 
Nmesh_2
)

310 
RR
 = 
loÿl_¡¬t
[
_z_
]+
loÿl_n
[_z_]; RR <ğ
Nmesh_2
; RR++)

312 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

314 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

315 
pha£
 == 0);

320 
	`g¦_ºg_ä“
(
k0_g’”©Ü
);

321 
	`ä“
(
SEEDTABLE
);

323 #ifdeà
DEBUG


324 
	`fşo£
(
numb”s
);

328 
addr_
;

330 
FILE
 *
fe
;

331 
f’ame
[100];

333 
	`¥rštf
(
f’ame
, "·¹Ÿl_%d", 
ThisTask
);

335 
ii
 = 0; i˜< 
NTasks
; ii++)

337 if(
ThisTask
 =ğ
ii
)

339 
fe
 = 
	`fİ’
(
f’ame
, "w");

340 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

341 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

342 
k
 = 0; k < (
loÿl_n
[
_z_
]-1); k++)

344 
addr
 = 2*Ğ(
i
*
loÿl_n
[
_y_
] + 
j
)*loÿl_n[
_z_
] + 
k
);

345 
addr_
 = ((
i
+
loÿl_¡¬t
[
_x_
])*
Nmesh
 + 
j
+loÿl_¡¬t[
_y_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

352 
	`årštf
(
fe
, "%d - %g %g\n", 
addr_
, 
kd’s™y
[
ThisGrid
][
addr
], kdensity[ThisGrid][addr+1]);

354 
	`fæush
(
¡dout
);

355 
	`fşo£
(
fe
);

357 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

359 if(
ThisTask
 == 0)

361 
	`sy¡em
("cat…artial_* | sort -k1 -n > my.dkdensity");

362 
	`sy¡em
("rm -f…artial_*");

368 
çc
=
	`pow
(()
Nmesh
, 3.0);

369 
i
=0; i<
VeùÜL’gth
; i++)

370 
kd’s™y
[
ThisGrid
][
i
] *ğ
çc
;

373 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/LPT.c

27 
	~"pšocchio.h
"

28 #ifdeà
TWO_LPT


30 
	$compu‹_LPT_di¥Ïûm’ts
(
ismoÙh
)

32 
loÿl_x
,
loÿl_y
,
loÿl_z
,
šdex
,
Ÿ
;

33 #ifdeà
THREE_LPT


34 
ib
,
id”
;

36 
time
;

48 #ifdeà
SMOOTH_VELOCITIES


49 
fš®
=(
ismoÙh
==
SmoÙhšg
.
NsmoÙh
-1);

58 
loÿl_z
=0;†oÿl_z < 
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

59 
loÿl_y
=0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

60 
loÿl_x
=0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

63 
šdex
 = 
loÿl_x
 + (
MyGrids
[0].
GSloÿl
[
_x_
]) *

64 (
loÿl_y
 + 
loÿl_z
 * 
MyGrids
[0].
GSloÿl
[
_y_
]);

69 
sourû_2LPT
[
šdex
] =

70 
£cÚd_d”iv©ives
[0][0][
šdex
] * second_derivatives[0][1][index] +

71 
£cÚd_d”iv©ives
[0][0][
šdex
] * second_derivatives[0][2][index] +

72 
£cÚd_d”iv©ives
[0][1][
šdex
] * second_derivatives[0][2][index] -

73 
£cÚd_d”iv©ives
[0][3][
šdex
] * second_derivatives[0][3][index] -

74 
£cÚd_d”iv©ives
[0][4][
šdex
] * second_derivatives[0][4][index] -

75 
£cÚd_d”iv©ives
[0][5][
šdex
] * second_derivatives[0][5][index];

77 #ifdeà
THREE_LPT


78 
sourû_3LPT_1
[
šdex
] = 3.0 *(
£cÚd_d”iv©ives
[0][0][index]*

79 (
£cÚd_d”iv©ives
[0][1][
šdex
]*second_derivatives[0][2][index]

80 -
£cÚd_d”iv©ives
[0][5][
šdex
]*second_derivatives[0][5][index])

81 - 
£cÚd_d”iv©ives
[0][3][
šdex
]*

82 (
£cÚd_d”iv©ives
[0][3][
šdex
]*second_derivatives[0][2][index]

83 -
£cÚd_d”iv©ives
[0][4][
šdex
]*second_derivatives[0][5][index])

84 + 
£cÚd_d”iv©ives
[0][4][
šdex
]*

85 (
£cÚd_d”iv©ives
[0][3][
šdex
]*second_derivatives[0][5][index]

86 -
£cÚd_d”iv©ives
[0][4][
šdex
]*second_derivatives[0][1][index]));

88 
sourû_3LPT_2
[
šdex
] = 2.0 *

89 (
£cÚd_d”iv©ives
[0][0][
šdex
] + second_derivatives[0][1][index] + second_derivatives[0][2][index]) *

90 
sourû_2LPT
[
šdex
];

95 
	`wr™e_š_rveùÜ
(0, 
sourû_2LPT
);

97 ià(!
ThisTask
)

98 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: s¹šg fá\n",
	`fd©e
());

100 
time
 = 
	`fÜw¬d_ŒªsfÜm
(0);

102 ià(!
ThisTask
)

103 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: dÚfá, cputimğ%f\n",
	`fd©e
(),
time
);

105 
ıutime
.
fá
+=
time
;

107 
	`wr™e_äom_cveùÜ
(0, 
kveùÜ_2LPT
);

109 #ifdeà
THREE_LPT


111 
Ÿ
=1; ia<=3; ia++)

112 
ib
=
Ÿ
; ib<=3; ib++)

115 
id”
=Ğ
Ÿ
==
ib
? ia : ia+ib+1 );

117 ià(!
ThisTask
)

118 
	`´štf
("[%s] Computšg 2nd d”iv©ivoà2LPT sourû: %d\n",
	`fd©e
(),
Ÿ
);

120 
	`wr™e_š_cveùÜ
(0, 
kveùÜ_2LPT
);

122 ià(
	`compu‹_d”iv©ive
(0,
Ÿ
,
ib
))

126 
loÿl_z
=0;†oÿl_z<
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

127 
loÿl_y
=0;†oÿl_y<
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

128 
loÿl_x
=0;†oÿl_x<
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

130 
šdex
 = 
loÿl_x
 + 
MyGrids
[0].
GSloÿl
[
_x_
] * (
loÿl_y
 + 
loÿl_z
 * MyGrids[0].GSloÿl[
_y_
]);

132 
sourû_3LPT_2
[
šdex
] -ğ2.0 * (
id”
<=3? 1.0 : 2.0) *

133 *(
rveùÜ_fá
[0] + 
loÿl_x
 + (
MyGrids
[0].
GSloÿl
[
_x_
] + MyGrids[0].
off
è* (
loÿl_y
 + 
loÿl_z
 * MyGrids[0].GSloÿl[
_y_
]))

134 * 
£cÚd_d”iv©ives
[0][
id”
-1][
šdex
];

140 ià(!
ThisTask
)

141 
	`´štf
("[%s] Computšg LPT di¥Ïûm’ts\n",
	`fd©e
());

143 
RsmoÙh
=0.0;

145 
Ÿ
=1; ia<=3; ia++)

147 ià(!
ThisTask
)

148 
	`´štf
("[%s] Computšg 1¡ d”iv©ivoà2LPT sourû: %d\n",
	`fd©e
(),
Ÿ
);

150 
	`wr™e_š_cveùÜ
(0, 
kveùÜ_2LPT
);

152 ià(
	`compu‹_d”iv©ive
(0,
Ÿ
,0))

155 
	`wr™e_äom_rveùÜ
(0, 
fœ¡_d”iv©ives
[0][
Ÿ
-1]);

159 
loÿl_z
=0;†oÿl_z < 
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

160 
loÿl_y
=0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

161 
loÿl_x
=0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

164 
šdex
 = 
loÿl_x
 + (
MyGrids
[0].
GSloÿl
[
_x_
]) *

165 (
loÿl_y
 + 
loÿl_z
 * 
MyGrids
[0].
GSloÿl
[
_y_
]);

167 #ifdeà
SMOOTH_VELOCITIES


168 ià(
´oduùs
[
šdex
].
Rmax
 =ğ
ismoÙh
 || (´oduùs[šdex].
Fmax
<0.0 && 
fš®
) )

171 
Ÿ
=0; ia<3; ia++)

172 
´oduùs
[
šdex
].
Vmax_2LPT
[
Ÿ
]=
fœ¡_d”iv©ives
[0][ia][index];

177 #ifdeà
THREE_LPT


180 
	`wr™e_š_rveùÜ
(0, 
sourû_3LPT_1
);

182 ià(!
ThisTask
)

183 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: s¹šg fá\n",
	`fd©e
());

185 
time
 = 
	`fÜw¬d_ŒªsfÜm
(0);

187 ià(!
ThisTask
)

188 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: dÚfá, cputimğ%f\n",
	`fd©e
(),
time
);

190 
ıutime
.
fá
+=
time
;

192 
	`wr™e_äom_cveùÜ
(0, 
kveùÜ_3LPT_1
);

194 ià(!
ThisTask
)

195 
	`´štf
("[%s] Computšg 3LPT_1 di¥Ïûm’ts\n",
	`fd©e
());

197 
Ÿ
=1; ia<=3; ia++)

199 ià(!
ThisTask
)

200 
	`´štf
("[%s] Computšg 1¡ d”iv©ivoà3LPT_1 sourû: %d\n",
	`fd©e
(),
Ÿ
);

202 
	`wr™e_š_cveùÜ
(0, 
kveùÜ_3LPT_1
);

204 ià(
	`compu‹_d”iv©ive
(0,
Ÿ
,0))

207 
	`wr™e_äom_rveùÜ
(0, 
fœ¡_d”iv©ives
[0][
Ÿ
-1]);

210 
loÿl_z
=0;†oÿl_z < 
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

211 
loÿl_y
=0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

212 
loÿl_x
=0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

215 
šdex
 = 
loÿl_x
 + (
MyGrids
[0].
GSloÿl
[
_x_
]) *

216 (
loÿl_y
 + 
loÿl_z
 * 
MyGrids
[0].
GSloÿl
[
_y_
]);

218 #ifdeà
SMOOTH_VELOCITIES


219 ià(
´oduùs
[
šdex
].
Rmax
 =ğ
ismoÙh
 || (´oduùs[šdex].
Fmax
<0.0 && 
fš®
) )

222 
Ÿ
=0; ia<3; ia++)

223 
´oduùs
[
šdex
].
Vmax_3LPT_1
[
Ÿ
]=
fœ¡_d”iv©ives
[0][ia][index];

228 
	`wr™e_š_rveùÜ
(0, 
sourû_3LPT_2
);

230 ià(!
ThisTask
)

231 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: s¹šg fá\n",
	`fd©e
());

233 
time
 = 
	`fÜw¬d_ŒªsfÜm
(0);

235 ià(!
ThisTask
)

236 
	`´štf
("[%s] compu‹_sourûs_fÜ_LPT: dÚfá, cputimğ%f\n",
	`fd©e
(),
time
);

238 
ıutime
.
fá
+=
time
;

240 
	`wr™e_äom_cveùÜ
(0, 
kveùÜ_3LPT_2
);

242 ià(!
ThisTask
)

243 
	`´štf
("[%s] Computšg 3LPT_2 di¥Ïûm’ts\n",
	`fd©e
());

245 
Ÿ
=1; ia<=3; ia++)

247 ià(!
ThisTask
)

248 
	`´štf
("[%s] Computšg 1¡ d”iv©ivoà3LPT_2 sourû: %d\n",
	`fd©e
(),
Ÿ
);

250 
	`wr™e_š_cveùÜ
(0, 
kveùÜ_3LPT_2
);

252 ià(
	`compu‹_d”iv©ive
(0,
Ÿ
,0))

255 
	`wr™e_äom_rveùÜ
(0, 
fœ¡_d”iv©ives
[0][
Ÿ
-1]);

258 
loÿl_z
=0;†oÿl_z < 
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

259 
loÿl_y
=0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

260 
loÿl_x
=0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

263 
šdex
 = 
loÿl_x
 + (
MyGrids
[0].
GSloÿl
[
_x_
]) *

264 (
loÿl_y
 + 
loÿl_z
 * 
MyGrids
[0].
GSloÿl
[
_y_
]);

266 #ifdeà
SMOOTH_VELOCITIES


267 ià(
´oduùs
[
šdex
].
Rmax
 =ğ
ismoÙh
 || (´oduùs[šdex].
Fmax
<0.0 && 
fš®
) )

270 
Ÿ
=0; ia<3; ia++)

271 
´oduùs
[
šdex
].
Vmax_3LPT_2
[
Ÿ
]=
fœ¡_d”iv©ives
[0][ia][index];

278 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/Pk_from_CAMB.c

27 #ifdeà
SCALE_DEPENDENT_GROWTH


29 
	~"pšocchio.h
"

31 
	#ONLY_CDM_TRANSF


	)

35 *
	gStÜedLogK
, *
	gCAMBRedshiás
, *
	gCAMBSÿËçc
, *
	gRefGrowšgMode
,

36 *
	gStÜedLogTÙ®Pow”S³ùrum
;

38 
g¦_š‹½_acûl
 *
	gacûlGrow
=0x0, *
	gacûl
=0x0;

39 
g¦_¥lše
 **
	g¥lšeGrowM©‹r
, **
	g¥lšeGrowV–
, **
	g¥lšeInvGrowM©‹r
, **
	g¥lšeFomega
, **
	g¥lšeFomega2
, *
	g¥lše
=0x0;

41 
	gThisOuut
, 
	gThisRadius
;

43 
IÁeg¿ndFÜSDMassV¬Ÿnû
(, *);

44 
IÁeg¿ndFÜSDV–V¬Ÿnû
(, *);

45 
Pow”FromCAMB
();

47 
	$»ad_pow”_bË_äom_CAMB
()

52 
i
,
j
,
dummy
,
ff
;

53 
k­·
,
Pk
;

54 
f’ame
[
BLENGTH
],
bufãr
[BLENGTH],*
ugo
;

55 
FILE
 *
fd
;

56 #ifdeà
ONLY_CDM_TRANSF


57 
g¦_¥lše
 *
¥lšeT¿nsf
=0x0;

58 
g¦_š‹½_acûl
 *
acûl
=0x0;

59 
NkŒªsf
;

60 *
KŒªsf
,*
TŒªsf
,
Tcdm
,
TtÙ
,
Tb¬
;

61 
FILE
 *
fd2
;

64 ià(!
ThisTask
)

67 
·¿ms
.
ÿmb
.
NCAMB
=0;

68 
	`¥rštf
(
f’ame
,"%s_%s_%03d.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
M©‹rFe
,·¿ms.ÿmb.
NCAMB
);

69 (
fd
=
	`fİ’
(
f’ame
,"r"))!=0x0)

71 ià(!
·¿ms
.
ÿmb
.
NCAMB
)

74 
·¿ms
.
ÿmb
.
Nkbšs
=0;

75 !
	`ãof
(
fd
))

77 
ugo
=
	`fg‘s
(
bufãr
,
BLENGTH
,
fd
);

78 
i
=
	`ssÿnf
(
bufãr
,"%lf",&
k­·
);

79 ià(
i
 && 
ugo
!=0x0)

80 
·¿ms
.
ÿmb
.
Nkbšs
++;

84 #ifdeà
ONLY_CDM_TRANSF


86 
	`¥rštf
(
f’ame
,"%s_%s_000.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
T¿nsãrFe
);

87 ià((
fd2
=
	`fİ’
(
f’ame
,"r"))!=0x0)

89 ià(!
·¿ms
.
ÿmb
.
NCAMB
)

92 
NkŒªsf
=0;

93 !
	`ãof
(
fd2
))

95 
ugo
=
	`fg‘s
(
bufãr
,
BLENGTH
,
fd2
);

96 
i
=
	`ssÿnf
(
bufãr
,"%lf",&
k­·
);

97 ià(
i
 && 
ugo
!=0x0)

98 
NkŒªsf
++;

101 
	`fşo£
(
fd2
);

105 
	`´štf
("E¼Ü oÀTask 0: CAMB¿nsã¸f% nÙ found\n",
f’ame
);

109 
	`fşo£
(
fd
);

110 
·¿ms
.
ÿmb
.
NCAMB
++;

111 
	`¥rštf
(
f’ame
,"%s_%s_%03d.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
M©‹rFe
,·¿ms.ÿmb.
NCAMB
);

114 ià(!
·¿ms
.
ÿmb
.
NCAMB
)

116 
	`´štf
("E¼Ü oÀTask 0: CAMB f% nÙ found\n",
f’ame
);

119 ià(!
·¿ms
.
ÿmb
.
Nkbšs
)

121 
	`¥rštf
(
f’ame
,"%s_%s_%03d.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
M©‹rFe
,0);

122 
	`´štf
("E¼Ü oÀTask 0:…robËm iÀ»adšg CAMB f%s\n",
f’ame
);

125 #ifdeà
ONLY_CDM_TRANSF


126 ià(!
NkŒªsf
)

128 
	`´štf
("Error on Task 0:‚o†ines found inransfer function file\n");

132 ià(
·¿ms
.
ÿmb
.
Reã»nûOuut
>·¿ms.ÿmb.
NCAMB
-1)

134 
	`´štf
("Error on Task 0: ReferenceOutput is†argerhan NCAMB-1\n");

138 
	`´štf
("Found %d CAMB matter…ower files with %d†inesƒach\n",

139 
·¿ms
.
ÿmb
.
NCAMB
,·¿ms.ÿmb.
Nkbšs
);

140 #ifdeà
ONLY_CDM_TRANSF


141 
	`´štf
("Numb” oàd©¨lše š¿nsã¸funùiÚ fe: %d\n",
NkŒªsf
);

146 
	`MPI_Bÿ¡
(&
·¿ms
.
ÿmb
.
NCAMB
, (), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

147 
	`MPI_Bÿ¡
(&
·¿ms
.
ÿmb
.
Nkbšs
, (), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

148 #ifdeà
ONLY_CDM_TRANSF


149 
	`MPI_Bÿ¡
(&
NkŒªsf
, (), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

153 
StÜedLogTÙ®Pow”S³ùrum
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
 *·¿ms.ÿmb.
Nkbšs
 * ());

154 
StÜedLogK
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
Nkbšs
 * ());

155 
CAMBRedshiás
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
 * ());

156 
CAMBSÿËçc
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
 * ());

157 
RefGrowšgMode
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
 * ());

160 ià(!
ThisTask
)

163 #ifdeà
ONLY_CDM_TRANSF


165 
acûl
 = 
	`g¦_š‹½_acûl_®loc
();

166 
¥lšeT¿nsf
 = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
NkŒªsf
);

167 
KŒªsf
=(*)
	`m®loc
(
NkŒªsf
*());

168 
TŒªsf
=(*)
	`m®loc
(
NkŒªsf
*());

171 
i
=0; i<
·¿ms
.
ÿmb
.
NCAMB
; i++)

173 #ifdeà
ONLY_CDM_TRANSF


174 
	`¥rštf
(
f’ame
,"%s_%s_%03d.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
T¿nsãrFe
,
i
);

175 
fd
=
	`fİ’
(
f’ame
,"r");

176 
j
=0; j<
NkŒªsf
; j++)

178 
ugo
=
	`fg‘s
(
bufãr
,
BLENGTH
,
fd
);

179 
	`ssÿnf
(
bufãr
,"%là%là%là%*à%*à%*à%lf",&
k­·
,&
Tcdm
,&
Tb¬
,&
TtÙ
);

180 
KŒªsf
[
j
]=
	`log
(
k­·
);

181 #ifdeà
NOBARYONS


182 
TŒªsf
[
j
]=2.*
	`log
(
Tcdm
/
TtÙ
);

184 
TŒªsf
[
j
]=2.*
	`log
(((
·¿ms
.
Omega0
-·¿ms.
OmegaB¬yÚ
)*
Tcdm
+·¿ms.OmegaB¬yÚ*
Tb¬
)/Õ¬ams.Omega0)/
TtÙ
);

187 
	`g¦_¥lše_š™
(
¥lšeT¿nsf
, 
KŒªsf
, 
TŒªsf
, 
NkŒªsf
);

188 
	`fşo£
(
fd
);

190 
	`¥rštf
(
f’ame
,"%s_%s_%03d.d©",
·¿ms
.
ÿmb
.
RunName
,·¿ms.ÿmb.
M©‹rFe
,
i
);

191 
fd
=
	`fİ’
(
f’ame
,"r");

192 
j
=0; j<
·¿ms
.
ÿmb
.
Nkbšs
; j++)

194 
ff
=
	`fsÿnf
(
fd
,"%là%lf",&
k­·
,&
Pk
);

195 
StÜedLogTÙ®Pow”S³ùrum
[
i
*
·¿ms
.
ÿmb
.
Nkbšs
 +
j
]=

196 
	`log
(
Pk
/
	`pow
(
·¿ms
.
HubbË100
,3.))

197 #ifdeà
ONLY_CDM_TRANSF


200 +
	`my_¥lše_ev®
(
¥lšeT¿nsf
, 
	`log
(
k­·
), 
acûl
)

203 ià(!
i
)

204 
StÜedLogK
[
j
]=
	`log
(
k­·
*
·¿ms
.
HubbË100
);

206 
	`fşo£
(
fd
);

208 #ifdeà
ONLY_CDM_TRANSF


209 
	`ä“
(
KŒªsf
);

210 
	`ä“
(
TŒªsf
);

211 
	`g¦_¥lše_ä“
(
¥lšeT¿nsf
);

212 
	`g¦_š‹½_acûl_ä“
(
acûl
);

215 ià((
fd
=
	`fİ’
(
·¿ms
.
ÿmb
.
RedshiásFe
,"r"))==0x0)

217 
	`´štf
("E¼Ü: Redshiá f% nÙ found\n",
·¿ms
.
ÿmb
.
RedshiásFe
);

220 
i
=0; i<
·¿ms
.
ÿmb
.
NCAMB
; i++)

221 
ff
=
	`fsÿnf
(
fd
,"%d %lf",&
dummy
,
CAMBRedshiás
+
i
);

222 
	`fşo£
(
fd
);

225 ià(
CAMBRedshiás
[
·¿ms
.
ÿmb
.
NCAMB
-1]!=0.0)

227 
	`´štf
("ERROR on Task 0:†ast CAMB„edsbift must be 0.0\n");

233 
	`MPI_Bÿ¡
(
StÜedLogK
, 
·¿ms
.
ÿmb
.
Nkbšs
, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

234 
	`MPI_Bÿ¡
(
StÜedLogTÙ®Pow”S³ùrum
, 
·¿ms
.
ÿmb
.
NCAMB
*·¿ms.ÿmb.
Nkbšs
, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

235 
	`MPI_Bÿ¡
(
CAMBRedshiás
, 
·¿ms
.
ÿmb
.
NCAMB
, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

236 
i
=0; i<
·¿ms
.
ÿmb
.
NCAMB
; i++)

238 
CAMBSÿËçc
[
i
]=1./(
CAMBRedshiás
[i]+1.);

239 
RefGrowšgMode
[
i
]=0.5*(
StÜedLogTÙ®Pow”S³ùrum
[˜* 
·¿ms
.
ÿmb
.
Nkbšs
 +…¬ams.ÿmb.
Reã»nûSÿË
] -

240 
StÜedLogTÙ®Pow”S³ùrum
[
·¿ms
.
ÿmb
.
Reã»nûOuut
 *…¬ams.ÿmb.
Nkbšs
 +…¬ams.ÿmb.
Reã»nûSÿË
]);

242 
·¿ms
.
ÿmb
.
Reã»nûRedshiá
=
CAMBRedshiás
[·¿ms.ÿmb.
Reã»nûOuut
];

245 
·¿ms
.
ÿmb
.
Logk
 = 
StÜedLogK
;

246 
·¿ms
.
ÿmb
.
LogPk»f
 = 
StÜedLogTÙ®Pow”S³ùrum
 +

247 
·¿ms
.
ÿmb
.
Reã»nûOuut
 *…¬ams.ÿmb.
Nkbšs
;

248 
·¿ms
.
ÿmb
.
D2»f
 = 
	`exp
(
StÜedLogTÙ®Pow”S³ùrum
[Õ¬ams.ÿmb.
NCAMB
-1è*…¬ams.ÿmb.
Nkbšs
 +…¬ams.ÿmb.
Reã»nûSÿË
] -

249 
StÜedLogTÙ®Pow”S³ùrum
[
·¿ms
.
ÿmb
.
Reã»nûOuut
 *…¬ams.ÿmb.
Nkbšs
 +…¬ams.ÿmb.
Reã»nûSÿË
]);

250 
·¿ms
.
ÿmb
.
SÿËf
 = 
CAMBSÿËçc
;

251 
·¿ms
.
ÿmb
.
RefGM
 = 
RefGrowšgMode
;

254 
	}
}

257 
	$š™Ÿlize_SÿËD•’d’tGrowth
()

263 
i
, 
i1
, 
i2
;

264 *
V¬M©‹r
, *
V¬V–
, *
ThisM©‹r
, *
ThisV–
, *
ThisfO
, *
ThisfO2
;

265 
»suÉ
,
”rÜ
;

266 
g¦_funùiÚ
 
FuncM©‹r
, 
FuncV–
;

267 
tŞ”ªû
=1.e-4;

270 
FuncM©‹r
.
funùiÚ
 = &
IÁeg¿ndFÜSDMassV¬Ÿnû
;

271 
FuncV–
.
funùiÚ
 = &
IÁeg¿ndFÜSDV–V¬Ÿnû
;

274 
acûlGrow
 = 
	`g¦_š‹½_acûl_®loc
();

275 
¥lšeGrowM©‹r
 = (
g¦_¥lše
**)
	`ÿÎoc
(
SmoÙhšg
.
NsmoÙh
,(gsl_spline*));

276 
¥lšeGrowV–
 = (
g¦_¥lše
**)
	`ÿÎoc
(
SmoÙhšg
.
NsmoÙh
,(gsl_spline*));

277 
¥lšeInvGrowM©‹r
 = (
g¦_¥lše
**)
	`ÿÎoc
(
SmoÙhšg
.
NsmoÙh
,(gsl_spline*));

278 
¥lšeFomega
 = (
g¦_¥lše
**)
	`ÿÎoc
(
SmoÙhšg
.
NsmoÙh
,(gsl_spline*));

279 
¥lšeFomega2
 = (
g¦_¥lše
**)
	`ÿÎoc
(
SmoÙhšg
.
NsmoÙh
,(gsl_spline*));

280 
i
=0; i<
SmoÙhšg
.
NsmoÙh
; i++)

282 
¥lšeGrowM©‹r
 [
i
] = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

283 
¥lšeGrowV–
 [
i
] = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

284 
¥lšeInvGrowM©‹r
[
i
] = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

285 
¥lšeFomega
 [
i
] = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

286 
¥lšeFomega2
 [
i
] = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

290 
V¬M©‹r
 =(*)
	`m®loc
(
SmoÙhšg
.
NsmoÙh
*());

291 
V¬V–
 =(*)
	`m®loc
(
SmoÙhšg
.
NsmoÙh
*());

292 
ThisM©‹r
=(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
*());

293 
ThisV–
 =(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
*());

294 
ThisfO
 =(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
*());

295 
ThisfO2
 =(*)
	`m®loc
(
·¿ms
.
ÿmb
.
NCAMB
*());

298 
acûl
 = 
	`g¦_š‹½_acûl_®loc
 ();

299 
¥lše
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
Nkbšs
);

302 
ThisOuut
=
·¿ms
.
ÿmb
.
Reã»nûOuut
;

303 
ThisRadius
=0; ThisRadius<
SmoÙhšg
.
NsmoÙh
; ThisRadius++)

305 
	`g¦_š‹g¿tiÚ_qags
 (&
FuncM©‹r
, 
StÜedLogK
[0], StÜedLogK[
·¿ms
.
ÿmb
.
Nkbšs
-1], 0.0, 
tŞ”ªû
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

306 
V¬M©‹r
[
ThisRadius
]=
»suÉ
;

307 
	`g¦_š‹g¿tiÚ_qags
 (&
FuncV–
, 
StÜedLogK
[0], StÜedLogK[
·¿ms
.
ÿmb
.
Nkbšs
-1], 0.0, 
tŞ”ªû
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

308 
V¬V–
[
ThisRadius
]=
»suÉ
;

311 #ifdeà
OUTPUT_GM


312 
SDGM
.
æag
=-1;

313 
FILE
 *
fd
;

314 ià(!
ThisTask
)

315 
fd
=
	`fİ’
("GrowingModes","w");

320 
ThisRadius
=0; ThisRadius<
SmoÙhšg
.
NsmoÙh
; ThisRadius++)

322 
ThisOuut
=0; ThisOuut<
·¿ms
.
ÿmb
.
NCAMB
; ThisOutput++)

324 
	`g¦_š‹g¿tiÚ_qags
 (&
FuncM©‹r
, 
StÜedLogK
[0], StÜedLogK[
·¿ms
.
ÿmb
.
Nkbšs
-1], 0.0, 
tŞ”ªû
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

325 
ThisM©‹r
[
ThisOuut
]=
	`sq¹
(
»suÉ
/
V¬M©‹r
[
ThisRadius
]);

326 
	`g¦_š‹g¿tiÚ_qags
 (&
FuncV–
, 
StÜedLogK
[0], StÜedLogK[
·¿ms
.
ÿmb
.
Nkbšs
-1], 0.0, 
tŞ”ªû
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

327 
ThisV–
[
ThisOuut
]=
	`sq¹
(
»suÉ
/
V¬V–
[
ThisRadius
]);

330 
	`g¦_¥lše_š™
(
¥lšeGrowM©‹r
[
ThisRadius
], 
CAMBSÿËçc
, 
ThisM©‹r
, 
·¿ms
.
ÿmb
.
NCAMB
);

331 
	`g¦_¥lše_š™
(
¥lšeGrowV–
[
ThisRadius
], 
CAMBSÿËçc
, 
ThisV–
, 
·¿ms
.
ÿmb
.
NCAMB
);

332 
	`g¦_¥lše_š™
(
¥lšeInvGrowM©‹r
[
ThisRadius
], 
ThisM©‹r
, 
CAMBSÿËçc
, 
·¿ms
.
ÿmb
.
NCAMB
);

335 
ThisOuut
=0; ThisOuut<
·¿ms
.
ÿmb
.
NCAMB
; ThisOutput++)

339 ià(
ThisOuut
<
·¿ms
.
ÿmb
.
NCAMB
-1)

341 
i1
=(
ThisOuut
>0 ? ThisOutput-1 : 0);

342 
i2
=
ThisOuut
+1;

344 
ThisfO
[
ThisOuut
] = (
ThisV–
[
i2
]-ThisV–[
i1
]è/ (
CAMBSÿËçc
[i2]-CAMBScalefac[i1]) * CAMBScalefac[ThisOutput] / ThisVel[ThisOutput];

345 
ThisfO2
[
ThisOuut
] = ( (3./7.*
	`pow
(
ThisV–
[
i2
],2.0)*pow(
	`Omega
(
CAMBRedshiás
[i2]),-0.007)) -

346 (3./7.*
	`pow
(
ThisV–
[
i1
],2.0)*pow(
	`Omega
(
CAMBRedshiás
[i1]),-0.007)) )

347 / (
CAMBSÿËçc
[
i2
]-CAMBSÿËçc[
i1
]è* CAMBSÿËçc[
ThisOuut
] /

348 (3./7.*
	`pow
(
ThisV–
[
ThisOuut
],2.0)*pow(
	`Omega
(
CAMBRedshiás
[ThisOutput]),-0.007));

352 
ThisfO
[
ThisOuut
] = - ThisfO[ThisOuut-2] * (
CAMBSÿËçc
[ThisOutput]-CAMBScalefac[ThisOutput-1])/(CAMBScalefac[ThisOutput-1]-CAMBScalefac[ThisOutput-2])

353 + 
ThisfO
[
ThisOuut
-1] * (
CAMBSÿËçc
[ThisOutput]-CAMBScalefac[ThisOutput-2])/(CAMBScalefac[ThisOutput-1]-CAMBScalefac[ThisOutput-2]) ;

354 
ThisfO2
[
ThisOuut
] = - ThisfO2[ThisOuut-2] * (
CAMBSÿËçc
[ThisOutput]-CAMBScalefac[ThisOutput-1])/(CAMBScalefac[ThisOutput-1]-CAMBScalefac[ThisOutput-2])

355 + 
ThisfO2
[
ThisOuut
-1] * (
CAMBSÿËçc
[ThisOutput]-CAMBScalefac[ThisOutput-2])/(CAMBScalefac[ThisOutput-1]-CAMBScalefac[ThisOutput-2]) ;

358 #ifdeà
OUTPUT_GM


359 ià(!
ThisTask
)

360 
	`årštf
(
fd
," %d %d %g %g %g %g %g %g %g %g %g %g %f %g %g\n",

361 
ThisRadius
,
ThisOuut
,

362 
CAMBRedshiás
[
ThisOuut
],
SmoÙhšg
.
Radius
[
ThisRadius
],

363 
ThisM©‹r
[
ThisOuut
],
ThisV–
[ThisOuut],
	`GrowšgMode
(
CAMBRedshiás
[ThisOutput]),

364 3./7.*
	`pow
(
ThisM©‹r
[
ThisOuut
],2.0)*pow(
	`Omega
(
CAMBRedshiás
[ThisOutput]),-0.007),

365 3./7.*
	`pow
(
ThisV–
[
ThisOuut
],2.0)*pow(
	`Omega
(
CAMBRedshiás
[ThisOutput]),-0.007),

366 
	`GrowšgMode_2LPT
(
CAMBRedshiás
[
ThisOuut
]),

367 
ThisfO
[
ThisOuut
], 
	`fomega
(
CAMBRedshiás
[ThisOuut]), 
	`Omega
(CAMBRedshifts[ThisOutput]),

368 
ThisfO2
[
ThisOuut
], 
	`fomega_2LPT
(
CAMBRedshiás
[ThisOutput])

374 
	`g¦_¥lše_š™
(
¥lšeFomega
[
ThisRadius
], 
CAMBSÿËçc
, 
ThisfO
, 
·¿ms
.
ÿmb
.
NCAMB
);

375 
	`g¦_¥lše_š™
(
¥lšeFomega2
[
ThisRadius
], 
CAMBSÿËçc
, 
ThisfO2
, 
·¿ms
.
ÿmb
.
NCAMB
);

379 #ifdeà
OUTPUT_GM


380 ià(!
ThisTask
è
	`fşo£
(
fd
);

383 
	`g¦_¥lše_ä“
(
¥lše
);

384 
	`g¦_š‹½_acûl_ä“
(
acûl
);

386 
	`ä“
(
ThisfO2
);

387 
	`ä“
(
ThisfO
);

388 
	`ä“
(
ThisV–
);

389 
	`ä“
(
ThisM©‹r
);

390 
	`ä“
(
V¬V–
);

391 
	`ä“
(
V¬M©‹r
);

394 
	}
}

397 
	$IÁeg¿ndFÜSDMassV¬Ÿnû
(
logk
, *
·¿m
)

399 
k
,
R
;

401 
k
=
	`exp
(
logk
);

402 
R
=(
ThisRadius
<
SmoÙhšg
.
NsmoÙh
-1 ? SmoÙhšg.
Radius
[ThisRadius] : 
·¿ms
.
IÁ”P¬tDi¡
/6.);

403  
	`Pow”FromCAMB
(
k
è* 
	`exp
(-k*k*
R
*Rè* k*k*k / (2.*
PI
*PI);

404 
	}
}

407 
	$IÁeg¿ndFÜSDV–V¬Ÿnû
(
logk
, *
¿dius
)

409 
k
,
R
;

411 
k
=
	`exp
(
logk
);

412 
R
=(
ThisRadius
<
SmoÙhšg
.
NsmoÙh
-1 ? SmoÙhšg.
Radius
[ThisRadius] : 
·¿ms
.
IÁ”P¬tDi¡
/6.);

413  
	`Pow”FromCAMB
(
k
è* 
	`exp
(-k*k*
R
*Rè* k / (2.*
PI
*PI);

414 
	}
}

417 
	$Pow”FromCAMB
(
k
)

422 
La¡Ouut
=-99;

425 ià(
¥lše
==0x0 || 
ThisOuut
!=
La¡Ouut
)

427 
	`g¦_¥lše_š™
 (
¥lše
, 
StÜedLogK
,

428 
StÜedLogTÙ®Pow”S³ùrum
 + 
ThisOuut
 * 
·¿ms
.
ÿmb
.
Nkbšs
,

429 
·¿ms
.
ÿmb
.
Nkbšs
);

432 
La¡Ouut
=
ThisOuut
;

433 
»suÉ
=
	`exp
(
	`my_¥lše_ev®
 (
¥lše
, 
	`log
(
k
), 
acûl
));

434  
»suÉ
;

435 
	}
}

438 
	$M©‹rGrowšgMode
(
z
)

441 
mysmoÙh
, 
š‹½Ş©e
;

442 
w
;

445 ià(
SDGM
.
ismoÙh
>=0 && SDGM.ismoÙh<
SmoÙhšg
.
NsmoÙh
)

447 
mysmoÙh
=
SDGM
.
ismoÙh
;

448 
š‹½Ş©e
=0;

452 ià(
SDGM
.
¿dius
>
SmoÙhšg
.
Radius
[0])

454 
mysmoÙh
=0;

455 
š‹½Ş©e
=0;

457 ià(
SDGM
.
¿dius
<
SmoÙhšg
.
Radius
[SmoÙhšg.
NsmoÙh
-1])

459 
mysmoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

460 
š‹½Ş©e
=0;

464 
mysmoÙh
=1; mysmoÙh<
SmoÙhšg
.
NsmoÙh
 && 
SDGM
.
¿dius
<=SmoÙhšg.
Radius
[mysmooth]; mysmooth++)

466 
š‹½Ş©e
=1;

470 ià(
š‹½Ş©e
)

472 
w
=(
SDGM
.
¿dius
-
SmoÙhšg
.
Radius
[
mysmoÙh
])/(Smoothing.Radius[mysmooth-1]-Smoothing.Radius[mysmooth]);

473  ((1.-
w
è* 
	`my_¥lše_ev®
(
¥lšeGrowM©‹r
[
mysmoÙh
 ], 1./(1.+
z
), 
acûlGrow
)

474 + 
w
 * 
	`my_¥lše_ev®
(
¥lšeGrowM©‹r
[
mysmoÙh
-1], 1./(1.+
z
), 
acûlGrow
));

477  
	`my_¥lše_ev®
(
¥lšeGrowM©‹r
[
mysmoÙh
], 1./(1.+
z
), 
acûlGrow
);

478 
	}
}

481 
	$V–GrowšgMode
(
z
)

484 
mysmoÙh
, 
š‹½Ş©e
;

485 
w
;

488 ià(
SDGM
.
ismoÙh
>=0 && SDGM.ismoÙh<
SmoÙhšg
.
NsmoÙh
)

490 
mysmoÙh
=
SDGM
.
ismoÙh
;

491 
š‹½Ş©e
=0;

495 ià(
SDGM
.
¿dius
>
SmoÙhšg
.
Radius
[0])

497 
mysmoÙh
=0;

498 
š‹½Ş©e
=0;

500 ià(
SDGM
.
¿dius
<
SmoÙhšg
.
Radius
[SmoÙhšg.
NsmoÙh
-1])

502 
mysmoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

503 
š‹½Ş©e
=0;

507 
mysmoÙh
=1; mysmoÙh<
SmoÙhšg
.
NsmoÙh
 && 
SDGM
.
¿dius
<=SmoÙhšg.
Radius
[mysmooth]; mysmooth++)

509 
š‹½Ş©e
=1;

513 ià(
š‹½Ş©e
)

515 
w
=(
SDGM
.
¿dius
-
SmoÙhšg
.
Radius
[
mysmoÙh
])/(Smoothing.Radius[mysmooth-1]-Smoothing.Radius[mysmooth]);

516  ((1.-
w
è* 
	`my_¥lše_ev®
(
¥lšeGrowV–
[
mysmoÙh
 ], 1./(1.+
z
), 
acûlGrow
)

517 + 
w
 * 
	`my_¥lše_ev®
(
¥lšeGrowV–
[
mysmoÙh
-1], 1./(1.+
z
), 
acûlGrow
));

520  
	`my_¥lše_ev®
(
¥lšeGrowV–
[
mysmoÙh
], 1./(1.+
z
), 
acûlGrow
);

521 
	}
}

524 
	$Inv”£M©‹rGrowšgMode
(
D
)

527 
mysmoÙh
, 
š‹½Ş©e
;

528 
w
;

531 ià(
SDGM
.
ismoÙh
>=0 && SDGM.ismoÙh<
SmoÙhšg
.
NsmoÙh
)

533 
mysmoÙh
=
SDGM
.
ismoÙh
;

534 
š‹½Ş©e
=0;

538 ià(
SDGM
.
¿dius
>
SmoÙhšg
.
Radius
[0])

540 
mysmoÙh
=0;

541 
š‹½Ş©e
=0;

543 ià(
SDGM
.
¿dius
<
SmoÙhšg
.
Radius
[SmoÙhšg.
NsmoÙh
-1])

545 
mysmoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

546 
š‹½Ş©e
=0;

550 
mysmoÙh
=1; mysmoÙh<
SmoÙhšg
.
NsmoÙh
 && 
SDGM
.
¿dius
<=SmoÙhšg.
Radius
[mysmooth]; mysmooth++)

552 
š‹½Ş©e
=1;

556 ià(
š‹½Ş©e
)

558 
w
=(
SDGM
.
¿dius
-
SmoÙhšg
.
Radius
[
mysmoÙh
])/(Smoothing.Radius[mysmooth-1]-Smoothing.Radius[mysmooth]);

559  1./((1.-
w
è* 
	`my_¥lše_ev®
(
¥lšeInvGrowM©‹r
[
mysmoÙh
 ], 
D
, 
acûlGrow
)

560 + 
w
 * 
	`my_¥lše_ev®
(
¥lšeInvGrowM©‹r
[
mysmoÙh
-1], 
D
, 
acûlGrow
)) -1.;

563  1./
	`my_¥lše_ev®
(
¥lšeInvGrowM©‹r
[
mysmoÙh
], 
D
, 
acûlGrow
) -1 ;

564 
	}
}

567 
	$V–fOmega
(
z
)

570 
mysmoÙh
, 
š‹½Ş©e
;

571 
w
;

574 ià(
SDGM
.
ismoÙh
>=0 && SDGM.ismoÙh<
SmoÙhšg
.
NsmoÙh
)

576 
mysmoÙh
=
SDGM
.
ismoÙh
;

577 
š‹½Ş©e
=0;

581 ià(
SDGM
.
¿dius
>
SmoÙhšg
.
Radius
[0])

583 
mysmoÙh
=0;

584 
š‹½Ş©e
=0;

586 ià(
SDGM
.
¿dius
<
SmoÙhšg
.
Radius
[SmoÙhšg.
NsmoÙh
-1])

588 
mysmoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

589 
š‹½Ş©e
=0;

593 
mysmoÙh
=1; mysmoÙh<
SmoÙhšg
.
NsmoÙh
 && 
SDGM
.
¿dius
<=SmoÙhšg.
Radius
[mysmooth]; mysmooth++)

595 
š‹½Ş©e
=1;

599 ià(
š‹½Ş©e
)

601 
w
=(
SDGM
.
¿dius
-
SmoÙhšg
.
Radius
[
mysmoÙh
])/(Smoothing.Radius[mysmooth-1]-Smoothing.Radius[mysmooth]);

602  ((1.-
w
è* 
	`my_¥lše_ev®
(
¥lšeFomega
[
mysmoÙh
 ], 1./(1.+
z
), 
acûlGrow
)

603 + 
w
 * 
	`my_¥lše_ev®
(
¥lšeFomega
[
mysmoÙh
-1], 1./(1.+
z
), 
acûlGrow
));

606  
	`my_¥lše_ev®
(
¥lšeFomega
[
mysmoÙh
], 1./(1.+
z
), 
acûlGrow
);

607 
	}
}

610 
	$V–fOmega2
(
z
)

613 
mysmoÙh
, 
š‹½Ş©e
;

614 
w
;

617 ià(
SDGM
.
ismoÙh
>=0 && SDGM.ismoÙh<
SmoÙhšg
.
NsmoÙh
)

619 
mysmoÙh
=
SDGM
.
ismoÙh
;

620 
š‹½Ş©e
=0;

624 ià(
SDGM
.
¿dius
>
SmoÙhšg
.
Radius
[0])

626 
mysmoÙh
=0;

627 
š‹½Ş©e
=0;

629 ià(
SDGM
.
¿dius
<
SmoÙhšg
.
Radius
[SmoÙhšg.
NsmoÙh
-1])

631 
mysmoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

632 
š‹½Ş©e
=0;

636 
mysmoÙh
=1; mysmoÙh<
SmoÙhšg
.
NsmoÙh
 && 
SDGM
.
¿dius
<=SmoÙhšg.
Radius
[mysmooth]; mysmooth++)

638 
š‹½Ş©e
=1;

642 ià(
š‹½Ş©e
)

644 
w
=(
SDGM
.
¿dius
-
SmoÙhšg
.
Radius
[
mysmoÙh
])/(Smoothing.Radius[mysmooth-1]-Smoothing.Radius[mysmooth]);

645  ((1.-
w
è* 
	`my_¥lše_ev®
(
¥lšeFomega2
[
mysmoÙh
 ], 1./(1.+
z
), 
acûlGrow
)

646 + 
w
 * 
	`my_¥lše_ev®
(
¥lšeFomega2
[
mysmoÙh
-1], 1./(1.+
z
), 
acûlGrow
));

649  
	`my_¥lše_ev®
(
¥lšeFomega2
[
mysmoÙh
], 1./(1.+
z
), 
acûlGrow
);

650 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/ReadParamfile.c

34 
	~"pšocchio.h
"

36 
	#DOUBLE
 1

	)

37 
	#STRING
 2

	)

38 
	#INT
 3

	)

39 
	#LOGICAL
 4

	)

40 
	#INT3
 5

	)

41 
	#DOUBLE3
 6

	)

42 
	#INT_SKIP
 99

	)

43 
	#MAXTAGS
 100

	)

45 
	$»ad_·¿m‘”_fe
()

47 
FILE
 *
fd
;

48 
buf
[
BLENGTH
], 
buf1
[BLENGTH], 
buf2
[BLENGTH], 
buf3
[BLENGTH], 
buf4
[BLENGTH];

49 
i
, 
j
, 
Á
, 
numb”_of_f›lds
;

50 
id
[
MAXTAGS
];

51 *
addr
[
MAXTAGS
];

52 
g
[
MAXTAGS
][
BLENGTH
];

53 
z
;

55 ià(!
ThisTask
)

58 
Á
=0;

61 
	`¡rıy
(
g
[
Á
], "RunFlag");

62 
addr
[
Á
] = 
·¿ms
.
RunFÏg
;

63 
id
[
Á
++] = 
STRING
;

65 
	`¡rıy
(
g
[
Á
], "OutputList");

66 
addr
[
Á
] = 
·¿ms
.
OuutLi¡
;

67 
id
[
Á
++] = 
STRING
;

69 
	`¡rıy
(
g
[
Á
], "Omega0");

70 
addr
[
Á
] = &
·¿ms
.
Omega0
;

71 
id
[
Á
++] = 
DOUBLE
;

73 
	`¡rıy
(
g
[
Á
], "OmegaLambda");

74 
addr
[
Á
] = &
·¿ms
.
OmegaLambda
;

75 
id
[
Á
++] = 
DOUBLE
;

77 
	`¡rıy
(
g
[
Á
], "PrimordialIndex");

78 
addr
[
Á
] = &
·¿ms
.
PrimÜdŸlIndex
;

79 
id
[
Á
++] = 
DOUBLE
;

81 
	`¡rıy
(
g
[
Á
], "Sigma8");

82 
addr
[
Á
] = &
·¿ms
.
Sigma8
;

83 
id
[
Á
++] = 
DOUBLE
;

85 
	`¡rıy
(
g
[
Á
], "Hubble100");

86 
addr
[
Á
] = &
·¿ms
.
HubbË100
;

87 
id
[
Á
++] = 
DOUBLE
;

89 
	`¡rıy
(
g
[
Á
], "OmegaBaryon");

90 
addr
[
Á
] = &
·¿ms
.
OmegaB¬yÚ
;

91 
id
[
Á
++] = 
DOUBLE
;

93 
	`¡rıy
(
g
[
Á
], "DEw0");

94 
addr
[
Á
] = &
·¿ms
.
DEw0
;

95 
id
[
Á
++] = 
DOUBLE
;

97 
	`¡rıy
(
g
[
Á
], "DEwa");

98 
addr
[
Á
] = &
·¿ms
.
DEwa
;

99 
id
[
Á
++] = 
DOUBLE
;

101 
	`¡rıy
(
g
[
Á
], "StartingzForPLC");

102 
addr
[
Á
] = &
·¿ms
.
S¹šgzFÜPLC
;

103 
id
[
Á
++] = 
DOUBLE
;

105 
	`¡rıy
(
g
[
Á
], "LastzForPLC");

106 
addr
[
Á
] = &
·¿ms
.
La¡zFÜPLC
;

107 
id
[
Á
++] = 
DOUBLE
;

109 
	`¡rıy
(
g
[
Á
], "PLCAperture");

110 
addr
[
Á
] = &
·¿ms
.
PLCA³¹u»
;

111 
id
[
Á
++] = 
DOUBLE
;

113 
	`¡rıy
(
g
[
Á
], "PLCProvideConeData");

114 
addr
[
Á
] = &
·¿ms
.
PLCProvideCÚeD©a
;

115 
id
[
Á
++] = 
LOGICAL
;

117 
	`¡rıy
(
g
[
Á
], "PLCCenter");

118 
addr
[
Á
] = &(
·¿ms
.
PLCC’‹r
);

119 
id
[
Á
++] = 
DOUBLE3
;

121 
	`¡rıy
(
g
[
Á
], "PLCAxis");

122 
addr
[
Á
] = &(
·¿ms
.
PLCAxis
);

123 
id
[
Á
++] = 
DOUBLE3
;

125 
	`¡rıy
(
g
[
Á
], "BoxSize");

126 
addr
[
Á
] = &
·¿ms
.
BoxSize
;

127 
id
[
Á
++] = 
DOUBLE
;

129 
	`¡rıy
(
g
[
Á
], "BoxInH100");

130 
addr
[
Á
] = &
·¿ms
.
BoxInH100
;

131 
id
[
Á
++] = 
LOGICAL
;

133 
	`¡rıy
(
g
[
Á
], "RandomSeed");

134 
addr
[
Á
] = &
·¿ms
.
RªdomS“d
;

135 
id
[
Á
++] = 
INT
;

137 
	`¡rıy
(
g
[
Á
], "GridSize");

138 
addr
[
Á
] = &(
·¿ms
.
GridSize
[0]);

139 
id
[
Á
++] = 
INT
;

141 
	`¡rıy
(
g
[
Á
], "BoundaryLayerFactor");

142 
addr
[
Á
] = &
·¿ms
.
Bound¬yLay”FaùÜ
;

143 
id
[
Á
++] = 
DOUBLE
;

145 
	`¡rıy
(
g
[
Á
], "MinHaloMass");

146 
addr
[
Á
] = &
·¿ms
.
MšH®oMass
;

147 
id
[
Á
++] = 
INT
;

149 
	`¡rıy
(
g
[
Á
], "WriteFmax");

150 
addr
[
Á
] = &
·¿ms
.
Wr™eFmax
;

151 
id
[
Á
++] = 
LOGICAL
;

153 
	`¡rıy
(
g
[
Á
], "WriteVmax");

154 
addr
[
Á
] = &
·¿ms
.
Wr™eVmax
;

155 
id
[
Á
++] = 
LOGICAL
;

157 
	`¡rıy
(
g
[
Á
], "WriteRmax");

158 
addr
[
Á
] = &
·¿ms
.
Wr™eRmax
;

159 
id
[
Á
++] = 
LOGICAL
;

161 
	`¡rıy
(
g
[
Á
], "NumFiles");

162 
addr
[
Á
] = &
·¿ms
.
NumFes
;

163 
id
[
Á
++] = 
INT_SKIP
;

165 
	`¡rıy
(
g
[
Á
], "MaxMem");

166 
addr
[
Á
] = &
·¿ms
.
MaxMem
;

167 
id
[
Á
++] = 
INT
;

169 
	`¡rıy
(
g
[
Á
], "AnalyticMassFunction");

170 
addr
[
Á
] = &
·¿ms
.
AÇlyticMassFunùiÚ
;

171 
id
[
Á
++] = 
INT
;

173 
	`¡rıy
(
g
[
Á
], "CatalogInAscii");

174 
addr
[
Á
] = &
·¿ms
.
C©®ogInAscii
;

175 
id
[
Á
++] = 
LOGICAL
;

177 
	`¡rıy
(
g
[
Á
], "DoNotWriteCatalogs");

178 
addr
[
Á
] = &
·¿ms
.
DoNÙWr™eC©®ogs
;

179 
id
[
Á
++] = 
LOGICAL
;

181 
	`¡rıy
(
g
[
Á
], "DoNotWriteHistories");

182 
addr
[
Á
] = &
·¿ms
.
DoNÙWr™eHi¡Ü›s
;

183 
id
[
Á
++] = 
LOGICAL
;

185 
	`¡rıy
(
g
[
Á
], "WriteSnapshot");

186 
addr
[
Á
] = &
·¿ms
.
Wr™eSÇpshÙ
;

187 
id
[
Á
++] = 
LOGICAL
;

189 
	`¡rıy
(
g
[
Á
], "OutputInH100");

190 
addr
[
Á
] = &
·¿ms
.
OuutInH100
;

191 
id
[
Á
++] = 
LOGICAL
;

193 
	`¡rıy
(
g
[
Á
], "InputSpectrum_UnitLength_in_cm");

194 
addr
[
Á
] = &(
·¿ms
.
IÅutS³ùrum_Un™L’gth_š_cm
);

195 
id
[
Á
++] = 
DOUBLE
;

197 
	`¡rıy
(
g
[
Á
], "FileWithInputSpectrum");

198 
addr
[
Á
] = 
·¿ms
.
FeW™hIÅutS³ùrum
;

199 
id
[
Á
++] = 
STRING
;

201 
	`¡rıy
(
g
[
Á
], "WDM_PartMass_in_kev");

202 
addr
[
Á
] = &(
·¿ms
.
WDM_P¬tMass_š_kev
);

203 
id
[
Á
++] = 
DOUBLE
;

205 
	`¡rıy
(
g
[
Á
], "TabulatedEoSfile");

206 
addr
[
Á
] = 
·¿ms
.
TabuÏ‹dEoSfe
;

207 
id
[
Á
++] = 
STRING
;

209 #ifdeà
SCALE_DEPENDENT_GROWTH


210 
	`¡rıy
(
g
[
Á
], "CAMBMatterFileTag");

211 
addr
[
Á
] = 
·¿ms
.
ÿmb
.
M©‹rFe
;

212 
id
[
Á
++] = 
STRING
;

214 
	`¡rıy
(
g
[
Á
], "CAMBTransferFileTag");

215 
addr
[
Á
] = 
·¿ms
.
ÿmb
.
T¿nsãrFe
;

216 
id
[
Á
++] = 
STRING
;

218 
	`¡rıy
(
g
[
Á
], "CAMBRunName");

219 
addr
[
Á
] = 
·¿ms
.
ÿmb
.
RunName
;

220 
id
[
Á
++] = 
STRING
;

222 
	`¡rıy
(
g
[
Á
], "CAMBRedsfhitsFile");

223 
addr
[
Á
] = 
·¿ms
.
ÿmb
.
RedshiásFe
;

224 
id
[
Á
++] = 
STRING
;

226 
	`¡rıy
(
g
[
Á
], "CAMBReferenceOutput");

227 
addr
[
Á
] = &
·¿ms
.
ÿmb
.
Reã»nûOuut
;

228 
id
[
Á
++] = 
INT
;

230 
	`¡rıy
(
g
[
Á
], "CAMBReferenceScale");

231 
addr
[
Á
] = &
·¿ms
.
ÿmb
.
Reã»nûSÿË
;

232 
id
[
Á
++] = 
INT
;

235 
	`¡rıy
(
g
[
Á
], "MaxMemPerParticle");

236 
addr
[
Á
] = &(
·¿ms
.
MaxMemP”P¬tişe
);

237 
id
[
Á
++] = 
DOUBLE
;

239 
	`¡rıy
(
g
[
Á
], "UseTransposedFFT");

240 
addr
[
Á
] = &(
·¿ms
.
u£_Œª¥o£d_fá
);

241 
id
[
Á
++] = 
LOGICAL
;

243 
	`¡rıy
(
g
[
Á
], "DumpVectors");

244 
addr
[
Á
] = &(
š‹º®
.
dump_veùÜs
);

245 
id
[
Á
++] = 
LOGICAL
;

247 
	`¡rıy
(
g
[
Á
], "DumpSeedPlane");

248 
addr
[
Á
] = &(
š‹º®
.
dump_£ed¶ªe
);

249 
id
[
Á
++] = 
INT_SKIP
;

251 
	`¡rıy
(
g
[
Á
], "DumpKDensity");

252 
addr
[
Á
] = &(
š‹º®
.
dump_kd’s™y
);

253 
id
[
Á
++] = 
INT_SKIP
;

255 
	`¡rıy
(
g
[
Á
], "UseInPlaceFFT");

256 
addr
[
Á
] = &(
·¿ms
.
u£_š¶aû_fá
);

257 
id
[
Á
++] = 
LOGICAL
;

259 
	`¡rıy
(
g
[
Á
], "VerboseLevel");

260 
addr
[
Á
] = &(
š‹º®
.
v”bo£_Ëv–
);

261 
id
[
Á
++] = 
INT_SKIP
;

263 
	`¡rıy
(
g
[
Á
], "MimicOldSeed");

264 
addr
[
Á
] = &(
š‹º®
.
mimic_Üigš®_£edbË
);

265 
id
[
Á
++] = 
LOGICAL
;

267 
	`¡rıy
(
g
[
Á
], "Constrain_dim0");

268 
addr
[
Á
] = &(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0]);

269 
id
[
Á
++] = 
INT_SKIP
;

271 
	`¡rıy
(
g
[
Á
], "Constrain_dim1");

272 
addr
[
Á
] = &(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[1]);

273 
id
[
Á
++] = 
INT_SKIP
;

275 
	`¡rıy
(
g
[
Á
], "Constrain_dim2");

276 
addr
[
Á
] = &(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[2]);

277 
id
[
Á
++] = 
INT_SKIP
;

279 
	`¡rıy
(
g
[
Á
], "LargePlane");

280 
addr
[
Á
] = &(
š‹º®
.
Ïrge_¶ªe
);

281 
id
[
Á
++] = 
LOGICAL
;

283 
j
=0; j<
Á
; j++)

284 ià(
id
[
j
]==
LOGICAL
)

285 *((*è
addr
[
j
]) = 0;

287 
	`´štf
("R—dšg…¬am‘” äom f%s\n",
·¿ms
.
P¬am‘”Fe
);

288 
	`fæush
(
¡dout
);

290 if((
fd
 = 
	`fİ’
(
·¿ms
.
P¬am‘”Fe
, "r")))

292 !
	`ãof
(
fd
))

294 *
buf
 = 0;

295 ()
	`fg‘s
(
buf
, 
BLENGTH
, 
fd
);

296 
numb”_of_f›lds
 = 
	`ssÿnf
(
buf
, "% % % %s", 
buf1
, 
buf2
, 
buf3
, 
buf4
);

297 if(
numb”_of_f›lds
 < 1)

300 if(
buf1
[0] == '#' || buf1[0]=='%')

304 
i
 = 0, 
j
 = -1; i < 
Á
; i++)

305 if(
	`¡rcmp
(
buf1
, 
g
[
i
]) == 0)

307 
j
 = 
i
;

308 
g
[
i
][0] = 0;

312 if(
j
 >= 0)

314 
id
[
j
])

316 
DOUBLE
:

317 ià(
numb”_of_f›lds
<2)

318 
j
=-10;

320 *((*è
addr
[
j
]èğ
	`©of
(
buf2
);

323 
STRING
:

324 ià(
numb”_of_f›lds
<2)

325 
j
=-10;

327 
	`¡rıy
(
addr
[
j
], 
buf2
);

330 
INT
:

331 ià(
numb”_of_f›lds
<2)

332 
j
=-10;

334 *((*è
addr
[
j
]èğ
	`©oi
(
buf2
);

337 
INT_SKIP
:

338 ià(
numb”_of_f›lds
<2)

339 
j
=-10;

341 *((*è
addr
[
j
]èğ
	`©oi
(
buf2
);

344 
INT3
:

345 ià(
numb”_of_f›lds
<4)

346 
j
=-10;

349 *((*)
addr
[
j
] ) = 
	`©oi
(
buf2
);

350 *((*)
addr
[
j
]+1èğ
	`©oi
(
buf3
);

351 *((*)
addr
[
j
]+2èğ
	`©oi
(
buf4
);

355 
DOUBLE3
:

356 ià(
numb”_of_f›lds
<4)

357 
j
=-10;

360 *((*è
addr
[
j
]èğ
	`©of
(
buf2
);

361 *((*è
addr
[
j
]+1èğ
	`©of
(
buf3
);

362 *((*è
addr
[
j
]+2èğ
	`©of
(
buf4
);

366 
LOGICAL
:

367 *((*è
addr
[
j
]) = 1;

375 ià(
j
<0)

377 
	`´štf
("ERROR onask 0: file %s, Tag %s has‚o‡rgument.\n",

378 
·¿ms
.
P¬am‘”Fe
, 
buf1
);

379 
	`fæush
(
¡dout
);

385 
	`´štf
("ERROR onask 0: file %s, Tag %s is unknown.\n",

386 
·¿ms
.
P¬am‘”Fe
, 
buf1
);

387 
	`fæush
(
¡dout
);

391 
	`fşo£
(
fd
);

396 
	`´štf
("ERROR: P¬am‘” f% nÙ found.\n", 
·¿ms
.
P¬am‘”Fe
);

401 
i
 = 0; i < 
Á
; i++)

403 if(*
g
[
i
])

405 ià(
id
[
i
]==
LOGICAL
 || id[i]==
INT_SKIP
 || id[i]==
DOUBLE3
)

406 *((*è
addr
[
i
]) = 0;

409 
	`´štf
("ERROR oÀsk 0: I mis ¨v®ufÜag '%s' iÀ·¿m‘” f'%s'.\n", 
g
[
i
], 
·¿ms
.
P¬am‘”Fe
);

410 
	`fæush
(
¡dout
);

418 
ouuts
.
n
=0;

419 if((
fd
 = 
	`fİ’
(
·¿ms
.
OuutLi¡
, "r")))

420 !
	`ãof
(
fd
))

422 *
buf
 = 0;

423 ()
	`fg‘s
(
buf
, 
BLENGTH
, 
fd
);

424 ià(
buf
[0] !ğ'#' && buf[0] !ğ'%' && 
	`ssÿnf
(buf,"%lf",&
z
è!ğ
EOF
)

425 
ouuts
.
z
[ouuts.
n
++]=z;

426 ià(
ouuts
.
n
 =ğ
MAXOUTPUTS
)

428 
	`´štf
("ERROR oÀsk 0:oØmªy ouuˆ»dshiá š f%s\n",
·¿ms
.
OuutLi¡
);

429 
	`´štf
(" increase MAXOUTPUTS in…inocchio.h\n");

430 
	`fæush
(
¡dout
);

437 
	`´štf
("E¼Ü oÀsk 0: f% nÙ found\n",
·¿ms
.
OuutLi¡
);

438 
	`fæush
(
¡dout
);

441 
	`fşo£
(
fd
);

442 
ouuts
.
zÏ¡
=ouuts.
z
[ouuts.
n
-1];

444 ià(
ouuts
.
n
<=0)

446 
	`´štf
("ERROR oÀsk 0:‚Øv®id†še found iÀf%s\n",
·¿ms
.
OuutLi¡
);

447 
	`fæush
(
¡dout
);

451 
·¿ms
.
GridSize
[1]=params.GridSize[2]=params.GridSize[0];

456 
	`MPI_Bÿ¡
(&
·¿ms
, (
·¿m_d©a
), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

457 
	`MPI_Bÿ¡
(&
š‹º®
, (
š‹º®_d©a
), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

458 
	`MPI_Bÿ¡
(&
ouuts
.
n
, (
ouut_d©a
), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

461 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/ReadWhiteNoise.c

27 
	~"pšocchio.h
"

32 #ifdeà
WHITENOISE


34 
	$»ad_wh™e_noi£
()

36 
dummy
,
Å1
,
Å2
,
Å3
,
£ed
,
Nš¶ªe
,
gz
,
lx
,
ly
,
lz
,
Task
,
i
;

37 
loÿl_x
,
loÿl_y
,
loÿl_z
,
ixx
,
iyy
,
izz
,
šdex
,
nxh®f
,
nyh®f
,
nzh®f
;

38 
size_t
 
¶ªesize
;

39 *
¶ªe
;

40 
kx
,
ky
,
kz
,
kxnÜm
,
kynÜm
,
kznÜm
,
k_squ¬ed
,
k_moduË
,
k_physiÿl
,
time
,
nÜm
,
d–
;

41 
ave
=0.0, 
v¬
=0.0, 
gave
, 
gv¬
;

42 
f’ame
[
BLENGTH
];

43 
FILE
 *
fe
;

44 
MPI_Stus
 
¡©us
;

46 
Nš¶ªe
=
MyGrids
[0].
GSglob®_x
 * MyGrids[0].
GSglob®_y
;

47 
¶ªesize
=
Nš¶ªe
 * ();

48 
¶ªe
=(*)
	`m®loc
(
¶ªesize
);

50 ià(!
ThisTask
)

52 
	`¡rıy
(
f’ame
,"WhiteNoise");

53 
fe
=
	`fİ’
(
f’ame
,"r");

54 ià(
fe
==0x0)

56 
	`´štf
("ERROR on Task 0: cannot find file WhiteNoise„equired by„ead_white_noise\n");

60 
	`ä—d
(&
dummy
, 1, (), 
fe
);

61 
	`ä—d
(&
Å1
, 1, (), 
fe
);

62 
	`ä—d
(&
Å2
, 1, (), 
fe
);

63 
	`ä—d
(&
Å3
, 1, (), 
fe
);

64 
	`ä—d
(&
£ed
, 1, (), 
fe
);

65 
	`ä—d
(&
dummy
, 1, (), 
fe
);

67 ià(
Å1
 !ğ
MyGrids
[0].
GSglob®_x
 || 
Å2
 !ğMyGrids[0].
GSglob®_y
 || 
Å3
 !ğMyGrids[0].
GSglob®_z
)

69 
	`´štf
("ERROR oÀTask 0: Wh™eNoi£ fha wrÚg dim’siÚs: %d %d %d\n",
Å1
,
Å2
,
Å3
);

74 
gz
=0; gz<
MyGrids
[0].
GSglob®_z
; gz++)

77 ià(!
ThisTask
)

79 
	`ä—d
(&
dummy
,1,(),
fe
);

80 ià(
dummy
 !ğ
¶ªesize
)

82 
	`´štf
("ERROR on Task 0: mis-matched„ecord size for file WhiteNoise, Iƒxpected %d but obtained %d\n",

83 ()
¶ªesize
, 
dummy
);

87 
	`ä—d
(
¶ªe
, 
Nš¶ªe
, (), 
fe
);

88 
	`ä—d
(&
dummy
,1,(),
fe
);

90 
	`´štf
("Task 0 ha »ad…ÏÃ %d\n",
gz
);

94 ià(
gz
>=
MyGrids
[0].
GS¡¬t_z
 && gz<MyGrids[0].GS¡¬t_z + MyGrids[0].
GSloÿl_z
)

95 
dummy
=
ThisTask
;

97 
dummy
=0;

100 
	`MPI_Reduû
(&
dummy
, &
Task
, 1, 
MPI_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

102 ià(!
ThisTask
)

104 
	`´štf
("Th¶ªwÈb¡Üed by Task %d\n",
Task
);

106 ià(
Task
)

107 
	`MPI_S’d
(
¶ªe
, 
¶ªesize
, 
MPI_BYTE
, 
Task
, 0, 
MPI_COMM_WORLD
);

110 
i
=0; i<
Nš¶ªe
; i++)

112 
ave
+=
¶ªe
[
i
];

113 
v¬
+=
¶ªe
[
i
]*plane[i];

115 
lz
=
gz
-
MyGrids
[0].
GS¡¬t_z
;

116 
ly
=0;†y<
MyGrids
[0].
GSloÿl_y
;†y++)

117 
lx
=0;†x<
MyGrids
[0].
GSloÿl_x
;†x++)

118 *(
rveùÜ_fá
[0] + 
lx
 + (
MyGrids
[0].
GSloÿl_x
 + MyGrids[0].
off
è* (
ly
 + 
lz
 * MyGrids[0].
GSloÿl_y
)) =

119 *(
¶ªe
 + 
lx
 + 
MyGrids
[0].
GSloÿl_x
 * 
ly
);

125 ià(
dummy
==
ThisTask
)

127 
	`MPI_Recv
(
¶ªe
, 
¶ªesize
, 
MPI_BYTE
, 0, 0, 
MPI_COMM_WORLD
, &
¡©us
);

128 
i
=0; i<
Nš¶ªe
; i++)

130 
ave
+=
¶ªe
[
i
];

131 
v¬
+=
¶ªe
[
i
]*plane[i];

133 
lz
=
gz
-
MyGrids
[0].
GS¡¬t_z
;

134 
ly
=0;†y<
MyGrids
[0].
GSloÿl_y
;†y++)

135 
lx
=0;†x<
MyGrids
[0].
GSloÿl_x
;†x++)

136 *(
rveùÜ_fá
[0] + 
lx
 + (
MyGrids
[0].
GSloÿl_x
 + MyGrids[0].
off
è* (
ly
 + 
lz
 * MyGrids[0].
GSloÿl_y
)) =

137 *(
¶ªe
 + 
lx
 + 
MyGrids
[0].
GSloÿl_x
 * 
ly
);

142 
	`MPI_Reduû
(&
ave
, &
gave
, 1, 
MPI_DOUBLE
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

143 
	`MPI_Reduû
(&
v¬
, &
gv¬
, 1, 
MPI_DOUBLE
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

144 ià(!
ThisTask
)

146 
gave
 /ğ()
MyGrids
[0].
GSglob®_x
*()MyGrids[0].
GSglob®_y
*()MyGrids[0].
GSglob®_z
;

147 
gv¬
 = 
	`sq¹
(gv¬/(()
MyGrids
[0].
GSglob®_x
*()MyGrids[0].
GSglob®_y
*()MyGrids[0].
GSglob®_z
));

148 
	`´štf
("Av”agªd v¬Ÿnû oàwh™noi£: %f, %f\n",
gave
,
gv¬
);

151 
	`ä“
(
¶ªe
);

154 ià(!
ThisTask
)

155 
	`´štf
("[%s]„—d_wh™e_noi£: s¹šg fá\n",
	`fd©e
());

157 
time
 = 
	`fÜw¬d_ŒªsfÜm
(0);

159 ià(!
ThisTask
)

160 
	`´štf
("[%s]„—d_wh™e_noi£: dÚfá, cputimğ%f\n",
	`fd©e
(),
time
);

162 
ıutime
.
fá
+=
time
;

167 
kxnÜm
 = 2.*
PI
/()
MyGrids
[0].
GSglob®_x
;

168 
kynÜm
 = 2.*
PI
/()
MyGrids
[0].
GSglob®_y
;

169 
kznÜm
 = 2.*
PI
/()
MyGrids
[0].
GSglob®_z
;

172 
nxh®f
 = 
MyGrids
[0].
GSglob®_x
/2;

173 
nyh®f
 = 
MyGrids
[0].
GSglob®_y
/2;

174 
nzh®f
 = 
MyGrids
[0].
GSglob®_z
/2;

176 
nÜm
 = 1.0/
	`pow
(
·¿ms
.
IÁ”P¬tDi¡
, 3.0);

178 
loÿl_z
 = 0;†oÿl_z < 
MyGrids
[0].
GSloÿl_k_z
;†ocal_z++)

180 
izz
 = 
loÿl_z
 + 
MyGrids
[0].
GS¡¬t_k_z
;

181 ià(
loÿl_z
 > 
nzh®f
)

182 
izz
 -ğ
MyGrids
[0].
GSglob®_z
;

183 
kz
 = 
kznÜm
*
izz
;

185 
loÿl_y
 = 0;†oÿl_y < 
MyGrids
[0].
GSloÿl_k_y
;†ocal_y++)

187 
iyy
 = 
loÿl_y
 + 
MyGrids
[0].
GS¡¬t_k_y
;

188 ià(
iyy
 > 
nyh®f
)

189 
iyy
 -ğ
MyGrids
[0].
GSglob®_y
;

190 
ky
 = 
kynÜm
*
iyy
;

192 
loÿl_x
 = 0;†oÿl_x <ğ
nxh®f
;†ocal_x++)

194 
ixx
 = 
loÿl_x
;

195 
kx
 = 
kxnÜm
*
ixx
;

197 
k_squ¬ed
 = 
kx
*kx + 
ky
*ky + 
kz
*kz;

198 
k_moduË
 = 
	`sq¹
(
k_squ¬ed
);

199 
k_physiÿl
 = 
k_moduË
 / 
·¿ms
.
IÁ”P¬tDi¡
;

202 
šdex
 = 1 + 2*
loÿl_x
 + (
MyGrids
[0].
GSglob®_x
+MyGrids[0].
off
)

203 *(
loÿl_z
 + 
loÿl_y
* 
MyGrids
[0].
GSglob®_z
);

205 ià(
k_squ¬ed
 > 0)

206 
d–
 = 
	`sq¹
(
nÜm
 * 
	`Pow”S³ùrum
(
k_physiÿl
) *

207 
	`exp
(-
	`pow
(
k_moduË
/
MyGrids
[0].
uµ”_k_cutoff
,16.0) ) );

209 
d–
 = 0.0;

211 (
cveùÜ_fá
[0][
šdex
/2])[0] *ğ
d–
;

212 (
cveùÜ_fá
[0][
šdex
/2])[1] *ğ
d–
;

218 
	`wr™e_äom_cveùÜ
(0,
kd’s™y
[0]);

222 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/allocations.c

27 
	~"pšocchio.h
"

31 
size_t
 
	gcubes_Üd”šg_memÜy
, 
	ggroup_memÜy
, 
	gäag_´ods_memÜy
, 
	gäag_memÜy
, 
	g´ods_memÜy
, 
	gfá_memÜy
,

32 
	g®l_memÜy
, 
	gfœ¡_®loÿ‹d_memÜy
, 
	gfmax_memÜy
, 
	gf›lds_memÜy
;

34 
	#ALIGN_MEMORY_BLOCK
(
M
è (Mè% 
ALIGN
 ) M++

	)

37 
	$®loÿ‹_maš_memÜy
()

104 
igrid
,
i
;

105 
size_t
 
memÜy
;

106 
	sm­
{

107 
lz
;

108 
oh
,
am
,
m1
,
m2
,
m3
,
m4
,
m5
,
m6
,
m7
,
m8
;

109 } 
mym­
;

110 
MPI_Stus
 
¡©us
;

111 #ifdeà
VERBOSE


112 
size_t
 *
bÿ¡
;

113 
bsize
, 
n
;

114 *
Ï¡
;

118 
cubes_Üd”šg_memÜy
 = 
NTasks
 * ();

119 
´ods_memÜy
 = 
MyGrids
[0].
tÙ®_loÿl_size
 * (
´oduù_d©a
);

120 
	`ALIGN_MEMORY_BLOCK
Ğ
´ods_memÜy
 );

122 
f›lds_memÜy
=0;

124 
igrid
 = 0; igrid < 
Ngrids
; igrid++)

126 
f›lds_memÜy
 +ğ
MyGrids
[
igrid
].
tÙ®_loÿl_size_fá
 * ();

127 
	`ALIGN_MEMORY_BLOCK
Ğ
f›lds_memÜy
 );

130 
igrid
 = 0; igrid < 
Ngrids
; igrid++)

132 
f›lds_memÜy
 +ğ6 * 
MyGrids
[
igrid
].
tÙ®_loÿl_size
 * ();

133 
	`ALIGN_MEMORY_BLOCK
Ğ
f›lds_memÜy
 );

136 #ifdeà
TWO_LPT


137 
f›lds_memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

138 
	`ALIGN_MEMORY_BLOCK
Ğ
f›lds_memÜy
 );

139 #ifdeà
THREE_LPT


140 
f›lds_memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

141 
	`ALIGN_MEMORY_BLOCK
Ğ
f›lds_memÜy
 );

142 
f›lds_memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

143 
	`ALIGN_MEMORY_BLOCK
Ğ
f›lds_memÜy
 );

147 
fœ¡_®loÿ‹d_memÜy
 = 
´ods_memÜy
 + 
f›lds_memÜy
;

150 
igrid
 = 0, 
fá_memÜy
 = 0; igrid < 
Ngrids
; igrid++)

152 
fá_memÜy
 +ğ
MyGrids
[
igrid
].
tÙ®_loÿl_size_fá
 * ();

153 
	`ALIGN_MEMORY_BLOCK
Ğ
fá_memÜy
 );

154 
fá_memÜy
 +ğ
MyGrids
[
igrid
].
tÙ®_loÿl_size_fá
 * ();

155 
	`ALIGN_MEMORY_BLOCK
Ğ
fá_memÜy
 );

158 
fmax_memÜy
 = 
fœ¡_®loÿ‹d_memÜy
 + 
fá_memÜy
;

162 
äag_´ods_memÜy
 = 
subbox
.
N·¹
 * (
´oduù_d©a
);

163 
group_memÜy
 = 
subbox
.
N·¹
 * 3 * () +

164 
subbox
.
N·¹
/10 * ((
group_d©a
è+ (
hi¡Ü›s_d©a
));

165 #ifdeà
PLC


166 
group_memÜy
 +ğ
¶c
.
Nmax
 * (
¶cgroup_d©a
);

169 #ifdeà
TEST_ONLY


170 
äag_´ods_memÜy
 = 0;

171 
group_memÜy
 = 0;

175 ià(
NSliûs
>1)

176 
äag_memÜy
 = 
´ods_memÜy
 + 
äag_´ods_memÜy
 + 
group_memÜy
;

178 
äag_memÜy
 = (
group_memÜy
 > 
´ods_memÜy
 ? group_memÜy :…rods_memÜyè+ 
äag_´ods_memÜy
;

180 #ifdeà
DO_NOT_REALLOC


182 ià(
äag_memÜy
 > 
fœ¡_®loÿ‹d_memÜy
)

183 
fœ¡_®loÿ‹d_memÜy
 = 
äag_memÜy
;

184 
®l_memÜy
 = 
fœ¡_®loÿ‹d_memÜy
 + 
fá_memÜy
;

189 
®l_memÜy
 = (
fmax_memÜy
 > 
äag_memÜy
? fmax_memory : frag_memory);

194 
mym­
.
lz
 = 
MyGrids
[0].
GSloÿl
[
_z_
];

195 
mym­
.
am
=()
®l_memÜy
/
MBYTE
;

197 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

199 
çùÜ
 = 1.0 / ()
MyGrids
[0].
tÙ®_loÿl_size
;

201 
mym­
.
oh
 = (è
subbox
.
N·¹
 * 
çùÜ
;

202 
mym­
.
m1
 = (è
´ods_memÜy
 * 
çùÜ
;

203 
mym­
.
m2
 = (è
f›lds_memÜy
 * 
çùÜ
;

204 
mym­
.
m3
 = (è
fá_memÜy
 * 
çùÜ
;

205 
mym­
.
m4
 = (è
fmax_memÜy
 * 
çùÜ
;

206 
mym­
.
m5
 = (è
äag_´ods_memÜy
* 
çùÜ
;

207 
mym­
.
m6
 = (è
group_memÜy
 * 
çùÜ
;

208 
mym­
.
m7
 = (è
äag_memÜy
 * 
çùÜ
;

209 
mym­
.
m8
 = (è
®l_memÜy
 * 
çùÜ
;

213 
mym­
.
oh
 = 0.0;

214 
mym­
.
m1
 = 0.0;

215 
mym­
.
m2
 = 0.0;

216 
mym­
.
m3
 = 0.0;

217 
mym­
.
m4
 = 0.0;

218 
mym­
.
m5
 = 0.0;

219 
mym­
.
m6
 = 0.0;

220 
mym­
.
m7
 = 0.0;

221 
mym­
.
m8
 = 0.0;

224 ià(!
ThisTask
)

226 
	`d´štf
(
VMSG
, 0, "\n");

227 
	`d´štf
(
VMSG
, 0, "Map of memory usage for‡ll MPIasks\n");

228 #ifdeà
DO_NOT_REALLOC


229 
	`d´štf
(
VMSG
, 0, " NB: here we‡void„eallocations\n");

231 
	`d´štf
(
VMSG
, 0, "Task N.…lanes mem(MB) overhead…roducts fields ffts fmax frag…r. groups fragmentotal bytes…er…article\n");

234 
i
=0; i<
NTasks
; i++)

236 ià(!
ThisTask
)

238 ià(
i
)

239 
	`MPI_Recv
((*)&
mym­
, (
m­
), 
MPI_BYTE
, 
i
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

240 
	`d´štf
(
VMSG
, 0, "%6d %6d %8.0f %6.1f "

243 
i
, 
mym­
.
lz
, mym­.
am
, mym­.
oh
,

244 
mym­
.
m1
, mym­.
m2
, mym­.
m3
, mym­.
m4
,

245 
mym­
.
m5
, mym­.
m6
, mym­.
m7
, mym­.
m8
);

248 ià(
ThisTask
==
i
)

249 
	`MPI_S’d
((*)&
mym­
, (
m­
), 
MPI_BYTE
, 0, 0, 
MPI_COMM_WORLD
);

252 ià(!
ThisTask
)

254 
	`d´štf
(
VMSG
, 0, "\n");

255 
	`fæush
(
¡dout
);

259 ià(()
®l_memÜy
/
MBYTE
 > 
·¿ms
.
MaxMem
)

261 
	`d´štf
(
VXERR
, 
ThisTask
, "ERROR onask %d:he„un„equires more memoryhanhe MaxMem value\n",ThisTask);

262 
	`fæush
(
¡dout
);

268 
maš_memÜy
=(*)
	`ÿÎoc
(
®l_memÜy
 + 
cubes_Üd”šg_memÜy
, ());

269 ià(
maš_memÜy
==0x0)

271 
	`d´štf
(
VXERR
, 
ThisTask
, "ERROR onask %d: I cannot‡llocate memory\n",ThisTask);

272 
	`fæush
(
¡dout
);

275 
	`ä“
(
maš_memÜy
);

278 
cubes_Üd”šg
 = (*)
	`ÿÎoc
(
NTasks
, ());

279 
maš_memÜy
=(*)
	`®igÃd_®loc
(32, 
fœ¡_®loÿ‹d_memÜy
 * ());

281 ià(
maš_memÜy
==0x0)

283 
	`d´štf
(
VXERR
, 
ThisTask
, "ERROR onaks %d: I cannot‡llocate memory‡fter first successful‡ttempt\n", ThisTask);

284 
	`fæush
(
¡dout
);

289 
´oduùs
 = (
´oduù_d©a
 *)
maš_memÜy
;

291 
memÜy
 = 
´ods_memÜy
;

293 
igrid
 = 0; igrid < 
Ngrids
; igrid++)

295 
kd’s™y
[
igrid
] = (*)(
maš_memÜy
 + 
memÜy
);

296 
memÜy
 +ğ
MyGrids
[
igrid
].
tÙ®_loÿl_size_fá
 * ();

297 
	`ALIGN_MEMORY_BLOCK
Ğ
memÜy
 );

300 
igrid
 = 0; igrid < 
Ngrids
; igrid++)

302 
i
 = 0; i < 6; i++)

304 
£cÚd_d”iv©ives
[
igrid
][
i
] = (*)(
maš_memÜy
 + 
memÜy
);

305 
memÜy
 +ğ
MyGrids
[
igrid
].
tÙ®_loÿl_size
 * ();

306 
	`ALIGN_MEMORY_BLOCK
Ğ
memÜy
 );

309 
i
 = 0; i < 3; i++)

310 
fœ¡_d”iv©ives
[
igrid
][
i
] = 
£cÚd_d”iv©ives
[igrid][i];

311 
d’s™y
[
igrid
] = 
£cÚd_d”iv©ives
[igrid][0];

314 #ifdeà
TWO_LPT


315 
kveùÜ_2LPT
 = (*)(
maš_memÜy
 + 
memÜy
);

316 
sourû_2LPT
 = 
kveùÜ_2LPT
;

317 
memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

318 
	`ALIGN_MEMORY_BLOCK
Ğ
memÜy
 );

320 #ifdeà
THREE_LPT


321 
kveùÜ_3LPT_1
 = (*)(
maš_memÜy
 + 
memÜy
);

322 
memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

323 
	`ALIGN_MEMORY_BLOCK
Ğ
memÜy
 );

325 
kveùÜ_3LPT_2
 = (*)(
maš_memÜy
 + 
memÜy
);

326 
memÜy
 +ğ
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

327 
	`ALIGN_MEMORY_BLOCK
Ğ
memÜy
 );

329 
sourû_3LPT_1
 = 
kveùÜ_3LPT_1
;

330 
sourû_3LPT_2
 = 
kveùÜ_3LPT_2
;

335 
igrid
 = 0; igrid < 
Ngrids
; igrid++)

337 
rveùÜ_fá
[
igrid
] = 
	`pfá_®loc_»®
(
MyGrids
[igrid].
tÙ®_loÿl_size_fá
);

338 
cveùÜ_fá
[
igrid
] = 
	`pfá_®loc_com¶ex
(
MyGrids
[igrid].
tÙ®_loÿl_size_fá
/2);

343 ià(
rveùÜ_fá
[
igrid
] =ğ0x0 || 
cveùÜ_fá
[igrid] == 0x0)

345 
	`d´štf
(
VXERR
, 
ThisTask
, "ERROR onaks %d: I cannot‡llocate memory for fft vectors\n", ThisTask);

346 
	`fæush
(
¡dout
);

351 ià(!
ThisTask
)

352 
	`d´štf
(
VXX
, 
ThisTask
, "[%s] MemÜy ha b“ÀsucûssfuÎy‡Îoÿ‹d\n",
	`fd©e
());

354 #ifdeà
VERBOSE


356 
Ï¡
 = 
maš_memÜy
+
fœ¡_®loÿ‹d_memÜy
;

358 #iâdeà
TWO_LPT


359 
bsize
 = 3+3*
Ngrids
;

361 
bsize
 = 4+3*
Ngrids
;

363 
bsize
 *= 2;

364 
bÿ¡
 = (
size_t
*)
	`m®loc
(
bsize
*(size_t));

366 
n
=0;

367 
bÿ¡
[
n
++] = (
size_t
)((*)
kd’s™y
[0]-(*)
´oduùs
);

369 
igrid
=1; igrid<
Ngrids
; igrid++)

370 
bÿ¡
[
n
++] = (
size_t
)((*)
kd’s™y
[
igrid
]-(*)kdensity[igrid-1]);

372 
bÿ¡
[
n
++] = (
size_t
)((*)
£cÚd_d”iv©ives
[0][0]-(*)
kd’s™y
[
Ngrids
-1]);

373 
igrid
=1; igrid<
Ngrids
; igrid++)

374 
bÿ¡
[
n
++] = (
size_t
)((*)
£cÚd_d”iv©ives
[
igrid
][0]-(*)second_derivatives[igrid-1][0]);

376 #ifdeà
TWO_LPT


377 
bÿ¡
[
n
++] = (
size_t
)((*)
kveùÜ_2LPT
-(*)
£cÚd_d”iv©ives
[
Ngrids
-1][0]);

380 
bÿ¡
[
n
++] = (
size_t
)(
Ï¡
-(*)
´oduùs
);

381 
bÿ¡
[
n
++] = 
fámemÜy
;

383 
bÿ¡
[
n
++] = 
´ods_memÜy
;

384 
igrid
=0; igrid<
Ngrids
; igrid++)

385 
bÿ¡
[
n
++] = 
MyGrids
[
igrid
].
tÙ®_loÿl_size_fá
 * ();

387 
igrid
=0; igrid<
Ngrids
; igrid++)

388 
bÿ¡
[
n
++] = 6*
MyGrids
[
igrid
].
tÙ®_loÿl_size
 * ();

390 #ifdeà
TWO_LPT


391 #iâdeà
THREE_LPT


392 
bÿ¡
[
n
++] = 
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

394 
bÿ¡
[
n
++] = 3*
MyGrids
[0].
tÙ®_loÿl_size_fá
 * ();

397 
igrid
=0; igrid<
Ngrids
; igrid++)

398 
bÿ¡
[
n
++] = 
MyGrids
[
igrid
].
GSglob®
[
_x_
] * MyGrids[igrid].GSglob®[
_y_
] * ();

400 
bÿ¡
[
n
++] = 
memÜy
;

401 
bÿ¡
[
n
++] = 
®lmemÜy
;

404 ià(!
ThisTask
)

406 
	`´štf
("Map of memory‡llocations for fmax (in byte):\n");

407 
	`´štf
(" TASK ");

408 
	`´štf
(" PRODUCTS");

409 
igrid
=0; igrid<
Ngrids
; igrid++)

410 
	`´štf
(" KDENS G.%d",
igrid
);

411 
igrid
=0; igrid<
Ngrids
; igrid++)

412 
	`´štf
(" DERIV G.%d",
igrid
);

413 #ifdeà
TWO_LPT


414 
	`´štf
(" KVEC 2LPT ");

415 #ifdeà
THREE_LPT


416 
	`´štf
(" KVEC 3LPT ");

419 
igrid
=0; igrid<
Ngrids
; igrid++)

420 
	`´štf
(" SEEDS G.%d ",
igrid
);

421 
	`´štf
(" MAIN MEMORY ");

422 
	`´štf
("- FFT VECTORS / REQ. MEMORY\n");

425 
i
=0; i<
NTasks
; i++)

428 ià(!
ThisTask
)

430 ià(
i
)

431 
s
=
	`MPI_Recv
((*)
bÿ¡
, 
bsize
*(
size_t
), 
MPI_BYTE
, 
i
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

432 
	`´štf
(" FOUND %5d",
i
);

433 
n
=0;‚<
bsize
/2;‚++)

434 
	`´štf
(" %12zu",
bÿ¡
[
n
]);

435 
	`´štf
("\n");

436 
	`´štf
(" PRED %5d",
i
);

437 
n
=
bsize
/2;‚<bsize;‚++)

438 
	`´štf
(" %12zu",
bÿ¡
[
n
]);

439 
	`´štf
("\n");

441 ià(
ThisTask
==
i
)

442 
s
=
	`MPI_S’d
((*)
bÿ¡
, 
bsize
*(
size_t
), 
MPI_BYTE
, 0, 0, 
MPI_COMM_WORLD
);

446 ià(!
ThisTask
)

448 
	`´štf
("\n");

449 
	`fæush
(
¡dout
);

452 
	`ä“
(
bÿ¡
);

457 
	}
}

460 
	$d—Îoÿ‹_fá_veùÜs
(
ThisGrid
)

463 
	`pfá_ä“
(
cveùÜ_fá
[
ThisGrid
]);

464 
	`pfá_ä“
(
rveùÜ_fá
[
ThisGrid
]);

467 
	}
}

469 
	$»®loÿ‹_memÜy_fÜ_äagm’tiÚ_1
()

472 
P»dN³aks
;

473 
size_t
 
memÜy
;

474 *
tmp
;

476 #ifdeà
VERBOSE


477 
size_t
 *
bÿ¡
;

478 
bsize
, 
s
, 
n
;

479 
MPI_Stus
 
¡©us
;

480 *
Ï¡
;

483 
kd’s™y
 =0x0;

484 
d’s™y
 =0x0;

485 
fœ¡_d”iv©ives
 =0x0;

486 
£cÚd_d”iv©ives
 =0x0;

490 #ifdeà
TWO_LPT


491 
kveùÜ_2LPT
 =0x0;

492 
sourû_2LPT
 =0x0;

493 #ifdeà
THREE_LPT


494 
kveùÜ_3LPT_1
 =0x0;

495 
sourû_3LPT_1
 =0x0;

496 
kveùÜ_3LPT_2
 =0x0;

497 
sourû_3LPT_2
 =0x0;

503 #iâdeà
DO_NOT_REALLOC


505 ià(
äag_memÜy
 > 
fœ¡_®loÿ‹d_memÜy
)

507 
tmp
=(*)
	`»®loc
(
maš_memÜy
,
äag_memÜy
);

508 ià(
tmp
!=0x0)

510 
maš_memÜy
=
tmp
;

511 
´oduùs
 = (
´oduù_d©a
 *)
maš_memÜy
;

512 ià(!
ThisTask
)

513 
	`´štf
("Task 0„—Îoÿ‹d memÜy fÜ %àGb\n",()
äag_memÜy
/
GBYTE
);

517 
	`´štf
("ERROR oÀsk %d: could‚Ù„—Îoÿ‹ memÜy from %zuØ%zu by‹s\n",
ThisTask
,

518 
fœ¡_®loÿ‹d_memÜy
, 
äag_memÜy
);

519 
	`fæush
(
¡dout
);

526 ià(
NSliûs
>1)

528 
äag
 = (
´oduù_d©a
 *)(
maš_memÜy
 + 
´ods_memÜy
);

529 
memÜy
=
´ods_memÜy
+
äag_´ods_memÜy
;

533 
äag
 = (
´oduù_d©a
 *)(
maš_memÜy
 + (
group_memÜy
 > 
´ods_memÜy
 ? group_memory :…rods_memory));

534 
memÜy
=0;

541 
P»dN³aks
=
subbox
.
N·¹
/10;

543 
šdiûs
 = (*)(
maš_memÜy
+
memÜy
);

544 
memÜy
 +ğ
subbox
.
N·¹
*();

545 
group_ID
 = (*)(
maš_memÜy
+
memÜy
);

546 
memÜy
 +ğ
subbox
.
N·¹
*();

547 
lškšg_li¡
 = (*)(
maš_memÜy
+
memÜy
);

548 
memÜy
 +ğ
subbox
.
N·¹
*();

549 
groups
 = (
group_d©a
 *)(
maš_memÜy
 + 
memÜy
);

550 
memÜy
 +ğ
P»dN³aks
*(
group_d©a
);

551 
wh”‘İÏû_myÿt
 = (*)(
maš_memÜy
 + 
memÜy
);

552 
memÜy
 +ğ
P»dN³aks
*(
hi¡Ü›s_d©a
);

553 #ifdeà
PLC


554 
¶cgroups
 = (
¶cgroup_d©a
 *)(
maš_memÜy
 + 
memÜy
);

555 
memÜy
 +ğ
¶c
.
Nmax
*(
¶cgroup_d©a
);

559 
	}
}

561 
	$»®loÿ‹_memÜy_fÜ_äagm’tiÚ_2
(
N³aks
)

563 
i
,
P»dN³aks
;

564 #ifdeà
VERBOSE


565 
size_t
 *
bÿ¡
;

566 
bsize
, 
s
, 
n
;

567 
MPI_Stus
 
¡©us
;

571 
P»dN³aks
=
subbox
.
N·¹
/10;

575 ià(
N³aks
+2 > 
P»dN³aks
)

577 
	`´štf
("ERROR onask %d: surprisingly,he‚umber of…eaks %dƒxceeds Npart/10 (%d)\n",

578 
ThisTask
,
N³aks
,
subbox
.
N·¹
/10);

579 
	`fæush
(
¡dout
);

583 ià(!
NSliûs
)

584 
´oduùs
=0x0;

587 
i
 = 0; i < 
subbox
.
N·¹
; i++)

588 *(
šdiûs
+
i
) = i;

590 
i
 = 0; i < 
subbox
.
N·¹
; i++)

591 *(
group_ID
+
i
) = 0;

593 
i
 = 0; i < 
subbox
.
N·¹
; i++)

594 *(
lškšg_li¡
 + 
i
)=0;

596 
i
 = 0; i < 
P»dN³aks
*(
group_d©a
); i++)

597 *((*)
groups
 + 
i
)=0;

599 
i
 = 0; i < 
P»dN³aks
*(
hi¡Ü›s_d©a
); i++)

600 *((*)
wh”‘İÏû_myÿt
 + 
i
)=0;

602 #ifdeà
PLC


603 
i
 = 0; i < 
¶c
.
Nmax
*(
¶cgroup_d©a
); i++)

604 *((*)
¶cgroups
 + 
i
)=0;

608 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/alternatives/GenIC_large.work.c

45 
	~"pšocchio.h
"

47 
	#GRID
 
MyGrids
[
ThisGrid
]

	)

49 
	#BOTTOM
 0

	)

50 
	#TOP
 1

	)

52 
	tm­_šdex
;

53 
	tm­_pošt
[2];

55 *
	gOLDSEEDTABLE
;

58 *
	gSEEDTABLE
;

59 *
	gSEED_k0
[2], *
	gSEED_x0
, *
	gSEED_y0
;

60 
m­_pošt
 
	gSEED_k0_BL
[2];

61 
	gSEED_k0_nx
[2];

62 
	gSEED_k0_ny
[2];

65 
g’”©e_£eds_¶ªe
(, 
m­_pošt
, map_point, , );

66 
quad¿Á
 (
m­_pošt
, );

67 
dump_£ed_¶ªe
 (, 
m­_pošt
, map_point, [3], , , );

71 
	$G’IC_Ïrge
(
ThisGrid
)

73 
Nmesh
, 
N§m¶e
, 
VeùÜL’gth
;

74 
C
[3], 
loÿl_n
[3], 
loÿl_¡¬t
[3];

75 
Box
, 
çc
;

77 
VeùÜL’gth
 = 
GRID
.
tÙ®_loÿl_size_fá
;

78 
Nmesh
 = 
GRID
.
GSglob®
[
_x_
];

79 
N§m¶e
 = 
GRID
.
GSglob®
[
_x_
];

80 
Box
 = 
GRID
.
BoxSize
;

82 
çc
 = 
	`pow
(1./
Box
,1.5);

85 
	`d´štf
(
VDIAG
, 
ThisTask
, "==== %d in k-space:: (%td, %td) - (%td, %td) - (%td, %td)\n",

86 
ThisTask
,

87 
GRID
.
GS¡¬t_k
[0], GRID.GS¡¬t_k[0] + GRID.
GSloÿl_k
[0],

88 
GRID
.
GS¡¬t_k
[1], GRID.GS¡¬t_k[1] + GRID.
GSloÿl_k
[1],

89 
GRID
.
GS¡¬t_k
[2], GRID.GS¡¬t_k[2] + GRID.
GSloÿl_k
[2]);

99 iàĞ!
·¿ms
.
u£_Œª¥o£d_fá
 )

101 
i
 = 0; i < 3; i++)

102 
C
[
i
] = i;

105 iàĞ
š‹º®
.
sks_subdivisiÚ_dim
 > 1 )

106 
C
[0] = 
_y_
, C[1] = 
_z_
, C[2] = 
_x_
;

108 
C
[0] = 
_y_
, C[1] = 
_x_
, C[2] = 
_z_
;

112 
i
 = 0; i< 3; i++)

114 
loÿl_n
 [
i
] = 
GRID
.
GSloÿl_k
[i];

115 
loÿl_¡¬t
[
i
] = 
GRID
.
GS¡¬t_k
[i];

121 
m­_pošt
 
bÙtom_Ëá
, 
tİ_right
;

122 
m­_pošt
 
¶ªe_bÙtom_Ëá
, 
¶ªe_tİ_right
;

124 
bÙtom_Ëá
[
_x_
] = 
GRID
.
GS¡¬t_k
[_x_];

125 
bÙtom_Ëá
[
_y_
] = 
GRID
.
GS¡¬t_k
[_y_];

127 
tİ_right
[
_x_
] = 
GRID
.
GS¡¬t_k
[_x_] + GRID.
GSloÿl_k
[_x_];

128 
tİ_right
[
_y_
] = 
GRID
.
GS¡¬t_k
[_y_] + GRID.
GSloÿl_k
[_y_];

130 ifĞ!
š‹º®
.
Ïrge_¶ªe
 )

132 
¶ªe_bÙtom_Ëá
[
_x_
] = 0;

133 
¶ªe_bÙtom_Ëá
[
_y_
] = 0;

135 
¶ªe_tİ_right
[
_x_
] = 
Nmesh
;

136 
¶ªe_tİ_right
[
_y_
] = 
Nmesh
;

140 
¶ªe_bÙtom_Ëá
[
_x_
] = 
bÙtom_Ëá
[_x_];

141 
¶ªe_bÙtom_Ëá
[
_y_
] = 
bÙtom_Ëá
[_y_];

142 
¶ªe_tİ_right
[
_x_
] = 
tİ_right
[_x_];

143 
¶ªe_tİ_right
[
_y_
] = 
tİ_right
[_y_];

146 
»t
 = 
	`g’”©e_£eds_¶ªe
(
ThisGrid
, 
¶ªe_bÙtom_Ëá
, 
¶ªe_tİ_right
, 
Nmesh
, (
loÿl_¡¬t
[
_z_
] == 0));

148 ifĞ
»t
 > 0 )

149  
»t
;

151 iàĞ
š‹º®
.
dump_£ed¶ªe
 )

154 iàĞ
·¿ms
.
u£_Œª¥o£d_fá
 && 
š‹º®
.
sks_subdivisiÚ_dim
 > 1 )

155 
C
[1] = 
_x_
;

156 
	`dump_£ed_¶ªe
(
ThisGrid
, 
bÙtom_Ëá
, 
tİ_right
, 
C
, 
loÿl_n
[
_x_
], 
GRID
.
GS¡¬t_k
[
_z_
], 
Nmesh
);

166 
	`mem£t
Ğ
kd’s™y
[
ThisGrid
], 0, 
VeùÜL’ght
 * () );

168 
Nmesh_2
, 
Nmesh_odd
;

169 
g¦_ºg
 *
k0_g’”©Ü
;

171 
Nmesh_2
 = 
Nmesh
 / 2;

172 
Nmesh_odd
 = (
Nmesh
 % 2);

177 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
·¿ms
.
RªdomS“d
);

181 
k0_g’”©Ü
 = 
	`g¦_ºg_®loc
(
g¦_ºg_¿Æxd1
);

187  
i
 = 0; i < 
loÿl_n
[
_x_
]; i++ )

191 
ii
 = 
loÿl_¡¬t
[
_x_
] + 
i
;

192 iàĞ
ii
 =ğ
Nmesh_2
 )

195 
kvec
[3];

197 iàĞ
ii
 < 
Nmesh_2
 )

198 
kvec
[0] = 
ii
 * 2 * 
PI
 / 
Box
;

200 
kvec
[0] = -(
Nmesh
 - 
ii
è* 2 * 
PI
 / 
Box
;

202 
kmag2_i
 = 
kvec
[0] * kvec[0];

203 
iii
 = 
ii
;

206 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

210 
jj
 = 
loÿl_¡¬t
[
_y_
] + 
j
;

211 if(
jj
 =ğ
Nmesh_2
)

213 
jjj
 = 
jj
;

215 if(
jj
 < 
Nmesh_2
)

216 
kvec
[1] = 
jj
 * 2 * 
PI
 / 
Box
;

218 
kvec
[1] = -(
Nmesh
 - 
jj
è* 2 * 
PI
 / 
Box
;

220 
kmag2_ij
 = 
kmag2_i
 + 
kvec
[1] * kvec[1];

222 
£ed
;

226 if(
š‹º®
.
Ïrge_¶ªe
)

228 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
SEEDTABLE
[
j
 * 
loÿl_n
[
_x_
] + 
i
]);

229 
£ed
 = 
SEEDTABLE
[
j
 * 
loÿl_n
[
_x_
] + 
i
];

233 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
SEEDTABLE
[
jj
 * 
Nmesh
 + 
ii
]);

234 
£ed
 = 
SEEDTABLE
[
jj
 * 
Nmesh
 + 
ii
];

242 
pha£
;

243 if(
loÿl_¡¬t
[
_z_
] > 0 &&†oÿl_¡¬t[_z_] < 
Nmesh_2
)

244 
RR
 = 0; RR < 
loÿl_¡¬t
[
_z_
]; RR++)

246 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

248 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

249 
pha£
 == 0);

253 
k
 = 0; (k < 
loÿl_n
[
_z_
]è&& (k+
loÿl_¡¬t
[_z_] < 
Nmesh_2
); k++)

256 
kk
 = 
loÿl_¡¬t
[
_z_
] + 
k
;

259 
pha£
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
è* 2 * 
PI
;

260 
am¶
;

262 
am¶
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

263 
am¶
 == 0);

266 if(
ii
 =ğ0 && 
jj
 =ğ0 && 
kk
 == 0)

268 if(
kk
 =ğ
Nmesh_2
)

271 if(
kk
 < 
Nmesh_2
)

272 
kvec
[2] = 
kk
 * 2 * 
PI
 / 
Box
;

274 
kvec
[2] = -(
Nmesh
 - 
kk
è* 2 * 
PI
 / 
Box
;

276 
kmag2_loÿl
 = 
kmag2_ij
 + 
kvec
[2] * kvec[2];

277 
kmag
 = 
	`sq¹
(
kmag2_loÿl
);

279 if(
kmag
 * 
Box
 / (2 * 
PI
è> 
NYQUIST
 * 
N§m¶e
 / 2)

282 
p_of_k
 = 
	`Pow”S³ùrum
(
kmag
);

284 
sign
 = 1.0;

285 
addr_j
 = 
j
;

288 ifĞ
kk
 == 0 )

292 ifĞ(
ii
 =ğ0è&& (
jj
 =ğ
Nmesh_2
 || jj =ğNmesh_2 + 
Nmesh_odd
) )

294 ifĞ(
ii
 =ğ
Nmesh_2
è|| (i˜=ğNmesh_2 + 
Nmesh_odd
) )

299 ifĞĞ
ii
 > 
Nmesh_2
 ) ||

300 Ğ
ii
 =ğ0 && 
jj
 > 
Nmesh
/2 ) )

303 
jjj
 = 
Nmesh
 -
jj
;

304 if(
jjj
 =ğ
Nmesh
)

305 
jjj
 = 0;

307 if(
Nmesh_odd
 && 
jj
 =ğ
Nmesh_2
+1)

309 
jjj
 = 
Nmesh_2
+1;

310 
addr_j
 = 
Nmesh_2
;

314 if(
ii
 > 
Nmesh_2
)

315 
iii
 = 
Nmesh
 - 
ii
;

319 if(
š‹º®
.
Ïrge_¶ªe
)

322 if(
jjj
 == 0)

329 
£ed
 = 
SEED_y0
[
loÿl_n
[
_x_
] - 
i
];

331 if(
iii
 == 0)

338 
£ed
 = 
SEED_x0
[
loÿl_n
[
_y_
] - 
j
];

342 
m­_pošt
 
V
;

343 
V
[
_x_
] = 
ii
;

344 
V
[
_y_
] = 
jj
;

345 
Q
 = 
	`quad¿Á
(
V
 , 
Nmesh
/2) / 2;

347 
£ed
 = 
SEED_k0
[
Q
][(
jjj
 - 
SEED_k0_BL
[Q][
_y_
]è* 
SEED_k0_nx
[Q] + (
iii
 - SEED_k0_BL[Q][
_x_
]) ];

353 
£ed
 = 
SEEDTABLE
[
jjj
 * 
Nmesh
 + 
iii
];

357 
sign
 = -1.0;

360 
	`g¦_ºg_£t
(
k0_g’”©Ü
, 
£ed
);

361 
pha£
 = 
	`g¦_ºg_unifÜm
(
k0_g’”©Ü
è* 2 * 
PI
;

363 
am¶
 = 
	`g¦_ºg_unifÜm
(
k0_g’”©Ü
);

364 
am¶
 == 0);

369 #iâdeà
NO_RANDOM_MODULES


370 
p_of_k
 *ğ-
	`log
(
am¶
);

372 
d–
 = 
çc
 * 
	`sq¹
(
p_of_k
);

374 
addr
;

377 if(!
·¿ms
.
u£_Œª¥o£d_fá
)

378 
addr
 = 2*((
i
 * 
loÿl_n
[
_y_
] + 
addr_j
è*†oÿl_n[
_z_
] + 
k
);

393 if(
š‹º®
.
sks_subdivisiÚ_dim
 > 1)

394 
addr
 = 2*((
addr_j
 * 
loÿl_n
[
_z_
] + 
k
è*†oÿl_n[
_x_
] + 
i
);

396 
addr
 = 2*((
addr_j
 * 
loÿl_n
[
_x_
] + 
i
è*†oÿl_n[
_z_
] + 
k
);

399 
kd’s™y
[
ThisGrid
][
addr
 ] = 
d–
 * 
	`cos
(
pha£
);

400 
kd’s™y
[
ThisGrid
][
addr
 + 1] = 
sign
 * 
d–
 * 
	`sš
(
pha£
);

407 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

409 
	`g¦_ºg_ä“
(
k0_g’”©Ü
);

411 if(
SEED_k0
[0] !ğ
NULL
)

412 
	`ä“
(
SEED_k0
[0]);

413 if(
SEED_k0
[1] !ğ
NULL
)

414 
	`ä“
(
SEED_k0
[1]);

415 if(
SEED_y0
 !ğ
NULL
)

416 
	`ä“
(
SEED_y0
);

417 if(
SEED_x0
 !ğ
NULL
)

418 
	`ä“
(
SEED_x0
);

419 
	`ä“
(
SEEDTABLE
);

424 
çc
=
	`pow
(()
Nmesh
, 3.0);

425 
myVeùÜL’gth
 = 
VeùÜL’gth
 - VectorLength % 8;

426 
i
;

427 
i
 = 0; i < 
myVeùÜL’gth
; i += 8)

429 
kd’s™y
[
ThisGrid
][
i
 ] *ğ
çc
;

430 
kd’s™y
[
ThisGrid
][
i
+1] *ğ
çc
;

431 
kd’s™y
[
ThisGrid
][
i
+2] *ğ
çc
;

432 
kd’s™y
[
ThisGrid
][
i
+3] *ğ
çc
;

433 
kd’s™y
[
ThisGrid
][
i
+4] *ğ
çc
;

434 
kd’s™y
[
ThisGrid
][
i
+5] *ğ
çc
;

435 
kd’s™y
[
ThisGrid
][
i
+6] *ğ
çc
;

436 
kd’s™y
[
ThisGrid
][
i
+7] *ğ
çc
;

438  ; 
i
 < 
VeùÜL’gth
; i++)

439 
kd’s™y
[
ThisGrid
][
i
] *ğ
çc
;

445 if(
š‹º®
.
dump_kd’s™y
)

446 
	`dump_cveùÜ
(
kd’s™y
[
ThisGrid
],

447 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
,

448 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

449 
MyGrids
[
ThisGrid
].
GSloÿl_k
,

450 
MyGrids
[
ThisGrid
].
GS¡¬t_k
, "my.dkdensity", 0);

454 
	}
}

460 
	#max
(
x
,
y
è((xè> (yè? (xè: (y))

	)

462 
	#BL
 0

463 
	#TR
 1

464 

	)

465 
symm‘ry
 (
m­_pošt
 *, map_point *, );

466 
m­_šdex
 
g‘_m­
 (
m­_pošt
);

467 
cmp_m­_pošts
 (const *, const *);

468 
g’”©e_£eds_sub»giÚ
 (
m­_pošt
, m­_pošt, 
ušt
, ušˆ**, ušt, 
m­_šdex
 *);

469 
Œª¥o£_sub»giÚ
 (, 
ušt
, 
m­_pošt
 *, map_point *);

470 
g‘_¶ªe_sub»giÚs
 (
ušt
, 
m­_pošt
, map_point, map_point [4][2], uint [4], uint[4]);

471 
cİy_£eds_sub»giÚ
 (
m­_pošt
, m­_pošt, 
ušt
 *, uint, uint);

476 
	$g’”©e_£eds_¶ªe
(
ThisGrid
, 
m­_pošt
 
bÙtom_Ëá
, m­_pošˆ
tİ_right
, 
Nmesh
, 
k0symm‘r›s
)

487 if(
š‹º®
.
mimic_Üigš®_£edbË
)

490 
OLDSEEDTABLE
 = (*è
	`ÿÎoc
Ğ
GRID
.
GSglob®
[
_x_
] * GRID.GSglob®[
_y_
], ());

492 ifĞ!
š‹º®
.
Ïrge_¶ªe
 )

493 
SEEDTABLE
 = 
OLDSEEDTABLE
;

495 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
·¿ms
.
RªdomS“d
);

497 
i
 = 0; i < 
Nmesh
 / 2; i++)

502 
j
 = 0; j < 
i
 ; j++)

503 
OLDSEEDTABLE
[
j
 * 
Nmesh
 + 
i
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

505 
j
 = 0; j < 
i
 + 1; j++)

506 
OLDSEEDTABLE
[
i
 * 
Nmesh
 + 
j
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

509 
j
 = 0; j < 
i
; j++)

510 
OLDSEEDTABLE
[
j
 * 
Nmesh
 + (Nmesh - 1 - 
i
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

512 
j
 = 0; j < 
i
 + 1; j++)

513 
OLDSEEDTABLE
[
i
 * 
Nmesh
 + (Nmesh - 1 - 
j
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

517 
j
 = 0; j < 
i
; j++)

518 
OLDSEEDTABLE
[(
Nmesh
 - 1 - 
j
è* Nmesh + 
i
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

520 
j
 = 0; j < 
i
 + 1; j++)

521 
OLDSEEDTABLE
[(
Nmesh
 - 1 - 
i
è* Nmesh + 
j
] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

525 
j
 = 0; j < 
i
; j++)

526 
OLDSEEDTABLE
[(
Nmesh
 - 1 - 
j
è* Nmesh + (Nmesh - 1 - 
i
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

528 
j
 = 0; j < 
i
 + 1; j++)

529 
OLDSEEDTABLE
[(
Nmesh
 - 1 - 
i
è* Nmesh + (Nmesh - 1 - 
j
)] = 0x7ffffffà* 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

535 ifĞ(!
š‹º®
.
Ïrge_¶ªe
è&& iÁ”Çl.
mimic_Üigš®_£edbË
 )

549 
N_sub»giÚs
;

550 
m­_šdex
 
”rÜ
;

551 
m­_pošt
 
sub»giÚs
[4][2] = { {{0, 0}, {0, 0}}, {{0, 0}, {0, 0}} };

552 
ušt
 
sub»giÚs_off£ts
[4] = {0 ,0, 0, 0}, 
sub»giÚs_¡¬ts
[4] = {0, 0, 0, 0};

557 
N_sub»giÚs
 = 
	`g‘_¶ªe_sub»giÚs
(
Nmesh
, 
bÙtom_Ëá
, 
tİ_right
, 
sub»giÚs
, 
sub»giÚs_off£ts
, 
sub»giÚs_¡¬ts
);

558 
	`d´štf
(
VDIAG
, 
ThisTask
, "Task %d: sub»giÚ dÚe\n", ThisTask); 
	`fæush
(
¡dout
);

563 if(
š‹º®
.
v”bo£_Ëv–
 > 
VDIAG
)

564 
T
 = 0; T < 
NTasks
; T++)

566 ifĞ
ThisTask
 =ğ
T
 )

567 
i
 = 0; i < 
N_sub»giÚs
; i++)

569 
	`d´štf
(
VDIAG
, 
ThisTask
, "\ttask: %3d\n"

572 "\t\tReg %d: st/off: %u, %u\À", 
ThisTask
,

573 
i
, 
sub»giÚs
[i][
BL
][0], sub»giÚs[i][BL][1], i, sub»giÚs[i][
TR
][0], subregions[i][TR][1],

574 
i
, 
sub»giÚs_¡¬ts
[i], 
sub»giÚs_off£ts
[i]);

577 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

591 
ušt
 
y¡ride
, *
¡¬t_poš‹r
;

592 
m­_šdex
 
Npošts
;

596 
y¡ride
 = 
sub»giÚs
[
N_sub»giÚs
-1][
TR
][
_y_
] - sub»giÚs[0][
BL
][_y_];

599 
Npošts
 = 
y¡ride
 * (
sub»giÚs
[
N_sub»giÚs
-1][
TR
][
_x_
] - sub»giÚs[0][
BL
][_x_]);

603 ifĞĞ
SEEDTABLE
 = 
	`ÿÎoc
Ğ(
ušt
), (
size_t
)
Npošts
èè=ğ
NULL
 )

605 
	`d´štf
(
VXERR
, 
ThisTask
, "UÇbËØ®loÿ‹ %Îd by‹s\n", 
Npošts
 * (
ušt
));

609 ifĞ
š‹º®
.
mimic_Üigš®_£edbË
 )

612 
i
 = 0; i < 
N_sub»giÚs
; i++)

614 
¡¬t_poš‹r
 = &(
SEEDTABLE
[
sub»giÚs_¡¬ts
[
i
]]);

615 
	`d´štf
(
VDBG
, 
ThisTask
, "\t\t cccask %d copying seed in„egion %d "

617 
ThisTask
, 
i
, 
sub»giÚs
[i][
BOTTOM
][
_x_
], sub»giÚs[i][BOTTOM][
_y_
],

618 
sub»giÚs
[
i
][
TOP
][
_x_
], sub»giÚs[i][TOP][
_y_
], 
sub»giÚs_¡¬ts
[i], 
sub»giÚs_off£ts
[i]);

620 
	`cİy_£eds_sub»giÚ
(
sub»giÚs
[
i
][
BOTTOM
], sub»giÚs[i][
TOP
], 
¡¬t_poš‹r
, 
Nmesh
, 
sub»giÚs_off£ts
[i]);

623  
i
 = 0; i < 
N_sub»giÚs
; i++ )

626 
m­_pošt
 
Œª¥o£d_sub»giÚ
[2];

628 
Œª¥o£d_sub»giÚ
[
BOTTOM
][
_x_
] = 
sub»giÚs
[
i
][BOTTOM][_x_];

629 
Œª¥o£d_sub»giÚ
[
BOTTOM
][
_y_
] = 
sub»giÚs
[
i
][BOTTOM][_y_];

630 
Œª¥o£d_sub»giÚ
[
TOP
][
_x_
] = 
sub»giÚs
[
i
][TOP][_x_];

631 
Œª¥o£d_sub»giÚ
[
TOP
][
_y_
] = 
sub»giÚs
[
i
][TOP][_y_];

634 
	`Œª¥o£_sub»giÚ
(0, 
Nmesh
, &
Œª¥o£d_sub»giÚ
[0], &transposed_subregion[1]);

636 
¡¬t_poš‹r
 = &
SEEDTABLE
[
sub»giÚs_¡¬ts
[
i
]];

639 
	`g’”©e_£eds_sub»giÚ
(
Œª¥o£d_sub»giÚ
[0],ransposed_subregion[1],

640 
·¿ms
.
RªdomS“d
, &
¡¬t_poš‹r
, 
sub»giÚs_off£ts
[
i
], &
”rÜ
);

645 
	`d´štf
(
VDIAG
, 
ThisTask
, "Task %d: s“d g’”©ed\n", ThisTask); 
	`fæush
(
¡dout
);

660 if(
š‹º®
.
Ïrge_¶ªe
 && 
k0symm‘r›s
)

682 
m­_pošt
 
SBL
, 
STR
;

683 
Np
;

686 
i
 = 0; i < 
N_sub»giÚs
; i++)

688 
Q
 = 
	`quad¿Á
(
sub»giÚs
[
i
][0], 
Nmesh
/2);

689 
SEED_k0_šdex
 = 
Q
 / 2;

691 if(
Q
 > 0)

693 
Q
)

698 if(
sub»giÚs
[
i
][
BOTTOM
][
_y_
] == 0)

702 
SBL
[
_y_
] = 0, SBL[
_x_
] = 
Nmesh
 - 
sub»giÚs
[
i
][
TOP
][_x_];

703 
STR
[
_y_
] = 1, STR[
_x_
] = 
Nmesh
 - 
sub»giÚs
[
i
][
BOTTOM
][_x_] + 1;

706 
Np
 = 
STR
[
_x_
] - 
SBL
[_x_];

709 
SEED_y0
 = (*)
	`m®loc
((è* 
Np
);

711 if(!
š‹º®
.
mimic_Üigš®_£edbË
)

714 
	`Œª¥o£_sub»giÚ
(0, 
Nmesh
, &
SBL
, &
STR
);

716 
	`g’”©e_£eds_sub»giÚ
(
SBL
, 
STR
, 
·¿ms
.
RªdomS“d
, &
SEED_y0
, 0, 0);

719 
	`cİy_£eds_sub»giÚ
(
SBL
, 
STR
, 
SEED_y0
, 
Nmesh
, 0);

732 
SBL
[
_x_
] = 
sub»giÚs
[
i
][
BOTTOM
][_x_], SBL[
_y_
] = subregions[i][BOTTOM][_y_];

733 
STR
[
_x_
] = 
sub»giÚs
[
i
][
TOP
 ][_x_], STR[
_y_
] = subregions[i][TOP ][_y_];

736 
	`symm‘ry
(&
SBL
, &
STR
, 
Nmesh
);

737 
SEED_k0_BL
[
SEED_k0_šdex
][
_x_
] = 
STR
[_x_], SEED_k0_BL[SEED_k0_šdex][
_y_
] = STR[_y_];

738 
SEED_k0_nx
[
SEED_k0_šdex
] = 
SBL
[
_x_
] - 
STR
[_x_];

739 
SEED_k0_ny
[
SEED_k0_šdex
] = 
SBL
[
_y_
] - 
STR
[_y_];

744 if(!
š‹º®
.
mimic_Üigš®_£edbË
)

745 
	`Œª¥o£_sub»giÚ
(0, 
Nmesh
, &
STR
, &
SBL
);

748 
Np
 = (
SBL
[
_x_
] - 
STR
[_x_]è* (SBL[
_y_
] - STR[_y_]);

751 
SEED_k0
[
SEED_k0_šdex
] = (*)
	`m®loc
((è* 
Np
);

753 if(
š‹º®
.
mimic_Üigš®_£edbË
)

754 
	`cİy_£eds_sub»giÚ
(
STR
, 
SBL
, 
SEED_k0
[
SEED_k0_šdex
], 
Nmesh
, 0);

757 
	`g’”©e_£eds_sub»giÚ
(
STR
, 
SBL
, 
·¿ms
.
RªdomS“d
, &
SEED_k0
[
SEED_k0_šdex
], 0, 0);

762 if(
sub»giÚs
[
i
][
BOTTOM
][
_x_
] == 0)

766 
SBL
[
_x_
] = 0, SBL[
_y_
] = 
Nmesh
 - 
sub»giÚs
[
i
][
TOP
][_y_];

767 
STR
[
_x_
] = 1, STR[
_y_
] = 
Nmesh
 - 
sub»giÚs
[
i
][
BOTTOM
][_y_] + 1;

770 
Np
 = 
STR
[
_y_
] - 
SBL
[_y_];

773 
SEED_x0
 = (*)
	`m®loc
((è* 
Np
);

775 if(!
š‹º®
.
mimic_Üigš®_£edbË
)

778 
	`Œª¥o£_sub»giÚ
(0, 
Nmesh
, &
SBL
, &
STR
);

780 
	`g’”©e_£eds_sub»giÚ
(
SBL
, 
STR
, 
·¿ms
.
RªdomS“d
, &
SEED_x0
, 0, 0);

783 
	`cİy_£eds_sub»giÚ
(
SBL
, 
STR
, 
SEED_x0
, 
Nmesh
, 0);

798 
	`d´štf
(
VDIAG
, 
ThisTask
, "Task %d: symm‘r› g’”©ed\n", ThisTask); 
	`fæush
(
¡dout
);

801 
	}
}

806 
	$symm‘ry
(
m­_pošt
 *
bÙtom_Ëá
, m­_pošˆ*
tİ_right
, 
N
)

808 
i
 = 0; i < 2; i++)

812 (*
bÙtom_Ëá
)[
i
] = 
	`abs
(
N
 - (*bottom_left)[i]) + 1;

813 (*
tİ_right
)[
i
] = 
	`abs
(
N
 - (*top_right)[i] + 1);

818 
	}
}

823 
	$quad¿Á
(
m­_pošt
 
P
, 
N_2
)

825 
Q
;

826 
Q
 = (
P
[0] >ğ
N_2
);

827 
Q
 +ğ(
P
[1] >ğ
N_2
) * 2;

828  
Q
;

829 
	}
}

834 
m­_šdex
 
	$g‘_m­
(
m­_pošt
 
P
)

837 
m­_šdex
 
l
, 
d
;

838 
ušt
 
mx
, 
my
, 
c
;

840 
mx
 = 
	`abs
(
P
[
_x_
]);

841 
my
 = 
	`abs
(
P
[
_y_
]);

842 
l
 = 2 * 
	`max
(
mx
, 
my
);

844 
c
 = (
P
[
_y_
] > P[
_x_
]) + (P[_x_] > 0)*(P[_x_] == P[_y_]);

846 
d
 = (
c
è? 
l
 * 3 + 
P
[
_x_
] + P[
_y_
] :† - P[_x_] - P[_y_];

848  (
l
-1)*Ö-1è+ 
d
;

849 
	}
}

852 
m­_šdex
 *
	gm­
;

855 
	$cmp_m­_pošts
(cÚ¡ *
A
, cÚ¡ *
B
)

860 
m­_šdex
 
a
 = 
m­
[*(
ušt
*)
A
];

861 
m­_šdex
 
b
 = 
m­
[*(
ušt
*)
B
];

863  (
a
 - 
b
);

864 
	}
}

869 
	$g’”©e_£eds_sub»giÚ
(
m­_pošt
 
bÙtom_Ëá
, m­_pošˆ
tİ_right
, 
ušt
 
£ed
, ušˆ**
£ed_¶ªe
, ušˆ
off£t
, 
m­_šdex
 *
v®ue
)

881 
m­_šdex
 
N
, 
ºd_couÁ”
, 
Nút
;

882 
m­_pošt
 
p
;

883 
ušt
 
xËngth
, 
yËngth
;

884 
ušt
 *
idxs
;

887 
xËngth
 = 
tİ_right
[
_x_
] - 
bÙtom_Ëá
[_x_];

888 
yËngth
 = 
tİ_right
[
_y_
] - 
bÙtom_Ëá
[_y_];

889 
N
 = 
xËngth
 * 
yËngth
;

895 if(*
£ed_¶ªe
 =ğ
NULL
)

897 if((*
£ed_¶ªe
 = 
	`ÿÎoc
Ğ(
size_t
)
N
, (
ušt
è)è=ğ
NULL
)

899 if(
v®ue
 !ğ
NULL
)

900 *
v®ue
 = 
N
 * (
ušt
);

903 
off£t
 = 0;

907 if((
m­
 = 
	`ÿÎoc
Ğ(
size_t
)
N
, (
m­_šdex
è)è=ğ
NULL
)

909 if(
v®ue
 !ğ
NULL
)

910 *
v®ue
 = 
N
 * (
m­_šdex
);

916 if((
idxs
 = 
	`ÿÎoc
Ğ(
size_t
)
N
, (
ušt
è)è=ğ
NULL
)

918 if(
v®ue
 !ğ
NULL
)

919 *
v®ue
 = 
N
 * (
ušt
);

928 
i
 = 0; i < 
N
; i++)

929 
idxs
[
i
] = i;

932 
j
 = 0; j < 
yËngth
; j++)

934 
p
[
_y_
] = 
bÙtom_Ëá
[_y_]+
j
;

936 
j_off£t
 = 
j
*
xËngth
;

937 
i
 = 0; i < 
xËngth
; i++)

939 
p
[
_x_
] = 
bÙtom_Ëá
[_x_]+
i
;

940 
m­
[
j_off£t
 + 
i
] = 
	`g‘_m­
(
p
);

945 
	`qsÜt
(
idxs
, (
size_t
)
N
, (
ušt
), 
cmp_m­_pošts
);

950 
g¦_ºg
 *
R
;

952 
R
 = 
	`g¦_ºg_®loc
(
g¦_ºg_mt19937
);

953 
	`g¦_ºg_£t
(
R
, 
£ed
);

956 
ºd_couÁ”
 = 0;

957 
Nút
 = 0;

958 
i
 = 0; i < 
N
; i++)

960 if(
ºd_couÁ”
 < 
m­
[
idxs
[
i
]]-1)

961 ; 
ºd_couÁ”
 < 
m­
[
idxs
[
i
]]-1;„nd_counter++)

962 
	`g¦_ºg_g‘
(
R
);

964 
m­
[
idxs
[
i
]] = (
m­_šdex
)
	`g¦_ºg_g‘
(
R
);

965 
Nút
++;

966 
ºd_couÁ”
++;

969 
	`g¦_ºg_ä“
(
R
);

971 
	`ä“
(
idxs
);

974 
ušt
 
k
 = 0, 
j
 = 0; j < 
N
; j++)

976 if((
k
 > 0è&& (
j
 % 
xËngth
 == 0))

977 
k
 +ğ
off£t
;

978 (*
£ed_¶ªe
)[
k
++] = (
ušt
)
m­
[
j
];

981 
	`ä“
(
m­
);

982 
m­
 = 0x0;

984 
	}
}

989 
	$cİy_£eds_sub»giÚ
(
m­_pošt
 
bÙtom_Ëá
, m­_pošˆ
tİ_right
, 
ušt
 *
£ed_¶ªe
, ušˆ
Nmesh
, ušˆ
off£t
)

991 
jdim
, 
idim
;

993 if((
idim
 = 
tİ_right
[
_x_
] - 
bÙtom_Ëá
[_x_]) == 0)

994 
idim
 = 1;

995 if((
jdim
 = 
tİ_right
[
_y_
] - 
bÙtom_Ëá
[_y_]) == 0)

996 
jdim
 = 1;

998 
k
 = 0, 
j
 = 
bÙtom_Ëá
[
_y_
]; j < 
tİ_right
[_y_]; j++)

1000 
i
 = 
bÙtom_Ëá
[
_x_
] ; i < 
tİ_right
[_x_]; i++)

1001 
£ed_¶ªe
[
k
++] = 
OLDSEEDTABLE
[
j
*
Nmesh
 + 
i
];

1003 
k
 +ğ
off£t
;

1007 
	}
}

1011 
	$Œª¥o£_sub»giÚ
(
mode
, 
ušt
 
N
, 
m­_pošt
 *
bÙtom_Ëá
, m­_pošˆ*
tİ_right
)

1014 
ušt
 
N_2
 = 
N
/2;

1016 
m­_pošt
 
cİy_1
 = {(*
bÙtom_Ëá
)[0], (*bottom_left)[1]};

1017 
m­_pošt
 
cİy_2
 = {(*
tİ_right
)[0], (*top_right)[1]};

1021 if(
mode
 == 0)

1024 if((*
bÙtom_Ëá
)[
_x_
] >ğ
N_2
)

1026 (*
bÙtom_Ëá
)[
_x_
] = (*bÙtom_Ëá)[_x_] - 
N
;

1027 (*
tİ_right
)[
_x_
] = (*tİ_right)[_x_] - 
N
;

1030 if((*
bÙtom_Ëá
)[
_y_
] >ğ
N_2
)

1032 (*
bÙtom_Ëá
)[
_y_
] = (*bÙtom_Ëá)[_y_] - 
N
;

1033 (*
tİ_right
)[
_y_
] = (*tİ_right)[_y_] - 
N
;

1039 if((*
bÙtom_Ëá
)[
_x_
] < 0)

1041 (*
bÙtom_Ëá
)[
_x_
] = 
N
 + (*bottom_left)[_x_];

1042 (*
tİ_right
)[
_x_
] = 
N
 + (*top_right)[_x_];

1045 if((*
bÙtom_Ëá
)[
_y_
] < 0)

1047 (*
bÙtom_Ëá
)[
_y_
] = 
N
 + (*bottom_left)[_y_];

1048 (*
tİ_right
)[
_y_
] = 
N
 + (*top_right)[_y_];

1052 
	`d´štf
(
VDIAG
, 
ThisTask
, "\t\t Task %d:„egion [%d, %d] -> "

1054 
ThisTask
, 
cİy_1
[0], cİy_1[1], 
cİy_2
[0], copy_2[1],

1055 (*
bÙtom_Ëá
)[0], (*bÙtom_Ëá)[1], (*
tİ_right
)[0], (*top_right)[1]);

1057 
	}
}

1062 
	$g‘_¶ªe_sub»giÚs
(
ušt
 
Nmesh
, 
m­_pošt
 
bÙtom_Ëá
, m­_pošˆ
tİ_right
, m­_pošˆ
RegiÚs
[4][2], ušˆ
Off£ts
[4], ušˆ
S¹s
[4])

1064 
	#NCOORDS
 2

	)

1066 
c
[
NCOORDS
] = {0, 1};

1067 
ušt
 
Nmesh_2
 = 
Nmesh
/2;

1068 
N»giÚs
 = 1;

1071 
i
 = 0; i < 
NCOORDS
; i++)

1073 
RegiÚs
[0][
BL
][
i
] = 
bÙtom_Ëá
[i];

1074 if(
bÙtom_Ëá
[
i
] > 
Nmesh
)

1078 
i
 = 0; i < 
NCOORDS
; i++)

1080 
RegiÚs
[0][
TR
][
i
] = 
tİ_right
[i];

1081 if(
tİ_right
[
i
] > 
Nmesh
)

1085 
i
 = 0; i < 4; i++)

1086 
Off£ts
[
i
] = 0, 
S¹s
[i] = 0;

1093 
xËn
 = 
tİ_right
[
_x_
] - 
bÙtom_Ëá
[_x_];

1095 
k
 = 0; k < 
NCOORDS
; k++)

1097 
m
 = 1;

1100 
R
 = 
N»giÚs
-1; R >= 0; R--)

1103 if(
RegiÚs
[
R
][
BL
][
c
[
k
]] < 
Nmesh_2
 &&

1104 
RegiÚs
[
R
][
TR
][
c
[
k
]] > 
Nmesh_2
)

1106 
j
 = 
N»giÚs
 + 
R
;

1108 
i
 = 0; i < 
NCOORDS
; i++)

1109 
RegiÚs
[
j
][
BL
][
c
[
i
]] = RegiÚs[
R
][BL][c[i]];

1110 
RegiÚs
[
j
][
BL
][
c
[
k
]] = 
Nmesh_2
;

1112 
i
 = 0; i < 
NCOORDS
; i++)

1113 
RegiÚs
[
j
][
TR
][
c
[
i
]] = RegiÚs[
R
][TR][c[i]];

1114 
RegiÚs
[
R
][
TR
][
c
[
k
]] = 
Nmesh_2
;

1116 if(
k
 == 0)

1118 
Off£ts
[
j
] = 
Nmesh_2
 - 
RegiÚs
[
R
][
BL
][
c
[
k
]];

1119 
Off£ts
[
R
] = 
RegiÚs
[
j
][
TR
][
c
[
k
]] - 
Nmesh_2
;

1122 
Off£ts
[
j
] = Off£ts[
R
];

1124 
S¹s
[
j
] = (
RegiÚs
[j][
BL
][
c
[
_y_
]] - 
bÙtom_Ëá
[_y_]è* 
xËn
 +

1125 (
RegiÚs
[
j
][
BL
][
c
[
_x_
]] - 
bÙtom_Ëá
[_x_]);

1127 
m
 = 2;

1130 
N»giÚs
 *ğ
m
;

1134  
N»giÚs
;

1135 
	}
}

1138 
	$dump_£ed_¶ªe
(
ThisGrid
, 
m­_pošt
 
bÙtom_Ëá
, m­_pošˆ
tİ_right
, 
C
[3], 
n_x
, 
z0
, 
Nmesh
)

1144 
bufãr
[400];

1146 
	`¥rštf
(
bufãr
, "£ed¶ªe_·¹Ÿl_%d", 
ThisTask
);

1147 
	`d´štf
(
VDIAG
, 
ThisTask
, "\t\tTask %d writing seedplane: %d, %d -> %d, %d\n", ThisTask,

1148 
bÙtom_Ëá
[
_x_
], bÙtom_Ëá[
_y_
], 
tİ_right
[_x_],op_right[_y_]);

1151 
‰
 = 0;ˆ< 
NTasks
;t++)

1153 ifĞ
ThisTask
 =ğ
‰
)

1155 ifĞ
z0
 == 0)

1159 
FILE
 *
fe
 = 
	`fİ’
(
bufãr
, "w");

1160 
k
, 
off£t
;

1162 if(
š‹º®
.
Ïrge_¶ªe
 == 0)

1164 
k
 = 
bÙtom_Ëá
[
_y_
] * 
Nmesh
 + bÙtom_Ëá[
_x_
];

1165 
off£t
 = 
Nmesh
 - 
n_x
;

1168 
k
 = 
off£t
 = 0;

1171 
jj
 = 
bÙtom_Ëá
[
_y_
]; jj < 
tİ_right
[_y_]; jj++)

1173 ifĞ
š‹º®
.
dump_£ed¶ªe
 == 1 )

1176 
lše
 = 
jj
*
Nmesh
;

1177 
ii
 = 
bÙtom_Ëá
[
_x_
]; i˜< 
tİ_right
[_x_]; ii++)

1178 
	`årštf
(
fe
, "%d %d %d %u\n", 
ii
, 
jj
, 
lše
 + ii, 
SEEDTABLE
[
k
++]);

1183 
ii
 = 
bÙtom_Ëá
[
_x_
]; i˜< 
tİ_right
[_x_]; ii++)

1184 
	`årštf
(
fe
, "%d %d %d %u\n", 
jj
, 
ii
, ii*
Nmesh
 + jj, 
SEEDTABLE
[
k
++]);

1186 
k
 +ğ
off£t
;

1189 
	`fşo£
(
fe
);

1192 
	`d´štf
(
VDIAG
, 
ThisTask
, "\t\t\tTask %d sk beÿu£ z0 =ğ%d\n", ThisTask, 
z0
);

1194 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

1197 if(
ThisTask
 == 0)

1199 
”r
;

1200 
f’ame
[200];

1201 
	`¥rštf
(
f’ame
, "£ed_¶ªe.Ng_%d_Nt_%d.d©", 
Nmesh
, 
NTasks
);

1202 
	`¥rštf
(
bufãr
, "ÿˆ£ed¶ªe_·¹Ÿl_* | sÜˆ-k3 -À> %s", 
f’ame
);

1204 
”r
 = 
	`sy¡em
(
bufãr
);

1205 if(
”r
 != 0)

1206 
	`d´štf
(
VXX
, 0, "som‘hšg w’ˆwrÚg whwr™šg % fe\n", 
f’ame
);

1208 
”r
 = 
	`sy¡em
("rm -f seedplane_partial_*");

1209 if(
”r
 != 0)

1210 
	`d´štf
(
VXX
, 0, "something went wrong while„emovingemporary files seedplane_partial_*\n");

1213 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

1216 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/alternatives/collapse_times.vector.c

27 
	~"pšocchio.h
"

29 
šlše
 
	$v_šv”£_cŞÏp£_time
(
dvec
 
d‹nsÜ
[6], 
dvec_u
 , dveø, dvec_u *, dvec_u *, dvec_u *, dvec_u *è
	`__©Œibu‹__
((
®ways_šlše
));

30 
šlše
 
	$šv”£_cŞÏp£_time
(*, *, *, *, *è
	`__©Œibu‹__
((
®ways_šlše
));

31 
šlše
 
	$–l
(,,,,è
	`__©Œibu‹__
((
®ways_šlše
));

32 
	`Üd
(*,*,*);

34 
	$compu‹_cŞÏp£_times
(
ismoÙh
)

37 
ç
;

38 
loÿl_av”age
,
loÿl_v¬Ÿnû
;

39 
dvec_u
 
vloÿl_av”age
, 
vloÿl_v¬Ÿnû
;

40 
dvec
 
vz”o
 = {0, 0, 0, 0};

43 
loÿl_v¬Ÿnû
 = 0.0;

44 
loÿl_av”age
 = 0.0;

45 
vloÿl_av”age
.
V
 = 
vz”o
;

46 
vloÿl_v¬Ÿnû
.
V
 = 
vz”o
;

49 ià(!
ismoÙh
)

50 
i
 = 0; i < 
MyGrids
[0].
tÙ®_loÿl_size
; i++)

52 
´oduùs
[
i
].
Fmax
 = -10.0;

53 
´oduùs
[
i
].
Rmax
 = -1;

54 
´oduùs
[
i
].
Vmax
[0] = 0.0;

55 
´oduùs
[
i
].
Vmax
[1] = 0.0;

56 
´oduùs
[
i
].
Vmax
[2] = 0.0;

57 #ifdeà
TWO_LPT


58 
´oduùs
[
i
].
Vmax_2LPT
[0] = 0.0;

59 
´oduùs
[
i
].
Vmax_2LPT
[1] = 0.0;

60 
´oduùs
[
i
].
Vmax_2LPT
[2] = 0.0;

61 #ifdeà
THREE_LPT


62 
´oduùs
[
i
].
Vmax_3LPT_1
[0] = 0.0;

63 
´oduùs
[
i
].
Vmax_3LPT_1
[1] = 0.0;

64 
´oduùs
[
i
].
Vmax_3LPT_1
[2] = 0.0;

65 
´oduùs
[
i
].
Vmax_3LPT_2
[0] = 0.0;

66 
´oduùs
[
i
].
Vmax_3LPT_2
[1] = 0.0;

67 
´oduùs
[
i
].
Vmax_3LPT_2
[2] = 0.0;

73 
loÿl_x
 = 0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

75 
idx_x
 = 
loÿl_x
 * 
MyGrids
[0].
GSloÿl
[
_y_
];

76 
loÿl_y
 = 0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

78 
idx_y
 = (
idx_x
 + 
loÿl_y
è* 
MyGrids
[0].
GSloÿl
[
_z_
];

79 
mysize
 = 
DVEC_SIZE
 * 
MyGrids
[0].
GSloÿl
[
_z_
] / DVEC_SIZE;

80 
loÿl_z
 = 0;

81  ; 
loÿl_z
 < 
mysize
;†oÿl_z +ğ
DVEC_SIZE
)

83 
šdex
 = 
idx_y
 + 
loÿl_z
;

85 
dvec
 
–em’ts
[6] 
	`__©Œibu‹__
((
	`®igÃd
(32)));

89 
i
 = 0; i < 6; i++)

90 
–em’ts
[
i
] = 
	`_mm256_lßd_pd
(&
£cÚd_d”iv©ives
[0][i][
šdex
]);

93 
dvec_u
 
d–
 
	`__©Œibu‹__
((
	`®igÃd
(32)));

94 
d–
.
V
 = 
–em’ts
[0] +ƒlements[1] +ƒlements[2];

95 
dvec
 
d–_2
 
	`__©Œibu‹__
((
	`®igÃd
(32)));

96 
d–_2
 = 
d–
.
V
*delta.V;

98 
vloÿl_av”age
.
V
 +ğ
d–
.V;

99 
vloÿl_v¬Ÿnû
.
V
 +ğ
d–_2
;

102 
dvec_u
 
Ïmbda1
,
Ïmbda2
,
Ïmbda3
 
	`__©Œibu‹__
((
	`®igÃd
(32)));

103 
dvec_u
 
FÃw
 
	`__©Œibu‹__
((
	`®igÃd
(32)));

104 if(
	`v_šv”£_cŞÏp£_time
(
–em’ts
, 
d–
, 
d–_2
, &
Ïmbda1
, &
Ïmbda2
, &
Ïmbda3
, &
FÃw
))

106 
	`´štf
("ERROR oÀsk %d: fau» iÀšv”£_cŞÏp£_time\n",
ThisTask
);

107 
	`fæush
(
¡dout
);

111 #ifdeà
SCALE_DEPENDENT_GROWTH


112 
SDGM
.
æag
=0;

113 
SDGM
.
ismoÙh
=ismooth;

115 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

118 ià(
FÃw
.
v
[
ii
] > 0)

119 
FÃw
.
v
[
ii
] = 1. + 
	`Inv”£GrowšgMode
(1./Fnew.v[ii]);

121 ià(
´oduùs
[
šdex
 + 
ii
].
Fmax
 < 
FÃw
.
v
[ii])

123 
´oduùs
[
šdex
].
Fmax
 = 
FÃw
.
v
[
ii
];

124 
´oduùs
[
šdex
].
Rmax
 = 
ismoÙh
;

128  ; 
loÿl_z
 < 
MyGrids
[0].
GSloÿl
[
_z_
];†ocal_z++)

130 
šdex
 = 
idx_y
 + 
loÿl_z
;

132 
diff_‹n
[6];

133 
i
 = 0; i < 6; i++)

134 
diff_‹n
[
i
] = 
£cÚd_d”iv©ives
[0][i][
šdex
];

137 
d–
 = 
diff_‹n
[0]+diff_ten[1]+diff_ten[2];

138 
loÿl_av”age
 +ğ
d–
;

139 
loÿl_v¬Ÿnû
 +ğ
d–
*delta;

142 
Ïmbda1
,
Ïmbda2
,
Ïmbda3
;

143 
FÃw
 = 
	`šv”£_cŞÏp£_time
(
diff_‹n
, &
Ïmbda1
, &
Ïmbda2
, &
Ïmbda3
, &
ç
);

145 #ifdeà
SCALE_DEPENDENT_GROWTH


146 
SDGM
.
æag
=0;

147 
SDGM
.
ismoÙh
=ismooth;

150 ià(
FÃw
>0)

151 
FÃw
 = 1.+
	`Inv”£GrowšgMode
(1./Fnew);

153 ià(
ç
)

155 
	`´štf
("ERROR oÀsk %d: fau» iÀšv”£_cŞÏp£_time\n",
ThisTask
);

156 
	`fæush
(
¡dout
);

160 ià(
´oduùs
[
šdex
].
Fmax
 < 
FÃw
)

162 
´oduùs
[
šdex
].
Fmax
 = 
FÃw
;

163 
´oduùs
[
šdex
].
Rmax
 = 
ismoÙh
;

173 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

175 
loÿl_v¬Ÿnû
 +ğ
vloÿl_v¬Ÿnû
.
v
[
ii
];

176 
loÿl_av”age
 +ğ
vloÿl_av”age
.
v
[
ii
];

179 
glob®_v¬Ÿnû
 = 0.0;

180 
glob®_av”age
 = 0.0;

182 
glob®_v¬Ÿnû
 = 0.0;

183 
glob®_av”age
 = 0.0;

185 
	`MPI_Reduû
(&
loÿl_v¬Ÿnû
, &
glob®_v¬Ÿnû
, 1, 
MPI_DOUBLE
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

186 
	`MPI_Reduû
(&
loÿl_av”age
 , &
glob®_av”age
 , 1, 
MPI_DOUBLE
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

188 ià(!
ThisTask
)

190 
Np
 = ()
MyGrids
[0].
GSglob®
[
_x_
] * ()MyGrids[0].GSglob®[
_y_
] *()MyGrids[0].GSglob®[
_z_
];

191 
glob®_v¬Ÿnû
 /ğ
Np
;

192 
glob®_av”age
 /ğ
Np
;

195 
	`MPI_Bÿ¡
(&
glob®_v¬Ÿnû
, 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

197 
SmoÙhšg
.
TrueV¬Ÿnû
[
ismoÙh
]=
glob®_v¬Ÿnû
;

199 #ifdeà
SCALE_DEPENDENT_GROWTH


200 
SDGM
.
æag
=0;

201 
SDGM
.
ismoÙh
=ismooth;

202 
SmoÙhšg
.
TrueV¬Ÿnû
[
ismoÙh
] *ğ
	`GrowšgMode
(
·¿ms
.
ÿmb
.
Reã»nûRedshiá
);

207 
	}
}

211 
šlše
 
	$v_šv”£_cŞÏp£_time
(
dvec
 
d‹nsÜ
[6], 
dvec_u
 
d–
, dveø
d–_2
, dvec_u *
x1
, dvec_u *
x2
, dvec_u *
x3
, dvec_u *
»s
)

214 
dvec
 
mu2
;

215 
dvec_u
 
q
, 
mu3
;

222 
mu2
 = 0.5 * 
d–_2
;

224 
dvec
 
d‹nsÜ_2
[3];

225 
d‹nsÜ_2
[0] = 
d‹nsÜ
[0] * dtensor[0];

226 
d‹nsÜ_2
[1] = 
d‹nsÜ
[1] * dtensor[1];

227 
d‹nsÜ_2
[2] = 
d‹nsÜ
[2] * dtensor[2];

228 
mu2
 -ğ0.5 * (
d‹nsÜ_2
[0] + dtensor_2[1] + dtensor_2[2]);

230 
d‹nsÜ_2
[0] = 
d‹nsÜ
[3] * dtensor[3];

231 
d‹nsÜ_2
[1] = 
d‹nsÜ
[4] * dtensor[4];

232 
d‹nsÜ_2
[2] = 
d‹nsÜ
[5] * dtensor[5];

233 
mu2
 -ğ
d‹nsÜ_2
[0] + dtensor_2[1] + dtensor_2[2];

235 
mu3
.
V
 = 
d‹nsÜ
[0]*dtensor[1]*dtensor[2] +

236 2.*
d‹nsÜ
[3]*dtensor[4]*dtensor[5] -

237 
d‹nsÜ
[0] * 
d‹nsÜ_2
[2] -

238 
d‹nsÜ
[1] * 
d‹nsÜ_2
[1] -

239 
d‹nsÜ
[2] * 
d‹nsÜ_2
[0];

241 
q
.
V
 = ( 
d–_2
 - 3.0*
mu2
 ) /9.0;

243 
ivec_u
 
com·»
;

244 
com·»
.
V
 = (
q
.V < 0);

245 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

246 if(
com·»
.
v
[
ii
] != 0)

249 
dvec_u
 
r
, 
q3
;

251 
r
.
V
 = -(2.*
d–_2
*
d–
.V - 9.0*d–.V*
mu2
 + 27.0*
mu3
.V)/54.;

252 
q3
.
V
 = (
q
.V * q.V) * q.V;

254 
com·»
.
V
 = (
q3
.V < 
r
.V*r.V);

255 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

256 if(
com·»
.
v
[
ii
] != 0)

259 
dvec
 
všv_3
 = {1.0/3.0, 1.0/3.0, 1.0/3.0, 1.0/3.0};

260 
dvec_u
 
sq
;

261 
sq
.
V
 = 2.0 * 
	`_mm256_sq¹_pd
(
q
.V);

262 
dvec_u
 
d–_šv_3
;

263 
d–_šv_3
.
V
 = 
d–
.V * 
všv_3
;

267 (*
x1
).
V
 = 
d‹nsÜ
[0];

268 (*
x2
).
V
 = 
d‹nsÜ
[1];

269 (*
x3
).
V
 = 
d‹nsÜ
[2];

271 
šv_3
 = 1.0/3.0;

273 
com·»
.
V
 = (
q
.V == 0);

274 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

275 if(
com·»
.
v
[
ii
] != 0)

277 
t
 = 
	`acos
(2*
r
.
v
[
ii
] / 
q
.v[ii] / 
sq
.v[ii]);

278 (*
x1
).
v
[
ii
] = -
sq
.v[ii]*
	`cos
(
t
 * 
šv_3
è+ 
d–_šv_3
.v[ii];

279 (*
x2
).
v
[
ii
] = -
sq
.v[ii]*
	`cos
((
t
 + 2.*
PI
è* 
šv_3
 )+ 
d–_šv_3
.v[ii];

280 (*
x3
).
v
[
ii
] = -
sq
.v[ii]*
	`cos
((
t
 + 4.*
PI
è* 
šv_3
 )+ 
d–_šv_3
.v[ii];

286 
ii
 = 0; i˜< 
DVEC_SIZE
; ii++)

288 
_x1
 = (*
x1
).
v
[
ii
];

289 
_x2
 = (*
x2
).
v
[
ii
];

290 
_x3
 = (*
x3
).
v
[
ii
];

291 
	`Üd
(&
_x1
, &
_x2
, &
_x3
);

292 
t
 = 
	`–l
(
_x1
, 
_x2
, 
_x3
, 
d–
.
v
[
ii
], 
mu3
.v[ii]);

293 if(
t
 > 0)

294 (*
»s
).
v
[
ii
] = 1.0 / 
t
;

296 (*
»s
).
v
[
ii
] = -10.0;

300 
	}
}

304 
šlše
 
	$šv”£_cŞÏp£_time
(*
defÜm©iÚ_‹nsÜ
, *
x1
, *
x2
, *
x3
, *
ç
)

307 
mu1
, 
mu2
, 
mu3
;

308 
d‹nsÜ
[6] = {
defÜm©iÚ_‹nsÜ
[0], deformation_tensor[1],

309 
defÜm©iÚ_‹nsÜ
[2], deformation_tensor[3],

310 
defÜm©iÚ_‹nsÜ
[4], deformation_tensor[5] };

315 *
ç
=0;

318 
mu1
 = 
d‹nsÜ
[0] + dtensor[1] + dtensor[2];

319 
mu1_2
 = 
mu1
 * mu1;

321 
mu2
 = 0.5 * 
mu1_2
;

324 
add
[3];

325 
add
[0] = 
d‹nsÜ
[0]*dtensor[0];

326 
add
[1] = 
d‹nsÜ
[1]*dtensor[1];

327 
add
[2] = 
d‹nsÜ
[2]*dtensor[2];

328 
mu2
 -ğ0.5 * (
add
[0] +‡dd[1] +‡dd[2]);

331 
add
[3];

332 
add
[0] = 
d‹nsÜ
[3]*dtensor[3];

333 
add
[1] = 
d‹nsÜ
[4]*dtensor[4];

334 
add
[2] = 
d‹nsÜ
[5]*dtensor[5];

335 
mu2
 -ğ
add
[0] +‡dd[1] +‡dd[2];

337 
mu3
 = 
d‹nsÜ
[0]*dtensor[1]*dtensor[2] +

338 2.*
d‹nsÜ
[3]*dtensor[4]*dtensor[5] -

339 
d‹nsÜ
[0]*
add
[2] -

340 
d‹nsÜ
[1]*
add
[1] -

341 
d‹nsÜ
[2]*
add
[0];

343 
q
;

344 
q
 = ( 
mu1_2
 - 3.0*
mu2
 ) /9.0;

346 ià(
q
 == 0.)

349 *
x1
 = 
d‹nsÜ
[0];

350 *
x2
 = 
d‹nsÜ
[1];

351 *
x3
 = 
d‹nsÜ
[2];

355 
r
 = -(2.*
mu1_2
*
mu1
 - 9.0*mu1*
mu2
 + 27.0*
mu3
)/54.;

357 ià(
q
*q*q < 
r
*r || q<0.0)

359 *
ç
=1;

363 
sq
 = 2 * 
	`sq¹
(
q
);

364 
t
 = 
	`acos
(2*
r
/
q
/
sq
);

365 
šv_3
 = 1.0/3.0;

366 *
x1
 = -
sq
*
	`cos
(
t
 * 
šv_3
è+ 
mu1
 * inv_3;

367 *
x2
 = -
sq
*
	`cos
((
t
 + 2.*
PI
è* 
šv_3
 )+ 
mu1
 * inv_3;

368 *
x3
 = -
sq
*
	`cos
((
t
 + 4.*
PI
è* 
šv_3
 )+ 
mu1
 * inv_3;

374 
	`Üd
(
x1
, 
x2
, 
x3
);

375 
t
 = 
	`–l
(*
x1
, *
x2
, *
x3
, 
mu1
, 
mu3
);

378 ià(
t
 > 0.)

379  1. / 
t
;

382 
	}
}

388 
šlše
 
	$–l
(
l1
,
l2
,
l3
,
d–
,
d‘
)

398 
a1
,
a2
,
a3
,
d’
,
dis
,
r
,
q
,
sq
,
t
,
s1
,
s2
,
s3
,
–l
;

401 ià(
l1
 == 0.)

402 
–l
 = -0.1;

405 
d’
 = 
d‘
 / 126. + 5.*
l1
*
d–
*(del-l1) / 84.;

407 ià(
d’
 == 0.)

409 ià(
d–
 =ğ
l1
)

411 iàĞ
l1
 > 0.0)

412 
–l
 = 1./
l1
;

414 
–l
 = -.1;

418 
dis
 = 7.*
l1
* (l1+6.*
d–
);

419 ià(
dis
 < 0.0)

420 
–l
 = -.1;

423 
–l
 = (7.*
l1
 - 
	`sq¹
(
dis
)è/ (3.*l1*Ö1-
d–
));

424 ià(
–l
 < 0.)

425 
–l
 = -.1;

431 
rd’
 = 1.0 / 
d’
;

433 
a1
 = 3.*
l1
*(
d–
-l1è/14. * 
rd’
;

434 
a1_2
 = 
a1
*a1;

436 
a2
 = 
l1
 * 
rd’
;

437 
a3
 = -1.0 * 
rd’
;

438 
q
 = (
a1_2
 - 3.*
a2
) / 9.;

439 
r
 = (2.* 
a1_2
*
a1
 - 9.*a1*
a2
 + 27.*
a3
) / 54.;

441 
r_2_q_3
 = 
r
*r-
q
*q*q;

443 ià(
r_2_q_3
 > 0)

445 
çbs_r
 = 
	`çbs
(
r
);

446 
sq
 = 
	`pow
(
	`sq¹
(
r_2_q_3
)+
çbs_r
,0.333333333333333);

447 
–l
 = -
çbs_r
 / 
r
 * (
sq
+
q
/sqè- 
a1
/3.;

448 ià(
–l
 < 0.)

449 
–l
 = -.1;

453 
sq
 = 2*
	`sq¹
(
q
);

454 
šv_3
 = 1.0/3;

455 
t
=
	`acos
(2*
r
/
q
/
sq
);

456 
s1
 = -
sq
*
	`cos
 (
t
 * 
šv_3
)-
a1
 * inv_3;

457 
s2
 = -
sq
*
	`cos
 ((
t
+2.*
PI
è* 
šv_3
è- 
a1
 * inv_3;

458 
s3
 = -
sq
*
	`cos
 ((
t
+4.*
PI
è* 
šv_3
è- 
a1
 * inv_3;

460 ià(
s1
 < 0.)

461 
s1
 =1.e10;

463 ià(
s2
 < 0.)

464 
s2
 = 1.e10;

466 ià(
s3
 < 0.)

467 
s3
 = 1.e10;

469 
–l
 = (
s1
 < 
s2
? s1 : s2);

470 
–l
 = (
s3
 <ell? s3 :ƒll);

471 ià(
–l
 == 1.e10)

472 
–l
 =- .1;

477 ià(
d–
 > 0. && 
–l
 > 0.)

479 
šv_d–
 = 1.0/
d–
;

480 
–l
+=-.364 * 
šv_d–
 * 
	`exp
(-6.5*(
l1
-
l2
)*šv_d–-2.8*Ö2-
l3
)*inv_del);

482  
–l
;

483 
	}
}

486 
	#mš
(
a
,
b
è(×)<(b)?×):(b))

	)

487 
	#max
(
a
,
b
è(×)>(b)?×):(b))

	)

489 
	$Üd
(*
a
, *
b
, *
c
)

492 
lo
,
hi
;

494 
hi
=
	`max
Ğmax(*
a
,*
b
), *
c
 );

495 
lo
=
	`mš
Ğmš(*
a
,*
b
), *
c
 );

497 *
b
=*
a
+*b+*
c
-
lo
-
hi
;

498 *
a
=
hi
;

499 *
c
=
lo
;

500 
	}
}

503 
	$compu‹_v–oc™›s
(
ismoÙh
)

506 #ifdeà
SMOOTH_VELOCITIES


507 
fš®
=(
ismoÙh
==
SmoÙhšg
.
NsmoÙh
-1);

510 
loÿl_x
 = 0;†oÿl_x < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_x++)

512 
idx_x
 = 
loÿl_x
 * 
MyGrids
[0].
GSloÿl
[
_y_
];

513 
loÿl_y
=0;†oÿl_y < 
MyGrids
[0].
GSloÿl
[
_y_
];†ocal_y++)

515 
idx_y
 = (
idx_x
 + 
loÿl_y
)*
MyGrids
[0].
GSloÿl
[
_z_
];

516 
loÿl_z
=0;†oÿl_z < 
MyGrids
[0].
GSloÿl
[
_x_
];†ocal_z++)

518 
šdex
 = 
loÿl_z
 + 
idx_y
;

522 #ifdeà
SMOOTH_VELOCITIES


523 ià(
´oduùs
[
šdex
].
Rmax
==
ismoÙh
 || (´oduùs[šdex].
Fmax
<0.0 && 
fš®
) )

525 
i
 = 0; i < 3; i++)

526 
´oduùs
[
šdex
].
Vmax
[
i
]=
fœ¡_d”iv©ives
[0][i][index];

531 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/build_groups.c

27 
	~"pšocchio.h
"

28 
	~"äagm’t.h
"

29 
	~<g¦/g¦_sf.h
>

31 
	#NCOUNTERS
 15

	)

33 
	g·¹işe_Çme
;

34 
	gglob®
[3], 
	ggood_·¹işe
;

36 #ifdeà
PLC


37 cÚ¡ 
g¦_roÙ_fsŞv”_ty³
 *
	gb»Á
;

38 
g¦_roÙ_fsŞv”
 *
	gsŞv”
;

39 
g¦_funùiÚ
 
	gcPLC
;

40 
	gLgrid
[3],
	g¡¬t
[3];

41 
	gthisgroup
;

42 
	g»¶iÿ‹
[3];

43 
	gb»Á_”r
;

44 
	#SAFEPLC
 3

	)

46 
cÚd™iÚ_PLC
();

47 
cÚd™iÚ_F
(, *);

48 
¡Üe_PLC
();

49 
fšd_b»Á
(, );

52 
	$bud_groups
(
N³aks
)

55 
m”ge
[
NV
][NV], 
Ãigh
[NV], 
f_li¡
[NV][3];

56 
iout
,
Lgridxy
,
Â
,
if
,
šdx
,
Ãig½
;

57 
iz
,
kk
,
i1
,
j1
,
k1
,
sk
;

58 
ig3
,
sm®l
,
Ïrge
,
nf
,
to_group
,
accg½
,
ig1
,
ig2
;

59 
acüæag
,
n¡•
,
nm”ge
,
n¡•_p
,
³ak_cÚd
;

60 
¿tio
,
be¡_¿tio
,
d2
,
r2
,
ıutmp
;

61 
m”ge_æag
;

62 
ibox
,
jbox
,
kbox
;

76 
couÁ”s
[
NCOUNTERS
],
®l_couÁ”s
[NCOUNTERS];

78 #ifdeà
PLC


80 
¶c_¡¬‹d
=0, 
Ï¡_check_dÚe
=0, 
œ•
, 
Ï¡_¡Üed
=0,

81 
§ve
, 
my§ve
, 
¡Üex
, 
¡Üey
, 
¡Üez
;

82 
¯
, 
bb
, 
F¶c
, 
NextF_PLC
, 
D–F_PLC
;

88 
ngroups
=
FILAMENT
;

89 
Lgridxy
 = 
subbox
.
Lgwbl_x
 * subbox.
Lgwbl_y
;

91 
iout
=0;

93 
i1
=0; i1<
NCOUNTERS
; i1++)

95 
couÁ”s
[
i1
]=0;

96 
®l_couÁ”s
[
i1
]=0;

99 
groups
[
FILAMENT
].
pošt
 = groups[FILAMENT].
bÙtom
 = 
subbox
.
N·¹
;

101 ià(!
ThisTask
)

102 
	`´štf
("[%s] S¹šghäagm’tiÚ…roûss\n",
	`fd©e
());

106 
n¡•
=0;

107 
äag
[
šdiûs
[
n¡•
]].
Fmax
 >ğ
ouuts
.
FÏ¡
)

108 
n¡•
++;

110 
n¡•_p
=
n¡•
/20;

112 #ifdeà
PLC


114 
cPLC
.
funùiÚ
 = &
cÚd™iÚ_F
;

115 
b»Á
 = 
g¦_roÙ_fsŞv”_b»Á
;

116 
sŞv”
 = 
	`g¦_roÙ_fsŞv”_®loc
 (
b»Á
);

117 
Lgrid
[0]=()
MyGrids
[0].
GSglob®
[
_x_
];

118 
Lgrid
[1]=()
MyGrids
[0].
GSglob®
[
_y_
];

119 
Lgrid
[2]=()
MyGrids
[0].
GSglob®
[
_z_
];

120 
¡¬t
[0]=()
subbox
.
¡abl_x
;

121 
¡¬t
[1]=()
subbox
.
¡abl_y
;

122 
¡¬t
[2]=()
subbox
.
¡abl_z
;

123 
NextF_PLC
=
¶c
.
F¡¬t
;

124 
D–F_PLC
=0.9;

125 
b»Á_”r
 = 1.e-3 * 
·¿ms
.
IÁ”P¬tDi¡
;

131 
iz
=0; iz<=
n¡•
; iz++)

135 #ifdeà
PLC


136 ià(
äag
[
šdiûs
[
iz
]].
Fmax
 >ğ
¶c
.
F¡İ
)

138 
äag
[
šdiûs
[
iz
]].
Fmax
 < 
NextF_PLC
)

140 
§ve
=0;

141 ià(
¶c
.
N¡Üed
=õlc.
Nmax
 &&…lc.
F¡¬t
==-1)

142 
my§ve
 = 0;

144 
my§ve
 = (
SAFEPLC
 * (
¶c
.
N¡Üed
 - 
Ï¡_¡Üed
è>…lc.
Nmax
 -…lc.Nstored);

145 
	`MPI_Reduû
(&
my§ve
, &
§ve
, 1, 
MPI_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

146 
	`MPI_Bÿ¡
(&
§ve
, 1, 
MPI_INT
, 0, 
MPI_COMM_WORLD
);

148 ià(!
ThisTask
)

149 
	`´štf
("[%s] Syncšgasks...\n",
	`fd©e
());

151 ià(
§ve
)

153 ià(
	`wr™e_PLC
())

155 
¶c
.
N¡Üed
=0;

158 
NextF_PLC
 *ğ
D–F_PLC
;

159 
Ï¡_¡Üed
=
¶c
.
N¡Üed
;

164 
äag
[
šdiûs
[
iz
]].
Fmax
 < 
ouuts
.
F
[
iout
])

166 
ıutmp
=
	`MPI_Wtime
();

168 ià(!
ThisTask
)

169 
	`´štf
("[%s] Wr™šg ouuˆ© z=%à(Dsigma=%f)\n",
	`fd©e
(),

170 
ouuts
.
z
[
iout
],

171 
	`sq¹
(
SmoÙhšg
.
TrueV¬Ÿnû
[SmoÙhšg.
NsmoÙh
-1]è* 
	`GrowšgMode
(
ouuts
.
z
[
iout
]));

173 ià(
	`wr™e_ÿlog
(
iout
))

176 ià(
·¿ms
.
Wr™eSÇpshÙ
 && 
	`wr™e_¢­shÙ
(
iout
))

179 ià(
	`compu‹_mf
(
iout
))

182 ià(
iout
==
ouuts
.
n
-1)

183 ià(
	`wr™e_hi¡Ü›s
())

186 
ıutime
.
io
 +ğ
	`MPI_Wtime
(è- 
ıutmp
;

188 
iout
++;

189 ià(
iz
==
n¡•
-1)

193 ià(
iout
==
ouuts
.
n
)

198 
Ãig½
=0;

199 
nf
=0;

200 
acüæag
=0;

201 
i1
=0; i1<
NV
; i1++)

202 
Ãigh
[
i1
]=0;

205 
kbox
=
šdiûs
[
iz
]/
Lgridxy
;

206 
kk
=
šdiûs
[
iz
]-
kbox
*
Lgridxy
;

207 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

208 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

211 
sk
=0;

212 iàĞ!
subbox
.
pbc_x
 && (
ibox
==0 || ibox==subbox.
Lgwbl_x
-1èè++
sk
;

213 iàĞ!
subbox
.
pbc_y
 && (
jbox
==0 || jbox==subbox.
Lgwbl_y
-1èè++
sk
;

214 iàĞ!
subbox
.
pbc_z
 && (
kbox
==0 || kbox==subbox.
Lgwbl_z
-1èè++
sk
;

217 
glob®
[
_x_
] = 
ibox
 + 
subbox
.
¡abl_x
;

219 ià(
glob®
[
_x_
] < 0èglob®[_x_]+=
MyGrids
[0].
GSglob®
[_x_];

220 ià(
glob®
[
_x_
] >ğ
MyGrids
[0].
GSglob®
[_x_]) global[_x_] -= MyGrids[0].GSglobal[_x_];

222 
glob®
[
_y_
] = 
jbox
 + 
subbox
.
¡abl_y
;

224 ià(
glob®
[
_y_
] < 0èglob®[_y_]+=
MyGrids
[0].
GSglob®
[_y_];

225 ià(
glob®
[
_y_
] >ğ
MyGrids
[0].
GSglob®
[_y_]) global[_y_] -= MyGrids[0].GSglobal[_y_];

227 
glob®
[
_z_
] = 
kbox
 + 
subbox
.
¡abl_z
;

229 ià(
glob®
[
_z_
] < 0èglob®[_z_]+=
MyGrids
[0].
GSglob®
[_z_];

230 ià(
glob®
[
_z_
] >ğ
MyGrids
[0].
GSglob®
[_z_]) global[_z_] -= MyGrids[0].GSglobal[_z_];

232 #ifdeà
ROTATE_BOX


234 
·¹işe_Çme
=()
glob®
[
_x_
] +

235 Ğ()
glob®
[
_z_
] +

236 ()
glob®
[
_y_
] * ()
MyGrids
[0].
GSglob®
[
_z_
] ) *

237 ()
MyGrids
[0].
GSglob®
[
_x_
];

241 
·¹işe_Çme
=()
glob®
[
_x_
] +

242 Ğ()
glob®
[
_y_
] +

243 ()
glob®
[
_z_
] * ()
MyGrids
[0].
GSglob®
[
_y_
] ) *

244 ()
MyGrids
[0].
GSglob®
[
_x_
];

248 
good_·¹işe
 = ( 
ibox
 >ğ
subbox
.
§ã_x
 && ibox < subbox.
Lgwbl_x
 - subbox.safe_x &&

249 
jbox
 >ğ
subbox
.
§ã_y
 && jbox < subbox.
Lgwbl_y
 - subbox.safe_y &&

250 
kbox
 >ğ
subbox
.
§ã_z
 && kbox < subbox.
Lgwbl_z
 - subbox.safe_z );

252 ià(!
sk
)

254 
³ak_cÚd
=1;

256 
Â
=0;‚n<
NV
;‚n++)

258 
Â
)

261 
i1
=Ğ
subbox
.
pbc_x
 && 
ibox
==0 ? subbox.
Lgwbl_x
-1 : ibox-1 );

262 
j1
=
jbox
;

263 
k1
=
kbox
;

266 
i1
=Ğ
subbox
.
pbc_x
 && 
ibox
==subbox.
Lgwbl_x
-1 ? 0 : ibox+1 );

267 
j1
=
jbox
;

268 
k1
=
kbox
;

271 
i1
=
ibox
;

272 
j1
=Ğ
subbox
.
pbc_y
 && 
jbox
==0 ? subbox.
Lgwbl_y
-1 : jbox-1 );

273 
k1
=
kbox
;

276 
i1
=
ibox
;

277 
j1
=Ğ
subbox
.
pbc_y
 && 
jbox
==subbox.
Lgwbl_y
-1 ? 0 : jbox+1 );

278 
k1
=
kbox
;

281 
i1
=
ibox
;

282 
j1
=
jbox
;

283 
k1
=Ğ
subbox
.
pbc_z
 && 
kbox
==0 ? subbox.
Lgwbl_z
-1 : kbox-1 );

286 
i1
=
ibox
;

287 
j1
=
jbox
;

288 
k1
=Ğ
subbox
.
pbc_z
 && 
kbox
==subbox.
Lgwbl_z
-1 ? 0 : kbox+1 );

292 
Ãigh
[
Â
] = 
group_ID
[
i1
 + 
j1
 *
subbox
.
Lgwbl_x
 + 
k1
 *
Lgridxy
];

294 ià(
Ãigh
[
Â
] =ğ
FILAMENT
)

296 
Ãigh
[
Â
] = 0;

297 
f_li¡
[
nf
][0] = 
i1
;

298 
f_li¡
[
nf
][1] = 
j1
;

299 
f_li¡
[
nf
][2] = 
k1
;

300 
nf
++;

303 
³ak_cÚd
 &ğ(
äag
[
šdiûs
[
iz
]].
Fmax
 > f¿g[
i1
 +
j1
*
subbox
.
Lgwbl_x
 + 
k1
*
Lgridxy
].Fmax);

307 
	`ş—n_li¡
(
Ãigh
);

310 
Â
=
Ãig½
=0;‚n<
NV
;‚n++)

311 ià(
Ãigh
[
Â
]>
FILAMENT
)

312 
Ãig½
++;

314 ià(
Ãig½
>0 && 
good_·¹işe
)

315 
couÁ”s
[
Ãig½
]++;

317 #ifdeà
PLC


326 ià(
äag
[
šdiûs
[
iz
]].
Fmax
 < 
¶c
.
F¡¬t
 && f¿g[šdiûs[iz]].Fmax >ğ¶c.
F¡İ
)

329 ià(!
¶c_¡¬‹d
)

331 
¶c_¡¬‹d
=1;

332 ià(!
ThisTask
)

333 
	`´štf
("[%s] S¹šg PLC„ecÚ¡ruùiÚ\n",
	`fd©e
());

334 
ıutmp
=
	`MPI_Wtime
();

338 
¡Üex
=
subbox
.
pbc_x
;

339 
¡Üey
=
subbox
.
pbc_y
;

340 
¡Üez
=
subbox
.
pbc_z
;

341 
subbox
.
pbc_x
=subbox.
pbc_y
=subbox.
pbc_z
=0;

343 
ig1
=0; ig1<
Ãig½
; ig1++)

346 ià(
Ãigh
[
ig1
] > 
FILAMENT
 &&

347 
groups
[
Ãigh
[
ig1
]].
good
 &&

348 
groups
[
Ãigh
[
ig1
]].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

350 
thisgroup
=
Ãigh
[
ig1
];

353 
œ•
=0; i»p<
¶c
.
N»¶iÿtiÚs
; irep++)

354 ià(
äag
[
šdiûs
[
iz
]].
Fmax
 < 
¶c
.
»¶s
[
œ•
].
F1
 &&

355 
äag
[
šdiûs
[
iz
]].
Fmax
 > 
¶c
.
»¶s
[
œ•
].
F2
)

357 
»¶iÿ‹
[0]=
¶c
.
»¶s
[
œ•
].
i
;

358 
»¶iÿ‹
[1]=
¶c
.
»¶s
[
œ•
].
j
;

359 
»¶iÿ‹
[2]=
¶c
.
»¶s
[
œ•
].
k
;

360 
bb
=
	`cÚd™iÚ_PLC
(
äag
[
šdiûs
[
iz
]].
Fmax
);

363 ià(
bb
==0.0)

365 ià(
	`¡Üe_PLC
(
äag
[
šdiûs
[
iz
]].
Fmax
))

368 ià(
bb
>0.)

371 
¯
=
	`cÚd™iÚ_PLC
(
groups
[
Ãigh
[
ig1
]].
FÏ¡
);

372 ià(
¯
<0.0)

375 iàĞ(
F¶c
=
	`fšd_b»Á
(
groups
[
Ãigh
[
ig1
]].
FÏ¡
,
äag
[
šdiûs
[
iz
]].
Fmax
)) == -99.00)

377 ià(
	`¡Üe_PLC
(
F¶c
))

391 
groups
[
Ãigh
[
ig1
]].
FÏ¡
=
äag
[
šdiûs
[
iz
]].
Fmax
;

395 
subbox
.
pbc_x
=
¡Üex
;

396 
subbox
.
pbc_y
=
¡Üey
;

397 
subbox
.
pbc_z
=
¡Üez
;

403 ià(
¶c
.
F¡¬t
>0. && 
äag
[
šdiûs
[
iz
]].
Fmax
<plc.Fstart)

405 
ig1
=0; ig1<
Ãig½
; ig1++)

406 
groups
[
Ãigh
[
ig1
]].
FÏ¡
=
äag
[
šdiûs
[
iz
]].
Fmax
;

413 
³ak_cÚd
=0;

414 
Ãig½
=0;

418 ià(
³ak_cÚd
)

425 ià(
good_·¹işe
)

426 
couÁ”s
[0]++;

428 
ngroups
++;

430 ià(
ngroups
 > 
N³aks
+2)

432 
	`´štf
("TOO MANY GROUPS???\n");

436 
groups
[
ngroups
].
t_³ak
=
äag
[
šdiûs
[
iz
]].
Fmax
;

437 
groups
[
ngroups
].
t_­³¬
=-1;

438 
groups
[
ngroups
].
t_m”ge
=-1;

439 
groups
[
ngroups
].
Pos
[0]=
ibox
+
SHIFT
;

440 
groups
[
ngroups
].
Pos
[1]=
jbox
+
SHIFT
;

441 
groups
[
ngroups
].
Pos
[2]=
kbox
+
SHIFT
;

442 
groups
[
ngroups
].
V–
[0]=
äag
[
šdiûs
[
iz
]].
Vmax
[0];

443 
groups
[
ngroups
].
V–
[1]=
äag
[
šdiûs
[
iz
]].
Vmax
[1];

444 
groups
[
ngroups
].
V–
[2]=
äag
[
šdiûs
[
iz
]].
Vmax
[2];

445 #ifdeà
TWO_LPT


446 
groups
[
ngroups
].
V–_2LPT
[0]=
äag
[
šdiûs
[
iz
]].
Vmax_2LPT
[0];

447 
groups
[
ngroups
].
V–_2LPT
[1]=
äag
[
šdiûs
[
iz
]].
Vmax_2LPT
[1];

448 
groups
[
ngroups
].
V–_2LPT
[2]=
äag
[
šdiûs
[
iz
]].
Vmax_2LPT
[2];

449 #ifdeà
THREE_LPT


450 
groups
[
ngroups
].
V–_3LPT_1
[0]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_1
[0];

451 
groups
[
ngroups
].
V–_3LPT_1
[1]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_1
[1];

452 
groups
[
ngroups
].
V–_3LPT_1
[2]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_1
[2];

453 
groups
[
ngroups
].
V–_3LPT_2
[0]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_2
[0];

454 
groups
[
ngroups
].
V–_3LPT_2
[1]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_2
[1];

455 
groups
[
ngroups
].
V–_3LPT_2
[2]=
äag
[
šdiûs
[
iz
]].
Vmax_3LPT_2
[2];

458 
groups
[
ngroups
].
Mass
=1;

459 
groups
[
ngroups
].
Çme
=
·¹işe_Çme
;

460 
groups
[
ngroups
].
good
 = 
good_·¹işe
;

461 
groups
[
ngroups
].
pošt
 = 
šdiûs
[
iz
];

462 
groups
[
ngroups
].
bÙtom
 = 
šdiûs
[
iz
];

463 
groups
[
ngroups
].
Î
=ngroups;

464 
groups
[
ngroups
].
h®o_­p
=ngroups;

465 #ifdeà
PLC


466 ià(
äag
[
šdiûs
[
iz
]].
Fmax
 > 
¶c
.
F¡¬t
)

467 
groups
[
ngroups
].
FÏ¡
=
¶c
.
F¡¬t
;

469 
groups
[
ngroups
].
FÏ¡
=
äag
[
šdiûs
[
iz
]].
Fmax
;

472 
group_ID
[
šdiûs
[
iz
]]=
ngroups
;

473 
lškšg_li¡
[
šdiûs
[
iz
]]=indices[iz];

476 ià(
Ãig½
==1)

485 
	`cÚd™iÚ_fÜ_acü‘iÚ
(
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
]

486 ,
äag
[
šdiûs
[
iz
]].
Fmax
,
Ãigh
[0],&
d2
,&
r2
);

488 ià(
d2
<
r2
)

495 ià(
good_·¹işe
)

496 
couÁ”s
[7]++;

497 
acüæag
=1;

498 
to_group
=
Ãigh
[0];

499 
	`acü‘iÚ
(
to_group
,
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
],
äag
[šdiûs[iz]].
Fmax
);

507 
groups
[
FILAMENT
].
Mass
++;

508 
group_ID
[
šdiûs
[
iz
]]=
FILAMENT
;

509 
lškšg_li¡
[
šdiûs
[
iz
]]=indices[iz];

513 ià(
Ãig½
>1)

525 
be¡_¿tio
=
	`pow
(10.*
subbox
.
Lgwbl_x
,2.0);

526 
accg½
=-1;

527 
ig1
=0; ig1<
Ãig½
; ig1++)

529 
	`cÚd™iÚ_fÜ_acü‘iÚ
(
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
]

530 ,
äag
[
šdiûs
[
iz
]].
Fmax
,
Ãigh
[
ig1
],&
d2
,&
r2
);

531 
¿tio
=
d2
/
r2
;

532 ià(
¿tio
<1.0 &&„©io<
be¡_¿tio
)

534 
be¡_¿tio
=
¿tio
;

535 
accg½
=
ig1
;

539 ià(
accg½
>=0)

541 ià(
good_·¹işe
)

542 
couÁ”s
[7]++;

543 ià(
good_·¹işe
)

544 
couÁ”s
[8]++;

545 
acüæag
=1;

546 
to_group
=
Ãigh
[
accg½
];

547 
	`acü‘iÚ
(
Ãigh
[
accg½
],
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
],
äag
[šdiûs[iz]].
Fmax
);

552 
nm”ge
=0;

553 
ig1
=0; ig1<
Ãig½
; ig1++)

554 
ig2
=0; ig2<
ig1
; ig2++)

556 
m”ge
[
ig1
][
ig2
]=0;

557 
	`cÚd™iÚ_fÜ_m”gšg
(
äag
[
šdiûs
[
iz
]].
Fmax
,
Ãigh
[
ig1
],Ãigh[
ig2
],&
m”ge_æag
);

558 ià(
m”ge_æag
)

560 
m”ge
[
ig1
][
ig2
]=1;

561 
nm”ge
++;

571 ià(
nm”ge
>0)

573 
ig1
=0; ig1<
Ãig½
; ig1++)

574 
ig2
=0; ig2<
ig1
; ig2++)

575 ià(
m”ge
[
ig1
][
ig2
]==1 && 
Ãigh
[ig1]!=neigh[ig2])

577 ià(
good_·¹işe
)

578 
couÁ”s
[10]++;

579 ià(
groups
[
Ãigh
[
ig1
]].
Mass
 > groups[Ãigh[
ig2
]].Mass)

581 
	`m”ge_groups
(
Ãigh
[
ig1
],Ãigh[
ig2
],
äag
[
šdiûs
[
iz
]].
Fmax
);

582 
Ïrge
=
Ãigh
[
ig1
];

583 
sm®l
=
Ãigh
[
ig2
];

587 
	`m”ge_groups
(
Ãigh
[
ig2
],Ãigh[
ig1
],
äag
[
šdiûs
[
iz
]].
Fmax
);

588 
sm®l
=
Ãigh
[
ig1
];

589 
Ïrge
=
Ãigh
[
ig2
];

591 ià(
to_group
==
sm®l
)

592 
to_group
=
Ïrge
;

593 
ig3
=0; ig3<
Ãig½
; ig3++)

594 ià(
Ãigh
[
ig3
]==
sm®l
)

595 
Ãigh
[
ig3
]=
Ïrge
;

597 ià(
groups
[
Ïrge
].
Mass
 < 5*groups[
sm®l
].Mas && 
good_·¹işe
)

598 
couÁ”s
[11]++;

604 ià(
accg½
==-1)

607 
	`ş—n_li¡
(
Ãigh
);

615 
Â
=
Ãig½
=0;‚n<
NV
;‚n++)

616 ià(
Ãigh
[
Â
]>
FILAMENT
)

617 
Ãig½
++;

619 
be¡_¿tio
=
	`pow
(10.*
subbox
.
Lgwbl_x
,2.0);

620 
accg½
=-1;

621 
ig1
=0; ig1<
Ãig½
; ig1++)

623 
	`cÚd™iÚ_fÜ_acü‘iÚ
(
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
]

624 ,
äag
[
šdiûs
[
iz
]].
Fmax
,
Ãigh
[
ig1
],&
d2
,&
r2
);

625 
¿tio
=
d2
/
r2
;

626 ià(
¿tio
<
be¡_¿tio
)

628 
be¡_¿tio
=
¿tio
;

629 
accg½
=
ig1
;

633 ià(
be¡_¿tio
<1)

635 ià(
good_·¹işe
)

636 
couÁ”s
[7]++;

637 ià(
good_·¹işe
)

638 
couÁ”s
[9]++;

639 
acüæag
=1;

640 
to_group
=
Ãigh
[
accg½
];

641 
	`acü‘iÚ
(
Ãigh
[
accg½
],
ibox
,
jbox
,
kbox
,
šdiûs
[
iz
],
äag
[šdiûs[iz]].
Fmax
);

651 ià(
good_·¹işe
)

652 
couÁ”s
[12]++;

653 
groups
[
FILAMENT
].
Mass
++;

654 
group_ID
[
šdiûs
[
iz
]]=
FILAMENT
;

655 
lškšg_li¡
[
šdiûs
[
iz
]]=indices[iz];

664 
groups
[
FILAMENT
].
Mass
++;

665 
group_ID
[
šdiûs
[
iz
]]=
FILAMENT
;

666 
lškšg_li¡
[
šdiûs
[
iz
]]=indices[iz];

674 ià(
acüæag
 && 
nf
 && !
sk
)

675 
if
=0; if<
nf
; ifil++)

678 
šdx
=
f_li¡
[
if
][0] + f_li¡[if][1]*
subbox
.
Lgwbl_x
 +

679 
f_li¡
[
if
][2]*
Lgridxy
;

681 
	`cÚd™iÚ_fÜ_acü‘iÚ
(
f_li¡
[
if
][0], fil_list[ifil][1],fil_list[ifil][2],

682 
šdx
,
äag
[
šdiûs
[
iz
]].
Fmax
,
to_group
, &
d2
,&
r2
);

684 ià(
d2
<
r2
)

686 
	`acü‘iÚ
(
to_group
, 
f_li¡
[
if
][0], fil_list[ifil][1],

687 
f_li¡
[
if
][2],
šdx
,
äag
[
šdiûs
[
iz
]].
Fmax
);

688 
groups
[
FILAMENT
].
Mass
--;

692 #ifdeà
PLC


731 ià(
¶c
.
F¡¬t
>0 && !
Ï¡_check_dÚe
 &&

732 (
iz
==
n¡•
-1 || 
äag
[
šdiûs
[iz]].
Fmax
<
¶c
.
F¡İ
))

735 
¡Üex
=
subbox
.
pbc_x
;

736 
¡Üey
=
subbox
.
pbc_y
;

737 
¡Üez
=
subbox
.
pbc_z
;

738 
subbox
.
pbc_x
=subbox.
pbc_y
=subbox.
pbc_z
=0;

740 
Ï¡_check_dÚe
=1;

741 
ig1
=
FILAMENT
+1; ig1<=
ngroups
; ig1++)

744 ià(
groups
[
ig1
].
good
 &&

745 
groups
[
ig1
].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

747 
thisgroup
=
ig1
;

750 
œ•
=0; i»p<
¶c
.
N»¶iÿtiÚs
; irep++)

754 
»¶iÿ‹
[0]=
¶c
.
»¶s
[
œ•
].
i
;

755 
»¶iÿ‹
[1]=
¶c
.
»¶s
[
œ•
].
j
;

756 
»¶iÿ‹
[2]=
¶c
.
»¶s
[
œ•
].
k
;

758 
bb
=
	`cÚd™iÚ_PLC
(
¶c
.
F¡İ
);

761 ià(
bb
==0.0)

763 ià(
	`¡Üe_PLC
(
¶c
.
F¡İ
))

766 ià(
bb
>0.)

770 
¯
=
	`cÚd™iÚ_PLC
(
groups
[
ig1
].
FÏ¡
);

771 ià(
¯
<0.0)

774 iàĞ(
F¶c
=
	`fšd_b»Á
(
groups
[
ig1
].
FÏ¡
,
¶c
.
F¡İ
)) == -99.0)

776 ià(
	`¡Üe_PLC
(
F¶c
))

785 
subbox
.
pbc_x
=
¡Üex
;

786 
subbox
.
pbc_y
=
¡Üey
;

787 
subbox
.
pbc_z
=
¡Üez
;

789 ià(!
ThisTask
)

790 
	`´štf
("[%s] PLC: Last check on groups done, Task 0 stored %d halos (expected:%d)\n",

791 
	`fd©e
(),
¶c
.
N¡Üed
,¶c.
Nmax
);

792 
ıutime
.
¶c
 +ğ
	`MPI_Wtime
()-
ıutmp
;

794 ià(
	`wr™e_PLC
())

805 ià(!
ThisTask
 && !(
iz
%
n¡•_p
))

806 
	`´štf
("[%s] *** %3d%% dÚe, F = %6.2f, z = %6.2f\n",
	`fd©e
(),

807 
iz
/(
n¡•_p
)*5,
äag
[
šdiûs
[iz]].
Fmax
,

810 
äag
[
šdiûs
[
iz
]].
Fmax
-1.0

816 
ig1
=
FILAMENT
+1; ig1<=
ngroups
; ig1++)

817 ià(
groups
[
ig1
].
pošt
 > 0 && groups[ig1].
good
)

818 
couÁ”s
[14]++;

820 
	`MPI_Reduû
(
couÁ”s
, 
®l_couÁ”s
, 
NCOUNTERS
, 
MPI_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

822 ià(!
ThisTask
)

824 
	`´štf
("TÙ®‚umb” oà³aks: %u\n",
®l_couÁ”s
[0]);

825 
	`´štf
("TÙ®‚umb” oàgood h®os: %u\n",
®l_couÁ”s
[14]);

826 
	`´štf
("Particles with N‚eighbouring groups: %u %u %u %u %u %u\n",

827 
®l_couÁ”s
[1],all_counters[2],all_counters[3],

828 
®l_couÁ”s
[4],all_counters[5],all_counters[6]);

829 
	`´štf
("TÙ®‚umb” oàacü‘iÚƒv’ts: %u\n",
®l_couÁ”s
[ 7]);

830 
	`´štf
("Acü‘iÚ befÜev®u©šg m”g”: %u\n",
®l_couÁ”s
[ 8]);

831 
	`´štf
("Acü‘iÚ‡á”ƒv®u©šg m”g”: %u\n",
®l_couÁ”s
[ 9]);

832 
	`´štf
("TÙ®‚umb” oàm”g”ƒv’ts: %u\n",
®l_couÁ”s
[10]);

833 
	`´štf
("TÙ®‚umb” oàmajÜ m”g”ƒv’ts: %u\n",
®l_couÁ”s
[11]);

834 
	`´štf
("TÙ®‚umb” oàfam’ˆ·¹işes: %u\n",
®l_couÁ”s
[12]);

837 #ifdeà
PLC


839 
	`g¦_roÙ_fsŞv”_ä“
 (
sŞv”
);

846 
	}
}

848 
	$ş—n_li¡
(*
¬r
)

850 
i
,
j
,
a
,
dÚe
;

852 
j
=1; j<
NV
; j++)

854 
i
=
j
-1; i>=0; i--)

855 ià(
¬r
[
i
]=÷¼[
j
])

856 
¬r
[
j
]=0;

858 
a
=
¬r
[
j
];

859 
dÚe
=0;

861 
i
=
j
-1; i>=0; i--)

863 ià(
¬r
[
i
]>0)

865 
dÚe
=1;

868 
¬r
[
i
+1]=arr[i];

871 ià(!
dÚe
)

872 
i
=-1;

873 
¬r
[
i
+1]=
a
;

875 
	}
}

878 
	#RMS0
 1.0

	)

880 
	$vœŸl
(
g½
,
F
,
æag
)

884 
r2
,
¾ag
,
sigmaD
;

886 
¾ag
 = 
	`pow
(()
g½
,0.333333333333333);

887 
sigmaD
 = 
	`sq¹
(
SmoÙhšg
.
TrueV¬Ÿnû
[SmoÙhšg.
NsmoÙh
-1]è* 
	`GrowšgMode
(
F
-1.);

889 ià(!
æag
)

891 
r2
 = 
	`pow
Ğ
f_m
 *…ow(
¾ag
, 
e¥o
è* (
sigmaD
>
sigmaD0
 ? 1.0+(sigmaD-sigmaD0)*
f_rm
 : 1.0è, 2.0 ) +…owĞ
f_200
 *„lag, 2.0 );

894 
r2
 = 
	`pow
Ğ
f_a
 *…ow(
¾ag
, 
e¥o
è* (
sigmaD
>
sigmaD0
 ? 1.0+(sigmaD-sigmaD0)*
f_¿
 : 1.0è, 2.0 ) +…owĞ
f_200
 *„lag, 2.0 );

896  
r2
;

897 
	}
}

901 
	$m”ge_groups
(
g½1
,
g½2
,
time
)

905 
i1
;

908 
i1
=
groups
[
g½2
].
pošt
;

909 
lškšg_li¡
[
i1
] !ğ
groups
[
g½2
].
pošt
)

911 
group_ID
[
i1
]=
g½1
;

912 
i1
=
lškšg_li¡
[i1];

914 
group_ID
[
i1
]=
g½1
;

916 
lškšg_li¡
[
groups
[
g½1
].
bÙtom
]=groups[
g½2
].
pošt
;

917 
lškšg_li¡
[
groups
[
g½2
].
bÙtom
]=groups[
g½1
].
pošt
;

918 
groups
[
g½1
].
bÙtom
=groups[
g½2
].bottom;

919 
groups
[
g½2
].
pošt
=-1;

920 
groups
[
g½2
].
bÙtom
=-1;

923 ià(
groups
[
g½1
].
Mass
 >ğ
·¿ms
.
MšH®oMass
 && groups[
g½2
].Mass >=…arams.MinHaloMass)

924 
	`upd©e_hi¡Üy
(
g½1
,
g½2
,
time
);

928 
	`£t_obj
(
g½1
,
time
,&
obj1
);

929 
	`£t_obj
(
g½2
,
time
,&
obj2
);

931 
	`upd©e
(&
obj1
,&
obj2
);

932 
	`£t_group
(
g½1
,&
obj1
);

934 ià(
groups
[
g½1
].
Mass
 >ğ
·¿ms
.
MšH®oMass
 && groups[g½1].
t_­³¬
==-1)

935 
groups
[
g½1
].
t_­³¬
=
time
;

938 
	}
}

941 
	$upd©e_hi¡Üy
(
g1
,
g2
,
time
)

945 
Şd_i
;

948 ià(
groups
[
g1
].
Î
 =ğg1 && groups[
g2
].ll == g2)

950 
groups
[
g1
].
Î
=
g2
;

951 
groups
[
g2
].
Î
=
g1
;

954 ià(
groups
[
g1
].
Î
 !ğg1 && groups[
g2
].ll == g2)

956 
groups
[
g2
].
Î
=
g1
;

957 
Şd_i
=
g1
;

958 
groups
[
Şd_i
].
Î
 !ğ
g1
)

959 
Şd_i
=
groups
[Şd_i].
Î
;

960 
groups
[
Şd_i
].
Î
=
g2
;

963 ià(
groups
[
g1
].
Î
 =ğg1 && groups[
g2
].ll != g2)

965 
Şd_i
=
g2
;

966 
groups
[
Şd_i
].
Î
 !ğ
g2
)

968 
Şd_i
=
groups
[Şd_i].
Î
;

969 
groups
[
Şd_i
].
h®o_­p
=
g1
;

971 
groups
[
g2
].
h®o_­p
=
g1
;

972 
groups
[
g1
].
Î
=groups[
g2
].ll;

973 
groups
[
g2
].
Î
=
g1
;

978 
Şd_i
=
g2
;

979 
groups
[
Şd_i
].
Î
 !ğ
g2
)

981 
Şd_i
=
groups
[Şd_i].
Î
;

982 
groups
[
Şd_i
].
h®o_­p
=
g1
;

984 
Şd_i
=
g1
;

985 
groups
[
Şd_i
].
Î
 !ğ
g1
)

986 
Şd_i
=
groups
[Şd_i].
Î
;

987 
groups
[
Şd_i
].
Î
=groups[
g2
].ll;

988 
groups
[
g2
].
Î
=
g1
;

991 
groups
[
g2
].
h®o_­p
=
g1
;

992 
groups
[
g2
].
t_m”ge
=
time
;

993 
groups
[
g2
].
mass_©_m”g”
=groups[
g1
].
Mass
;

994 
groups
[
g2
].
m”ged_w™h
=
g1
;

995 
	}
}

998 
	$acü‘iÚ
(
group
,
i
,
j
,
k
,
šdx
,
F
)

1002 
	`£t_obj
(
group
,
F
,&
obj1
);

1003 
	`£t_pošt
(
i
,
j
,
k
,
šdx
,
F
,&
obj2
);

1004 
	`upd©e
(&
obj1
,&
obj2
);

1005 
	`£t_group
(
group
,&
obj1
);

1007 ià(
groups
[
group
].
Mass
 >ğ
·¿ms
.
MšH®oMass
 && groups[group].
t_­³¬
==-1)

1008 
groups
[
group
].
t_­³¬
=
F
;

1009 
group_ID
[
šdx
]=
group
;

1013 
lškšg_li¡
[
groups
[
group
].
bÙtom
]=
šdx
;

1014 
groups
[
group
].
bÙtom
=
šdx
;

1015 
lškšg_li¡
[
šdx
]=
groups
[
group
].
pošt
;

1016 
	}
}

1021 
	$cÚd™iÚ_fÜ_acü‘iÚ
(
i
,
j
,
k
,
šd
,
Fmax
, 
g½
,*
dd
,*
¼
)

1025 
dx
=0,
dy
=0,
dz
=0,
d2
;

1029 *
¼
=
	`vœŸl
(
groups
[
g½
].
Mass
,
Fmax
,1);

1030 *
dd
=100.* *
¼
;

1032 
	`£t_pošt
(
i
,
j
,
k
,
šd
,
Fmax
,&
obj1
);

1033 
	`£t_obj
(
g½
,
Fmax
,&
obj2
);

1035 
dy
=
dz
=0.0;

1037 
dx
=
	`di¡ªû
(0,&
obj1
,&
obj2
);

1039 
d2
=
dx
*dx;

1040 ià(
d2
<*
¼
)

1042 
dy
=
	`di¡ªû
(1,&
obj1
,&
obj2
);

1043 
d2
+=
dy
*dy;

1044 ià(
d2
<*
¼
)

1046 
dz
=
	`di¡ªû
(2,&
obj1
,&
obj2
);

1047 
d2
+=
dz
*dz;

1048 ià(
d2
<=*
¼
)

1049 *
dd
=
d2
;

1053 
	}
}

1056 
	$cÚd™iÚ_fÜ_m”gšg
(
Fmax
,
g½1
,
g½2
,*
m”ge_æag
)

1060 
rvœ1
,
rvœ2
,
dd
,
¼
,
dx
,
dy
,
dz
;

1062 *
m”ge_æag
=0;

1063 
rvœ1
=
	`vœŸl
(
groups
[
g½1
].
Mass
,
Fmax
,0);

1064 
rvœ2
=
	`vœŸl
(
groups
[
g½2
].
Mass
,
Fmax
,0);

1065 
¼
=(
rvœ1
>
rvœ2
 ?„vir1 :„vir2);

1068 
	`£t_obj
(
g½1
,
Fmax
,&
obj1
);

1069 
	`£t_obj
(
g½2
,
Fmax
,&
obj2
);

1071 
dx
=
	`di¡ªû
(0,&
obj1
,&
obj2
);

1072 
dd
=
dx
*dx;

1073 ià(
dd
<
¼
)

1075 
dy
=
	`di¡ªû
(1,&
obj1
,&
obj2
);

1076 
dd
+=
dy
*dy;

1077 ià(
dd
<
¼
)

1079 
dz
=
	`di¡ªû
(2,&
obj1
,&
obj2
);

1080 
dd
+=
dz
*dz;

1081 ià(
dd
<=
¼
)

1082 *
m”ge_æag
=1;

1085 
	}
}

1091 
	$£t_obj
(
g½
,
F
,
pos_d©a
 *
myobj
)

1093 
i
;

1095 
myobj
->
M
=
groups
[
g½
].
Mass
;

1096 
i
=0;i<3;i++)

1098 
myobj
->
q
[
i
]=
groups
[
g½
].
Pos
[i];

1099 
myobj
->
v
[
i
]=
groups
[
g½
].
V–
[i];

1100 #ifdeà
TWO_LPT


1101 
myobj
->
v2
[
i
]=
groups
[
g½
].
V–_2LPT
[i];

1102 #ifdeà
THREE_LPT


1103 
myobj
->
v31
[
i
]=
groups
[
g½
].
V–_3LPT_1
[i];

1104 
myobj
->
v32
[
i
]=
groups
[
g½
].
V–_3LPT_2
[i];

1109 #ifdeà
SCALE_DEPENDENT_GROWTH


1110 
SDGM
.
æag
=1;

1111 
SDGM
.
ismoÙh
=-1;

1112 
SDGM
.
¿dius
=
	`pow
(
myobj
->
M
,1./3.)*
·¿ms
.
IÁ”P¬tDi¡
;

1118 
myobj
->
z
=
F
-1.0;

1119 
myobj
->
D
=
	`GrowšgMode
(myobj->
z
);

1120 #ifdeà
TWO_LPT


1121 
myobj
->
D2
=
	`GrowšgMode_2LPT
(myobj->
z
);

1122 #ifdeà
THREE_LPT


1123 
myobj
->
D31
=
	`GrowšgMode_3LPT_1
(myobj->
z
);

1124 
myobj
->
D32
=
	`GrowšgMode_3LPT_2
(myobj->
z
);

1128 
	}
}

1130 
	$£t_pošt
(
i
,
j
,
k
,
šd
,
F
,
pos_d©a
 *
myobj
)

1132 #ifdeà
SCALE_DEPENDENT_GROWTH


1133 
SDGM
.
æag
=1;

1134 
SDGM
.
ismoÙh
=
äag
[
šd
].
Rmax
;

1139 
myobj
->
z
=
F
-1.0;

1140 
myobj
->
D
=
	`GrowšgMode
(myobj->
z
);

1141 
myobj
->
M
=1;

1142 
myobj
->
q
[0]=
i
+
SHIFT
;

1143 
myobj
->
q
[1]=
j
+
SHIFT
;

1144 
myobj
->
q
[2]=
k
+
SHIFT
;

1145 
myobj
->
v
[0]=
äag
[
šd
].
Vmax
[0];

1146 
myobj
->
v
[1]=
äag
[
šd
].
Vmax
[1];

1147 
myobj
->
v
[2]=
äag
[
šd
].
Vmax
[2];

1148 #ifdeà
TWO_LPT


1149 
myobj
->
v2
[0]=
äag
[
šd
].
Vmax_2LPT
[0];

1150 
myobj
->
v2
[1]=
äag
[
šd
].
Vmax_2LPT
[1];

1151 
myobj
->
v2
[2]=
äag
[
šd
].
Vmax_2LPT
[2];

1152 
myobj
->
D2
=
	`GrowšgMode_2LPT
(myobj->
z
);

1153 #ifdeà
THREE_LPT


1154 
myobj
->
v31
[0]=
äag
[
šd
].
Vmax_3LPT_1
[0];

1155 
myobj
->
v31
[1]=
äag
[
šd
].
Vmax_3LPT_1
[1];

1156 
myobj
->
v31
[2]=
äag
[
šd
].
Vmax_3LPT_1
[2];

1157 
myobj
->
v32
[0]=
äag
[
šd
].
Vmax_3LPT_2
[0];

1158 
myobj
->
v32
[1]=
äag
[
šd
].
Vmax_3LPT_2
[1];

1159 
myobj
->
v32
[2]=
äag
[
šd
].
Vmax_3LPT_2
[2];

1160 
myobj
->
D31
=
	`GrowšgMode_3LPT_1
(myobj->
z
);

1161 
myobj
->
D32
=
	`GrowšgMode_3LPT_2
(myobj->
z
);

1164 
	}
}

1167 
	$£t_group
(
g½
,
pos_d©a
 *
myobj
)

1169 
i
;

1171 
groups
[
g½
].
Mass
=
myobj
->
M
;

1172 
i
=0;i<3;i++)

1174 
groups
[
g½
].
Pos
[
i
]=
myobj
->
q
[i];

1175 
groups
[
g½
].
V–
[
i
]=
myobj
->
v
[i];

1176 #ifdeà
TWO_LPT


1177 
groups
[
g½
].
V–_2LPT
[
i
]=
myobj
->
v2
[i];

1178 #ifdeà
THREE_LPT


1179 
groups
[
g½
].
V–_3LPT_1
[
i
]=
myobj
->
v31
[i];

1180 
groups
[
g½
].
V–_3LPT_2
[
i
]=
myobj
->
v32
[i];

1184 
	}
}

1187 
	$q2x
(
i
,
pos_d©a
 *
myobj
,
Üd”
)

1192 
p
;

1193 
L
,
pos
;

1195 
pos
 = 
myobj
->
q
[
i
] + myobj->
v
[i]*myobj->
D
;

1196 #ifdeà
TWO_LPT


1197 ià(
Üd”
>1)

1198 
pos
 +ğ
myobj
->
D2
*myobj->
v2
[
i
];

1199 #ifdeà
THREE_LPT


1200 ià(
Üd”
>2)

1201 
pos
 +ğ
myobj
->
D31
*myobj->
v31
[
i
] + myobj->
D32
*myobj->
v32
[i];

1205 
i
)

1208 
p
=
subbox
.
pbc_x
;

1209 
L
=()
subbox
.
Lgwbl_x
;

1212 
p
=
subbox
.
pbc_y
;

1213 
L
=()
subbox
.
Lgwbl_y
;

1216 
p
=
subbox
.
pbc_z
;

1217 
L
=()
subbox
.
Lgwbl_z
;

1221 ià(
p
)

1223 ià(
pos
>=
L
)…os-=L;

1224 ià(
pos
<0èpos+=
L
;

1227  
pos
;

1228 
	}
}

1232 
	$v–
(
i
,
pos_d©a
 *
myobj
)

1235 
vv
,
çc
;

1237 
çc
=
	`HubbË
(
myobj
->
z
)/(1.+myobj->z)*
·¿ms
.
IÁ”P¬tDi¡
;

1238 
vv
 = 
myobj
->
v
[
i
] * 
çc
 * 
	`fomega
(myobj->
z
è* myobj->
D
;

1239 #ifdeà
TWO_LPT


1240 
vv
 +ğ
myobj
->
v2
[
i
] * 
çc
 * 
	`fomega_2LPT
(myobj->
z
è* myobj->
D2
;

1241 #ifdeà
THREE_LPT


1242 
vv
 +ğ
myobj
->
v31
[
i
] * 
çc
 * 
	`fomega_3LPT_1
(myobj->
z
è* myobj->
D31


1243 + 
myobj
->
v32
[
i
] * 
çc
 * 
	`fomega_3LPT_2
(myobj->
z
è* myobj->
D32
;

1247  
vv
;

1248 
	}
}

1251 
	$di¡ªû
(
i
,
pos_d©a
 *
obj1
,pos_d©¨*
obj2
)

1253 
d
,
L
;

1254 
p
;

1256 
i
)

1259 
p
=
subbox
.
pbc_x
;

1260 
L
=()
subbox
.
Lgwbl_x
;

1263 
p
=
subbox
.
pbc_y
;

1264 
L
=()
subbox
.
Lgwbl_y
;

1267 
p
=
subbox
.
pbc_z
;

1268 
L
=()
subbox
.
Lgwbl_z
;

1273 
d
=
	`q2x
(
i
,
obj2
,
ORDER_FOR_GROUPS
)-q2x(i,
obj1
,ORDER_FOR_GROUPS);

1275 ià(
p
)

1277 ià(
d
 > 
L
/2) d -= L;

1278 ià(
d
 < -
L
/2.) d += L;

1281  
d
;

1282 
	}
}

1288 
	$upd©e
(
pos_d©a
 *
obj1
,…os_d©¨*
obj2
)

1292 
d
,
L
;

1293 
i
,
p
;

1295 
i
=0;i<3;i++)

1297 
i
)

1300 
p
=
subbox
.
pbc_x
;

1301 
L
=()
subbox
.
Lgwbl_x
;

1304 
p
=
subbox
.
pbc_y
;

1305 
L
=()
subbox
.
Lgwbl_y
;

1308 
p
=
subbox
.
pbc_z
;

1309 
L
=()
subbox
.
Lgwbl_z
;

1313 
d
 = 
	`çbs
(
obj1
->
q
[
i
] - 
obj2
->q[i]);

1314 ià(!
p
)

1315 
obj1
->
q
[
i
] = (obj1->q[i]*obj1->
M
 + 
obj2
->q[i]*obj2->M)/()(obj1->M + obj2->M);

1319 ià(
d
 <ğ
L
/2.)

1321 
obj1
->
q
[
i
] = (obj1->q[i]*obj1->
M
 + 
obj2
->q[i]*obj2->M)/()(obj1->M + obj2->M);

1322 ià(
obj1
->
q
[
i
] > 
L
/2)

1324 
obj1
->
q
[
i
] = (obj1->q[i]*obj1->
M
+(
obj2
->q[i]+
L
)*obj2->M)/()(obj1->M+obj2->M);

1327 
obj1
->
q
[
i
] = (obj1->q[i]*obj1->
M
+(
obj2
->q[i]-
L
)*obj2->M)/()(obj1->M+obj2->M);

1330 ià(
p
 && 
obj1
->
q
[
i
]>
L
) obj1->q[i]-=L;

1331 ià(
p
 && 
obj1
->
q
[
i
]<0èobj1->q[i]+=
L
;

1335 
obj1
->
v
[
i
] = (obj1->v[i]*obj1->
M
 + 
obj2
->v[i]*obj2->M)/()(obj1->M + obj2->M);

1336 #ifdeà
TWO_LPT


1337 
obj1
->
v2
[
i
] = (obj1->v2[i]*obj1->
M
 + 
obj2
->v2[i]*obj2->M)/()(obj1->M + obj2->M);

1338 #ifdeà
THREE_LPT


1339 
obj1
->
v31
[
i
] = (obj1->v31[i]*obj1->
M
 + 
obj2
->v31[i]*obj2->M)/()(obj1->M + obj2->M);

1340 
obj1
->
v32
[
i
] = (obj1->v32[i]*obj1->
M
 + 
obj2
->v32[i]*obj2->M)/()(obj1->M + obj2->M);

1346 
obj1
->
M
+=
obj2
->M;

1349 
	}
}

1351 #ifdeà
PLC


1352 
	#MAX_ITER
 100

	)

1355 
	$cÚd™iÚ_F
(
F
, *
p
)

1357  
	`cÚd™iÚ_PLC
(
F
);

1358 
	}
}

1360 
	$cÚd™iÚ_PLC
(
F
)

1364 
i
;

1365 
diff1
,
cÚd™iÚ
;

1367 
	`£t_obj
(
thisgroup
,
F
,&
obj1
);

1369 
i
=0, 
cÚd™iÚ
=0.0; i<3; i++)

1372 
diff1
 = 
	`q2x
(
i
,&
obj1
,
ORDER_FOR_CATALOG
è+ 
¡¬t
[i] - ( 
¶c
.
ûÁ”
[i] -

1373 
Lgrid
[
i
]*
»¶iÿ‹
[i] );

1374 
cÚd™iÚ
+=
diff1
*diff1;

1378 
cÚd™iÚ
 = 
	`sq¹
(cÚd™iÚè- 
	`Prİ”Di¡ªû
(
F
-1.0)/
·¿ms
.
IÁ”P¬tDi¡
;

1380  
cÚd™iÚ
;

1381 
	}
}

1384 
	$¡Üe_PLC
(
F
)

1386 
i
,
ii
;

1388 ià(
¶c
.
N¡Üed
=õlc.
Nmax
)

1390 
	`´štf
("ERROR oÀsk %d: PLC couÁ ov”shoÙed\n",
ThisTask
);

1391 
	`´štf
("Fragmentation will continue without PLC„econstruction\n");

1392 
	`fæush
(
¡dout
);

1393 
¶c
.
F¡¬t
õlc.
F¡İ
=-1;

1397 
	`£t_obj
(
thisgroup
,
F
,&
obj1
);

1401 
¶cgroups
[
¶c
.
N¡Üed
].
z
 = 
F
-1.0;

1402 
¶cgroups
[
¶c
.
N¡Üed
].
Mass
 = 
groups
[
thisgroup
].Mass;

1403 
¶cgroups
[
¶c
.
N¡Üed
].
Çme
 = 
groups
[
thisgroup
].name;

1405 
i
=0; i<3; i++)

1407 #ifdeà
ROTATE_BOX


1408 
ii
=
i
-1;

1409 ià(
ii
==-1)

1410 
ii
=2;

1412 
ii
=
i
;

1415 
¶cgroups
[
¶c
.
N¡Üed
].
x
[
ii
] = 
·¿ms
.
IÁ”P¬tDi¡
 *

1416 Ğ
	`q2x
(
i
,&
obj1
,
ORDER_FOR_CATALOG
è+ 
¡¬t
[i] - ( 
¶c
.
ûÁ”
[i] - 
Lgrid
[i]*
»¶iÿ‹
[i] ) );

1417 
¶cgroups
[
¶c
.
N¡Üed
].
v
[
ii
] = 
	`v–
(
i
,&
obj1
);

1421 
¶c
.
N¡Üed
++;

1424 
	}
}

1467 
	$fšd_b»Á
(
x_hi
, 
x_lo
)

1469 
™”
, 
¡©us
;

1470 
r
;

1472 
	`g¦_roÙ_fsŞv”_£t
 (
sŞv”
, &
cPLC
, 
x_lo
, 
x_hi
);

1474 
™”
=0;

1477 
™”
++;

1478 
¡©us
 = 
	`g¦_roÙ_fsŞv”_™”©e
 (
sŞv”
);

1479 
r
 = 
	`g¦_roÙ_fsŞv”_roÙ
 (
sŞv”
);

1480 
x_lo
 = 
	`g¦_roÙ_fsŞv”_x_low”
 (
sŞv”
);

1481 
x_hi
 = 
	`g¦_roÙ_fsŞv”_x_uµ”
 (
sŞv”
);

1486 ià(
	`çbs
(
	`cÚd™iÚ_PLC
(
r
)è< 
b»Á_”r
)

1487  
r
;

1489 
¡©us
=
GSL_CONTINUE
;

1492 
¡©us
 =ğ
GSL_CONTINUE
 && 
™”
 < 
MAX_ITER
);

1494 
	`´štf
("ERROR oÀsk %d: fšd_b»Á could‚Ù cÚv”ge\n",
ThisTask
);

1497 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/cosmo.c

27 
	~"pšocchio.h
"

29 
	#NVAR
 5

	)

30 
	#NBIN
 210

	)

31 #ifdeà
NORADIATION


32 
	#OMEGARAD_H2
 (()0.0)

	)

34 
	#OMEGARAD_H2
 (()4.2e-5)

	)

36 
	#TOLERANCE
 (()1.e-4)

	)

37 
	#Un™L’gth_š_cm
 (()3.085678e24)

	)

38 
	#Sh­eGamma
 (()0.21)

	)

39 
	#HUBBLETIME_GYR
 (()3.085678e24/()1.e7/()3.1558150e16)

	)

40 
	#DELTA_C
 (()1.686)

	)

44 
	gWhichS³ùrum
, 
	gNPow”TabË
=0, 
	gNbEoS
=0;;

45 
	gPkNÜm
, 
	gM©‹rD’s™y
, 
	gOmegaK
, 
	gOmegaRad
;

48 
g¦_funùiÚ
 
	gFunùiÚ
;

50 
g¦_¥lše
 *
	g¥lšeGrow
=0x0, *
	g¥lšeGrow2
=0x0,*
	g¥lšeGrow31
=0x0,*
	g¥lšeGrow32
=0x0, *
	g¥lšeTime
=0x0,

51 *
	g¥lšeEoS
=0x0, *
	g¥lšePk
=0x0, *
	g¥lšeV¬
=0x0, *
	g¥lšeInvGrow
=0x0,

52 *
	g¥lšeInvTime
=0x0, *
	g¥lšeDi¡
=0x0, *
	g¥lšeInvDi¡
=0x0, *
	g¥lšedrdz
=0x0,

53 *
	g¥lšeRadius
=0x0, *
	g¥lšefO
=0x0, *
	g¥lšefO2
=0x0,*
	g¥lšefO31
=0x0,*
	g¥lšefO32
=0x0, *
	g¥lšedldr
=0x0,

54 *
	g¥lšeIÁEoS
=0x0, *
	g¥lšeDV¬
=0x0;

55 
g¦_š‹½_acûl
 *
	gacûl
=0x0, *
	gacûlPk
=0x0, *
	gacûlEoS
=0x0;

57 #ifdeà
SCALE_DEPENDENT_GROWTH


58 
g¦_¥lše
 *
	g¥lšeGrowCAMB
=0x0, *
	g¥lšeInvGrowCAMB
=0x0;

59 
g¦_š‹½_acûl
 *
	gacûlCAMB
=0x0;

62 
sy¡em_of_ODEs
(, const [], *, * );

63 
jac
(, const [], *, [], *);

64 
»ad_TabuÏ‹dEoS
();

65 
š™Ÿlize_Pow”S³ùrum
();

66 
nÜm®ize_Pow”S³ùrum
();

67 
IÁeg¿ndFÜEoS
(, *);

68 
DE_Equ©iÚOfS‹
();

69 
IÁeg¿ndPrİ”Di¡ªû
(, *);

70 
Compu‹MassV¬Ÿnû
();

71 
Compu‹Di¥lV¬Ÿnû
();

78 
	$š™Ÿlize_cosmŞogy
()

87 
ode_·¿m
;

88 
y
[
NVAR
], 
x1
, 
x2
, 
hh
, 
h1
, 
nÜm
, 
k
, 
»suÉ
, 
”rÜ
, 
Sq¹OmegaK
;

89 
¡©us
=
GSL_SUCCESS
, 
i
, 
i1
, 
i2
;

90 
f’ame
[
BLENGTH
];

91 
FILE
 *
fd
;

92 
log_amš
=-4.,
log_amax
=0.2, 
dloga
;

94 *
sÿËf
, *
cosmtime
, *
grow1
, *
grow2
, *
IÁEoS
, *
´di¡
, *
´di¡Ãg
, *
d´di¡
,

95 *
fomegav
, *
fomega2v
, *
grow31
, *
grow32
, *
fomega31v
, *
fomega32v
;

97 cÚ¡ 
g¦_odeiv_¡•_ty³
 *
T
 = 
g¦_odeiv_¡•_rkf45
;

98 
g¦_odeiv_¡•
 *
ode_s
 = 
	`g¦_odeiv_¡•_®loc
(
T
,
NVAR
);

99 
g¦_odeiv_cÚŒŞ
 *
ode_c
 = 
	`g¦_odeiv_cÚŒŞ_¡ªd¬d_Ãw
(1.0e-8, 1.0e-8, 1.0, 1.0);

100 
g¦_odeiv_evŞve
 *
ode_e
 = 
	`g¦_odeiv_evŞve_®loc
(
NVAR
);

101 
g¦_odeiv_sy¡em
 
ode_sys
 = {
sy¡em_of_ODEs
, 
jac
, 
NVAR
, (*)&
ode_·¿m
};

103 
g¦_¥lše
 *
¥lše
=0x0;

105 
dloga
=(
log_amax
-
log_amš
)/()
NBIN
;

107 
OmegaRad
 = 
OMEGARAD_H2
 / 
·¿ms
.
HubbË100
 /…arams.Hubble100;

108 
OmegaK
 = 1.0-
·¿ms
.
Omega0
 -…¬ams.
OmegaLambda
 - 
OmegaRad
;

109 
Sq¹OmegaK
 = 
	`sq¹
(
	`çbs
(
OmegaK
));

110 
M©‹rD’s™y
 = 2.775499745e11 * 
·¿ms
.
HubbË100
 *…¬ams.HubbË100 *…¬ams.
Omega0
;

111 ià(
·¿ms
.
DEw0
==-1 &&…¬ams.
DEwa
==0 && 
	`¡rcmp
Õ¬ams.
TabuÏ‹dEoSfe
,"no"))

112 
·¿ms
.
sim¶eLambda
=1;

114 
·¿ms
.
sim¶eLambda
=0;

117 
¥lšeGrow
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

118 
¥lšeInvGrow
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

119 
¥lšeGrow2
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

120 
¥lšeGrow31
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

121 
¥lšeGrow32
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

122 
¥lšefO
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

123 
¥lšefO2
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

124 
¥lšefO31
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

125 
¥lšefO32
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

126 ià(!
·¿ms
.
sim¶eLambda
)

127 
¥lšeIÁEoS
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

128 
¥lšeTime
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

129 
¥lšeInvTime
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

130 
¥lšeDi¡
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

131 
¥lšeInvDi¡
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

132 
¥lšedrdz
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

133 
¥lšeV¬
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

134 
¥lšeDV¬
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

135 
¥lšeRadius
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

136 
¥lšedldr
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

137 
acûl
 = 
	`g¦_š‹½_acûl_®loc
 ();

140 ià(
	`¡rcmp
(
·¿ms
.
TabuÏ‹dEoSfe
,"no"))

141 ià(
	`»ad_TabuÏ‹dEoS
())

145 
sÿËf
 = (*)
	`m®loc
(
NBIN
 * ());

146 
cosmtime
 = (*)
	`m®loc
(
NBIN
 * ());

147 
grow1
 = (*)
	`m®loc
(
NBIN
 * ());

148 
grow2
 = (*)
	`m®loc
(
NBIN
 * ());

149 
grow31
 = (*)
	`m®loc
(
NBIN
 * ());

150 
grow32
 = (*)
	`m®loc
(
NBIN
 * ());

151 
´di¡
 = (*)
	`m®loc
(
NBIN
 * ());

152 
´di¡Ãg
 = (*)
	`m®loc
(
NBIN
 * ());

153 
d´di¡
 = (*)
	`m®loc
(
NBIN
 * ());

154 
fomegav
 = (*)
	`m®loc
(
NBIN
 * ());

155 
fomega2v
 = (*)
	`m®loc
(
NBIN
 * ());

156 
fomega31v
 = (*)
	`m®loc
(
NBIN
 * ());

157 
fomega32v
 = (*)
	`m®loc
(
NBIN
 * ());

158 ià(!
·¿ms
.
sim¶eLambda
)

159 
IÁEoS
 = (*)
	`m®loc
(
NBIN
 * ());

163 ià(!
·¿ms
.
sim¶eLambda
)

165 
FunùiÚ
.
funùiÚ
 = &
IÁeg¿ndFÜEoS
;

166 
i
=0; i<
NBIN
; i++)

168 
x2
=
	`pow
(10., 
log_amš
 + (
i
+1)*
dloga
);

169 
	`g¦_š‹g¿tiÚ_qags
(&
FunùiÚ
, 
x2
, 1.0, 0.0, 
TOLERANCE
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

170 
sÿËf
[
i
] = 
log_amš
 + (i+1)*
dloga
;

171 
IÁEoS
[
i
] = 
»suÉ
;

173 
	`g¦_¥lše_š™
(
¥lšeIÁEoS
, 
sÿËf
, 
IÁEoS
, 
NBIN
);

177 
x1
=1.e-6;

178 
y
[0]=1.0;

179 
y
[1]=
x1
;

180 
y
[2]=2.0/3.0*
	`pow
(
x1
,1.5);

181 
y
[3]=-6./7.*
x1
;

182 
y
[4]=-3./7.*
x1
*x1;

183 
h1
=1.e-6;

184 
hh
=
h1
;

187 
FunùiÚ
.
funùiÚ
 = &
IÁeg¿ndPrİ”Di¡ªû
;

190 
i
=0; i<
NBIN
; i++)

192 
x2
=
	`pow
(10., 
log_amš
 + 
i
*
dloga
);

195 
x1
<
x2
 && 
¡©us
==
GSL_SUCCESS
)

197 
¡©us
=
	`g¦_odeiv_evŞve_­¶y
(
ode_e
, 
ode_c
, 
ode_s
, &
ode_sys
, &
x1
, 
x2
, &
hh
, 
y
);

198 ià(
¡©us
!=
GSL_SUCCESS
)

200 
	`´štf
("ERROR oÀsk %d: iÁeg¿tiÚ oàcosmŞogiÿÈquªt™› çed\n",
ThisTask
);

201 
	`fæush
(
¡dout
);

206 
sÿËf
[
i
] = 
x2
;

207 
cosmtime
[
i
] = 
y
[2]*
HUBBLETIME_GYR
/
·¿ms
.
HubbË100
;

208 
grow1
[
i
] = 
y
[1];

209 
grow2
[
i
] = -
y
[4];

214 
	`g¦_š‹g¿tiÚ_qags
(&
FunùiÚ
, 0.0, 1./
x2
-1., 0.0, 
TOLERANCE
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

216 ià(
	`çbs
(
OmegaK
) < 1.e-4)

217 
´di¡
[
i
] = 
SPEEDOFLIGHT
*
»suÉ
/(
·¿ms
.
HubbË100
*100.);

219 if(
OmegaK
 <0)

220 
´di¡
[
i
] = 
SPEEDOFLIGHT
/(
·¿ms
.
HubbË100
*100.)/
Sq¹OmegaK
*
	`sš
(Sq¹OmegaK*
»suÉ
);

223 
´di¡
[
i
]=
SPEEDOFLIGHT
/(
·¿ms
.
HubbË100
*100.)/
Sq¹OmegaK
*
	`sšh
(Sq¹OmegaK*
»suÉ
);

225 
x1
=
x2
;

230 
¥lše
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
NBIN
);

231 
	`g¦_¥lše_š™
(
¥lše
, 
sÿËf
, 
grow1
, 
NBIN
);

232 
nÜm
=
	`my_¥lše_ev®
(
¥lše
, 1.00, 
acûl
);

233 
i
=0; i<
NBIN
; i++)

235 
grow1
[
i
] = grow1[i] / 
nÜm
;

236 
grow2
[
i
] = grow2[i] / 
nÜm
/norm;

237 
grow31
[
i
] = 
grow1
[i]*grow1[i]*grow1[i]*
	`pow
(
·¿ms
.
Omega0
,-4./275.)/9.;

238 
grow32
[
i
] = 
grow1
[i]*grow1[i]*grow1[i]*
	`pow
(
·¿ms
.
Omega0
,-269./17875.)*5./42.;

240 
	`g¦_¥lše_ä“
(
¥lše
);

243 
i
=0; i<
NBIN
; i++)

245 
i1
=(
i
>0 ? i-1 : 0);

246 
i2
=(
i
<
NBIN
-1 ? i+1 : NBIN-1);

247 
fomegav
[
i
] = (
grow1
[
i2
]-grow1[
i1
]è/ (
sÿËf
[i2]-scalef[i1]) * scalef[i] / grow1[i];

248 
fomega2v
[
i
]ğ(
grow2
[
i2
]-grow2[
i1
]è/ (
sÿËf
[i2]-scalef[i1]) * scalef[i] / grow2[i];

249 
fomega31v
[
i
] = (
grow31
[
i2
]-grow31[
i1
]è/ (
sÿËf
[i2]-scalef[i1]) * scalef[i] / grow31[i];

250 
fomega32v
[
i
]ğ(
grow32
[
i2
]-grow32[
i1
]è/ (
sÿËf
[i2]-scalef[i1]) * scalef[i] / grow32[i];

254 
i
=0; i<
NBIN
; i++)

256 
´di¡Ãg
[
i
]=-
´di¡
[i];

257 
i1
=(
i
>0 ? i-1 : 0);

258 
i2
=(
i
<
NBIN
-1 ? i+1 : NBIN-1);

259 
d´di¡
[
i
]=(
´di¡
[
i2
]-´di¡[
i1
])/(1./
sÿËf
[i2]-1./scalef[i1]);

263 
i
=0; i<
NBIN
; i++)

265 
sÿËf
[
i
] = 
	`log10
(scalef[i] );

266 
cosmtime
[
i
] = 
	`log10
(cosmtime[i]);

267 
grow1
[
i
] = 
	`log10
(grow1[i] );

268 
grow2
[
i
] = 
	`log10
(grow2[i] );

269 
grow31
[
i
] = 
	`log10
(grow31[i] );

270 
grow32
[
i
] = 
	`log10
(grow32[i] );

274 
	`g¦_¥lše_š™
(
¥lšeGrow
, 
sÿËf
, 
grow1
, 
NBIN
);

275 
	`g¦_¥lše_š™
(
¥lšeInvGrow
, 
grow1
, 
sÿËf
, 
NBIN
);

276 
	`g¦_¥lše_š™
(
¥lšeGrow2
, 
sÿËf
, 
grow2
, 
NBIN
);

277 
	`g¦_¥lše_š™
(
¥lšeGrow31
, 
sÿËf
, 
grow31
, 
NBIN
);

278 
	`g¦_¥lše_š™
(
¥lšeGrow32
, 
sÿËf
, 
grow32
, 
NBIN
);

279 
	`g¦_¥lše_š™
(
¥lšefO
, 
sÿËf
, 
fomegav
, 
NBIN
);

280 
	`g¦_¥lše_š™
(
¥lšefO2
, 
sÿËf
, 
fomega2v
, 
NBIN
);

281 
	`g¦_¥lše_š™
(
¥lšefO31
, 
sÿËf
, 
fomega31v
, 
NBIN
);

282 
	`g¦_¥lše_š™
(
¥lšefO32
, 
sÿËf
, 
fomega32v
, 
NBIN
);

283 
	`g¦_¥lše_š™
(
¥lšeTime
, 
sÿËf
, 
cosmtime
, 
NBIN
);

284 
	`g¦_¥lše_š™
(
¥lšeInvTime
, 
cosmtime
, 
sÿËf
, 
NBIN
);

285 
	`g¦_¥lše_š™
(
¥lšeDi¡
, 
sÿËf
, 
´di¡
, 
NBIN
);

286 
	`g¦_¥lše_š™
(
¥lšeInvDi¡
, 
´di¡Ãg
, 
sÿËf
, 
NBIN
);

287 
	`g¦_¥lše_š™
(
¥lšedrdz
, 
sÿËf
, 
d´di¡
, 
NBIN
);

291 ià(!
·¿ms
.
sim¶eLambda
)

292 
	`ä“
(
IÁEoS
 );

293 
	`ä“
(
fomega2v
);

294 
	`ä“
(
fomegav
 );

295 
	`ä“
(
d´di¡
 );

296 
	`ä“
(
´di¡Ãg
);

297 
	`ä“
(
´di¡
 );

298 
	`ä“
(
grow2
 );

299 
	`ä“
(
grow1
 );

300 
	`ä“
(
grow32
 );

301 
	`ä“
(
grow31
 );

302 
	`ä“
(
cosmtime
);

303 
	`ä“
(
sÿËf
 );

306 ià(
	`š™Ÿlize_Pow”S³ùrum
())

310 
WšdowFunùiÚTy³
=0;

311 ià(
	`š™Ÿlize_MassV¬Ÿnû
())

315 ià(!
ThisTask
)

318 
	`¡rıy
(
f’ame
,"pinocchio.");

319 
	`¡rÿt
(
f’ame
,
·¿ms
.
RunFÏg
);

320 
	`¡rÿt
(
f’ame
,".cosmology.out");

322 
fd
=
	`fİ’
(
f’ame
,"w");

324 
	`årštf
(
fd
,"# CosmŞogiÿÈquªt™› u£d iÀPINOCCHIO (h=%f)\n",
·¿ms
.
HubbË100
);

325 
	`årštf
(
fd
,"# TIME-DEPENDENT QUANTITIES\n");

326 
	`årštf
(
fd
,"# 1: scale factor\n");

327 
	`årštf
(
fd
,"# 2: cosmicime (Gyr)\n");

328 
	`årštf
(
fd
,"# 3: growth factor\n");

329 
	`årštf
(
fd
,"# 4: 2nd-order growth factor\n");

330 
	`årštf
(
fd
,"# 5: darkƒnergy EOS\n");

331 
	`årštf
(
fd
,"# 6:…roper distance (true Mpc)\n");

332 
	`årštf
(
fd
,"# 7: d/dz of…roper distance (true Mpc)\n");

333 
	`årštf
(
fd
,"# SCALE-DEPENDENT QUANTITIES\n");

334 
	`årštf
(
fd
,"# 8: scale (true Mpc)\n");

335 
	`årštf
(
fd
,"# 9: mass variance\n");

336 
	`årštf
(
fd
,"#10: d Log sigma^2 / d Log R\n");

337 
	`årštf
(
fd
,"#11: k (true Mpc^-1)\n");

338 
	`årštf
(
fd
,"#12: P(k)\n");

339 
	`årštf
(
fd
,"#\n");

340 
i
=0; i<
NBIN
; i++)

342 
k
=
	`pow
(10.,-4.0+()
i
/()
NBIN
*6.0);

343 
	`årštf
(
fd
," %lg %lg %lg %lg %lg %lg %lg %lg %lg %lg %lg %lg %lg %lg\n",

344 
	`pow
(10.,
¥lšeGrow
->
x
[
i
]),

345 
	`pow
(10.,
¥lšeTime
->
y
[
i
]),

346 
	`pow
(10.,
¥lšeGrow
->
y
[
i
]),

347 -
	`pow
(10.,
¥lšeGrow2
->
y
[
i
]),

348 (!
·¿ms
.
sim¶eLambda
 ? -1 : 
¥lšeEoS
->
y
[
i
]),

349 
¥lšeDi¡
->
y
[
i
],

350 
¥lšedrdz
->
y
[
i
],

351 
	`pow
(10.,
¥lšeV¬
->
x
[
i
]),

352 
	`pow
(10.,
¥lšeV¬
->
y
[
i
]),

353 
	`pow
(10.,
¥lšedldr
->
y
[
i
]),

354 
k
,
	`Pow”S³ùrum
(k),

355 
	`pow
(10.,
¥lšeDV¬
->
x
[
i
]),pow(10.,¥lšeDV¬->
y
[i]));

357 
	`fşo£
(
fd
);

361 
	}
}

364 
	$sy¡em_of_ODEs
(
x
, cÚ¡ 
y
[], *
dydx
, *
·¿m
)

367 
a1
, 
b1
, 
Esq
, 
eqds
;

372 ià(
·¿ms
.
sim¶eLambda
)

374 
Esq
 = 
·¿ms
.
Omega0
/
	`pow
(
x
,3.0)

375 + 
OmegaK
/(
x
*x)

376 + 
·¿ms
.
OmegaLambda


377 + 
OmegaRad
/
	`pow
(
x
,4.0);

378 
a1
 = -(3./
x
 + 1./2.*((- 3.*
·¿ms
.
Omega0
/
	`pow
(x,4.0)

379 - 2*
OmegaK
/
	`pow
(
x
,3.0)

380 - 4*
OmegaRad
/
	`pow
(
x
,5.0))/
Esq
));

381 
b1
 = 3./2.*
·¿ms
.
Omega0
/(
Esq
*
	`pow
(
x
,5.0));

386 
eqds
=
	`my_¥lše_ev®
(
¥lšeIÁEoS
, 
	`log10
(
x
), 
acûl
);

388 
Esq
 = 
·¿ms
.
Omega0
/
	`pow
(
x
,3.0)

389 + 
OmegaK
/(
x
*x)

390 + 
·¿ms
.
OmegaLambda
/
	`pow
(
x
,3.0è* 
	`exp
(3.*
eqds
)

391 + 
OmegaRad
/
	`pow
(
x
,4.0);

392 
a1
 = -(3./
x
+1./2.*((- 3.*
·¿ms
.
Omega0
/
	`pow
(x,4.0)

393 - 2*
OmegaK
/
	`pow
(
x
,3.0)

394 - 4*
OmegaRad
/
	`pow
(
x
,5.0)

395 - 3*((1+
	`DE_Equ©iÚOfS‹
(
x
))/
	`pow
(x,4))

396 * 
·¿ms
.
OmegaLambda
*
	`exp
(3*
eqds
))/
Esq
));

397 
b1
 = 3./2.*
·¿ms
.
Omega0
/(
Esq
*
	`pow
(
x
,5.0));

400 #iâdeà
FOMEGA_GAMMA


401 
dydx
[0] = 
a1
*
y
[0]+
b1
*y[1];

402 
dydx
[1] = 
y
[0];

404 
dydx
[0] = 0.;

405 
dydx
[1] = (
	`pow
(
·¿ms
.
Omega0
/pow(
x
,3.0)/
Esq
,
FOMEGA_GAMMA
))/x * 
y
[1];

407 
dydx
[2] = 1.0/
x
/
	`sq¹
(
Esq
);

408 
dydx
[3] = 
a1
*
y
[3]+
b1
*y[4]-b1*y[1]*y[1];

409 
dydx
[4] = 
y
[3];

411  
GSL_SUCCESS
;

412 
	}
}

415 
	$jac
Ğ
t
, cÚ¡ 
y
[], *
dfdy
, 
dfdt
[], *
·¿ms
)

417 
	`´štf
("This integration method should‚ot callhis function.\n");

418  
GSL_FAILURE
;

419 
	}
}

422 
	$IÁeg¿ndPrİ”Di¡ªû
(
z
, *
·¿m
)

424  1./
	`HubbË
(
z
)*
·¿ms
.
HubbË100
*100.;

425 
	}
}

431 
	$»ad_TabuÏ‹dEoS
()

435 
i
;

436 
FILE
 *
fd
;

437 
a
, 
w
;

438 *
sÿËf
,*
EoS
;

440 ià(!
ThisTask
)

442 if(!(
fd
 = 
	`fİ’
(
·¿ms
.
TabuÏ‹dEoSfe
, "r")))

444 
	`´štf
("ERROR oÀsk 0: cª'ˆİ’abuÏ‹d EoS iÀf'%s'\n", 
·¿ms
.
TabuÏ‹dEoSfe
);

445 
	`fæush
(
¡dout
);

449 
NbEoS
=0;

452 if(
	`fsÿnf
(
fd
, " %lg %lg ", &
a
, &
w
) == 2)

453 
NbEoS
++;

458 
	`fşo£
(
fd
);

460 ià(!
NbEoS
)

462 
	`´štf
("ERROR oÀsk 0: cª'ˆ»adabuÏ‹d EoS iÀf'%s'\n", 
·¿ms
.
TabuÏ‹dEoSfe
);

463 
	`fæush
(
¡dout
);

467 
	`´štf
("Found %d…aœ oàv®ue šabuÏ‹d EoS fe\n", 
NbEoS
);

468 
	`fæush
(
¡dout
);

472 
	`MPI_Bÿ¡
(&
NbEoS
, (), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

474 
acûlEoS
 = 
	`g¦_š‹½_acûl_®loc
();

475 
¥lšeEoS
 = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
NbEoS
);

477 
sÿËf
 = (*)
	`m®loc
(
NbEoS
 * ());

478 
EoS
 = (*)
	`m®loc
(
NbEoS
 * ());

480 ià(!
ThisTask
)

482 
fd
 = 
	`fİ’
(
·¿ms
.
TabuÏ‹dEoSfe
, "r");

484 
i
=0; i<
NbEoS
; i++)

486 if(
	`fsÿnf
(
fd
, " %lg %lg ", &
a
, &
w
) == 2)

488 
sÿËf
[
i
]=
	`log10
(
a
);

489 
EoS
[
i
]=
w
;

493 
	`fşo£
(
fd
);

497 
	`MPI_Bÿ¡
(
sÿËf
, 
NbEoS
*(), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

498 
	`MPI_Bÿ¡
(
EoS
, 
NbEoS
*(), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

500 
	`g¦_¥lše_š™
(
¥lšeEoS
, 
sÿËf
, 
EoS
, 
NbEoS
);

502 
	`ä“
(
EoS
);

503 
	`ä“
(
sÿËf
);

506 
	}
}

509 
	$DE_Equ©iÚOfS‹
(
a
)

511 ià(!
NbEoS
)

512  
·¿ms
.
DEw0
+(1-
a
)*·¿ms.
DEwa
;

514  
	`my_¥lše_ev®
(
¥lšeEoS
, 
	`log10
(
a
), 
acûlEoS
);

515 
	}
}

517 
	$IÁeg¿ndFÜEoS
(
a
, *
·¿m
)

519  
	`DE_Equ©iÚOfS‹
(
a
)/a;

520 
	}
}

529 
»ad_Pk_bË
();

530 
Pow”S³c_TabuÏ‹d
();

531 
Pow”S³c_Ef¡©hiou
();

532 
Pow”S³c_EH
();

533 
Œªsf_EH
();

534 
T0
(,,);

538 
	$Pow”S³ùrum
(
k
)

543 
pow”
, 
®pha
, 
Tf
;

545 
WhichS³ùrum
)

548 
pow”
 = 
	`Pow”S³c_EH
(
k
);

552 
pow”
 = 
	`Pow”S³c_TabuÏ‹d
(
k
);

556 
pow”
 = 
	`Pow”S³c_Ef¡©hiou
(
k
);

560 if(
·¿ms
.
WDM_P¬tMass_š_kev
 > 0.)

562 #ifdeà
BODE_ET_AL_A9


565 
®pha
 =

566 0.048 * 
	`pow
((
·¿ms
.
Omega0
 -…¬ams.
OmegaB¬yÚ
) / 0.4, 0.15)

567 * 
	`pow
(
·¿ms
.
HubbË100
 / 0.65, 1.3è*…ow(1.0 /…¬ams.
WDM_P¬tMass_š_kev
, 1.15);

568 
Tf
 = 
	`pow
(1 +…ow(
®pha
 * 
k
 / 
·¿ms
.
HubbË100
 * (3.085678e24 / 
Un™L’gth_š_cm
), 2 * 1.2), -5.0 / 1.2);

572 
®pha
 =

573 0.05 * 
	`pow
((
·¿ms
.
Omega0
 -…¬ams.
OmegaB¬yÚ
) / 0.4, 0.15)

574 * 
	`pow
(
·¿ms
.
HubbË100
 / 0.65, 1.3è*…ow(1.0 /…¬ams.
WDM_P¬tMass_š_kev
, 1.15);

576 
Tf
 = 
	`pow
(1 +…ow(
®pha
 * 
k
 / 
·¿ms
.
HubbË100
 * (3.085678e24 / 
Un™L’gth_š_cm
), 2), -5.0);

578 
pow”
 *ğ
Tf
 * Tf;

581  
PkNÜm
 * 
pow”
;

582 
	}
}

584 
	$š™Ÿlize_Pow”S³ùrum
()

587 #iâdeà
SCALE_DEPENDENT_GROWTH


588 ià(!
	`¡rcmp
(
·¿ms
.
FeW™hIÅutS³ùrum
,"no"))

589 
WhichS³ùrum
=1;

591 
WhichS³ùrum
=2;

593 ià(
	`¡rcmp
(
·¿ms
.
FeW™hIÅutS³ùrum
,"no"))

594 ià(
	`»ad_Pk_bË
())

597 *
logk
,*
Pk
;

598 
i
;

600 
WhichS³ùrum
=2;

601 
·¿ms
.
Sigma8
=0.0;

604 
NPow”TabË
=
·¿ms
.
ÿmb
.
Nkbšs
;

606 
acûlPk
 = 
	`g¦_š‹½_acûl_®loc
();

607 
¥lšePk
 = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
NPow”TabË
);

608 
logk
 = (*)
	`m®loc
(
NPow”TabË
 * ());

609 
Pk
 = (*)
	`m®loc
(
NPow”TabË
 * ());

611 
i
=0; i<
NPow”TabË
; i++)

613 
logk
[
i
] = 
	`log10
(
	`exp
(
·¿ms
.
ÿmb
.
Logk
[i]));

614 
Pk
 [
i
] = 
	`log10
(
	`exp
(
·¿ms
.
ÿmb
.
LogPk»f
[i])è+ 3.*
logk
[i];

617 
	`g¦_¥lše_š™
(
¥lšePk
, 
logk
, 
Pk
, 
NPow”TabË
);

619 
	`ä“
(
Pk
);

620 
	`ä“
(
logk
);

623 
acûlCAMB
 = 
	`g¦_š‹½_acûl_®loc
();

624 
¥lšeGrowCAMB
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

625 
	`g¦_¥lše_š™
(
¥lšeGrowCAMB
, 
·¿ms
.
ÿmb
.
SÿËf
,…¬ams.ÿmb.
RefGM
,…¬ams.ÿmb.
NCAMB
);

626 
¥lšeInvGrowCAMB
 = 
	`g¦_¥lše_®loc
 (
g¦_š‹½_c¥lše
, 
·¿ms
.
ÿmb
.
NCAMB
);

627 
	`g¦_¥lše_š™
(
¥lšeInvGrowCAMB
, 
·¿ms
.
ÿmb
.
RefGM
,…¬ams.ÿmb.
SÿËf
,…¬ams.ÿmb.
NCAMB
);

629 #ifdeà
OUTPUT_GM


630 ià(!
ThisTask
)

632 
FILE
 *
fd
;

633 
fd
=
	`fİ’
("TwoGrowingModes","w");

634 
	`årštf
(
fd
,"# 1: scale factor\n# 2: D‡s computed fromƒquations\n# 3: from CAMB\n");

635 
a
=
·¿ms
.
ÿmb
.
SÿËf
[0]/1.05;

638 
a
*=1.05;

639 ià(
a
>1)

640 
a
=1.0;

641 
	`årštf
(
fd
," %g %g %g\n",

642 
a
,

643 
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow
, 
	`log10
(
a
), 
acûl
)),

644 
	`exp
(
	`my_¥lše_ev®
(
¥lšeGrowCAMB
, 
a
, 
acûlCAMB
))

647 
a
<1.0);

648 
	`fşo£
(
fd
);

654 ià(
	`nÜm®ize_Pow”S³ùrum
())

658 
	}
}

661 
	$nÜm®ize_Pow”S³ùrum
()

663 
tmp
;

665 
WšdowFunùiÚTy³
=2;

666 
PkNÜm
=1.0;

667 ià(
·¿ms
.
Sigma8
!=0.0)

669 
tmp
 = 
·¿ms
.
Sigma8
 *…¬ams.Sigma8 / 
	`Compu‹MassV¬Ÿnû
(8.0/·¿ms.
HubbË100
);

670 
PkNÜm
 = 
tmp
;

671 ià(!
ThisTask
)

672 
	`´štf
("NÜm®iz©iÚ cÚ¡ªˆfÜhpow” s³ùrum: %g\n",
PkNÜm
);

676 
·¿ms
.
Sigma8
 = 
	`sq¹
(
	`Compu‹MassV¬Ÿnû
(8.0/·¿ms.
HubbË100
));

677 #ifdeà
SCALE_DEPENDENT_GROWTH


678 
·¿ms
.
Sigma8
 *ğ
	`sq¹
Õ¬ams.
ÿmb
.
D2»f
);

680 ià(!
ThisTask
)

681 
	`´štf
("NÜm®iz©iÚ oàth´ovided P(k): Sigma8=%f\n",
·¿ms
.
Sigma8
);

685 
	}
}

688 
	$»ad_Pk_bË
()

692 
i
, 
Şd»ad
=0;

693 
FILE
 *
fd
;

694 
k
, 
p
;

695 *
logk
,*
Pk
;

697 ià(!
ThisTask
)

699 if(!(
fd
 = 
	`fİ’
(
·¿ms
.
FeW™hIÅutS³ùrum
, "r")))

701 
	`´štf
("ERROR onask 0: can't open input spectrum in file '%s' onask %d\n",

702 
·¿ms
.
FeW™hIÅutS³ùrum
, 
ThisTask
);

703 
	`fæush
(
¡dout
);

707 
NPow”TabË
 = 0;

710 if(
	`fsÿnf
(
fd
, " %lg %lg ", &
k
, &
p
) == 2)

711 
NPow”TabË
++;

717 
	`fşo£
(
fd
);

719 ià(!
NPow”TabË
)

721 
	`´štf
("ERROR onask 0: can't„ead data from input spectrum in file '%s'\n",

722 
·¿ms
.
FeW™hIÅutS³ùrum
);

723 
	`fæush
(
¡dout
);

727 
	`´štf
("Found %d…aœ oàv®ue š iÅuˆ¥eùrumabË\n", 
NPow”TabË
);

728 
	`fæush
(
¡dout
);

732 
	`MPI_Bÿ¡
(&
NPow”TabË
, (), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

734 
acûlPk
 = 
	`g¦_š‹½_acûl_®loc
();

735 
¥lšePk
 = 
	`g¦_¥lše_®loc
(
g¦_š‹½_c¥lše
, 
NPow”TabË
);

737 
logk
 = (*)
	`m®loc
(
NPow”TabË
 * ());

738 
Pk
 = (*)
	`m®loc
(
NPow”TabË
 * ());

740 ià(!
ThisTask
)

742 
fd
 = 
	`fİ’
(
·¿ms
.
FeW™hIÅutS³ùrum
, "r");

744 
i
=0; i<
NPow”TabË
; i++)

746 if(
	`fsÿnf
(
fd
, " %lg %lg ", &
k
, &
p
) == 2)

749 ià(!
i
)

751 ià(
k
<0.0)

753 
Şd»ad
=1;

754 
	`´štf
("I‡m‡ssumšgh© f% cÚš Log k - Log k^3 P(k)\n",
·¿ms
.
FeW™hIÅutS³ùrum
);

758 
Şd»ad
=0;

759 
	`´štf
("I‡m‡ssumšgh© f% cÚš k - P(k)\n",
·¿ms
.
FeW™hIÅutS³ùrum
);

763 ià(
Şd»ad
)

765 
logk
[
i
] = 
k
;

766 
Pk
[
i
] = 
p
;

770 
logk
[
i
] = 
	`log10
(
k
);

771 
Pk
[
i
] = 
	`log10
(
p
*
k
*k*k);

775 
logk
[
i
] +ğ
	`log10
(
·¿ms
.
HubbË100
);

777 ià(
·¿ms
.
IÅutS³ùrum_Un™L’gth_š_cm
!=0.0)

778 
logk
[
i
] +ğ
	`log10
(
·¿ms
.
IÅutS³ùrum_Un™L’gth_š_cm
/
Un™L’gth_š_cm
);

782 
	`fşo£
(
fd
);

786 
	`MPI_Bÿ¡
(
Pk
, 
NPow”TabË
*(), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

787 
	`MPI_Bÿ¡
(
logk
, 
NPow”TabË
*(), 
MPI_BYTE
, 0, 
MPI_COMM_WORLD
);

789 
	`g¦_¥lše_š™
(
¥lšePk
, 
logk
, 
Pk
, 
NPow”TabË
);

791 
	`ä“
(
Pk
);

792 
	`ä“
(
logk
);

795 
	}
}

797 
	$Pow”S³c_TabuÏ‹d
(
k
)

799  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšePk
, 
	`log10
(
k
), 
acûlPk
))/k/k/k;

800 
	}
}

802 
	$Pow”S³c_Ef¡©hiou
(
k
)

804  
	`pow
(
k
,
·¿ms
.
PrimÜdŸlIndex
è/…ow(1 +…ow(6.4 / 
Sh­eGamma
 * k +…ow(3.0 / ShapeGamma * k, 1.5) +…ow(1.7 / ShapeGamma,2.0) * k * k, 1.13), 2 / 1.13);

805 
	}
}

807 
	$Pow”S³c_EH
(
k
)

809  
	`pow
(
k
,
·¿ms
.
PrimÜdŸlIndex
)*pow(
	`Œªsf_EH
(k),2.);

810 
	}
}

812 
	$Œªsf_EH
(
fk
)

814 
T‘a_27
=1.0104;

815 
q
,
Omegac
,
Oh2
,
b1
,
b2
,
zd
,
Rd
,
zeq
,
Req
,
keq
,
s
,
ks
,
®c
,
bec
,
f
,
Tc
,
beb
,
bno
,
k¡
,
ksi
,
Tb
,
Tr
,
y
,
®b
,
Ob2
,
OB
;

819 
OB
 = (
·¿ms
.
OmegaB¬yÚ
 > 1.e-6 ?…arams.OmegaBaryon : 1.e-6);

820 
Omegac
 = 
·¿ms
.
Omega0
-
OB
;

821 
Oh2
 = 
·¿ms
.
Omega0
*·¿ms.
HubbË100
*params.Hubble100;

822 
Ob2
 = 
OB
*
·¿ms
.
HubbË100
*params.Hubble100;

823 
b1
 = 0.313*
	`pow
(
Oh2
,-0.419)*(1+0.607*pow(Oh2,0.674));

824 
b2
 = 0.238*
	`pow
(
Oh2
,0.223);

825 
zd
 = 1291.*
	`pow
(
Oh2
,0.251)*(1.+
b1
*pow(
Ob2
,
b2
))/(1.+0.659*pow(Oh2,0.828));

826 
Rd
 = 31.5*
Ob2
/(
	`pow
(
T‘a_27
,4.0)*0.001*
zd
);

827 
zeq
 = 2.5e4*
Oh2
/
	`pow
(
T‘a_27
,4.0);

828 
Req
 = 31.5*
Ob2
/(
	`pow
(
T‘a_27
,4.0)*0.001*
zeq
);

829 
keq
 = 7.46e-2*
Oh2
/
T‘a_27
/Teta_27;

830 
s
 = 1.633*
	`log
((
	`sq¹
(1.+
Rd
)+sq¹(Rd+
Req
))/(1+sq¹(Req)))/(
keq
*sqrt(Req));

831 
ks
 = 
fk
*
s
;

832 
q
 = 
fk
*
T‘a_27
*T‘a_27/
Oh2
;

833 
®c
 = 
	`pow
Õow(46.9*
Oh2
,0.670)*(1.+pow(32.1*Oh2,-0.532)),-
OB
/
·¿ms
.
Omega0
) *

834 
	`pow
Õow(12.0*
Oh2
,0.424)*(1.+pow(45.0*Oh2,-0.582)),-pow(
OB
/
·¿ms
.
Omega0
,3.0));

835 
bec
 = 1./(1.+(0.944/(1.+
	`pow
(458.*
Oh2
,-0.708)))*Õow(
Omegac
/
·¿ms
.
Omega0
,pow(0.395*Oh2,-0.0266))-1.));

836 
f
 = 1./(1+
	`pow
(
ks
/5.4,4.0));

837 
Tc
 = 
f
*
	`T0
(
q
,1.,
bec
)+(1.-f)*T0(q,
®c
,bec);

838 
beb
 = 0.5+
OB
/
·¿ms
.
Omega0
+(3.-2.*OB/·¿ms.Omega0)*
	`sq¹
(
	`pow
(17.2*
Oh2
,2.0)+1.);

839 
bno
 = 8.41*
	`pow
(
Oh2
,0.435);

840 
k¡
 = 
ks
/
	`pow
(1.+pow(
bno
/ks,3.0),0.3333);

841 
ksi
 = 1.6*
	`pow
(
Ob2
,0.52)*pow(
Oh2
,0.73)*(1.+pow(10.4*Oh2,-0.95));

842 
y
 = (1.+
zeq
)/(1+
zd
);

843 
®b
 = 2.07*
keq
*
s
*
	`pow
(1.0+
Rd
,-0.75)*(
y
*(-6.*
	`sq¹
(1.+y)+(2.+3.*y)*
	`log
((sqrt(1.+y)+1.)/(sqrt(1.+y)-1.))));

844 
Tb
 = (
	`T0
(
q
,1.,1.)/(1.+
	`pow
(
ks
/5.2,2.0))+
®b
/(1.+pow(
beb
/ks,3.0))*
	`exp
(-pow(
fk
/
ksi
,1.4)))*
	`sš
(
k¡
)/kst;

845 
Tr
 = (
OB
*
Tb
+
Omegac
*
Tc
)/
·¿ms
.
Omega0
;

847  
Tr
;

848 
	}
}

851 
	$T0
(
q
,
a
,
b
)

853 
Î
,
C
;

855 
Î
 = 
	`log
(
	`exp
(1.)+1.8*
b
*
q
);

856 
C
 = 14.2/
a
+386./(1.+69.9*
	`pow
(
q
,1.08));

858  
Î
/Öl+
C
*
q
*q);

859 
	}
}

865 
	gThisRadius
;

866 
IÁeg¿ndFÜMassV¬Ÿnû
(, *);

867 
IÁeg¿ndFÜDi¥lV¬Ÿnû
(, *);

869 
	$š™Ÿlize_MassV¬Ÿnû
()

871 
i
;

872 
r
;

873 
rmš
=-6.0, 
dr
=0.04;

874 *
rv
, *
Ïmv
, *
dldr
, *
ÏmvÃg
, *
di¥lv
;

876 
rv
 = (*)
	`m®loc
(
NBIN
 * ());

877 
Ïmv
 = (*)
	`m®loc
(
NBIN
 * ());

878 
dldr
 = (*)
	`m®loc
(
NBIN
 * ());

879 
ÏmvÃg
 = (*)
	`m®loc
(
NBIN
 * ());

880 
di¥lv
 = (*)
	`m®loc
(
NBIN
 * ());

882 
i
=
NBIN
-1; i>=0; i--)

884 
rv
[
i
]=(
rmš
+i*
dr
);

885 
r
=
	`pow
(10.,
rv
[
i
]);

886 
Ïmv
[
i
]=
	`log10
(
	`Compu‹MassV¬Ÿnû
(
r
));

889 ià(
i
<
NBIN
-1 && 
Ïmv
[i]-lamv[i+1]<1.e-6)

890 
Ïmv
[
i
]=lamv[i+1]+1.e-6;

892 
ÏmvÃg
[
i
]=-
Ïmv
[i];

893 
di¥lv
[
i
]=
	`log10
(
	`Compu‹Di¥lV¬Ÿnû
(
r
));

896 
i
=0; i<
NBIN
; i++)

898 ià(
i
==0)

899 
dldr
[
i
]=(
Ïmv
[i+1]-Ïmv[i])/(
rv
[i+1]-rv[i]);

900 ià(
i
==
NBIN
-1)

901 
dldr
[
i
]=(
Ïmv
[i]-Ïmv[i-1])/(
rv
[i]-rv[i-1]);

903 
dldr
[
i
]=(
Ïmv
[i+1]-Ïmv[i-1])/(
rv
[i+1]-rv[i-1]);

907 
	`g¦_¥lše_š™
(
¥lšeV¬
, 
rv
, 
Ïmv
, 
NBIN
);

908 
	`g¦_¥lše_š™
(
¥lšeRadius
, 
ÏmvÃg
, 
rv
, 
NBIN
);

909 
	`g¦_¥lše_š™
(
¥lšedldr
, 
rv
, 
dldr
, 
NBIN
);

910 
	`g¦_¥lše_š™
(
¥lšeDV¬
, 
rv
, 
di¥lv
, 
NBIN
);

912 
	`ä“
(
di¥lv
 );

913 
	`ä“
(
ÏmvÃg
 );

914 
	`ä“
(
dldr
 );

915 
	`ä“
(
Ïmv
 );

916 
	`ä“
(
rv
 );

919 
	}
}

921 
	$Compu‹MassV¬Ÿnû
(
R
)

923 
»suÉ
, 
”rÜ
;

925 
ThisRadius
=
R
;

926 
FunùiÚ
.
funùiÚ
 = &
IÁeg¿ndFÜMassV¬Ÿnû
;

927 
	`g¦_š‹g¿tiÚ_qags
 (&
FunùiÚ
, -10., 
	`log
(500.0/
R
è, 0.0, 
TOLERANCE
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

929  
»suÉ
;

930 
	}
}

932 
	$IÁeg¿ndFÜMassV¬Ÿnû
(
logk
, *
·¿m
)

934 
w
, 
k
;

935 
k
=
	`exp
(
logk
);

936 
w
 = 
	`WšdowFunùiÚ
(
k
 * 
ThisRadius
);

937  
	`Pow”S³ùrum
(
k
è* 
w
*w * k*k*k / (2.*
PI
*PI);

938 
	}
}

940 
	$Compu‹Di¥lV¬Ÿnû
(
R
)

942 
»suÉ
, 
”rÜ
;

944 
ThisRadius
=
R
;

945 
FunùiÚ
.
funùiÚ
 = &
IÁeg¿ndFÜDi¥lV¬Ÿnû
;

946 
	`g¦_š‹g¿tiÚ_qags
 (&
FunùiÚ
, -10., 
	`log
(500.0/
R
è, 0.0, 
TOLERANCE
, 
NWINT
, 
wÜk¥aû
, &
»suÉ
, &
”rÜ
);

948  
»suÉ
;

949 
	}
}

951 
	$IÁeg¿ndFÜDi¥lV¬Ÿnû
(
logk
, *
·¿m
)

953 
w
, 
k
;

954 
k
=
	`exp
(
logk
);

955 
w
 = 
	`WšdowFunùiÚ
(
k
 * 
ThisRadius
);

956  
	`Pow”S³ùrum
(
k
è* 
w
*w * k / (2.*
PI
*PI);

957 
	}
}

959 
	$WšdowFunùiÚ
(
kr
)

969 
wšdow
, 
kr2
;

971 
WšdowFunùiÚTy³
)

974 
wšdow
=
	`exp
(-
kr
*kr/2.);

978 
wšdow
=(
kr
<1? 1.0 : 0.0);

982 ià(
kr
 < 1.e-5)

983 
wšdow
=1.0;

986 
kr2
=
kr
*kr;

987 
wšdow
=3.*(
	`sš
(
kr
)/
kr2
/kr-
	`cos
(kr)/kr2);

992 
wšdow
=1;

996  
wšdow
;

997 
	}
}

999 
	$MassV¬Ÿnû
(
R
)

1001  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeV¬
, 
	`log10
(
R
), 
acûl
));

1002 
	}
}

1005 
	$dMassV¬Ÿnû_dr
(
R
)

1007  
	`my_¥lše_ev®
(
¥lšedldr
, 
	`log10
(
R
), 
acûl
);

1008 
	}
}

1010 
	$Di¥lV¬Ÿnû
(
R
)

1012  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeDV¬
, 
	`log10
(
R
), 
acûl
));

1013 
	}
}

1015 
	$Radius
(
V¬
)

1017  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeRadius
, -
	`log10
(
V¬
), 
acûl
));

1018 
	}
}

1025 
	$Omega
(
z
)

1030  
·¿ms
.
Omega0
 * 
	`pow
(1.+
z
,3.è*…ow(
	`HubbË
(z)/100./·¿ms.
HubbË100
, -2);

1031 
	}
}

1034 
	$HubbË
(
z
)

1038 
Esq
,
eqds
;

1040 ià(
·¿ms
.
sim¶eLambda
)

1041 
Esq
 = 
·¿ms
.
Omega0
*
	`pow
(1.+
z
,3.)+
OmegaK
*pow(1.+z,2.)+·¿ms.
OmegaLambda
;

1044 
eqds
=
	`my_¥lše_ev®
(
¥lšeIÁEoS
, -
	`log10
(1.+
z
), 
acûl
);

1045 
Esq
 = 
·¿ms
.
Omega0
*
	`pow
(1.+
z
,3.)+
OmegaK
*pow(1.+z,2.)+·¿ms.
OmegaLambda
*pow(1.+z,3.è* 
	`exp
(3.*
eqds
);

1048  100.*
·¿ms
.
HubbË100
*
	`sq¹
(
Esq
);

1049 
	}
}

1052 
	$HubbË_Gyr
(
z
)

1057  
	`HubbË
(
z
)/
HUBBLETIME_GYR
/100.;

1058 
	}
}

1061 
	$fomega
(
z
)

1066 #iâdeà
SCALE_DEPENDENT_GROWTH


1067  
	`my_¥lše_ev®
(
¥lšefO
, -
	`log10
(1.+
z
), 
acûl
);

1070 
SDGM
.
æag
)

1073  
	`my_¥lše_ev®
(
¥lšefO
, -
	`log10
(1.+
z
), 
acûl
);

1077  
	`V–fOmega
(
z
);

1084 
	}
}

1086 
	$fomega_2LPT
(
z
)

1091 #iâdeà
SCALE_DEPENDENT_GROWTH


1092  
	`my_¥lše_ev®
(
¥lšefO2
, -
	`log10
(1.+
z
), 
acûl
);

1095 
SDGM
.
æag
)

1098  
	`my_¥lše_ev®
(
¥lšefO2
, -
	`log10
(1.+
z
), 
acûl
);

1102  
	`V–fOmega2
(
z
);

1109 
	}
}

1111 
	$fomega_3LPT_1
(
z
)

1116  
	`my_¥lše_ev®
(
¥lšefO31
, -
	`log10
(1.+
z
), 
acûl
);

1117 
	}
}

1119 
	$fomega_3LPT_2
(
z
)

1124  
	`my_¥lše_ev®
(
¥lšefO32
, -
	`log10
(1.+
z
), 
acûl
);

1125 
	}
}

1127 
	$GrowšgMode
(
z
)

1132 #iâdeà
SCALE_DEPENDENT_GROWTH


1133  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow
, -
	`log10
(1.+
z
), 
acûl
));

1136 
SDGM
.
æag
)

1139  
	`exp
(
	`my_¥lše_ev®
(
¥lšeGrowCAMB
, 1./(1.+
z
), 
acûlCAMB
));

1142  
	`M©‹rGrowšgMode
(
z
);

1145  
	`V–GrowšgMode
(
z
);

1152 
	}
}

1155 
	$GrowšgMode_2LPT
(
z
)

1160 #iâdeà
SCALE_DEPENDENT_GROWTH


1161  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow2
, -
	`log10
(1.+
z
), 
acûl
));

1164 
SDGM
.
æag
)

1167  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow2
, -
	`log10
(1.+
z
), 
acûl
));

1171  3./7.*
	`pow
(
	`GrowšgMode
(
z
),2.0è*…ow(
	`Omega
(z),-0.007);

1178 
	}
}

1180 
	$GrowšgMode_3LPT_1
(
z
)

1185  -
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow31
, -
	`log10
(1.+
z
), 
acûl
));

1186 
	}
}

1188 
	$GrowšgMode_3LPT_2
(
z
)

1193  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeGrow32
, -
	`log10
(1.+
z
), 
acûl
));

1194 
	}
}

1196 
	$Inv”£GrowšgMode
(
D
)

1201 #iâdeà
SCALE_DEPENDENT_GROWTH


1202  1./
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeInvGrow
, 
	`log10
(
D
), 
acûl
)) -1.;

1205 
SDGM
.
æag
)

1208  1./
	`my_¥lše_ev®
(
¥lšeInvGrowCAMB
, 
	`log
(
D
), 
acûl
) -1.;

1211  
	`Inv”£M©‹rGrowšgMode
(
D
);

1221 
	}
}

1224 
	$CosmicTime
(
z
)

1229  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeTime
, -
	`log10
(1.+
z
), 
acûl
));

1230 
	}
}

1232 
	$Inv”£CosmicTime
(
t
)

1237  
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeInvTime
, 
	`log10
(
t
), 
acûl
));

1238 
	}
}

1240 
	$Prİ”Di¡ªû
(
z
)

1245  
	`my_¥lše_ev®
(
¥lšeDi¡
, -
	`log10
(1.+
z
), 
acûl
);

1246 
	}
}

1248 
	$Inv”£Prİ”Di¡ªû
(
d
)

1253  1./
	`pow
(10.,
	`my_¥lše_ev®
(
¥lšeInvDi¡
, -
d
, 
acûl
))-1;

1254 
	}
}

1256 
	$dPrİ”Di¡ªû_dz
(
z
)

1261  
	`my_¥lše_ev®
(
¥lšedrdz
, -
	`log10
(1.+
z
), 
acûl
);

1262 
	}
}

1264 
	$SizeFÜMass
(
m
)

1272 
WšdowFunùiÚTy³
)

1275  
	`pow
(
m
/pow(2.0*
PI
,1.5)/
M©‹rD’s™y
,0.3333333333333333);

1278  
	`pow
(
m
/(6.0*
PI
*PI*
M©‹rD’s™y
),0.3333333333333333);

1281  
	`pow
(
m
/(4.0*
PI
*
M©‹rD’s™y
/3.0),0.3333333333333333);

1287 
	}
}

1289 
	$MassFÜSize
(
size
)

1292 
WšdowFunùiÚTy³
)

1295  
M©‹rD’s™y
 * 
	`pow
(2.0*
PI
,1.5)*pow(
size
,3.0);

1298  
M©‹rD’s™y
 * 6.*
PI
*PI*
	`pow
(
size
,3.0);

1301  
M©‹rD’s™y
 * 4.*
PI
/3.*
	`pow
(
size
,3.0);

1308 
	}
}

1310 
	$TypiÿlCŞÏpsšgMass
(
z
)

1314  
	`MassFÜSize
(
	`Radius
(
	`pow
(
DELTA_C
/
	`GrowšgMode
(
z
),2.0)));

1315 
	}
}

1321 
	#SQRT2PI
 (()0.39894228)

	)

1322 
	#ALPHA
 (()0.569558118758974)

	)

1324 
	$dOmega_dV¬Ÿnû
(
v
,
z
)

1346 
sv
, 
ni
, 
ni2
, 
Ú•z
;

1348 
sv
=
	`sq¹
(
v
);

1349 
ni
=
DELTA_C
/
sv
;

1351 
·¿ms
.
AÇlyticMassFunùiÚ
)

1354  2.* 
	`exp
(-0.5*
ni
*niè*‚˜* 
SQRT2PI
;

1358 
ni2
=
	`sq¹
(0.707)*
ni
;

1359  2.* 0.3222 * 
SQRT2PI
 * 
ni2
 * 
	`exp
(-0.5*ni2*ni2è* (1.0+ 1.0/
	`pow
(ni2,0.6));

1363  0.315 * 
	`exp
(-
	`pow
(
	`çbs
(-
	`log
(
sv
)+0.61),3.8));

1367  0.7234 * (
	`pow
(
sv
,-1.625)+0.2538)*
	`exp
(-1.1982/
v
);

1371 
ni2
=
	`sq¹
(0.707)*
ni
;

1372  2.*0.3222 * 
SQRT2PI
 * 
ni2
 * 
	`exp
(-0.54*ni2*ni2)*

1373 (1.0+ 1.0/
	`pow
(
ni2
,0.6è+ 0.2 * 
	`exp
(-Õow(-
	`log
(
sv
)-0.4,2.0)/0.72)));

1377 
Ú•z
 = (
z
<1 ? 1.0+z : 2.0);

1378  0.58* 
	`pow
(
Ú•z
,-0.13)

1379 * (
	`pow
Ğ
sv
,-1.37 *…ow(
Ú•z
,-0.15) ) + 0.3 *…ow(onepz,-0.084))

1380 * 
	`exp
(-1.036 * 
	`pow
(
Ú•z
,-0.024)/
v
);

1384 
Ú•z
 = (
z
<2.5 ? 1.0+z : 3.5);

1385  0.186*
	`pow
(
Ú•z
,-0.14)*Õow(2.57*pow(Ú•z,-0.569558118758974)/
sv
,

1386 1.47*
	`pow
(
Ú•z
,-0.06))+1.)*
	`exp
(-1.19/
v
);

1390 
ni2
=
	`sq¹
(0.695)*1.673/
sv
;

1391  0.348 * 2.*
SQRT2PI
 * 
ni2
 * (1.+
	`pow
(1./ni2/ni2,0.1))*
	`exp
(-ni2*ni2/2.);

1395  0.201*(
	`pow
(
ni
*2.08/
DELTA_C
,1.7è+ 1.0è*
	`exp
(-1.172 *ni*ni/DELTA_C/DELTA_C);

1399  0.282*(
	`pow
(
ni
*1.406/
DELTA_C
,2.163è+ 1.0è*
	`exp
(-1.210 *ni*ni/DELTA_C/DELTA_C);

1403 
Ú•z
 = 1.0;

1404  0.58* 
	`pow
(
Ú•z
,-0.13)

1405 * (
	`pow
Ğ
sv
,-1.37 *…ow(
Ú•z
,-0.15) ) + 0.3 *…ow(onepz,-0.084))

1406 * 
	`exp
(-1.036 * 
	`pow
(
Ú•z
,-0.024)/
v
);

1415 
	}
}

1417 
	$AÇlyticMassFunùiÚ
(
mass
, 
z
)

1419 
r
,
D
;

1421 
r
=
	`SizeFÜMass
(
mass
);

1422 #ifdeà
SCALE_DEPENDENT_GROWTH


1424 
SDGM
.
æag
=0;

1425 
SDGM
.
¿dius
=
r
;

1427 
D
=
	`GrowšgMode
(
z
);

1429  
M©‹rD’s™y
 * 
	`dOmega_dV¬Ÿnû
(
	`MassV¬Ÿnû
(
r
)*
D
*D,
z
)

1430 * 
	`çbs
(
	`dMassV¬Ÿnû_dr
(
r
è/6.0è/
mass
 /mass;

1432 
	}
}

1469 
	$my_¥lše_ev®
(
g¦_¥lše
 *
¥lše
, 
x
, 
g¦_š‹½_acûl
 *
acûl
)

1471 ià(
x
<
¥lše
->x[0])

1472  
¥lše
->
y
[0]+(
x
-spline->x[0])*(spline->y[1]-spline->y[0])/(spline->x[1]-spline->x[0]);

1473 ià(
x
>
¥lše
->x[¥lše->
size
-1])

1474  
¥lše
->
y
[¥lše->
size
-1]+(
x
-spline->x[spline->size-1])*

1475 (
¥lše
->
y
[¥lše->
size
-1]-¥lše->y[¥lše->size-2])/(¥lše->
x
[spline->size-1]-spline->x[spline->size-2]);

1477  
	`g¦_¥lše_ev®
(
¥lše
,
x
,
acûl
);

1478 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/distribute.c

27 
	~"pšocchio.h
"

33 
	msk
,
	mbox_x
,
	mbox_y
,
	mbox_z
,
	mbz
,
	mgz
,
	mæag
,
	mcheck
;

34 } 
	tcomm_¡ruù
;

36 
	gÏrge¡_size
;

37 
´oduù_d©a
 *
	gsub_¶ªe
;

39 
fšd_sk
(, , , , *, *, *);

40 
£nd_d©a
(
comm_¡ruù
 *);

41 
»cv_d©a
(
comm_¡ruù
 *);

42 
k“p_d©a
(
comm_¡ruù
 *);

44 
	$di¡ribu‹
()

50 
glob®_z
, *
b–Úgs_loÿl
, *
b–Úgs_glob®
;

51 
i1
,
i2
,
i3
,
maš_sk
,
£cÚd_sk
,
£nd”
,
box_z
,
£cÚd_z
;

53 
log_Áask
,
b™
,
»ûiv”
,
ss
,
¼
,
dd
,
tuº
,
i
,
couÁ_£nd
,
couÁ_»cv
,
couÁ_k“p
,
i£nd
,
œecv
;

54 
comm_¡ruù
 *
comm_£nd
, *
comm_»cv
, *
comm_k“p
;

57 
	`fæush
(
¡dout
);

58 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

60 #ifdeà
VERBOSE


61 
	`´štf
("\n");

62 
	`´štf
("task %d,…lan of sub-boxes: %d %d %d - %d %d %d/%d - %d %d %d - %d %d %d - %d %d %d - %d %d %d - %d %d %d\n",

63 
ThisTask
,
MyGrids
[0].
GSloÿl
[
_x_
],MyGrids[0].GSloÿl[
_y_
],MyGrids[0].GSloÿl[
_z_
],

64 
subbox
.
nbox_x
, subbox.
nbox_y
, subbox.
nbox_z_this¦iû
, subbox.
nbox_z_®l¦iûs
,

65 
subbox
.
mybox_x
,subbox.
mybox_y
,subbox.
mybox_z
,

66 
subbox
.
Lgrid_x
,subbox.
Lgrid_y
,subbox.
Lgrid_z
,

67 
subbox
.
¡¬t_x
,subbox.
¡¬t_y
,subbox.
¡¬t_z
,

68 
subbox
.
Lgwbl_x
,subbox.
Lgwbl_y
,subbox.
Lgwbl_z
,

69 
subbox
.
¡abl_x
,subbox.
¡abl_y
,subbox.
¡abl_z
);

70 
	`fæush
(
¡dout
);

71 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

77 
b–Úgs_loÿl
 = (*)
	`m®loc
(
MyGrids
[0].
GSglob®
[
_z_
]*());

78 
b–Úgs_glob®
 = (*)
	`m®loc
(
MyGrids
[0].
GSglob®
[
_z_
]*());

79 
glob®_z
=0; glob®_z<
MyGrids
[0].
GSglob®
[
_z_
]; global_z++)

81 
b–Úgs_glob®
[
glob®_z
]=0;

82 ià(
glob®_z
 >ğ
MyGrids
[0].
GS¡¬t
[
_z_
] && glob®_z < MyGrids[0].GS¡¬t[_z_] + MyGrids[0].
GSloÿl
[_z_])

83 
b–Úgs_loÿl
[
glob®_z
]=
ThisTask
;

85 
b–Úgs_loÿl
[
glob®_z
]=0;

88 ià(
	`MPI_Reduû
(
b–Úgs_loÿl
, 
b–Úgs_glob®
,

89 
MyGrids
[0].
GSglob®
[
_z_
], 
MPI_INT
, 
MPI_SUM
, 0,

90 
MPI_COMM_WORLD
è!ğ
MPI_SUCCESS
)

92 
	`´štf
("ERROR oÀsk %d: di¡ribu‹ could‚Ù…”fÜm‡ÀMPI_Reduû\n",
ThisTask
);

93 
	`fæush
 (
¡dout
);

97 ià(
	`MPI_Bÿ¡
(
b–Úgs_glob®
, 
MyGrids
[0].
GSglob®
[
_z_
],

98 
MPI_INT
, 0, 
MPI_COMM_WORLD
è!ğ
MPI_SUCCESS
)

100 
	`´štf
("ERROR oÀsk %d: di¡ribu‹ could‚Ù…”fÜm‡ÀMPI_Bÿ¡\n",
ThisTask
);

101 
	`fæush
 (
¡dout
);

108 
glob®_z
 = 
i3
=
couÁ_£nd
=
couÁ_»cv
=
couÁ_k“p
=0; glob®_z<
MyGrids
[0].
GSglob®
[
_z_
]; global_z++)

112 ià(
i3
<
subbox
.
nbox_z_®l¦iûs
-1 && 
glob®_z
==
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.nbox_z_allslices,i3+1))

113 
i3
++;

116 
i2
=0; i2<
subbox
.
nbox_y
; i2++)

117 
i1
=0; i1<
subbox
.
nbox_x
; i1++)

121 
maš_sk
 = 
	`fšd_sk
(
glob®_z
, 
i1
, 
i2
, 
i3
, &
£cÚd_sk
, &
box_z
, &
£cÚd_z
);

124 ià(
b–Úgs_glob®
[
glob®_z
]==
ThisTask
)

126 ià(
maš_sk
==
ThisTask
)

127 
couÁ_k“p
++;

128 ià(
maš_sk
>=0)

129 
couÁ_£nd
++;

131 ià(
£cÚd_sk
==
ThisTask
)

132 
couÁ_k“p
++;

133 ià(
£cÚd_sk
>=0)

134 
couÁ_£nd
++;

137 ià(
maš_sk
==
ThisTask
 && 
b–Úgs_glob®
[
glob®_z
]!=ThisTask)

138 
couÁ_»cv
++;

140 ià(
£cÚd_sk
==
ThisTask
 && 
b–Úgs_glob®
[
glob®_z
]!=ThisTask)

141 
couÁ_»cv
++;

146 
comm_£nd
=(
comm_¡ruù
*)
	`m®loc
(
couÁ_£nd
 * (comm_struct));

147 
comm_»cv
=(
comm_¡ruù
*)
	`m®loc
(
couÁ_»cv
 * (comm_struct));

148 
comm_k“p
=(
comm_¡ruù
*)
	`m®loc
(
couÁ_k“p
 * (comm_struct));

151 
glob®_z
 = 
i3
=
couÁ_£nd
=
couÁ_»cv
=
couÁ_k“p
=0; glob®_z<
MyGrids
[0].
GSglob®
[
_z_
]; global_z++)

154 ià(
i3
<
subbox
.
nbox_z_®l¦iûs
-1 && 
glob®_z
==
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.nbox_z_allslices,i3+1))

155 
i3
++;

158 
i2
=0; i2<
subbox
.
nbox_y
; i2++)

159 
i1
=0; i1<
subbox
.
nbox_x
; i1++)

163 
maš_sk
 = 
	`fšd_sk
(
glob®_z
, 
i1
, 
i2
, 
i3
, &
£cÚd_sk
, &
box_z
, &
£cÚd_z
);

166 ià(
b–Úgs_glob®
[
glob®_z
]==
ThisTask
)

168 ià(
maš_sk
==
ThisTask
)

170 
comm_k“p
[
couÁ_k“p
 ].
sk
 = 
ThisTask
;

171 
comm_k“p
[
couÁ_k“p
 ].
box_x
 = 
i1
;

172 
comm_k“p
[
couÁ_k“p
 ].
box_y
 = 
i2
;

173 
comm_k“p
[
couÁ_k“p
 ].
box_z
 = 
i3
;

174 
comm_k“p
[
couÁ_k“p
 ].
gz
 = 
glob®_z
;

175 
comm_k“p
[
couÁ_k“p
 ].
bz
 = 
box_z
;

176 
comm_k“p
[
couÁ_k“p
 ].
æag
 = 1;

177 
comm_k“p
[
couÁ_k“p
++].
check
 = 0;

179 ià(
maš_sk
>=0)

181 
comm_£nd
[
couÁ_£nd
 ].
sk
 = 
maš_sk
;

182 
comm_£nd
[
couÁ_£nd
 ].
box_x
 = 
i1
;

183 
comm_£nd
[
couÁ_£nd
 ].
box_y
 = 
i2
;

184 
comm_£nd
[
couÁ_£nd
 ].
box_z
 = 
i3
;

185 
comm_£nd
[
couÁ_£nd
 ].
gz
 = 
glob®_z
;

186 
comm_£nd
[
couÁ_£nd
 ].
bz
 = 
box_z
;

187 
comm_£nd
[
couÁ_£nd
 ].
æag
 = 1;

188 
comm_£nd
[
couÁ_£nd
++].
check
 = 0;

191 ià(
£cÚd_sk
==
ThisTask
)

193 
comm_k“p
[
couÁ_k“p
 ].
sk
 = 
ThisTask
;

194 
comm_k“p
[
couÁ_k“p
 ].
box_x
 = 
i1
;

195 
comm_k“p
[
couÁ_k“p
 ].
box_y
 = 
i2
;

196 
comm_k“p
[
couÁ_k“p
 ].
box_z
 = 
i3
;

197 
comm_k“p
[
couÁ_k“p
 ].
gz
 = 
glob®_z
;

198 
comm_k“p
[
couÁ_k“p
 ].
bz
 = 
£cÚd_z
;

199 
comm_k“p
[
couÁ_k“p
 ].
æag
 = 2;

200 
comm_k“p
[
couÁ_k“p
++].
check
 = 0;

202 ià(
£cÚd_sk
>=0)

204 
comm_£nd
[
couÁ_£nd
 ].
sk
 = 
£cÚd_sk
;

205 
comm_£nd
[
couÁ_£nd
 ].
box_x
 = 
i1
;

206 
comm_£nd
[
couÁ_£nd
 ].
box_y
 = 
i2
;

207 
comm_£nd
[
couÁ_£nd
 ].
box_z
 = 
i3
;

208 
comm_£nd
[
couÁ_£nd
 ].
gz
 = 
glob®_z
;

209 
comm_£nd
[
couÁ_£nd
 ].
bz
 = 
£cÚd_z
;

210 
comm_£nd
[
couÁ_£nd
 ].
æag
 = 2;

211 
comm_£nd
[
couÁ_£nd
++].
check
 = 0;

215 ià(
maš_sk
==
ThisTask
 && 
b–Úgs_glob®
[
glob®_z
]!=ThisTask)

217 
comm_»cv
[
couÁ_»cv
 ].
sk
 = 
b–Úgs_glob®
[
glob®_z
];

218 
comm_»cv
[
couÁ_»cv
 ].
box_x
 = 
i1
;

219 
comm_»cv
[
couÁ_»cv
 ].
box_y
 = 
i2
;

220 
comm_»cv
[
couÁ_»cv
 ].
box_z
 = 
i3
;

221 
comm_»cv
[
couÁ_»cv
 ].
gz
 = 
glob®_z
;

222 
comm_»cv
[
couÁ_»cv
 ].
bz
 = 
box_z
;

223 
comm_»cv
[
couÁ_»cv
 ].
æag
 = 1;

224 
comm_»cv
[
couÁ_»cv
++].
check
 = 0;

227 ià(
£cÚd_sk
==
ThisTask
 && 
b–Úgs_glob®
[
glob®_z
]!=ThisTask)

229 
comm_»cv
[
couÁ_»cv
 ].
sk
 = 
b–Úgs_glob®
[
glob®_z
];

230 
comm_»cv
[
couÁ_»cv
 ].
box_x
 = 
i1
;

231 
comm_»cv
[
couÁ_»cv
 ].
box_y
 = 
i2
;

232 
comm_»cv
[
couÁ_»cv
 ].
box_z
 = 
i3
;

233 
comm_»cv
[
couÁ_»cv
 ].
gz
 = 
glob®_z
;

234 
comm_»cv
[
couÁ_»cv
 ].
bz
 = 
£cÚd_z
;

235 
comm_»cv
[
couÁ_»cv
 ].
æag
 = 2;

236 
comm_»cv
[
couÁ_»cv
++].
check
 = 0;

241 #ifdeà
VERBOSE


242 
™ask
;

243 
™ask
=0; isk<
NTasks
; itask++)

245 ià(
ThisTask
==
™ask
)

247 
	`´štf
("Task %d\n",
ThisTask
);

248 
	`´štf
("k“p_d©a: %d\n",
couÁ_k“p
);

249 
i
=0; i<
couÁ_k“p
; i++)

250 
	`´štf
("task=%d, box_x=%d, box_y=%d, box_z=%d, global_z=%d,†ocal_z=%d, flag=%d\n",

251 
comm_k“p
[
i
].
sk
,

252 
comm_k“p
[
i
].
box_x
,

253 
comm_k“p
[
i
].
box_y
,

254 
comm_k“p
[
i
].
box_z
,

255 
comm_k“p
[
i
].
gz
,

256 
comm_k“p
[
i
].
bz
,

257 
comm_k“p
[
i
].
æag
);

258 
	`´štf
("£nd_d©a: %d\n",
couÁ_£nd
);

259 
i
=0; i<
couÁ_£nd
; i++)

260 
	`´štf
("task=%d, box_x=%d, box_y=%d, box_z=%d, global_z=%d,†ocal_z=%d, flag=%d\n",

261 
comm_£nd
[
i
].
sk
,

262 
comm_£nd
[
i
].
box_x
,

263 
comm_£nd
[
i
].
box_y
,

264 
comm_£nd
[
i
].
box_z
,

265 
comm_£nd
[
i
].
gz
,

266 
comm_£nd
[
i
].
bz
,

267 
comm_£nd
[
i
].
æag
);

268 
	`´štf
("»cv_d©a: %d\n",
couÁ_»cv
);

269 
i
=0; i<
couÁ_»cv
; i++)

270 
	`´štf
("task=%d, box_x=%d, box_y=%d, box_z=%d, global_z=%d,†ocal_z=%d, flag=%d\n",

271 
comm_»cv
[
i
].
sk
,

272 
comm_»cv
[
i
].
box_x
,

273 
comm_»cv
[
i
].
box_y
,

274 
comm_»cv
[
i
].
box_z
,

275 
comm_»cv
[
i
].
gz
,

276 
comm_»cv
[
i
].
bz
,

277 
comm_»cv
[
i
].
æag
);

282 
Ïrge¡_size
=(
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],
subbox
.
nbox_x
,0è+ 2.*subbox.
§ã_x
) *

283 (
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],
subbox
.
nbox_y
,0è+ 2.*subbox.
§ã_y
);

284 
sub_¶ªe
=(
´oduù_d©a
*)
	`m®loc
(
Ïrge¡_size
 * (product_data));

285 ià(
sub_¶ªe
==0x0)

287 
	`´štf
("ERROR oÀsk %d: could‚Ù‡Îoÿ‹ sub_¶ªš di¡ribu‹\n",
ThisTask
);

288 
	`fæush
 (
¡dout
);

293 
i
=0; i<
couÁ_k“p
; i++)

295 ià(
	`k“p_d©a
(
comm_k“p
+
i
))

297 
comm_k“p
[
i
].
check
=1;

301 
log_Áask
=0;†og_ntask<1000;†og_ntask++)

302 ià(1<<
log_Áask
 >ğ
NTasks
)

306 
b™
=1; b™<1<<
log_Áask
; bit++)

309 
£nd”
=0; s’d”<
NTasks
; sender++)

312 
»ûiv”
 = 
£nd”
 ^ 
b™
;

315 ià(
»ûiv”
 < 
NTasks
 && 
£nd”
 <„eceiver)

319 
ss
=
£nd”
;

320 
¼
=
»ûiv”
;

321 #ifdeà
VERBOSE


322 ià(!
ThisTask
)

323 
	`´štf
("COMMUNICATION %d %d\n",
ss
,
¼
);

325 
tuº
=0;urn<2;urn++)

327 ià(
ThisTask
==
ss
)

329 
i£nd
=0; i£nd<
couÁ_£nd
; isend++)

330 ià(
comm_£nd
[
i£nd
].
sk
==
¼
)

332 ià(
comm_£nd
[
i£nd
].
check
)

333 
	`´štf
("CASINO SEND %d %d %d %d\n",
ThisTask
,
¼
,
ss
,
i£nd
);

334 ià(
	`£nd_d©a
(
comm_£nd
+
i£nd
))

336 
comm_£nd
[
i£nd
].
check
=1;

339 ià(
ThisTask
==
¼
)

341 
œecv
=0; i»cv<
couÁ_»cv
 ; irecv++)

342 ià(
comm_»cv
[
œecv
].
sk
==
ss
)

344 ià(
comm_»cv
[
œecv
].
check
)

345 
	`´štf
("CASINO RECV %d %d %d %d\n",
ThisTask
,
¼
,
ss
,
i£nd
);

346 ià(
	`»cv_d©a
(
comm_»cv
+
œecv
))

348 
comm_»cv
[
œecv
].
check
=1;

353 
dd
=
¼
;

354 
¼
=
ss
;

355 
ss
=
dd
;

364 
i
=0; i<
couÁ_k“p
; i++)

365 ià(!
comm_k“p
[
i
].
check
)

366 
	`´štf
("CASINO FINALE KEEP %d %d %d\n",
ThisTask
,
i
,
comm_k“p
[i].
sk
);

367 
i
=0; i<
couÁ_£nd
; i++)

368 ià(!
comm_£nd
[
i
].
check
)

369 
	`´štf
("CASINO FINALE SEND %d %d %d\n",
ThisTask
,
i
,
comm_£nd
[i].
sk
);

370 
i
=0; i<
couÁ_»cv
; i++)

371 ià(!
comm_»cv
[
i
].
check
)

372 
	`´štf
("CASINO FINALE RECV %d %d %d\n",
ThisTask
,
i
,
comm_»cv
[i].
sk
);

374 
	`ä“
(
sub_¶ªe
);

376 
	`ä“
(
comm_k“p
);

377 
	`ä“
(
comm_»cv
);

378 
	`ä“
(
comm_£nd
);

380 
	`ä“
(
b–Úgs_glob®
);

381 
	`ä“
(
b–Úgs_loÿl
);

383 
	`fæush
(
¡dout
);

384 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

387 
	}
}

390 
	$fšd_sk
(
glob®_z
, 
i1
, 
i2
, 
i3
, *
£cÚd_sk
, *
box_z
, *
£cÚd_z
)

395 
maš_sk
,
i3bis
,
TL
;

398 ià(
i3
>=
subbox
.
nbox_z_this¦iû
*
ThisSliû
 && i3<subbox.nbox_z_thisslice*(ThisSlice+1))

399 
maš_sk
=
subbox
.
nbox_z_this¦iû
*(
i1
*subbox.
nbox_y
+
i2
)+(
i3
-subbox.nbox_z_this¦iû*
ThisSliû
);

401 
maš_sk
=-1;

404 *
box_z
=
glob®_z
-
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],
subbox
.
nbox_z_®l¦iûs
,
i3
);

405 
TL
=
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],
subbox
.
nbox_z_®l¦iûs
,
i3
);

408 ià(*
box_z
<
subbox
.
§ã_z
)

410 
i3bis
=
i3
-1;

411 ià(
i3bis
<0)

412 
i3bis
+=
subbox
.
nbox_z_®l¦iûs
;

413 ià(
i3bis
>=
subbox
.
nbox_z_this¦iû
*
ThisSliû
 && i3bis<subbox.nbox_z_thisslice*(ThisSlice+1))

415 *
£cÚd_sk
 = 
subbox
.
nbox_z_this¦iû
*(
i1
*subbox.
nbox_y
+
i2
)+(
i3bis
-subbox.nbox_z_this¦iû*
ThisSliû
);

416 *
£cÚd_z
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],
subbox
.
nbox_z_®l¦iûs
,
i3bis
è+ *
box_z
;

420 *
£cÚd_sk
=-1;

421 *
£cÚd_z
=-99;

424 ià(*
box_z
>=
TL
-
subbox
.
§ã_z
)

426 
i3bis
=
i3
+1;

427 ià(
i3bis
>=
subbox
.
nbox_z_®l¦iûs
)

428 
i3bis
-=
subbox
.
nbox_z_®l¦iûs
;

429 ià(
i3bis
>=
subbox
.
nbox_z_this¦iû
*
ThisSliû
 && i3bis<subbox.nbox_z_thisslice*(ThisSlice+1))

431 *
£cÚd_sk
 = 
subbox
.
nbox_z_this¦iû
*(
i1
*subbox.
nbox_y
+
i2
)+(
i3bis
-subbox.nbox_z_this¦iû*
ThisSliû
);

432 *
£cÚd_z
 = *
box_z
 - 
TL
;

436 *
£cÚd_sk
=-1;

437 *
£cÚd_z
=-99;

442 *
£cÚd_sk
=-1;

443 *
£cÚd_z
=-99;

447 *
box_z
 +ğ
subbox
.
§ã_z
;

448 *
£cÚd_z
 +ğ
subbox
.
§ã_z
;

450 #ifdeà
VERBOSE


456  
maš_sk
;

457 
	}
}

460 
	$£nd_d©a
(
comm_¡ruù
 *
comm_d©a
)

464 
j2
,
k2
,
j1
,
k1
,
k2¡¬t
,
k1¡¬t
;

465 
Lgrid_x
, 
Lgrid_y
, 
off£t
;

466 
size_t
 
size
;

468 #ifdeà
VERBOSE


469 
	`´štf
("SEND_DATA: Task %d s’dšgØ%d\n",
ThisTask
,
comm_d©a
->
sk
);

472 
Lgrid_x
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],
subbox
.
nbox_x
,
comm_d©a
->
box_x
è+ 2.*subbox.
§ã_x
;

473 
Lgrid_y
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],
subbox
.
nbox_y
,
comm_d©a
->
box_y
è+ 2.*subbox.
§ã_y
;

476 
size
 = 
Lgrid_x
 * 
Lgrid_y
;

477 ià(
size
>
Ïrge¡_size
)

479 
	`´štf
("ASSURDO: size>largest_size in SEND_DATA!!!\n");

484 
k2¡¬t
=
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_y_
],
subbox
.
nbox_y
,
comm_d©a
->
box_y
)-subbox.
§ã_y
;

485 
k1¡¬t
=
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_x_
],
subbox
.
nbox_x
,
comm_d©a
->
box_x
)-subbox.
§ã_x
;

489 
off£t
 = (
comm_d©a
->
gz
 - 
MyGrids
[0].
GS¡¬t
[
_z_
]è* MyGrids[0].
GSloÿl
[
_x_
] * MyGrids[0].GSloÿl[
_y_
];

490 
j2
=0; j2<
Lgrid_y
; j2++)

492 
k2
=
j2
+
k2¡¬t
;

493 ià(
k2
<0èk2+=
MyGrids
[0].
GSglob®
[
_y_
];

494 ià(
k2
>=
MyGrids
[0].
GSglob®
[
_y_
]) k2-=MyGrids[0].GSglobal[_y_];

495 
j1
=0; j1<
Lgrid_x
; j1++)

497 
k1
=
j1
+
k1¡¬t
;

498 ià(
k1
<0èk1+=
MyGrids
[0].
GSglob®
[
_x_
];

499 ià(
k1
>=
MyGrids
[0].
GSglob®
[
_x_
]) k1-=MyGrids[0].GSglobal[_x_];

501 *(
sub_¶ªe
 + 
j1
 + 
j2
*
Lgrid_x
) =

502 *(
´oduùs
 + 
k1
 + 
MyGrids
[0].
GSloÿl
[
_x_
] * 
k2
 + 
off£t
);

507 ià(
	`MPI_S’d
((*)
sub_¶ªe
, 
size
 * (
´oduù_d©a
),

508 
MPI_BYTE
, 
comm_d©a
->
sk
, 0, 
MPI_COMM_WORLD
è!ğ
MPI_SUCCESS
)

510 
	`´štf
("ERROR oÀsk %d: faed communiÿtiÚ iÀ£nd_d©a\n",
ThisTask
);

511 
	`fæush
(
¡dout
);

517 
	}
}

519 
	$»cv_d©a
(
comm_¡ruù
 *
comm_d©a
)

524 
i
,
off£t
;

525 
size_t
 
size
;

526 
MPI_Stus
 
¡©us
;

528 #ifdeà
VERBOSE


529 
	`´štf
("RECV_DATA: Task %d„eûivšg from %d\n",
ThisTask
,
comm_d©a
->
sk
);

533 
size
 = 
subbox
.
Lgwbl_x
 * subbox.
Lgwbl_y
;

534 ià(
size
>
Ïrge¡_size
)

536 
	`´štf
("ASSURDO: size>largest_size in RECV_DATA!!!\n");

541 ià(
	`MPI_Recv
((*)
sub_¶ªe
, 
size
 * (
´oduù_d©a
),

542 
MPI_BYTE
, 
comm_d©a
->
sk
, 0, 
MPI_COMM_WORLD
, &
¡©us
è!ğ
MPI_SUCCESS
)

544 
	`´štf
("ERROR oÀsk %d: faed communiÿtiÚ iÀ»cv_d©a\n",
ThisTask
);

545 
	`fæush
(
¡dout
);

550 
off£t
 = 
comm_d©a
->
bz
 * 
size
;

551 
i
=0; i<
size
; i++)

552 *(
äag
 + 
i
 + 
off£t
èğ*(
sub_¶ªe
+i);

556 
	}
}

558 
	$k“p_d©a
(
comm_¡ruù
 *
comm_d©a
)

560 
j2
,
k2
,
j1
,
k1
,
offmax
,
ofäag
;

564 
offmax
 = (
comm_d©a
->
gz
 - 
MyGrids
[0].
GS¡¬t
[
_z_
]è* MyGrids[0].
GSloÿl
[
_x_
] * MyGrids[0].GSloÿl[
_y_
];

565 
ofäag
 = 
comm_d©a
->
bz
 * 
subbox
.
Lgwbl_x
 * subbox.
Lgwbl_y
;

567 
j2
=0; j2<
subbox
.
Lgwbl_y
; j2++)

569 
k2
=
j2
+
subbox
.
¡abl_y
;

570 ià(
k2
<0èk2+=
MyGrids
[0].
GSloÿl
[
_y_
];

571 ià(
k2
>=
MyGrids
[0].
GSloÿl
[
_y_
]) k2-=MyGrids[0].GSlocal[_y_];

572 
j1
=0; j1<
subbox
.
Lgwbl_x
; j1++)

574 
k1
=
j1
+
subbox
.
¡abl_x
;

575 ià(
k1
<0èk1+=
MyGrids
[0].
GSloÿl
[
_x_
];

576 ià(
k1
>=
MyGrids
[0].
GSloÿl
[
_x_
]) k1-=MyGrids[0].GSlocal[_x_];

578 *(
äag
 + 
j1
 + 
j2
*
subbox
.
Lgwbl_x
 + 
ofäag
) =

579 *(
´oduùs
 + 
k1
 + 
MyGrids
[0].
GSloÿl
[
_x_
] * 
k2
 + 
offmax
);

584 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax-fftw.c

27 
	~"pšocchio.h
"

31 #ifdeà
DEBUG


32 
FILE
 *
	g»suÉs
;

33 
	gf’ame
[300];

37 
g»’s_funùiÚ
(*, , , );

39 
	$£t_Úe_grid
(
ThisGrid
)

41 
±rdiff_t
 
L
, 
M
, 
N
;

42 
±rdiff_t
 
®loc_loÿl
, 
loÿl_n0
, 
loÿl_0_¡¬t
;

43 
±rdiff_t
 
loÿl_n1
, 
loÿl_1_¡¬t
;

45 
	`fáw_mpi_š™
();

47 
MyGrids
[
ThisGrid
].
nÜm
 = 1.0

48 /()
MyGrids
[
ThisGrid
].
GSglob®_x


49 /()
MyGrids
[
ThisGrid
].
GSglob®_y


50 /()
MyGrids
[
ThisGrid
].
GSglob®_z
;

51 
MyGrids
[
ThisGrid
].
C–lSize
 = MyGrids[ThisGrid].
BoxSize
/()MyGrids[ThisGrid].
GSglob®_x
;

53 
L
=
MyGrids
[
ThisGrid
].
GSglob®_x
;

54 
M
=
MyGrids
[
ThisGrid
].
GSglob®_y
;

55 
N
=
MyGrids
[
ThisGrid
].
GSglob®_z
;

58 
®loc_loÿl
 = 
	`fáw_mpi_loÿl_size_3d_Œª¥o£d
(
L
, 
M
, 
N
/2+1, 
MPI_COMM_WORLD
,

59 &
loÿl_n0
, &
loÿl_0_¡¬t
,

60 &
loÿl_n1
, &
loÿl_1_¡¬t
);

62 
MyGrids
[
ThisGrid
].
GSloÿl_x
 = MyGrids[ThisGrid].
GSglob®_x
;

63 
MyGrids
[
ThisGrid
].
GSloÿl_y
 = MyGrids[ThisGrid].
GSglob®_y
;

64 
MyGrids
[
ThisGrid
].
GSloÿl_z
 = 
loÿl_n0
;

66 
MyGrids
[
ThisGrid
].
GS¡¬t_x
 = 0;

67 
MyGrids
[
ThisGrid
].
GS¡¬t_y
 = 0;

68 
MyGrids
[
ThisGrid
].
GS¡¬t_z
 = 
loÿl_0_¡¬t
;

70 
MyGrids
[
ThisGrid
].
GSloÿl_k_x
 = MyGrids[ThisGrid].
GSglob®_x
;

71 
MyGrids
[
ThisGrid
].
GSloÿl_k_y
 = 
loÿl_n1
;

72 
MyGrids
[
ThisGrid
].
GSloÿl_k_z
 = MyGrids[ThisGrid].
GSglob®_z
;

74 
MyGrids
[
ThisGrid
].
GS¡¬t_k_x
 = 0;

75 
MyGrids
[
ThisGrid
].
GS¡¬t_k_y
 = 
loÿl_1_¡¬t
;

76 
MyGrids
[
ThisGrid
].
GS¡¬t_k_z
 = 0;

78 
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size_fá
 = 2*
®loc_loÿl
;

79 
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size
 = MyGrids[ThisGrid].
GSloÿl_x
 * MyGrids[ThisGrid].
GSloÿl_y
 * MyGrids[ThisGrid].
GSloÿl_z
;

82 ià(
MyGrids
[0].
GSglob®_x
%2)

83 
MyGrids
[0].
off
=1;

85 
MyGrids
[0].
off
=2;

88 
	}
}

90 
	$š™Ÿlize_fá
()

92 
±rdiff_t
 
L
, 
M
, 
N
;

93 
igrid
;

95 
igrid
=0; igrid<
Ngrids
; igrid++)

98 
L
=
MyGrids
[
igrid
].
GSglob®_x
;

99 
M
=
MyGrids
[
igrid
].
GSglob®_y
;

100 
N
=
MyGrids
[
igrid
].
GSglob®_z
;

103 
MyGrids
[
igrid
].
fÜw¬d_¶ª
 = 
	`fáw_mpi_¶ª_dá_r2c_3d
(
L
, 
M
, 
N
, 
rveùÜ_fá
[igrid], 
cveùÜ_fá
[igrid],

104 
MPI_COMM_WORLD
, 
FFTW_MEASURE
 + 
FFTW_MPI_TRANSPOSED_OUT
);

106 
MyGrids
[
igrid
].
»v”£_¶ª
 = 
	`fáw_mpi_¶ª_dá_c2r_3d
(
L
, 
M
, 
N
, 
cveùÜ_fá
[igrid], 
rveùÜ_fá
[igrid],

107 
MPI_COMM_WORLD
, 
FFTW_MEASURE
 + 
FFTW_MPI_TRANSPOSED_IN
);

111 
	}
}

114 
	$fÜw¬d_ŒªsfÜm
(
ThisGrid
)

116 
time
;

118 
time
=
	`MPI_Wtime
();

120 
	`fáw_execu‹
(
MyGrids
[
ThisGrid
].
fÜw¬d_¶ª
);

122  
	`MPI_Wtime
()-
time
;

123 
	}
}

126 
	$»v”£_ŒªsfÜm
(
ThisGrid
)

129 
i
;

130 
time
;

133 
time
=
	`MPI_Wtime
();

135 
	`fáw_execu‹
(
MyGrids
[
ThisGrid
].
»v”£_¶ª
);

137 
i
=0; i<
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size_fá
; i++)

138 
rveùÜ_fá
[
ThisGrid
][
i
]*=
MyGrids
[ThisGrid].
nÜm
;

140 #ifdeà
DEBUG


141 
i
=0; i<
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size_fá
; i++)

142 
	`årštf
(
»suÉs
, " %d %g \n", 
i
, 
rveùÜ_fá
[
ThisGrid
][i]);

143 
	`fşo£
(
»suÉs
);

146  
	`MPI_Wtime
()-
time
;

147 
	}
}

150 
	$fš®ize_fáw
()

152 
igrid
;

154 
igrid
=
Ngrids
-1; igrid>=0; igrid--)

156 
	`fáw_de¡roy_¶ª
(
MyGrids
[
igrid
].
fÜw¬d_¶ª
);

157 
	`fáw_de¡roy_¶ª
(
MyGrids
[
igrid
].
»v”£_¶ª
);

160 
igrid
=
Ngrids
-1; igrid>=0; igrid--)

161 ià(
	`d—Îoÿ‹_fá_veùÜs
(
igrid
))

164 
	`fáw_ş—nup
();

167 
	}
}

171 
	$compu‹_d”iv©ive
(
ThisGrid
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
)

173 
sw­
, 
loÿl_x
,
loÿl_y
,
loÿl_z
,
ixx
,
iyy
,
izz
,
šdex
,
nxh®f
,
nyh®f
,
nzh®f
;

174 
kx
,
ky
,
kz
,
kxnÜm
,
kynÜm
,
kznÜm
,
g»’
,
k_squ¬ed
,
smoÙhšg
,
tmp
,
time
;

175 
diff_comp
[4];

178 #ifdeà
DEBUG


179 
	`¥rštf
(
f’ame
,"»suÉs.%d-%d.%d",
fœ¡_d”iv©ive
,
£cÚd_d”iv©ive
,
ThisTask
);

180 
»suÉs
=
	`fİ’
(
f’ame
,"w");

184 
kxnÜm
 = 2.*
PI
/()
MyGrids
[
ThisGrid
].
GSglob®_x
;

185 
kynÜm
 = 2.*
PI
/()
MyGrids
[
ThisGrid
].
GSglob®_y
;

186 
kznÜm
 = 2.*
PI
/()
MyGrids
[
ThisGrid
].
GSglob®_z
;

189 
nxh®f
 = 
MyGrids
[
ThisGrid
].
GSglob®_x
/2;

190 
nyh®f
 = 
MyGrids
[
ThisGrid
].
GSglob®_y
/2;

191 
nzh®f
 = 
MyGrids
[
ThisGrid
].
GSglob®_z
/2;

194 
sw­
=((
fœ¡_d”iv©ive
==0 && 
£cÚd_d”iv©ive
> 0) ||

195 (
fœ¡_d”iv©ive
> 0 && 
£cÚd_d”iv©ive
==0));

210 
loÿl_z
 = 0;†oÿl_z < 
MyGrids
[
ThisGrid
].
GSloÿl_k_z
;†ocal_z++)

212 
izz
 = 
loÿl_z
 + 
MyGrids
[
ThisGrid
].
GS¡¬t_k_z
;

213 ià(
loÿl_z
 > 
nzh®f
)

214 
izz
 -ğ
MyGrids
[
ThisGrid
].
GSglob®_z
;

215 
kz
 = 
kznÜm
*
izz
;

217 
loÿl_y
 = 0;†oÿl_y < 
MyGrids
[
ThisGrid
].
GSloÿl_k_y
;†ocal_y++)

219 
iyy
 = 
loÿl_y
 + 
MyGrids
[
ThisGrid
].
GS¡¬t_k_y
;

220 ià(
iyy
 > 
nyh®f
)

221 
iyy
 -ğ
MyGrids
[
ThisGrid
].
GSglob®_y
;

222 
ky
 = 
kynÜm
*
iyy
;

224 
loÿl_x
 = 0;†oÿl_x <ğ
nxh®f
;†ocal_x++)

226 
ixx
 = 
loÿl_x
;

227 
kx
 = 
kxnÜm
*
ixx
;

229 
k_squ¬ed
 = 
kx
*kx + 
ky
*ky + 
kz
*kz;

232 
šdex
 = 1 + 2*
loÿl_x
 + (
MyGrids
[
ThisGrid
].
GSglob®_x
+MyGrids[ThisGrid].
off
)

233 *(
loÿl_z
 + 
loÿl_y
* 
MyGrids
[
ThisGrid
].
GSglob®_z
);

235 ià(
k_squ¬ed
 != 0.)

239 
smoÙhšg
 = 
	`exp
(-0.5 * 
k_squ¬ed
 * 
RsmoÙh
 * Rsmooth);

242 
diff_comp
[0] = 1.0;

243 
diff_comp
[1] = 
kx
;

244 
diff_comp
[2] = 
ky
;

245 
diff_comp
[3] = 
kz
;

247 
g»’
 = 
	`g»’s_funùiÚ
(
diff_comp
, 
k_squ¬ed
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
);

249 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[0] *ğ
g»’
 * 
smoÙhšg
;

250 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1] *ğ
g»’
 * 
smoÙhšg
;

253 ià(
sw­
)

255 
tmp
 = (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1];

256 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1] = (cvector_fft[ThisGrid][index/2])[0];

257 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[0] = -
tmp
;

263 ià(!
ThisTask
)

264 
	`´štf
("[%s] compu‹_d”iv©ive: s¹šg fá\n",
	`fd©e
());

266 
time
=
	`»v”£_ŒªsfÜm
(
ThisGrid
);

268 ià(!
ThisTask
)

269 
	`´štf
("[%s] compu‹_d”iv©ive: dÚfá, cpuimğ%f\n",
	`fd©e
(),
time
);

271 
ıutime
.
fá
+=
time
;

274 
	}
}

277 
	$g»’s_funùiÚ
(*
diff_comp
, 
k_squ¬ed
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
)

281 ià(
fœ¡_d”iv©ive
 =ğ-1 && 
£cÚd_d”iv©ive
 == -1)

284 ià(
fœ¡_d”iv©ive
==0 && 
£cÚd_d”iv©ive
==0)

285  -
diff_comp
[
fœ¡_d”iv©ive
]*diff_comp[
£cÚd_d”iv©ive
]/
k_squ¬ed
;

287  
diff_comp
[
fœ¡_d”iv©ive
]*diff_comp[
£cÚd_d”iv©ive
]/
k_squ¬ed
;

289 
	}
}

292 
	$wr™e_š_cveùÜ
(
ThisGrid
, *
veùÜ
)

294 
i
;

296 
i
=0; i<
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size_fá
; i++)

297 *((*)
cveùÜ_fá
[
ThisGrid
]+
i
)=*(
veùÜ
+i);

299 
	}
}

302 
	$wr™e_äom_cveùÜ
(
ThisGrid
, *
veùÜ
)

304 
i
;

306 
i
=0; i<
MyGrids
[
ThisGrid
].
tÙ®_loÿl_size_fá
; i++)

307 *(
veùÜ
+
i
)=*((*)
cveùÜ_fá
[
ThisGrid
]+i);

309 
	}
}

312 
	$wr™e_š_rveùÜ
(
ThisGrid
, *
veùÜ
)

314 
lx
,
ly
,
lz
;

316 
lz
=0;†z<
MyGrids
[
ThisGrid
].
GSloÿl_z
;†z++)

317 
ly
=0;†y<
MyGrids
[
ThisGrid
].
GSloÿl_y
;†y++)

318 
lx
=0;†x<
MyGrids
[
ThisGrid
].
GSloÿl_x
;†x++)

319 *(
rveùÜ_fá
[
ThisGrid
] + 
lx
 + (
MyGrids
[ThisGrid].
GSloÿl_x
 + MyGrids[ThisGrid].
off
è* (
ly
 + 
lz
 * MyGrids[ThisGrid].
GSloÿl_y
)) =

320 *(
veùÜ
 + 
lx
 + 
MyGrids
[
ThisGrid
].
GSloÿl_x
 *(
ly
 + 
lz
* MyGrids[ThisGrid].
GSloÿl_y
));

322 
lz
=0;†z<
MyGrids
[
ThisGrid
].
GSloÿl_z
;†z++)

323 
ly
=0;†y<
MyGrids
[
ThisGrid
].
GSloÿl_y
;†y++)

324 
lx
=
MyGrids
[
ThisGrid
].
GSloÿl_x
;†x<MyGrids[ThisGrid].GSloÿl_x+MyGrids[ThisGrid].
off
;†x++)

325 *(
rveùÜ_fá
[
ThisGrid
] + 
lx
 + (
MyGrids
[ThisGrid].
GSloÿl_x
 + MyGrids[ThisGrid].
off
è* (
ly
 + 
lz
 * MyGrids[ThisGrid].
GSloÿl_y
)) = 0.0;

327 
	}
}

330 
	$wr™e_äom_rveùÜ
(
ThisGrid
, *
veùÜ
)

332 
lx
,
ly
,
lz
;

334 
lz
=0;†z<
MyGrids
[
ThisGrid
].
GSloÿl_z
;†z++)

335 
ly
=0;†y<
MyGrids
[
ThisGrid
].
GSloÿl_y
;†y++)

336 
lx
=0;†x<
MyGrids
[
ThisGrid
].
GSloÿl_x
;†x++)

337 *(
veùÜ
 + 
lx
 + 
MyGrids
[
ThisGrid
].
GSloÿl_x
 *(
ly
 + 
lz
* MyGrids[ThisGrid].
GSloÿl_y
)) =

338 *(
rveùÜ_fá
[
ThisGrid
] + 
lx
 + (
MyGrids
[ThisGrid].
GSloÿl_x
 + MyGrids[ThisGrid].
off
è* (
ly
 + 
lz
 * MyGrids[ThisGrid].
GSloÿl_y
));

340 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax-pfft.c

27 
	~"pšocchio.h
"

36 #ifdeà
DEBUG


37 
FILE
 *
	g»suÉs
;

38 
	gf’ame
[300];

41 
	#GRID
 
MyGrids
[
ThisGrid
]

	)

43 
±rdiff_t
 
	tpošt
[3];

44 
pošt
 *
	g¡¬ts
;

51 
g»’s_funùiÚ
 (*, , , );

52 
cubes_Üd”
 (const *, const *);

59 
	$cubes_Üd”
(cÚ¡ *
A
, cÚ¡ *
B
)

61 
a
 = *(
¡¬ts
[*(*)
A
]);

62 
b
 = *(
¡¬ts
[*(*)
B
]);

64 ifĞ
a
 > 
b
)

66 if(
a
 < 
b
)

69 
	}
}

74 
	$£t_Úe_grid
(
ThisGrid
)

76 
±rdiff_t
 
®loc_loÿl
;

77 
pfá_æags
;

79 
GRID
.
nÜm
 = ()1.0 /

80 (()
GRID
.
GSglob®
[
_x_
] * GRID.GSglob®[
_y_
] * GRID.GSglob®[
_z_
]);

82 
GRID
.
C–lSize
 = ()GRID.
BoxSize
/GRID.
GSglob®
[
_x_
];

85 
pfá_æags
 = 0;

86 if(
·¿ms
.
u£_Œª¥o£d_fá
)

87 
pfá_æags
 |ğ
PFFT_TRANSPOSED_OUT
;

89 
®loc_loÿl
 = 
	`pfá_loÿl_size_dá_r2c_3d
(
GRID
.
GSglob®
, 
FFT_Comm
, 
pfá_æags
,

90 
GRID
.
GSloÿl
, GRID.
GS¡¬t
,

91 
GRID
.
GSloÿl_k
, GRID.
GS¡¬t_k
);

94 
	`d´štf
(
VMSG
, 
ThisTask
, "[set grid %02d]ask %d %ld "

97 
ThisGrid
, 
ThisTask
, 
®loc_loÿl
,

98 
GRID
.
GSloÿl
[
_x_
], GRID.GSloÿl[
_y_
], GRID.GSloÿl[
_z_
],

99 
GRID
.
GS¡¬t
[
_x_
], GRID.GS¡¬t[
_y_
], GRID.GS¡¬t[
_z_
],

100 
GRID
.
GSloÿl_k
[
_x_
], GRID.GSloÿl_k[
_y_
], GRID.GSloÿl_k[
_z_
],

101 
GRID
.
GS¡¬t_k
[
_x_
], GRID.GS¡¬t_k[
_y_
], GRID.GS¡¬t_k[
_z_
]);

106 
GRID
.
tÙ®_loÿl_size_fá
 = 2 * 
®loc_loÿl
;

107 
GRID
.
tÙ®_loÿl_size
 = GRID.
GSloÿl
[
_x_
] * GRID.GSloÿl[
_y_
] * GRID.GSloÿl[
_z_
];

117 
GRID
.
off
 = 0;

139 
	}
}

144 
	$š™Ÿlize_fá
()

146 
±rdiff_t
 
DIM
[3];

147 
pfá_æags
;

148 
ThisGrid
;

150 
ThisGrid
 = 0; ThisGrid < 
Ngrids
; ThisGrid++)

153 
DIM
[
_x_
] = 
GRID
.
GSglob®
[_x_];

154 
DIM
[
_y_
] = 
GRID
.
GSglob®
[_y_];

155 
DIM
[
_z_
] = 
GRID
.
GSglob®
[_z_];

160 
pfá_æags
 = 
PFFT_MEASURE
 ;

162 if(
·¿ms
.
u£_Œª¥o£d_fá
)

163 
pfá_æags
 |ğ
PFFT_TRANSPOSED_OUT
;

164 
GRID
.
fÜw¬d_¶ª
 = 
	`pfá_¶ª_dá_r2c_3d
(
DIM
, 
rveùÜ_fá
[
ThisGrid
], 
cveùÜ_fá
[ThisGrid],

165 
FFT_Comm
, 
PFFT_FORWARD
, 
pfá_æags
);

168 
DIM
[
_x_
] = 
GRID
.
GSglob®
[_x_];

169 
DIM
[
_y_
] = 
GRID
.
GSglob®
[_y_];

170 
DIM
[
_z_
] = 
GRID
.
GSglob®
[_z_];

172 
pfá_æags
 = 
PFFT_MEASURE
;

173 if(
·¿ms
.
u£_Œª¥o£d_fá
)

174 
pfá_æags
 |ğ
PFFT_TRANSPOSED_IN
;

176 
GRID
.
»v”£_¶ª
 = 
	`pfá_¶ª_dá_c2r_3d
(
DIM
, 
cveùÜ_fá
[
ThisGrid
], 
rveùÜ_fá
[ThisGrid],

177 
FFT_Comm
, 
PFFT_BACKWARD
, 
pfá_æags
);

181 
	}
}

186 
	$fÜw¬d_ŒªsfÜm
(
ThisGrid
)

188 
time
;

190 
time
=
	`MPI_Wtime
();

192 
	`pfá_execu‹
(
GRID
.
fÜw¬d_¶ª
);

194  
	`MPI_Wtime
()-
time
;

195 
	}
}

201 
	$»v”£_ŒªsfÜm
(
ThisGrid
)

204 
i
;

205 
time
;

207 
time
=
	`MPI_Wtime
();

209 
	`pfá_execu‹
(
GRID
.
»v”£_¶ª
);

211 
dvec
 
NORM
 = {
GRID
.
nÜm
, GRID.norm, GRID.norm, GRID.norm};

212 
mysize
 = 
GRID
.
tÙ®_loÿl_size_fá
 / 4;

213 
i
 = 0; i < 
mysize
; i++)

214 *((
dvec
*)
rveùÜ_fá
[
ThisGrid
] + 
i
è*ğ
NORM
;

216 
i
 = 
GRID
.
tÙ®_loÿl_size_fá
 - GRID.total_local_size_fft%4 ; i < GRID.total_local_size_fft; i++)

217 
rveùÜ_fá
[
ThisGrid
][
i
] *ğ
GRID
.
nÜm
;

223 #ifdeà
DEBUG


224 
i
 = 0; i < 
GRID
.
tÙ®_loÿl_size_fá
; i++)

225 
	`årštf
(
»suÉs
, " %d %g \n", 
i
, 
rveùÜ_fá
[
ThisGrid
][i]);

226 
	`fşo£
(
»suÉs
);

229  
	`MPI_Wtime
()-
time
;

230 
	}
}

235 
	$fš®ize_fá
()

237 
ThisGrid
;

239 
ThisGrid
 = 
Ngrids
-1; ThisGrid >= 0; ThisGrid--)

241 
	`pfá_de¡roy_¶ª
(
GRID
.
fÜw¬d_¶ª
);

242 
	`pfá_de¡roy_¶ª
(
GRID
.
»v”£_¶ª
);

251 
	`pfá_ş—nup
();

252 
	`MPI_Comm_ä“
(&
FFT_Comm
);

255 
	}
}

258 
	$compu‹_d”iv©ive
(
ThisGrid
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
)

260 
sw­
, 
loÿl
[3], 
¡¬t
[3], 
C
[3], 
N
[3], 
Nh®f
[3];

261 
knÜm
[3];

263 #ifdeà
DEBUG


264 
	`¥rštf
(
f’ame
,"»suÉs.%d-%d.%d",
fœ¡_d”iv©ive
,
£cÚd_d”iv©ive
,
ThisTask
);

265 
»suÉs
=
	`fİ’
(
f’ame
,"w");

274 if(!
·¿ms
.
u£_Œª¥o£d_fá
)

276 
i
 = 0; i < 3; i++)

277 
C
[
i
] = i;

280 if(
š‹º®
.
sks_subdivisiÚ_dim
 > 1)

281 
C
[0] = 
_y_
, C[1] = 
_z_
, C[2] = 
_x_
;

283 
C
[0] = 
_y_
, C[1] = 
_x_
, C[2] = 
_z_
;

286 
i
 = 0; i < 3; i++)

289 
N
[
i
] = 
GRID
.
GSglob®
[
C
[i]];

291 
Nh®f
[
i
] = 
N
[i] / 2;

293 
knÜm
[
i
] = 2.*
PI
/()
GRID
.
GSglob®
[
C
[i]];

295 
loÿl
[
i
] = 
GRID
.
GSloÿl_k
[
C
[i]];

296 
¡¬t
[
i
] = 
GRID
.
GS¡¬t_k
[
C
[i]];

301 
sw­
=((
fœ¡_d”iv©ive
==0 && 
£cÚd_d”iv©ive
> 0) ||

302 (
fœ¡_d”iv©ive
> 0 && 
£cÚd_d”iv©ive
==0));

307 
idx
;

308 
idx
 = 0; idx < 
loÿl
[
_x_
]; idx++)

310 
ii
[3];

312 
ii
[
_x_
] = 
idx
 + 
¡¬t
[_x_];

314 ià(
ii
[
_x_
] > 
Nh®f
[_x_])

315 
ii
[
_x_
] -ğ
N
[_x_];

317 
k_x
 = 
knÜm
[
_x_
] * 
ii
[_x_];

318 
k2_0
 = 
k_x
 * k_x;

320 
idy
;

321 
idy
 = 0; idy < 
loÿl
[
_y_
]; idy++)

323 
ii
[
_y_
] = 
idy
 + 
¡¬t
[_y_];

325 ià(
ii
[
_y_
] > 
Nh®f
[_y_])

326 
ii
[
_y_
] -ğ
N
[_y_];

328 
k_y
 = 
knÜm
[
_y_
] * 
ii
[_y_];

329 
k2_1
 = 
k2_0
 + 
k_y
 * k_y;

331 
idz
;

332 
idz
 = 0; idz < 
loÿl
[
_z_
]; idz++)

334 
ii
[
_z_
] = 
idz
 + 
¡¬t
[_z_];

336 ià(
ii
[
_z_
] > 
Nh®f
[_z_])

337 
ii
[
_z_
] -ğ
N
[_z_];

339 
k_z
 = 
knÜm
[
_z_
] * 
ii
[_z_];

341 
k_squ¬ed
 = 
k2_1
 + 
k_z
 * k_z;

343 
šdex
 = 2*(Ğ
idx
 * 
loÿl
[
_y_
] + 
idy
 ) *†oÿl[
_z_
] + 
idz
);

345 ià(
k_squ¬ed
 != 0.)

349 
smoÙhšg
 = 
	`exp
(-0.5 * 
k_squ¬ed
 * 
RsmoÙh
 * Rsmooth);

351 
diff_comp
[4];

354 
diff_comp
[0] = 1.0;

355 
diff_comp
[1] = 
k_x
;

356 
diff_comp
[2] = 
k_y
;

357 
diff_comp
[3] = 
k_z
;

359 
g»’
 = 
	`g»’s_funùiÚ
(
diff_comp
, 
k_squ¬ed
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
);

361 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[0] *ğ
g»’
 * 
smoÙhšg
;

362 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1] *ğ
g»’
 * 
smoÙhšg
;

365 ià(
sw­
)

367 
tmp
 = (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1];

368 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[1] = (cvector_fft[ThisGrid][index/2])[0];

369 (
cveùÜ_fá
[
ThisGrid
][
šdex
/2])[0] = -
tmp
;

384 ià(!
ThisTask
)

385 
	`d´štf
(
VMSG
, 0, "[%s] compu‹_d”iv©ive: s¹šg fá\n",
	`fd©e
());

388 
time
 = 
	`»v”£_ŒªsfÜm
(
ThisGrid
);

390 ià(!
ThisTask
)

391 
	`d´štf
(
VMSG
, 0, "[%s] compu‹_d”iv©ive: dÚfá, cpuimğ%f\n",
	`fd©e
(),
time
);

393 
ıutime
.
fá
+=
time
;

397 
	}
}

402 
	$g»’s_funùiÚ
(*
diff_comp
, 
k_squ¬ed
, 
fœ¡_d”iv©ive
, 
£cÚd_d”iv©ive
)

405 ià(
fœ¡_d”iv©ive
 =ğ-1 && 
£cÚd_d”iv©ive
 == -1)

409 ià(
fœ¡_d”iv©ive
==0 && 
£cÚd_d”iv©ive
==0)

410  -
diff_comp
[
fœ¡_d”iv©ive
]*diff_comp[
£cÚd_d”iv©ive
]/
k_squ¬ed
;

412  
diff_comp
[
fœ¡_d”iv©ive
]*diff_comp[
£cÚd_d”iv©ive
]/
k_squ¬ed
;

414 
	}
}

419 
	$wr™e_š_cveùÜ
(
ThisGrid
, * 
»¡riù
 
veùÜ
)

421 
i
;

422 
dvec
 * 
»¡riù
 
rg‘
 = (dvec*)
cveùÜ_fá
[
ThisGrid
];

423 
dvec
 * 
»¡riù
 
sourû
 = (dvec*)
veùÜ
;

424 
mysize
 = 
GRID
.
tÙ®_loÿl_size_fá
/
DVEC_SIZE
;

426 #´agm¨
GCC
 
ivd•


427  
i
 = 0; i < 
mysize
; i++ )

428 *(
rg‘
 + 
i
èğ*(
sourû
 + i);

430 
i
 = 
mysize
*
DVEC_SIZE
; i < 
GRID
.
tÙ®_loÿl_size_fá
; i++ )

431 *((*)
cveùÜ_fá
[
ThisGrid
] + 
i
èğ*(
veùÜ
+i);

437 
	}
}

442 
	$wr™e_äom_cveùÜ
(
ThisGrid
, * 
»¡riù
 
veùÜ
)

444 
i
;

445 
dvec
 * 
»¡riù
 
sourû
 = (dvec*)
cveùÜ_fá
[
ThisGrid
];

446 
dvec
 * 
»¡riù
 
rg‘
 = (dvec*)
veùÜ
;

448 
mysize
 = 
GRID
.
tÙ®_loÿl_size_fá
/
DVEC_SIZE
;

450 #´agm¨
GCC
 
ivd•


451  
i
 = 0; i < 
mysize
; i++ )

452 *(
rg‘
 + 
i
èğ*(
sourû
 + i);

454 
i
 = 
mysize
*
DVEC_SIZE
; i < 
GRID
.
tÙ®_loÿl_size_fá
; i++ )

455 *(
veùÜ
 + 
i
èğ*((*)
cveùÜ_fá
[
ThisGrid
] + i);

461 
	}
}

465 
	$wr™e_š_rveùÜ
(
ThisGrid
, * 
»¡riù
 
veùÜ
)

467 
i
;

468 
dvec
 * 
»¡riù
 
rg‘
 = (dvec*)
rveùÜ_fá
[
ThisGrid
];

469 
dvec
 * 
»¡riù
 
sourû
 = (dvec*è
veùÜ
;

470 
mysize
 = 
GRID
.
tÙ®_loÿl_size
 / 
DVEC_SIZE
;

472 #´agm¨
GCC
 
ivd•


473 
i
 = 0; i < 
mysize
; i ++)

474 *(
rg‘
 + 
i
èğ*(
sourû
 + i);

475 
i
 = 
mysize
*
DVEC_SIZE
 ; i < 
GRID
.
tÙ®_loÿl_size
; i++)

476 *((*)
rveùÜ_fá
[
ThisGrid
] + 
i
èğ*(
veùÜ
 + i);

482 
	}
}

485 
	$wr™e_äom_rveùÜ
(
ThisGrid
, * 
»¡riù
 
veùÜ
)

487 
i
;

489 
dvec
 * 
»¡riù
 
sourû
 = (dvec*)
rveùÜ_fá
[
ThisGrid
];

490 
dvec
 * 
»¡riù
 
rg‘
 = (dvec*)
veùÜ
;

491 
mysize
 = 
GRID
.
tÙ®_loÿl_size
 / 
DVEC_SIZE
;

493 #´agm¨
GCC
 
ivd•


494  
i
 = 0; i < 
mysize
; i ++)

495 *(
rg‘
 + 
i
èğ*(
sourû
 + i);

497  
i
 = 
mysize
*
DVEC_SIZE
; i < 
GRID
.
tÙ®_loÿl_size
; i++)

498 *(
veùÜ
 + 
i
èğ*((*)
rveùÜ_fá
[
ThisGrid
] + i);

504 
	}
}

509 
	$dump_cveùÜ
(*
veùÜ
, 
T
, 
Nmesh
, 
±rdiff_t
 *
loÿl_n
,…Œdiff_ˆ*
loÿl_¡¬t
, *
f’ame
, 
ThisGrid
)

523 
ii
, 
i
, 
j
, 
k
, 
addr
, 
addr_
;

524 
Nmesh_2
 = 
Nmesh
 / 2;

525 
FILE
 *
fe
;

526 
myf’ame
[300];

528 
	`¥rštf
(
myf’ame
, "·¹Ÿl_%d", 
ThisTask
);

530 
ii
 = 0; i˜< 
NTasks
; ii++)

532 ifĞ(
ThisTask
 =ğ
ii
) &&

533 (
loÿl_¡¬t
[
_z_
] < 
Nmesh_2
-1) )

535 
fe
 = 
	`fİ’
(
myf’ame
, "w");

537 if(
T
 == 1)

540 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

541 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

542 
k
 = 0; k < (
loÿl_n
[
_z_
]è&& (k + 
loÿl_¡¬t
[_z_] < 
Nmesh_2
); k++)

544 if(
š‹º®
.
dump_kd’s™y
 == 1)

546 
addr_
 = ((
i
+
loÿl_¡¬t
[
_x_
])*
Nmesh
 + 
j
+loÿl_¡¬t[
_y_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

549 
addr_
 = ((
j
+
loÿl_¡¬t
[
_y_
])*
Nmesh
 + 
i
+loÿl_¡¬t[
_x_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

550 
addr
 = 2*((
j
 * 
loÿl_n
[
_x_
] + 
i
è*†oÿl_n[
_z_
] + 
k
);

551 
	`årštf
(
fe
, "%d - %g %g\n", 
addr_
,

552 
veùÜ
[
addr
], vector[addr+1]);

556 if(
T
 > 1)

559 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

560 
k
 = 0; k < (
loÿl_n
[
_z_
]è&& (k + 
loÿl_¡¬t
[_z_] < 
Nmesh_2
); k++)

561 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

563 if(
š‹º®
.
dump_kd’s™y
 == 1)

565 
addr_
 = ((
i
+
loÿl_¡¬t
[
_x_
])*
Nmesh
 + 
j
+loÿl_¡¬t[
_y_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

568 
addr_
 = ((
j
+
loÿl_¡¬t
[
_y_
])*
Nmesh
 + 
k
+loÿl_¡¬t[
_z_
])*(
Nmesh_2
+1è+ 
i
+loÿl_¡¬t[
_x_
];

569 
addr
 = 2*((
j
 * 
loÿl_n
[
_z_
] + 
k
è*†oÿl_n[
_x_
] + 
i
);

570 
	`årštf
(
fe
, "%d - %g %g\n", 
addr_
,

571 
veùÜ
[
addr
], vector[addr+1]);

578 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

579 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

580 
k
 = 0; k < (
loÿl_n
[
_z_
]è&& (k + 
loÿl_¡¬t
[_z_] < 
Nmesh_2
); k++)

582 if(
š‹º®
.
dump_kd’s™y
 == 2)

584 
addr_
 = ((
j
+
loÿl_¡¬t
[
_y_
])*
Nmesh
 + 
i
+loÿl_¡¬t[
_x_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

587 
addr_
 = ((
i
+
loÿl_¡¬t
[
_x_
])*
Nmesh
 + 
j
+loÿl_¡¬t[
_y_
])*(
Nmesh_2
+1è+ 
k
+loÿl_¡¬t[
_z_
];

588 
addr
 = 2*Ğ(
i
*
loÿl_n
[
_y_
] + 
j
)*loÿl_n[
_z_
] + 
k
);

589 
	`årštf
(
fe
, "%d - %g %g\n", 
addr_
,

590 
veùÜ
[
addr
], vector[addr+1]);

595 
	`fæush
(
fe
);

596 
	`fşo£
(
fe
);

599 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

602 if(
ThisTask
 == 0)

604 
”r
;

605 
	`¥rštf
(
myf’ame
, "ÿˆ·¹Ÿl_* | sÜˆ-k1 -À> %s", 
f’ame
);

606 
”r
 = 
	`sy¡em
(
myf’ame
);

607 
”r
 = 
	`sy¡em
("rm -f…artial_*");

608 if(
”r
 != 0)

609 
	`d´štf
(
VXX
, 0, "something got wrong while writing cvector dump file\n");

615 
	}
}

618 
	$dump_rveùÜ
(*
veùÜ
, 
Nmesh
, 
±rdiff_t
 *
loÿl_n
,…Œdiff_ˆ*
loÿl_¡¬t
, *
f’ame
, 
ThisGrid
)

628 
ii
, 
i
, 
j
, 
k
, 
addr
, 
addr_
;

630 
FILE
 *
fe
;

631 
myf’ame
[300];

633 
	`¥rštf
(
myf’ame
, "·¹Ÿl_%d", 
ThisTask
);

635 
ii
 = 0; i˜< 
NTasks
; ii++)

637 ifĞ(
ThisTask
 =ğ
ii
) )

639 
fe
 = 
	`fİ’
(
myf’ame
, "w");

641 
i
 = 0; i < 
loÿl_n
[
_x_
]; i++)

642 
j
 = 0; j < 
loÿl_n
[
_y_
]; j++)

643 
k
 = 0; k < 
loÿl_n
[
_z_
]; k++)

645 
addr_
 = ((
i
+
loÿl_¡¬t
[
_x_
])*
Nmesh
 + 
j
+loÿl_¡¬t[
_y_
])*Nmesh + 
k
+loÿl_¡¬t[
_z_
];

646 
addr
 = ( (
i
*
loÿl_n
[
_y_
] + 
j
)*loÿl_n[
_z_
] + 
k
);

648 
	`årštf
(
fe
, "%d %g\n", 
addr_
, 
veùÜ
[
addr
]);

651 
	`fæush
(
fe
);

652 
	`fşo£
(
fe
);

655 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

658 if(
ThisTask
 == 0)

660 
”r
;

661 
	`¥rštf
(
myf’ame
, "ÿˆ·¹Ÿl_* | sÜˆ-k1 -À> %s", 
f’ame
);

662 
”r
 = 
	`sy¡em
(
myf’ame
);

663 
”r
 = 
	`sy¡em
("rm -f…artial_*");

664 if(
”r
 != 0)

665 
	`d´štf
(
VXX
, 0, "something got wrong while writing cvector dump file\n");

671 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax.c

27 
	~"pšocchio.h
"

29 
compu‹_£cÚd_d”iv©ives
(, );

30 
compu‹_fœ¡_d”iv©ives
(, );

34 
	$compu‹_fmax
()

36 
ismoÙh
,
ThisGrid
;

37 
ıutmp
,
ıusm
;

39 
ıutime
.
fmax
=
	`MPI_Wtime
();

41 ià(!
ThisTask
)

42 
	`´štf
("[%s] Fœ¡…¬t: computiÚ oàcŞÏp£imes\n",
	`fd©e
());

44 
ThisGrid
=0;

60 
ismoÙh
=0; ismoÙh<
SmoÙhšg
.
NsmoÙh
; ismooth++)

62 ià(!
ThisTask
)

63 
	`´štf
("\n[%s] Starting smoothing„adius %d of %d (R=%9.5f, sigma=%9.5f)\n",

64 
	`fd©e
(), 
ismoÙh
+1, 
SmoÙhšg
.
NsmoÙh
, SmoÙhšg.
Radius
[ismooth],

65 
	`sq¹
(
SmoÙhšg
.
V¬Ÿnû
[
ismoÙh
]) );

67 
ıusm
=
	`MPI_Wtime
();

74 ià(!
ThisTask
)

75 
	`´štf
("[%s] Computšg secÚd d”iv©ives\n",
	`fd©e
());

77 
ıutmp
=
	`MPI_Wtime
();

79 ià(
	`compu‹_£cÚd_d”iv©ives
(
SmoÙhšg
.
Radius
[
ismoÙh
] ,
ThisGrid
))

82 
ıutmp
=
	`MPI_Wtime
()-cputmp;

84 ià(!
ThisTask
)

85 
	`´štf
("[%s] DÚ£cÚd d”iv©ives, cpuimğ%às\n",
	`fd©e
(),
ıutmp
);

86 
ıutime
.
d”iv
 +ğ
ıutmp
;

93 ià(!
ThisTask
)

94 
	`´štf
("[%s] Computšg cŞÏp£imes\n",
	`fd©e
());

96 
ıutmp
=
	`MPI_Wtime
();

98 ià(
	`compu‹_cŞÏp£_times
(
ismoÙh
))

101 
ıutmp
 = 
	`MPI_Wtime
()-cputmp;

102 ià(!
ThisTask
)

103 
	`´štf
("[%s] DÚcomputšg cŞÏp£imes, cpuimğ%às\n",
	`fd©e
(),
ıutmp
);

104 
ıutime
.
cŞl
 +ğ
ıutmp
;

106 #ifdeà
TWO_LPT


107 #iâdeà
SMOOTH_VELOCITIES


108 ià(
ismoÙh
==
SmoÙhšg
.
NsmoÙh
-1)

112 ià(!
ThisTask
)

113 
	`´štf
("[%s] Computšg LPT di¥Ïûm’ts\n",
	`fd©e
());

115 
ıutmp
=
	`MPI_Wtime
();

117 ià(
	`compu‹_LPT_di¥Ïûm’ts
(
ismoÙh
))

120 
ıutmp
=
	`MPI_Wtime
()-cputmp;

121 ià(!
ThisTask
)

122 
	`´štf
("[%s] DÚLPT di¥Ïûm’ts, cpuimğ%às\n",
	`fd©e
(),
ıutmp
);

123 
ıutime
.
Ít
+=
ıutmp
;

132 #iâdeà
SMOOTH_VELOCITIES


133 ià(
ismoÙh
==
SmoÙhšg
.
NsmoÙh
-1)

136 ià(!
ThisTask
)

137 
	`´štf
("[%s] Computšg fœ¡ d”iv©ives\n",
	`fd©e
());

139 
ıutmp
=
	`MPI_Wtime
();

141 ià(
	`compu‹_fœ¡_d”iv©ives
(
SmoÙhšg
.
Radius
[
ismoÙh
] ,
ThisGrid
))

144 
ıutmp
=
	`MPI_Wtime
()-cputmp;

145 ià(!
ThisTask
)

146 
	`´štf
("[%s] DÚfœ¡ d”iv©ives, cpuimğ%às\n",
	`fd©e
(),
ıutmp
);

153 ià(!
ThisTask
)

154 
	`´štf
("[%s] Computšg v–oc™›s\n",
	`fd©e
());

156 
ıutmp
=
	`MPI_Wtime
();

158 ià(
	`compu‹_v–oc™›s
(
ismoÙh
))

161 
ıutmp
=
	`MPI_Wtime
()-cputmp;

162 ià(!
ThisTask
)

163 
	`´štf
("[%s] DÚcomputšg v–oc™›s, cpuimğ%às\n",
	`fd©e
(),
ıutmp
);

164 
ıutime
.
v–
+=
ıutmp
;

171 
ıusm
 = 
	`MPI_Wtime
()-cpusm;

173 ià(!
ThisTask
)

174 
	`´štf
("Smoothing„adius completed: %d, R=%6.3f,ƒxpected„ms: %7.4f, computed„ms: %7.4f, cpuime = %f s\n",

175 
ismoÙh
, 
SmoÙhšg
.
Radius
[ismoÙh], 
	`sq¹
(SmoÙhšg.
V¬Ÿnû
[ismooth]),

176 
	`sq¹
(
SmoÙhšg
.
TrueV¬Ÿnû
[
ismoÙh
]), 
ıusm
 );

178 
	`fæush
(
¡dout
);

179 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

188 
ıutmp
=
	`MPI_Wtime
();

190 #iâdeà
TEST_ONLY


191 ià(
	`wr™e_f›lds
())

194 
ıutime
.
io
 +ğ
	`MPI_Wtime
()-
ıutmp
;

197 ià(
	`fš®ize_fá
())

200 
ıutime
.
fmax
 = 
	`MPI_Wtime
() - cputime.fmax;

202 ià(!
ThisTask
)

203 
	`´štf
("[%s] Finishing fmax,otal fmax cpuime = %14.6f\n"

207 
	`fd©e
(), 
ıutime
.
fmax
, cputime.
io
, cputime.fmax-ıutime.io, cputime.
fá
, cputime.
cŞl
);

210 
	}
}

213 
	$compu‹_fœ¡_d”iv©ives
(
R
, 
ThisGrid
)

217 
time
 = 0;

220 
RsmoÙh
 = 
R
 / 
MyGrids
[
ThisGrid
].
C–lSize
;

222 
Ÿ
 = 1; ia <= 3; ia++)

225 ià(!
ThisTask
)

226 
	`´štf
("[%s] Computšg 1¡ d”iv©ive: %d\n",
	`fd©e
(),
Ÿ
);

228 
tim‘mp
 = 
	`MPI_Wtime
();

229 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

230 
time
 +ğ
	`MPI_Wtime
(è- 
tim‘mp
;

232 ià(
	`compu‹_d”iv©ive
(
ThisGrid
,
Ÿ
,0))

235 
tim‘mp
 = 
	`MPI_Wtime
();

236 
	`wr™e_äom_rveùÜ
(
ThisGrid
, 
fœ¡_d”iv©ives
[ThisGrid][
Ÿ
-1]);

237 
time
 +ğ
	`MPI_Wtime
(è- 
tim‘mp
;

240 
ıutime
.
mem_Œªsf
 +ğ
time
;

242 
	}
}

245 
	$compu‹_£cÚd_d”iv©ives
(
R
, 
ThisGrid
)

250 
Ÿ
,
ib
,
id”
;

251 
time
 = 0;

254 
RsmoÙh
 = 
R
 / 
MyGrids
[
ThisGrid
].
C–lSize
;

256 
Ÿ
=1; ia<=3; ia++)

257 
ib
=
Ÿ
; ib<=3; ib++)

260 
id”
=Ğ
Ÿ
==
ib
? ia : ia+ib+1 );

262 ià(!
ThisTask
)

263 
	`´štf
("[%s] Computšg 2nd d”iv©ive: %d\n",
	`fd©e
(),
id”
);

265 
tim‘mp
 = 
	`MPI_Wtime
();

266 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

267 
time
 +ğ
	`MPI_Wtime
(è- 
tim‘mp
;

269 ià(
	`compu‹_d”iv©ive
(
ThisGrid
,
Ÿ
,
ib
))

272 
tim‘mp
 = 
	`MPI_Wtime
();

273 
	`wr™e_äom_rveùÜ
(
ThisGrid
, 
£cÚd_d”iv©ives
[ThisGrid][
id”
-1]);

274 
time
 +ğ
	`MPI_Wtime
(è- 
tim‘mp
;

277 
ıutime
.
mem_Œªsf
 +ğ
time
;

279 
	}
}

282 *
	$fd©e
()

287 
time_t
 
cu¼’t_time
;

288 *
¡ršg
;

289 
n
;

298 
cu¼’t_time
=
	`time
(
NULL
);

299 
¡ršg
=
	`ùime
(&
cu¼’t_time
);

301 
n
=0;‚<10;‚++)

302 *(
d©e_¡ršg
+
n
)=*(
¡ršg
+n);

303 
n
=10;‚<15;‚++)

304 *(
d©e_¡ršg
+
n
)=*(
¡ršg
+n+9);

305 
n
=10;‚<19;‚++)

306 *(
d©e_¡ršg
+
n
+5)=*(
¡ršg
+n);

307 *(
d©e_¡ršg
+24)='\0';

309  
d©e_¡ršg
;

310 
	}
}

313 
	$compu‹_di¥Ïûm’ts
()

315 
i
;

317 #ifdeà
TWO_LPT


318 
j
;

320 ià(
	`compu‹_£cÚd_d”iv©ives
(0.0, 0))

322 ià(
	`compu‹_LPT_di¥Ïûm’ts
(0))

325 
i
=0; i<3; i++)

326 
j
=0; j<
MyGrids
[0].
tÙ®_loÿl_size
; j++)

327 
£cÚd_d”iv©ives
[0][
i
+3][
j
]=second_derivatives[0][i][j];

329 
i
=0; i<3; i++)

330 
VEL2_fÜ_di¥l
[
i
]=
£cÚd_d”iv©ives
[0][i+3];

334 ià(
	`compu‹_fœ¡_d”iv©ives
(0.0, 0))

337 
i
=0; i<3; i++)

338 
VEL_fÜ_di¥l
[
i
]=
fœ¡_d”iv©ives
[0][i];

341 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fragment.c

27 
	~"pšocchio.h
"

28 
	~"äagm’t.h
"

29 
	~<sys/ty³s.h
>

30 
	~<sys/¡©.h
>

32 
š™_äagm’t_1
();

33 
š™_äagm’t_2
(*);

34 
couÁ_³aks
();

35 
£t_äagm’t_·¿m‘”s
();

39 #ià
defšed
(
LIST_OF_FRAGMENT_PARAMETERS
è&& defšed(
READ_FRAGMENT_PARAMS_FROM_FILE
)

40 #”rÜ 
Tryšg
 
to
 
compe
 
w™h
 
LIST_OF_FRAGMENT_PARAMETERS
 
ªd
 
READ_FRAGMENT_PARAMS_FROM_FILE


44 
	gngroups
;

46 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


47 
	gfœ¡_time
=1;

50 
	$£t_äagm’t_·¿m‘”s
(
Üd”
)

53 #iâdeà
TWO_LPT


54 
Üd”
=1;

56 #iâdeà
THREE_LPT


57 ià(
Üd”
>2)

58 
Üd”
=2;

60 ià(
Üd”
>3)

61 
Üd”
=3;

67 
f_200
 = 0.171;

68 
Üd”
)

71 #ifdeà
USE_SIM_PARAMS


72 
f_m
 = 
f_a
 = 0.495;

73 
f_rm
 = -0.075;

74 
e¥o
 = 0.852;

75 
f_¿
 = 0.500;

77 
f_m
 = 
f_a
 = 0.505;

78 
f_rm
 = 0.000;

79 
e¥o
 = 0.820;

80 
f_¿
 = 0.300;

82 
sigmaD0
 = 1.7;

86 #ifdeà
USE_SIM_PARAMS


87 
f_m
 = 
f_a
 = 0.475;

88 
f_rm
 = -0.020;

89 
e¥o
 = 0.780;

90 
f_¿
 = 0.650;

92 
f_m
 = 
f_a
 = 0.501;

93 
f_rm
 = 0.052;

94 
e¥o
 = 0.745;

95 
f_¿
 = 0.334;

97 
sigmaD0
 = 1.5;

101 #ifdeà
USE_SIM_PARAMS


102 
f_m
 = 
f_a
 = 0.455;

103 
f_rm
 = 0.000;

104 
e¥o
 = 0.755;

105 
f_¿
 = 0.700;

107 
f_m
 = 
f_a
 = 0.5024;

108 
f_rm
 = 0.1475;

109 
e¥o
 = 0.6852;

110 
f_¿
 = 0.4584;

112 
sigmaD0
 = 1.2;

119 
	}
}

123 
	$äagm’t
()

125 
N³aks
;

126 
tmp
;

129 
ıutime
.
äag
=
	`MPI_Wtime
();

131 ià(!
ThisTask
)

132 
	`´štf
("[%s] SecÚd…¬t: f¿gm’tiÚ oàthcŞÏp£d medium\n",
	`fd©e
());

134 ià(
	`š™_äagm’t_1
())

137 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


138 
FILE
 *
li¡fe
;

139 
Â
, 
mÜe_·¿ms
;

140 
tobÿ¡
[6];

141 
bufãr
[
BLENGTH
],
MyRunFÏg
[BLENGTH],
check
[BLENGTH];

142 
§ve_mybox_z
;

143 
¡©
 
dr
;

145 
§ve_mybox_z
 = 
subbox
.
mybox_z
;

146 
	`¡rıy
(
MyRunFÏg
,
·¿ms
.
RunFÏg
);

151 ià(!
ThisTask
)

153 
mÜe_·¿ms
=0;

154 
tobÿ¡
[0]=-99.0;

155 ià(
fœ¡_time
)

157 
li¡fe
=
	`fİ’
("list_of_fragment_parameters.txt","r");

158 ià(
li¡fe
==0x0)

159 
	`´štf
("\n[%s]†i¡_of_äagm’t_·¿m‘”s.txˆnÙ found, usšg snd¬d…¬am‘”s\n",
	`fd©e
());

161 
	`´štf
("\n[%s]†i¡_of_äagm’t_·¿m‘”s.txˆfound\n",
	`fd©e
());

164 ià(
li¡fe
!=0x0)

166 !
mÜe_·¿ms
 && !
	`ãof
(
li¡fe
))

168 
	`fg‘s
(
bufãr
,
BLENGTH
,
li¡fe
);

169 ià(!
	`ãof
(
li¡fe
è&& 
bufãr
[0]!='#' && buffer[0]!='%' &&

170 (
Â
=
	`ssÿnf
(
bufãr
,"%là%là%là%là%là%lf",&
f_m
,&
f_rm
,&
e¥o
,&
f_a
,&
f_¿
,&
f_200
)) == 6)

172 
	`¥rštf
(
·¿ms
.
RunFÏg
,"%s.fm%5.3f-rm%5.3f-em%5.3f-ç%5.3f-¿%5.3f-—%5.3f",
MyRunFÏg
,
f_m
,
f_rm
,
e¥o
,
f_a
,
f_¿
,
f_200
);

173 
	`¥rštf
(
check
,"pšocchio.%6.4f.%s.mf.out",
ouuts
.
z
[ouuts.
n
-1],
·¿ms
.
RunFÏg
);

174 ià(
	`¡©
(
check
,&
dr
))

176 
mÜe_·¿ms
=1;

177 
tobÿ¡
[0]=
f_m
;

178 
tobÿ¡
[1]=
f_rm
;

179 
tobÿ¡
[2]=
e¥o
;

180 
tobÿ¡
[3]=
f_a
;

181 
tobÿ¡
[4]=
f_¿
;

182 
tobÿ¡
[5]=
f_200
;

185 
	`´štf
("Thi combš©iÚ oà·¿m‘” ha ®»ady b“À´oûs£d: %s\n",
·¿ms
.
RunFÏg
);

190 
	`MPI_Bÿ¡
(
tobÿ¡
, 6, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

191 ià(
ThisTask
)

193 
mÜe_·¿ms
=(
tobÿ¡
[0]>=0.0);

194 ià(
mÜe_·¿ms
)

196 
f_m
 =
tobÿ¡
[0];

197 
f_rm
 =
tobÿ¡
[1];

198 
e¥o
 =
tobÿ¡
[2];

199 
f_a
 =
tobÿ¡
[3];

200 
f_¿
 =
tobÿ¡
[4];

201 
f_200
 =
tobÿ¡
[5];

205 ià(
fœ¡_time
 || 
mÜe_·¿ms
)

208 ià(!
ThisTask
)

210 
	`´štf
("\n");

211 
	`´štf
("Fragmentation…arameters forhis fragmentation„un:\n");

212 
	`´štf
("f_m = %f\n",
f_m
);

213 
	`´štf
("f_rm = %f\n",
f_rm
);

214 
	`´štf
("e¥Ø = %f\n",
e¥o
);

215 
	`´štf
("f_¨ = %f\n",
f_a
);

216 
	`´štf
("f_¿ = %f\n",
f_¿
);

217 
	`´štf
("f_200 = %f\n",
f_200
);

218 
	`´štf
("v¬Ÿnû oÀthgrid: %f\n",
SmoÙhšg
.
TrueV¬Ÿnû
[SmoÙhšg.
NsmoÙh
-1]);

219 
	`´štf
("\n");

223 
ıutime
.
group
=ıutime.
sÜt
=ıutime.
di¡r
=0.0;

224 #ifdeà
PLC


225 
ıutime
.
¶c
=0.0;

228 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


229 
subbox
.
mybox_z
 = 
§ve_mybox_z
;

230 
subbox
.
¡¬t_z
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

231 
subbox
.
Lgrid_z
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

232 
subbox
.
¡abl_z
 = subbox.
¡¬t_z
 - subbox.
§ã_z
;

235 
ThisSliû
=0; ThisSliû<
NSliûs
; ThisSlice++)

237 ià(!
ThisTask
)

238 
	`´štf
("\n[%s] S¹šg sliû N. %d oà%d\n",
	`fd©e
(),
ThisSliû
+1,
NSliûs
);

240 ià(
	`š™_äagm’t_2
(&
N³aks
))

243 
tmp
=
	`MPI_Wtime
();

246 ià(
	`bud_groups
(
N³aks
))

249 
ıutime
.
group
+=
	`MPI_Wtime
()-
tmp
;

252 
subbox
.
mybox_z
 +ğsubbox.
nbox_z_this¦iû
;

253 
subbox
.
¡¬t_z
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

254 
subbox
.
Lgrid_z
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

255 
subbox
.
¡abl_z
 = subbox.
¡¬t_z
 - subbox.
§ã_z
;

259 
ıutime
.
äag
 = 
	`MPI_Wtime
() - cputime.frag;

261 ià(!
ThisTask
)

262 
	`´štf
("[%s] Fšishšg f¿gm’t,Ù® cputimğ%14.6f\n",
	`fd©e
(),
ıutime
.
äag
);

264 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


266 
fœ¡_time
=0;

268 
mÜe_·¿ms
);

271 
	}
}

274 
	$šdex_com·»
(cÚ¡ * 
a
,cÚ¡ * 
b
)

276 iàĞ
äag
[*((*)
a
)].
Fmax
 =ğäag[*((*)
b
)].Fmax )

279 iàĞ
äag
[*((*)
a
)].
Fmax
 > f¿g[*((*)
b
)].Fmax )

283 
	}
}

286 
	$š™_äagm’t_1
()

293 #ifdeà
READ_FRAGMENT_PARAMS_FROM_FILE


295 
f’ame
[
BLENGTH
];

296 
FILE
 *
fe
;

297 
n
;

299 ià(!
ThisTask
)

301 
	`¥rštf
(
f’ame
,"%s.äagm’t_·¿ms",
·¿ms
.
RunFÏg
);

302 
	`´štf
("F¿gm’ˆ·¿m‘” wÈb»ad from f%s\n",
f’ame
);

304 
fe
=
	`fİ’
(
f’ame
,"r");

305 ià(
fe
==0x0)

307 
	`´štf
("ERROR: f¿gm’ˆ·¿m‘” f% nÙ found\n",
f’ame
);

308 
	`´štf
("I will use standard values forhe…arameters\n");

309 
	`£t_äagm’t_·¿m‘”s
(
ORDER_FOR_GROUPS
);

313 
n
=
	`fsÿnf
(
fe
,"%là%là%là%là%là%lf", &
f_m
, &
f_rm
, &
e¥o
, &
f_a
, &
f_¿
, &
f_200
);

314 ià(
n
!=6)

316 
	`´štf
("ERROR: f¿gm’ˆ·¿m‘” nÙ„—d from f%s\n",
f’ame
);

317 
	`´štf
("I will use standard values forhe…arameters\n");

318 
	`£t_äagm’t_·¿m‘”s
(
ORDER_FOR_GROUPS
);

320 
	`fşo£
(
fe
);

324 
	`MPI_Bÿ¡
(&
f_m
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

325 
	`MPI_Bÿ¡
(&
f_rm
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

326 
	`MPI_Bÿ¡
(&
e¥o
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

327 
	`MPI_Bÿ¡
(&
f_a
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

328 
	`MPI_Bÿ¡
(&
f_¿
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

329 
	`MPI_Bÿ¡
(&
f_200
 , 1, 
MPI_DOUBLE
, 0, 
MPI_COMM_WORLD
);

333 
	`£t_äagm’t_·¿m‘”s
(
ORDER_FOR_GROUPS
);

337 #iâdeà
LIST_OF_FRAGMENT_PARAMETERS


339 ià(!
ThisTask
)

341 
	`´štf
("Fragmentation…arameters:\n");

342 
	`´štf
("à = %f\n",
f_m
);

343 
	`´štf
("f_rm = %f\n",
f_rm
);

344 
	`´štf
("e¥Ø = %f\n",
e¥o
);

346 
	`´štf
("f_¿ = %f\n",
f_¿
);

348 
	`´štf
("v¬Ÿnû oÀthgrid: %f\n",
SmoÙhšg
.
TrueV¬Ÿnû
[SmoÙhšg.
NsmoÙh
-1]);

349 
	`´štf
("\n");

354 ià(
	`»®loÿ‹_memÜy_fÜ_äagm’tiÚ_1
())

358 
	}
}

361 
	$š™_äagm’t_2
(*
N³aks
)

363 
Ngood
, 
tÙ_good
;

364 
tmp
;

366 
tmp
=
	`MPI_Wtime
();

369 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


370 ià(
fœ¡_time
 || 
NSliûs
>1)

373 ià(!
ThisTask
)

374 
	`´štf
("[%s] S¹šg„e-di¡ributiÚ oà´oduùs\n",
	`fd©e
());

375 ià(
	`di¡ribu‹
())

377 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


381 
tmp
=
	`MPI_Wtime
()-tmp;

382 
ıutime
.
di¡r
 +ğ
tmp
;

383 ià(!
ThisTask
)

384 
	`´štf
("[%s] Re-di¡ributiÚ oàFmax dÚe, cputimğ%14.6f\n",
	`fd©e
(),
tmp
);

387 *
N³aks
=
	`couÁ_³aks
(&
Ngood
);

389 ià(
	`MPI_Reduû
(&
Ngood
, &
tÙ_good
, 1,

390 
MPI_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
è!ğ
MPI_SUCCESS
)

392 
	`´štf
("ERROR oÀsk %d: in™_äagm’ˆçed‡ÀMPI_Reduû\n",
ThisTask
);

393 
	`fæush
(
¡dout
);

397 ià(!
ThisTask
)

398 
	`´štf
("[%s] Task 0 found %d…eaks, inhe well„esolved„egion: %d. Total‚umber of…eaks: %d\n",

399 
	`fd©e
(),*
N³aks
,
Ngood
,
tÙ_good
);

401 ià(
	`»®loÿ‹_memÜy_fÜ_äagm’tiÚ_2
(*
N³aks
))

404 
tmp
=
	`MPI_Wtime
();

405 ià(!
ThisTask
)

406 
	`´štf
("[%s] S¹šg sÜtšg\n",
	`fd©e
());

408 
	`qsÜt
((*)
šdiûs
, 
subbox
.
N·¹
, (), 
šdex_com·»
);

410 
tmp
=
	`MPI_Wtime
()-tmp;

411 
ıutime
.
sÜt
+=
tmp
;

412 ià(!
ThisTask
)

413 
	`´štf
("[%s] SÜtšg dÚe,Ù® cputimğ%14.6f\n",
	`fd©e
(),
tmp
);

416 
	}
}

419 
	$couÁ_³aks
(*
ngood
)

425 
iz
,
i
,
j
,
k
,
kk
,
Â
,
ngroups_tÙ
,
Lgridxy
,
³ak_cÚd
,
i1
,
j1
,
k1
;

427 
ngroups_tÙ
=0;

428 *
ngood
=0;

429 
Lgridxy
 = 
subbox
.
Lgwbl_x
 * subbox.
Lgwbl_y
;

431 
iz
=0; iz<
subbox
.
N·¹
; iz++)

435 
k
=
iz
/
Lgridxy
;

436 
kk
=
iz
-
k
*
Lgridxy
;

437 
j
=
kk
/
subbox
.
Lgwbl_x
;

438 
i
=
kk
-
j
*
subbox
.
Lgwbl_x
;

441 iàĞ!
subbox
.
pbc_x
 && (
i
==0 || i==subbox.
Lgwbl_x
-1) ) ;

442 iàĞ!
subbox
.
pbc_y
 && (
j
==0 || j==subbox.
Lgwbl_y
-1) ) ;

443 iàĞ!
subbox
.
pbc_z
 && (
k
==0 || k==subbox.
Lgwbl_z
-1) ) ;

446 
³ak_cÚd
=1;

447 
Â
=0;‚n<6;‚n++)

449 
Â
)

452 
i1
=Ğ
subbox
.
pbc_x
 && 
i
==0 ? subbox.
Lgwbl_x
-1 : i-1 );

453 
j1
=
j
;

454 
k1
=
k
;

457 
i1
=Ğ
subbox
.
pbc_x
 && 
i
==subbox.
Lgwbl_x
-1 ? 0 : i+1 );

458 
j1
=
j
;

459 
k1
=
k
;

462 
i1
=
i
;

463 
j1
=Ğ
subbox
.
pbc_y
 && 
j
==0 ? subbox.
Lgwbl_y
-1 : j-1 );

464 
k1
=
k
;

467 
i1
=
i
;

468 
j1
=Ğ
subbox
.
pbc_y
 && 
j
==subbox.
Lgwbl_y
-1 ? 0 : j+1 );

469 
k1
=
k
;

472 
i1
=
i
;

473 
j1
=
j
;

474 
k1
=Ğ
subbox
.
pbc_z
 && 
k
==0 ? subbox.
Lgwbl_z
-1 : k-1 );

477 
i1
=
i
;

478 
j1
=
j
;

479 
k1
=Ğ
subbox
.
pbc_z
 && 
k
==subbox.
Lgwbl_z
-1 ? 0 : k+1 );

483 
³ak_cÚd
 &ğ(
äag
[
iz
].
Fmax
 > f¿g[
i1
 +
j1
*
subbox
.
Lgwbl_x
 + 
k1
*
Lgridxy
].Fmax);

487 ià(
³ak_cÚd
 && 
äag
[
iz
].
Fmax
 >ğ
ouuts
.
FÏ¡
)

489 
ngroups_tÙ
++;

490 iàĞ
i
>=
subbox
.
§ã_x
 && i<subbox.
Lgwbl_x
-subbox.safe_x &&

491 
j
>=
subbox
.
§ã_y
 && j<subbox.
Lgwbl_y
-subbox.safe_y &&

492 
k
>=
subbox
.
§ã_z
 && k<subbox.
Lgwbl_z
-subbox.safe_z)

493 (*
ngood
)++;

498  
ngroups_tÙ
;

499 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fragment.h

27 
	#NV
 6

	)

28 
	#FILAMENT
 1

	)

29 
	#SHIFT
 0.5

	)

31 
	#ORDER_FOR_GROUPS
 2

	)

32 
	#ORDER_FOR_CATALOG
 3

	)

34 
ngroups
;

38 
	mM
,
	mi
;

39 
	mq
[3],
	mv
[3],
	mD
,
	mz
;

40 #ifdeà
TWO_LPT


41 
	mD2
,
	mv2
[3];

42 #ifdeà
THREE_LPT


43 
	mD31
,
	mv31
[3],
	mD32
,
	mv32
[3];

46 } 
	tpos_d©a
;

47 
pos_d©a
 
	gobj
, 
	gobj1
, 
	gobj2
;

51 
	mÇme
;

52 
	mM
,
	mq
[3],
	mx
[3],
	mv
[3];

53 
	mn
, 
	m·d
;

54 } 
	tÿlog_d©a
;

56 
cÚd™iÚ_fÜ_acü‘iÚ
(, , , , , , *, *);

57 
cÚd™iÚ_fÜ_m”gšg
(, , , *);

58 
£t_obj
(, , 
pos_d©a
 *);

59 
£t_pošt
(, , , , , 
pos_d©a
 *);

60 
£t_group
(, 
pos_d©a
 *);

61 
q2x
(, 
pos_d©a
 *, );

62 
v–
(, 
pos_d©a
 *);

63 
di¡ªû
(, 
pos_d©a
 *,…os_data *);

64 
ş—n_li¡
(*);

65 
vœŸl
(, , );

66 
m”ge_groups
(, , );

67 
upd©e_hi¡Üy
(, , );

68 
acü‘iÚ
(, , , , , );

69 
upd©e
(
pos_d©a
 *,…os_data *);

70 
wr™e_ÿlog
();

71 
wr™e_hi¡Ü›s
();

72 
compu‹_mf
();

73 #ifdeà
PLC


74 
wr™e_PLC
();

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/initialization.c

27 
	~"pšocchio.h
"

29 #ifdeà
PRECISE_TIMING


31 
	#SET_WTIME
 
ıutime
.
·¹Ÿl
 = 
	`MPI_Wtime
();

	)

32 
	#ASSIGN_WTIME
(
INIT
, 
ACC
èdØ{ 
‰t
ğ
	`MPI_Wtime
(); 
ıutime
.ACC =‰ - cputime.INIT; } 0)

	)

33 
	#ACCUMULATE_WTIME
(
INIT
, 
ACC
èdØ{ 
‰t
ğ
	`MPI_Wtime
(); 
ıutime
.ACC +ğ‰ˆ- cputime.INIT; } 0)

	)

35 
	#SET_WTIME


	)

36 
	#ASSIGN_WTIME
(
INIT
, 
ACC
)

	)

37 
	#ACCUMULATE_WTIME
(
INIT
, 
ACC
)

	)

40 
š™_cosmŞogy
();

41 
£t_smoÙhšg
();

42 
g’”©e_d’s™›s
();

43 
£t_subboxes
();

44 
£t_¶c
();

45 
gcd
(, );

46 
£t_fá_decompos™iÚ
();

51 
	$š™Ÿliz©iÚ
()

55 
ıutime
.
š™
 = 
	`MPI_Wtime
();

58 
wÜk¥aû
 = 
	`g¦_š‹g¿tiÚ_wÜk¥aû_®loc
(
NWINT
);

61 
¿ndom_g’”©Ü
 = 
	`g¦_ºg_®loc
(
g¦_ºg_¿Æxd1
);

64 ià(
	`£t_·¿m‘”s
())

67 if(
	`£t_fá_decompos™iÚ
())

70 if(
ThisTask
 == 0)

71 
	`d´štf
(
VMSG
, 
ThisTask
, "cube subdivision [%d dim]: %d x %d x %d = %d…rocesses\n",

72 
š‹º®
.
sks_subdivisiÚ_dim
,

73 
š‹º®
.
sks_subdivisiÚ_3D
[0], internal.tasks_subdivision_3D[1], internal.tasks_subdivision_3D[2],

74 
š‹º®
.
sks_subdivisiÚ_3D
[0] * internal.tasks_subdivision_3D[1] * internal.tasks_subdivision_3D[2]);

76 ifĞ
	`pfá_ü—‹_´ocmesh
(
š‹º®
.
sks_subdivisiÚ_dim
, 
MPI_COMM_WORLD
, iÁ”Çl.
sks_subdivisiÚ_3D
, &
FFT_Comm
) )

78 
iii
, 
®l
 = 1;

79 
iii
 = 0; ii˜< 
š‹º®
.
sks_subdivisiÚ_dim
; iii++)

80 
®l
 *ğ
š‹º®
.
sks_subdivisiÚ_3D
[
iii
];

81 
	`pfá_årštf
(
MPI_COMM_WORLD
, 
¡d”r
, "Error while creating communicator‡nd mesh with %d…rocesses\n",

82 
®l
);

86 #ifdeà
SCALE_DEPENDENT_GROWTH


88 ià(
	`»ad_pow”_bË_äom_CAMB
())

93 ià(
	`š™Ÿlize_cosmŞogy
())

97 ià(
	`£t_grids
())

101 ià(
	`£t_smoÙhšg
())

105 
WšdowFunùiÚTy³
=2;

106 ià(
	`š™Ÿlize_MassV¬Ÿnû
())

109 #ifdeà
SCALE_DEPENDENT_GROWTH


111 ià(
	`š™Ÿlize_SÿËD•’d’tGrowth
())

115 
SET_WTIME
;

117 ià(
	`£t_subboxes
())

119 ià(!
ThisTask
)

120 
	`´štf
("Pinocchio done!\n");

121 
	`MPI_Fš®ize
();

122 
	`ex™
 (0);

124 
	`ASSIGN_WTIME
(
·¹Ÿl
, 
£t_subboxes
);

126 
SET_WTIME
;

128 ià(
	`£t_¶c
())

130 
	`ASSIGN_WTIME
(
·¹Ÿl
, 
£t_¶c
);

133 
	`fæush
(
¡dout
);

134 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

137 
SET_WTIME
;

139 ià(
	`®loÿ‹_maš_memÜy
())

141 
	`ASSIGN_WTIME
(
·¹Ÿl
, 
memÜy_®loÿtiÚ
);

144 
SET_WTIME
;

146 ià(
	`š™Ÿlize_fá
())

148 
	`ASSIGN_WTIME
(
·¹Ÿl
, 
fá_š™Ÿliz©iÚ
);

152 ià(
	`g’”©e_d’s™›s
())

155 
ıutime
.
š™
 = 
	`MPI_Wtime
()-cputime.init;

157 ià(!
ThisTask
)

159 
	`d´štf
(
VMSG
, 
ThisTask
, "[%s] in™Ÿliz©iÚ dÚe, in™Ÿliz©iÚ cpuimğ%14.6f\n", 
	`fd©e
(), 
ıutime
.
š™
);

160 
	`d´štf
(
VMSG
, 
ThisTask
, "\t\t set subboxesime = %14.6f\n"

165 
ıutime
.
£t_subboxes
, cputime.
£t_¶c
, cputime.
memÜy_®loÿtiÚ
,

166 
ıutime
.
fá_š™Ÿliz©iÚ
, cputime.
d’s
);

170 
	}
}

173 
	$£t_·¿m‘”s
()

175 
i
;

178 
š‹º®
.
v”bo£_Ëv–
 = 
VDIAG
;

179 
š‹º®
.
dump_£ed¶ªe
 = 0;

180 
š‹º®
.
dump_kd’s™y
 = 0;

181 
š‹º®
.
Ïrge_¶ªe
 = 1;

182 
š‹º®
.
mimic_Üigš®_£edbË
 = 0;

183 
š‹º®
.
dump_veùÜs
 = 0;

184 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0] = 0;

185 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[1] = 0;

186 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[2] = 0;

187 
š‹º®
.
sks_subdivisiÚ_3D
[0] = 0;

188 
š‹º®
.
sks_subdivisiÚ_3D
[1] = 0;

189 
š‹º®
.
sks_subdivisiÚ_3D
[2] = 0;

191 if(
	`»ad_·¿m‘”_fe
())

194 ià(
·¿ms
.
BoxInH100
)

196 
·¿ms
.
BoxSize_h100
 =…¬ams.
BoxSize
;

197 
·¿ms
.
BoxSize_hŒue
 =…¬ams.
BoxSize
/·¿ms.
HubbË100
;

201 
·¿ms
.
BoxSize_h100
 =…¬ams.
BoxSize
*·¿ms.
HubbË100
;

202 
·¿ms
.
BoxSize_hŒue
 =…¬ams.
BoxSize
;

204 
·¿ms
.
IÁ”P¬tDi¡
 =…¬ams.
BoxSize_hŒue
/·¿ms.
GridSize
[0];

206 
·¿ms
.
P¬tişeMass
 = 2.775499745e11 *

207 
·¿ms
.
HubbË100
 *…¬ams.HubbË100 *…¬ams.
Omega0
 *

208 
	`pow
(
·¿ms
.
IÁ”P¬tDi¡
,3.);

210 
	`¡rıy
(
·¿ms
.
D©aDœ
,"Data/");

212 ià(!
·¿ms
.
NumFes
)

213 
·¿ms
.
NumFes
=1;

216 ià(
NTasks
%
·¿ms
.
NumFes
 != 0)

218 
NTasks
%
·¿ms
.
NumFes
 != 0)

219 
·¿ms
.
NumFes
--;

221 ià(!
ThisTask
)

222 
	`´štf
("Warning: NumFiles must be‡ divisor of NTasks, it has been fixedo %d\n",

223 
·¿ms
.
NumFes
);

228 
i
=0; i<
ouuts
.
n
; i++)

231 
ouuts
.
F
[
i
]=1.+ouuts.
z
[i];

232 
ouuts
.
FÏ¡
=ouuts.
F
[ouuts.
n
-1];

235 ià(!
ThisTask
)

237 
	`d´štf
(
VMSG
, 0, "FÏg fÜhi run: %s\n\n",
·¿ms
.
RunFÏg
);

238 
	`d´štf
(
VMSG
, 0, "PARAMETER VALUES from f%s:\n",
·¿ms
.
P¬am‘”Fe
);

239 
	`d´štf
(
VMSG
, 0, "Omega0 %f\n",
·¿ms
.
Omega0
);

240 
	`d´štf
(
VMSG
, 0, "OmegaLambd¨ %f\n",
·¿ms
.
OmegaLambda
);

241 
	`d´štf
(
VMSG
, 0, "OmegaB¬yÚ %f\n",
·¿ms
.
OmegaB¬yÚ
);

242 ià(
	`¡rcmp
(
·¿ms
.
TabuÏ‹dEoSfe
,"no"))

244 
	`d´štf
(
VMSG
, 0, "D¬k EÃrgy EoS wÈb»ad from f%s\n",
·¿ms
.
TabuÏ‹dEoSfe
);

248 
	`d´štf
(
VMSG
, 0, "DE EoS…¬am‘”  %à%f\n",
·¿ms
.
DEw0
,·¿ms.
DEwa
);

251 
	`d´štf
(
VMSG
, 0, "HubbË100 %f\n",
·¿ms
.
HubbË100
);

252 
	`d´štf
(
VMSG
, 0, "Sigma8 %f\n",
·¿ms
.
Sigma8
);

253 
	`d´štf
(
VMSG
, 0, "PrimÜdŸlIndex %f\n",
·¿ms
.
PrimÜdŸlIndex
);

254 
	`d´štf
(
VMSG
, 0, "RªdomS“d %d\n",
·¿ms
.
RªdomS“d
);

255 
	`d´štf
(
VMSG
, 0, "OuutLi¡ %s\n",
·¿ms
.
OuutLi¡
);

256 
	`d´štf
(
VMSG
, 0, "Numb” oàouut  %d\n",
ouuts
.
n
);

257 
	`d´štf
(
VMSG
, 0, "Output„edshifts ");

258 
i
=0; i<
ouuts
.
n
; i++)

259 
	`d´štf
(
VMSG
, 0, " %à",
ouuts
.
z
[
i
]);

260 
	`d´štf
(
VMSG
, 0, "\n");

261 
	`d´štf
(
VMSG
, 0, "GridSiz %d %d %d\n",
·¿ms
.
GridSize
[0],params.GridSize[1],params.GridSize[2]);

262 
	`d´štf
(
VMSG
, 0, "BoxSizÑruMpcè %f\n",
·¿ms
.
BoxSize_hŒue
);

263 
	`d´štf
(
VMSG
, 0, "BoxSiz(Mpc/hè %f\n",
·¿ms
.
BoxSize_h100
);

264 
	`d´štf
(
VMSG
, 0, "P¬tişMas ÑruMsunè %g\n",
·¿ms
.
P¬tişeMass
);

265 
	`d´štf
(
VMSG
, 0, "P¬tişMas (Msun/hè %g\n",
·¿ms
.
P¬tişeMass
*·¿ms.
HubbË100
);

266 
	`d´štf
(
VMSG
, 0, "IÁ”-·¹ di¡ (ŒuMpcè %f\n",
·¿ms
.
IÁ”P¬tDi¡
);

267 
	`d´štf
(
VMSG
, 0, "IÁ”-·¹ di¡ (Mpc/hè %f\n",
·¿ms
.
IÁ”P¬tDi¡
*·¿ms.
HubbË100
);

268 
	`d´štf
(
VMSG
, 0, "MšH®oMas Õ¬tişesè %d\n",
·¿ms
.
MšH®oMass
);

269 
	`d´štf
(
VMSG
, 0, "Bound¬yLay”FaùÜ %f\n",
·¿ms
.
Bound¬yLay”FaùÜ
);

270 
	`d´štf
(
VMSG
, 0, "MaxMem…”ask (Mbè %d\n",
·¿ms
.
MaxMem
);

271 
	`d´štf
(
VMSG
, 0, "MaxMem…”…¬tiş(bè %f\n",
·¿ms
.
MaxMemP”P¬tişe
);

272 
	`d´štf
(
VMSG
, 0, "C©®ogInAsci˜ %d\n",
·¿ms
.
C©®ogInAscii
);

273 
	`d´štf
(
VMSG
, 0, "NumFe  %d\n",
·¿ms
.
NumFes
);

274 
	`d´štf
(
VMSG
, 0, "DoNÙWr™eC©®og  %d\n",
·¿ms
.
DoNÙWr™eC©®ogs
);

275 
	`d´štf
(
VMSG
, 0, "DoNÙWr™eHi¡Ü›  %d\n",
·¿ms
.
DoNÙWr™eHi¡Ü›s
);

276 
	`d´štf
(
VMSG
, 0, "Wr™eSÇpshÙ %d\n",
·¿ms
.
Wr™eSÇpshÙ
);

277 
	`d´štf
(
VMSG
, 0, "OuutInH100 %d\n",
·¿ms
.
OuutInH100
);

278 
	`d´štf
(
VMSG
, 0, "Wr™eFmax %d\n",
·¿ms
.
Wr™eFmax
);

279 
	`d´štf
(
VMSG
, 0, "Wr™eVmax %d\n",
·¿ms
.
Wr™eVmax
);

280 
	`d´štf
(
VMSG
, 0, "Wr™eRmax %d\n",
·¿ms
.
Wr™eRmax
);

281 
·¿ms
.
AÇlyticMassFunùiÚ
)

284 
	`d´štf
(
VMSG
, 0, "Using Press & Schechter (1974) forhe‡nalytic mass function\n");

287 
	`d´štf
(
VMSG
, 0, "Using Sheth & Tormen (2001) forhe‡nalytic mass function\n");

290 
	`d´štf
(
VMSG
, 0, "Using Jenkinsƒt‡l. (2001) forhe‡nalytic mass function\n");

293 
	`d´štf
(
VMSG
, 0, "Using Warrenƒt‡l. (2006) forhe‡nalytic mass function\n");

296 
	`d´štf
(
VMSG
, 0, "Using Reedƒt‡l. (2007) forhe‡nalytic mass function\n");

299 
	`d´štf
(
VMSG
, 0, "Using Crocceƒt‡l. (2010) forhe‡nalytic mass function\n");

302 
	`d´štf
(
VMSG
, 0, "Using Tinkerƒt‡l. (2008) forhe‡nalytic mass function\n");

305 
	`d´štf
(
VMSG
, 0, "Using Courtinƒt‡l. (2010) forhe‡nalytic mass function\n");

308 
	`d´štf
(
VMSG
, 0, "Using Anguloƒt‡l. (2012) forhe‡nalytic mass function\n");

311 
	`d´štf
(
VMSG
, 0, "Using Watsonƒt‡l. (2013) forhe‡nalytic mass function\n");

314 
	`d´štf
(
VMSG
, 0, "Using Crocceƒt‡l. (2010) with forced universality forhe‡nalytic mass function\n");

317 
	`d´štf
(
VMSG
, 0, "Unknown value for AnalyticMassFunction, Using Watsonƒt‡l. (2013)\n");

318 
·¿ms
.
AÇlyticMassFunùiÚ
=9;

321 
	`d´štf
(
VMSG
, 0, "\n");

323 
	`d´štf
(
VMSG
, 0, "\n");

324 
	`d´štf
(
VMSG
, 0, "GENIC…arameters:\n");

325 
	`d´štf
(
VMSG
, 0, "IÅutS³ùrum_Un™L’gth_š_cm %f\n",
·¿ms
.
IÅutS³ùrum_Un™L’gth_š_cm
);

326 
	`d´štf
(
VMSG
, 0, "FeW™hIÅutS³ùrum %s\n",
·¿ms
.
FeW™hIÅutS³ùrum
);

327 
	`d´štf
(
VMSG
, 0, "WDM_P¬tMass_š_kev %f\n",
·¿ms
.
WDM_P¬tMass_š_kev
);

328 
	`d´štf
(
VMSG
, 0, "\n");

332 
	`MPI_Bÿ¡
(&
·¿ms
.
AÇlyticMassFunùiÚ
, 1, 
MPI_INT
, 0, 
MPI_COMM_WORLD
);

335 
	}
}

338 
	#NSIGMA
 (()6.0)

	)

339 
	#STEP_VAR
 (()0.15)

	)

341 
	$£t_smoÙhšg
()

343 
ismoÙh
;

344 
v¬_mš
, 
v¬_max
, 
rmš
;

346 #ifdeà
SCALE_DEPENDENT_GROWTH


347 
SDGM
.
æag
=-1;

350 
v¬_mš
 = 
	`pow
(1.686/
NSIGMA
 / 
	`GrowšgMode
(
ouuts
.
zÏ¡
),2.0);

352 
rmš
 = 
·¿ms
.
IÁ”P¬tDi¡
/6.;

353 
v¬_max
 = 
	`MassV¬Ÿnû
(
rmš
);

354 
SmoÙhšg
.
NsmoÙh
 = (
	`log10
(
v¬_max
)-log10(
v¬_mš
))/
STEP_VAR
+2;

356 ià(
SmoÙhšg
.
NsmoÙh
<=0)

358 ià(!
ThisTask
)

359 
	`d´štf
(
VERR
, 0, "I‡m‡fraidhat‚othing is…redictedo collapse inhis configuration.\nI will work with‚o smoothing\n");

360 
SmoÙhšg
.
NsmoÙh
=1;

363 ià(!
ThisTask
)

364 
	`d´štf
(
VMSG
, 0, "Min variance: %f12.6, max variance: %f12.6,‚umber of smoothing„adii: %d\n",

365 
v¬_mš
,
v¬_max
,
SmoÙhšg
.
NsmoÙh
);

367 
SmoÙhšg
.
Radius
 =(*)
	`m®loc
(SmoÙhšg.
NsmoÙh
 * ());

368 
SmoÙhšg
.
V¬Ÿnû
 =(*)
	`m®loc
(SmoÙhšg.
NsmoÙh
 * ());

369 
SmoÙhšg
.
TrueV¬Ÿnû
=(*)
	`m®loc
(SmoÙhšg.
NsmoÙh
 * ());

370 ià(
SmoÙhšg
.
Radius
==0x0 || SmoÙhšg.
V¬Ÿnû
==0x0 || SmoÙhšg.
TrueV¬Ÿnû
==0x0)

372 
	`d´štf
(
VXERR
, 0, "ERROR oÀsk %d:‡ÎoÿtiÚ oàSmoÙhšg faed\n",
ThisTask
);

373 
	`fæush
(
¡dout
);

377 
ismoÙh
=0; ismoÙh<
SmoÙhšg
.
NsmoÙh
-1; ismooth++)

379 
SmoÙhšg
.
V¬Ÿnû
[
ismoÙh
] = 
	`pow
(10., 
	`log10
(
v¬_mš
)+
STEP_VAR
*ismooth);

380 
SmoÙhšg
.
Radius
[
ismoÙh
] = 
	`Radius
(SmoÙhšg.
V¬Ÿnû
[ismooth]);

382 
SmoÙhšg
.
Radius
[
ismoÙh
] = 0.0;

383 
SmoÙhšg
.
V¬Ÿnû
[
ismoÙh
] = 
v¬_max
;

385 ià(!
ThisTask
)

386 
ismoÙh
=0; ismoÙh<
SmoÙhšg
.
NsmoÙh
; ismooth++)

387 
	`d´štf
(
VMSG
, 0, " %2dè Radius=%10f, V¬Ÿnû=%10f\n",
ismoÙh
+1,
SmoÙhšg
.
Radius
[ismoÙh],SmoÙhšg.
V¬Ÿnû
[ismooth]);

389 
	`fæush
(
¡dout
);

390 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

393 
	}
}

396 
	$g’”©e_d’s™›s
()

399 
ıutime
.
d’s
 = 
	`MPI_Wtime
();

401 ià(!
ThisTask
)

402 
	`d´štf
(
VMSG
, 0, "[%s] G’”©šg d’s™y iÀFour›¸¥aû\n",
	`fd©e
());

404 #ifdeà
WHITENOISE


406 ià(
Ngrids
>1)

408 ià(!
ThisTask
)

409 
	`d´štf
(
VMSG
, 0, "Sorry,his works only with‡ single grid\n");

413 ià(
	`»ad_wh™e_noi£
())

418 
igrid
;

419 
igrid
=0; igrid<
Ngrids
; igrid++)

420 ià(
	`G’IC_Ïrge
(
igrid
))

425 
ıutime
.
d’s
 = 
	`MPI_Wtime
()-cputime.dens;

426 ià(!
ThisTask
)

427 
	`d´štf
(
VMSG
, 0, "[%s] DÚg’”©šg d’s™y iÀFour›¸¥aû, cputimğ%às\n",
	`fd©e
(), 
ıutime
.
d’s
);

430 
	}
}

433 
	$£t_grids
()

437 
igrid
;

439 
Ngrids
=1;

441 ifĞĞ
MyGrids
 = (
grid_d©a
*è
	`m®loc
(
Ngrids
 * (grid_d©a)èè=ğ
NULL
 )

443 
	`d´štf
(
VXERR
, 
ThisTask
,

444 "uÇbËØ®loÿ‹ MyGrid (%zd by‹s)\n", 
Ngrids
 * (
grid_d©a
));

445 
	`MPI_Fš®ize
();

446 #ifdeà
USE_GPERFTOOLS


447 
	`Prof”Stİ
();

452 
MyGrids
[0].
GSglob®
[
_x_
] = 
·¿ms
.
GridSize
[0];

453 
MyGrids
[0].
GSglob®
[
_y_
] = 
·¿ms
.
GridSize
[1];

454 
MyGrids
[0].
GSglob®
[
_z_
] = 
·¿ms
.
GridSize
[2];

456 
MyGrids
[0].
BoxSize
 = 
·¿ms
.
BoxSize_hŒue
;

457 
MyGrids
[0].
low”_k_cutoff
 = 0.;

458 
MyGrids
[0].
uµ”_k_cutoff
 = 
NYQUIST
 * 
PI
;

461 
cveùÜ_fá
 = (
pfá_com¶ex
**è
	`m®loc
(
Ngrids
 * (
fáw_com¶ex
*));

462 
rveùÜ_fá
 = (**è
	`m®loc
(
Ngrids
 * (*));

464 
kd’s™y
 = (**è
	`m®loc
(
Ngrids
 * (*));

465 
d’s™y
 = (**è
	`m®loc
(
Ngrids
 * (*));

466 
fœ¡_d”iv©ives
 = (***è
	`m®loc
(
Ngrids
 * (**));

467 
£cÚd_d”iv©ives
 = (***è
	`m®loc
(
Ngrids
 * (**));

468 
VEL_fÜ_di¥l
 = (**è
	`m®loc
(3 * (*));

469 #ifdeà
TWO_LPT


470 
VEL2_fÜ_di¥l
 = (**è
	`m®loc
(3 * (*));

473  
igrid
 = 0; igrid < 
Ngrids
; igrid++ )

475 
fœ¡_d”iv©ives
[
igrid
] = (**è
	`m®loc
(3 * (*));

476 
£cÚd_d”iv©ives
[
igrid
] = (**è
	`m®loc
(6 * (*));

481  
igrid
 = 0; igrid < 
Ngrids
; igrid++ )

482 iàĞ
	`£t_Úe_grid
(
igrid
) )

486 
	}
}

490 #ifdeà
PLC


492 
	gmyz
;

493 
cÚe_ªd_cube_š‹r£ù
(*, *, *, *, , *, *, *);

494 
maxF
(*, *, *, *, *);

496 
	$£t_¶c
()

498 
NAÎ
,
œ
,
jr
,
kr
,
ic
,
this
,
š‹r£ùiÚ
,
axis
;

499 
L¬ge¡_r
,
Sm®Ë¡_r
,
sm®Ë¡r
,
Ïrge¡r
,
x
[3],
l
[3],
z
,
d
,
mod
;

500 
FILE
 *
fout
;

501 
f’ame
[
BLENGTH
];

504 #ifdeà
ROTATE_BOX


505 
rÙ
[3] = {1,2,0};

507 
rÙ
[3] = {0,1,2};

510 ià(
·¿ms
.
S¹šgzFÜPLC
<0.)

512 
¶c
.
N»¶iÿtiÚs
 = 0;

513 
¶c
.
F¡¬t
õlc.
F¡İ
 = -1.;

514 
¶c
.
Nmax
=0;

515 ià(!
ThisTask
)

516 
	`´štf
("Negative value of StartingzForPLC,‚o Past Light Cone output will be given\n\n");

523 ià(
·¿ms
.
PLCProvideCÚeD©a
)

526 
¶c
.
ûÁ”
[
rÙ
[0]] = 
·¿ms
.
PLCC’‹r
[0] /…¬ams.
BoxSize
 *…¬ams.
GridSize
[0];

527 
¶c
.
ûÁ”
[
rÙ
[1]] = 
·¿ms
.
PLCC’‹r
[1] /…¬ams.
BoxSize
 *…¬ams.
GridSize
[0];

528 
¶c
.
ûÁ”
[
rÙ
[2]] = 
·¿ms
.
PLCC’‹r
[2] /…¬ams.
BoxSize
 *…¬ams.
GridSize
[0];

529 
¶c
.
zv”s
[
rÙ
[0]] = 
·¿ms
.
PLCAxis
[0];

530 
¶c
.
zv”s
[
rÙ
[1]] = 
·¿ms
.
PLCAxis
[1];

531 
¶c
.
zv”s
[
rÙ
[2]] = 
·¿ms
.
PLCAxis
[2];

536 
	`g¦_ºg_£t
(
¿ndom_g’”©Ü
, 
·¿ms
.
RªdomS“d
);

537 
¶c
.
ûÁ”
[0] = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
)*
MyGrids
[0].
GSglob®
[
_x_
];

538 
¶c
.
ûÁ”
[1] = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
)*
MyGrids
[0].
GSglob®
[
_y_
];

539 
¶c
.
ûÁ”
[2] = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
)*
MyGrids
[0].
GSglob®
[
_z_
];

540 
¶c
.
zv”s
[0] = 1.0;

541 
¶c
.
zv”s
[1] = 1.0;

542 
¶c
.
zv”s
[2] = 1.0;

546 
mod
 = 
	`sq¹
Ğ
¶c
.
zv”s
[0]*plc.zvers[0] +…lc.zvers[1]*plc.zvers[1] +…lc.zvers[2]*plc.zvers[2] );

547 
œ
=0;ir<3;ir++)

548 
¶c
.
zv”s
[
œ
] /ğ
mod
;

551 ià(
¶c
.
zv”s
[2] == 1.0)

554 
¶c
.
xv”s
[0] = 1.0;

555 
¶c
.
xv”s
[1] = 0.0;

556 
¶c
.
xv”s
[2] = 0.0;

557 
¶c
.
yv”s
[0] = 0.0;

558 
¶c
.
yv”s
[1] = 1.0;

559 
¶c
.
yv”s
[2] = 0.0;

564 
mod
 = 
	`sq¹
Ğ
¶c
.
zv”s
[0]*plc.zvers[0]+plc.zvers[1]*plc.zvers[1] );

565 
¶c
.
xv”s
[0] =…lc.
zv”s
[1] / 
mod
;

566 
¶c
.
xv”s
[1] = -¶c.
zv”s
[0] / 
mod
;

567 
¶c
.
xv”s
[2] = 0.0;

569 
¶c
.
yv”s
[0] =…lc.
zv”s
[1]*¶c.
xv”s
[2] -…lc.zvers[2]*plc.xvers[1];

570 
¶c
.
yv”s
[1] =…lc.
zv”s
[2]*¶c.
xv”s
[0] -…lc.zvers[0]*plc.xvers[2];

571 
¶c
.
yv”s
[2] =…lc.
zv”s
[0]*¶c.
xv”s
[1] -…lc.zvers[1]*plc.xvers[0];

575 
NAÎ
 = ()(
	`Prİ”Di¡ªû
(
·¿ms
.
S¹šgzFÜPLC
)/
MyGrids
[0].
BoxSize
) + 2;

576 
¶c
.
F¡¬t
 = 1.+
·¿ms
.
S¹šgzFÜPLC
;

577 
¶c
.
F¡İ
 = 1.+
·¿ms
.
La¡zFÜPLC
;

582 
L¬ge¡_r
=
	`Prİ”Di¡ªû
(
·¿ms
.
S¹šgzFÜPLC
)/·¿ms.
IÁ”P¬tDi¡
;

583 
Sm®Ë¡_r
=
	`Prİ”Di¡ªû
(
·¿ms
.
La¡zFÜPLC
)/·¿ms.
IÁ”P¬tDi¡
;

585 
l
[0]=()(
MyGrids
[0].
GSglob®
[
_x_
]);

586 
l
[1]=()(
MyGrids
[0].
GSglob®
[
_y_
]);

587 
l
[2]=()(
MyGrids
[0].
GSglob®
[
_z_
]);

590 
¶c
.
N»¶iÿtiÚs
=0;

591 
œ
=-
NAÎ
; ir<=NAll; ir++)

592 
jr
=-
NAÎ
; jr<=NAll; jr++)

593 
kr
=-
NAÎ
; kr<=NAll; kr++)

595 
x
[0]=
œ
*
l
[0];

596 
x
[1]=
jr
*
l
[1];

597 
x
[2]=
kr
*
l
[2];

599 
š‹r£ùiÚ
 = 
	`cÚe_ªd_cube_š‹r£ù
(
x
, 
l
, 
¶c
.
ûÁ”
,…lc.
zv”s
, 
·¿ms
.
PLCA³¹u»
, &
sm®Ë¡r
, &
Ïrge¡r
, &
axis
);

601 ià(
š‹r£ùiÚ
 && !(
sm®Ë¡r
>
L¬ge¡_r
 || 
Ïrge¡r
<
Sm®Ë¡_r
))

602 
¶c
.
N»¶iÿtiÚs
++;

606 
¶c
.
»¶s
=
	`m®loc
Õlc.
N»¶iÿtiÚs
 * (
»¶iÿtiÚ_d©a
));

608 ià(!
ThisTask
)

610 
	`¥rštf
(
f’ame
,"pšocchio.%s.geom‘ry.out",
·¿ms
.
RunFÏg
);

611 
fout
=
	`fİ’
(
f’ame
,"w");

612 
	`årštf
(
fout
, "# N.„•liÿtiÚs: %d (ouˆoà%d checked)\n",
¶c
.
N»¶iÿtiÚs
,(2*
NAÎ
+1)*(2*NAll+1)*(2*NAll+1));

613 
	`årštf
(
fout
, "# di¡ªû„ªge: %10.6à%10.6f\n",
Sm®Ë¡_r
,
L¬ge¡_r
);

614 
	`årštf
(
fout
, "# V = %10.6à%10.6à%10.6f\n",
¶c
.
ûÁ”
[0],plc.center[1],plc.center[2]);

615 
	`årštf
(
fout
, "# D = %10.6à%10.6à%10.6f\n",
¶c
.
zv”s
[0],plc.zvers[1],plc.zvers[2]);

616 
	`årštf
(
fout
, "# L = %10.6à%10.6à%10.6f\n",
l
[0],l[1],l[2]);

617 
	`årštf
(
fout
, "# A = %10.6f\n",
·¿ms
.
PLCA³¹u»
);

618 
	`årštf
(
fout
, "# IPD = %10.6f\n",
·¿ms
.
IÁ”P¬tDi¡
);

619 
	`årštf
(
fout
, "#\n");

623 
this
=0;

624 
œ
=-
NAÎ
; ir<=NAll; ir++)

625 
jr
=-
NAÎ
; jr<=NAll; jr++)

626 
kr
=-
NAÎ
; kr<=NAll; kr++)

628 
x
[0]=
œ
*
l
[0];

629 
x
[1]=
jr
*
l
[1];

630 
x
[2]=
kr
*
l
[2];

632 
š‹r£ùiÚ
 = 
	`cÚe_ªd_cube_š‹r£ù
(
x
, 
l
, 
¶c
.
ûÁ”
,…lc.
zv”s
, 
·¿ms
.
PLCA³¹u»
, &
sm®Ë¡r
, &
Ïrge¡r
, &
axis
);

634 ià(
š‹r£ùiÚ
 && !(
sm®Ë¡r
>
L¬ge¡_r
 || 
Ïrge¡r
<
Sm®Ë¡_r
))

636 ià(!
ThisTask
)

637 
	`årštf
(
fout
," %3d %3d %3d %3d %10.6à%10.6à %d %d\n",
this
,
œ
,
jr
,
kr
,
sm®Ë¡r
,
Ïrge¡r
,
š‹r£ùiÚ
,
axis
);

638 
¶c
.
»¶s
[
this
].
i
=
œ
;

639 
¶c
.
»¶s
[
this
].
j
=
jr
;

640 
¶c
.
»¶s
[
this
].
k
=
kr
;

641 
¶c
.
»¶s
[
this
].
F1
=-
Ïrge¡r
;

642 
¶c
.
»¶s
[
this
++].
F2
=-
sm®Ë¡r
;

645 ià(!
ThisTask
)

646 
	`fşo£
(
fout
);

649 
z
=100.; z>=0.0; z-=0.01)

651 
d
=
	`Prİ”Di¡ªû
(
z
)/
·¿ms
.
IÁ”P¬tDi¡
;

652 
this
=0;his<
¶c
.
N»¶iÿtiÚs
;his++)

654 ià(
¶c
.
»¶s
[
this
].
F1
<=0.0 && 
d
<-plc.repls[this].F1)

655 
¶c
.
»¶s
[
this
].
F1
=
z
+0.01+1.0;

656 ià(
¶c
.
»¶s
[
this
].
F2
<=0.0 && 
d
<-plc.repls[this].F2)

657 
¶c
.
»¶s
[
this
].
F2
=
z
-0.01+1.0;

660 
this
=0;his<
¶c
.
N»¶iÿtiÚs
;his++)

662 ià(
¶c
.
»¶s
[
this
].
F1
<=0.0)

663 
¶c
.
»¶s
[
this
].
F1
=1.0;

664 ià(
¶c
.
»¶s
[
this
].
F2
<=0.0)

665 
¶c
.
»¶s
[
this
].
F2
=1.0;

668 
¶c
.
Nmax
 = 
subbox
.
N·¹
 / 10;

670 ià(!
ThisTask
)

672 
	`d´štf
(
VMSG
, 0, "ThPa¡ LighˆCÚwÈb»cÚ¡ruù from z=%àtØz=%f\n", 
·¿ms
.
S¹šgzFÜPLC
,·¿ms.
La¡zFÜPLC
);

673 ià(
·¿ms
.
PLCProvideCÚeD©a
)

674 
	`d´štf
(
VMSG
, 0, "Cone data have been…rovided inhe…arameter file\n");

676 
	`d´štf
(
VMSG
, 0, "Cone data have been decided byhe code\n");

677 
	`d´štf
(
VMSG
, 0, "Past Light Cone will be centred on…oint [%f,%f,%f] (true Mpc)\n",

678 
¶c
.
ûÁ”
[0]*
·¿ms
.
IÁ”P¬tDi¡
,plc.center[1]*params.InterPartDist,plc.center[2]*params.InterPartDist);

679 
	`d´štf
(
VMSG
, 0, "ThcÚv”‹x wÈbpoš‹dow¬d [%f,%f,%f]\n",
¶c
.
zv”s
[0],plc.zvers[1],plc.zvers[2]);

680 
	`d´štf
(
VMSG
, 0, "IˆwÈhavª‡³¹u» oà%àdeg»es\n",
·¿ms
.
PLCA³¹u»
);

681 #ifdeà
ROTATE_BOX


682 ià(
·¿ms
.
PLCProvideCÚeD©a
)

683 
	`´štf
("(NB:„otation has been‡ppliedohe…rovided coordinates)\n");

685 
	`d´štf
(
VMSG
, 0, "The…roper distance‡the starting„edshift, z=%f, is: %f Mpc\n",

686 
·¿ms
.
S¹šgzFÜPLC
, 
L¬ge¡_r
*·¿ms.
IÁ”P¬tDi¡
);

687 
	`d´štf
(
VMSG
, 0, "The…roper distance‡the stopping„edshift, z=%f, is: %f Mpc\n",

688 
·¿ms
.
La¡zFÜPLC
, 
Sm®Ë¡_r
*·¿ms.
IÁ”P¬tDi¡
);

689 
	`d´štf
(
VMSG
, 0, "Th»cÚ¡ruùiÚ wÈbdÚfÜ %à< z < %f\n",
·¿ms
.
La¡zFÜPLC
,·¿ms.
S¹šgzFÜPLC
);

690 
	`d´štf
(
VMSG
, 0, "ThcÜ»¥Údšg F v®ue ¬e: F¡¬t=%f, F¡İ=%f\n",
¶c
.
F¡¬t
,¶c.
F¡İ
);

691 
	`d´štf
(
VMSG
, 0, "Thbox wÈb»¶iÿ‹d %dime tØcÚ¡ruùhPLC\n",
¶c
.
N»¶iÿtiÚs
);

692 
ic
=0; ic<
¶c
.
N»¶iÿtiÚs
; ic++)

693 
	`´štf
(" Replication %2d: shift (%2d,%2d,%2d), from F=%fo F=%f\n",

694 
ic
,
¶c
.
»¶s
[ic].
i
,¶c.»¶s[ic].
j
,¶c.»¶s[ic].
k
,

695 
¶c
.
»¶s
[
ic
].
F1
,¶c.»¶s[ic].
F2
);

696 
	`d´štf
(
VMSG
, 0, "Task 0 wÈu£…lc.Nmax=%d\n",
¶c
.
Nmax
);

697 
	`d´štf
(
VMSG
, 0, "\n");

702 
	}
}

705 
	$maxF
(*
P
, *
V
, *
U
, *
D
, *
L
)

714 
dP
=
	`sq¹
((
P
[0]-
V
[0])*(P[0]-V[0])+(P[1]-V[1])*(P[1]-V[1])+(P[2]-V[2])*(P[2]-V[2]));

715 ià(
dP
==0.0)

717 
cosDU
=(
D
[0]*
U
[0]+D[1]*U[1]+D[2]*U[2]);

718 
cosDP
=(
D
[0]*(
P
[0]-
V
[0])+D[1]*(P[1]-V[1])+D[2]*(P[2]-V[2]))/
dP
;

719 
cosUP
=(
U
[0]*(
P
[0]-
V
[0])+U[1]*(P[1]-V[1])+U[2]*(P[2]-V[2]))/
dP
;

721 ià(
cosDP
-
cosDU
*
cosUP
==0.0)

723 
tmax
=(
cosDU
-
cosDP
*
cosUP
)/(cosDP-cosDU*cosUP);

724 ià(
tmax
<0)

725 
tmax
=0.0;

726 ià(
tmax
>*
L
/
dP
)

727 
tmax
=*
L
/
dP
;

729  (
cosDP
+
tmax
*
cosDU
)/
	`sq¹
(1.0+tmax*tmax+2.*tmax*
cosUP
);

730 
	}
}

732 
	$cÚe_ªd_cube_š‹r£ù
(*
Oc
, *
L
, *
V
, *
D
, 
th‘a
, *
rmš
, *
rmax
, *
axis
)

734 
i
, 
j
, 
k
, 
ivec
[3], 
dim
, 
dim1
, 
dim2
;

735 
r
, 
x
, 
F
, 
Fmax
, 
co¡h
, 
´oj
, 
U
[3], 
P
[3];

745 *
rmš
 = 1.e32;

746 *
rmax
 = 0.0;

749  
i
 = 0; i < 2; i++ )

750  
j
 = 0; j < 2; j++ )

751  
k
 = 0; k < 2; k++ )

753 
r
 = 
	`sq¹
Ğ
	`pow
(
Oc
[0] + 
i
*
L
[0] - 
V
[0], 2.0) +

754 
	`pow
(
Oc
[1] + 
j
*
L
[1] - 
V
[1], 2.0) +

755 
	`pow
(
Oc
[2] + 
k
*
L
[2] - 
V
[2], 2.0) );

756 iàĞ
r
 > *
rmax
 )

757 *
rmax
 = 
r
;

763 *
axis
 = 0;

764  
dim
 = 0; dim < 3; dim++ )

765  
i
 = 0; i < 2; i++ )

767 
´oj
 = 
Oc
[
dim
] - 
V
[dim] + 
i
*
L
[dim];

768 
dim1
 = (
dim
+1) % 3;

769 
dim2
 = (
dim
+2) % 3;

772 
r
=
´oj
*proj;

773 ià(
V
[
dim1
]<
Oc
[dim1])

774 
r
+=
	`pow
(
V
[
dim1
]-
Oc
[dim1],2.0);

775 ià(
V
[
dim1
]>
Oc
[dim1]+
L
[dim1])

776 
r
+=
	`pow
(
V
[
dim1
]-
Oc
[dim1]-
L
[dim1],2.0);

777 ià(
V
[
dim2
]<
Oc
[dim2])

778 
r
+=
	`pow
(
V
[
dim2
]-
Oc
[dim2],2.0);

779 ià(
V
[
dim2
]>
Oc
[dim2]+
L
[dim2])

780 
r
+=
	`pow
(
V
[
dim2
]-
Oc
[dim2]-
L
[dim2],2.0);

781 
r
=
	`sq¹
(r);

782 ià(
r
<*
rmš
)

783 *
rmš
=
r
;

786 iàĞ(
x
=
´oj
/
D
[
dim
]) > 0.0 &&

787 
V
[
dim1
] + 
x
*
D
[dim1] >ğ
Oc
[dim1] &&

788 
V
[
dim1
] + 
x
*
D
[dim1] <ğ
Oc
[dim1] + 
L
[dim1] &&

789 
V
[
dim2
] + 
x
*
D
[dim2] >ğ
Oc
[dim2] &&

790 
V
[
dim2
] + 
x
*
D
[dim2] <ğ
Oc
[dim2] + 
L
[dim2] )

791 *
axis
+=1<<(
dim
+
i
*3);

795 ià(
th‘a
>=180.)

799 ià(Ğ*
axis
 &&

800 
V
[0]>=
Oc
[0] && V[0]<=Oc[0]+
L
[0] &&

801 
V
[1]>=
Oc
[1] && V[1]<=Oc[1]+
L
[1] &&

802 
V
[2]>=
Oc
[2] && V[2]<=Oc[2]+
L
[2] ) )

804 *
rmš
 = 0.0;

809 ià(*
axis
)

814 
Fmax
=-10.0;

815 
co¡h
 = 
	`cos
Ğ
th‘a
 / 180. * 
PI
 );

816 
i
=0;i<2;i++)

817 
j
=0;j<2;j++)

818 
k
=0;k<2;k++)

820 
ivec
[0]=
i
;

821 
ivec
[1]=
j
;

822 
ivec
[2]=
k
;

824 
dim
=0;dim<3;dim++)

825 ià(!
ivec
[
dim
])

827 
U
[
dim
]=1.0;

828 
U
[(
dim
+1)%3]=0.0;

829 
U
[(
dim
+2)%3]=0.0;

830 
P
[0]=
Oc
[0]+
ivec
[0]*
L
[0];

831 
P
[1]=
Oc
[1]+
ivec
[1]*
L
[1];

832 
P
[2]=
Oc
[2]+
ivec
[2]*
L
[2];

833 
F
=
	`maxF
(
P
, 
V
, 
U
, 
D
, 
L
+
dim
)-
co¡h
;

834 ià(
F
>
Fmax
)

835 
Fmax
=
F
;

840 ià(
Fmax
>0)

846 
	}
}

851 
	$£t_¶c
()

853 ià(!
ThisTask
)

854 
	`d´štf
(
VMSG
, 0, "PLC flag‡t compilation was‚ot set,‚o Past Light Cone output will be given\n\n");

857 
	}
}

863 
	$£t_subboxes
()

866 
i
,
j
,
k
, 
i1
,
j1
,
k1
, 
i2
,
j2
,
k2
,
NS2
, 
NN
,
NN1
,
N1
,
N2
,
N3
,
s§ã
;

867 
tdis
,
size
,
this
,
By‹sP”P¬tişe
,
FmaxBPP
,
F¿gG_BPP
,
F¿gP_BPP
,

868 
TÙ®NP
,
TÙ®NP_³¹ask
,
¿tio
,
sm®Ë¡
,
cc
,
MemP”Task
;

870 #ifdeà
SCALE_DEPENDENT_GROWTH


871 
SDGM
.
æag
=-1;

875 
tdis
 = 
	`GrowšgMode
(
ouuts
.
zÏ¡
è* 
	`sq¹
Ğ
	`Di¥lV¬Ÿnû
(
·¿ms
.
IÁ”P¬tDi¡
) );

878 
·¿ms
.
L¬ge¡
=1.e18;

879 
cc
=1./
	`pow
(
·¿ms
.
BoxSize_hŒue
,3.0);

881 
¯
=
	`AÇlyticMassFunùiÚ
(
·¿ms
.
L¬ge¡
,
ouuts
.
zÏ¡
);

882 
¯
*
·¿ms
.
L¬ge¡
<
cc
)

884 
·¿ms
.
L¬ge¡
*=0.99;

885 
¯
=
	`AÇlyticMassFunùiÚ
(
·¿ms
.
L¬ge¡
,
ouuts
.
zÏ¡
);

889 
size
=
	`SizeFÜMass
(
·¿ms
.
L¬ge¡
);

890 
subbox
.
SaãtyBÜd”
 = 
·¿ms
.
Bound¬yLay”FaùÜ
 * 
size
;

891 
subbox
.
§ã
 = ()(subbox.
SaãtyBÜd”
/
·¿ms
.
IÁ”P¬tDi¡
)+1;

893 ià(!
ThisTask
)

895 
	`d´štf
(
VMSG
, 
ThisTask
, "\n");

896 
	`d´štf
(
VMSG
, 
ThisTask
, "Determination ofhe boundary†ayer\n");

897 
	`d´štf
(
VMSG
, 
ThisTask
, " growšg mod© z=%f: %f\n",
ouuts
.
zÏ¡
, 
	`GrowšgMode
( outputs.zlast ));

898 
	`d´štf
(
VMSG
, 
ThisTask
, "†argest haloƒxpected inhis box‡t z=%f: %e Msun\n",

899 
ouuts
.
zÏ¡
, 
·¿ms
.
L¬ge¡
);

900 
	`d´štf
(
VMSG
, 
ThisTask
, " it Lag¿ngŸÀsize: %àMpc\n",
size
);

901 
	`d´štf
(
VMSG
, 
ThisTask
, "ypiÿÈdi¥Ïûm’t: %à\n",
tdis
);

902 
	`d´štf
(
VMSG
, 
ThisTask
, "he boundary†ayer will be %f,‡ factor of %f with„espectoheypical displacement\n",

903 
subbox
.
SaãtyBÜd”
, subbox.SaãtyBÜd”/
tdis
);

907 
s§ã
 = 2.*
subbox
.
§ã
;

908 
FmaxBPP
 = ()(
´oduù_d©a
) + 10.0*()() +

909 ()(è* ()
NTasks
 / ()
MyGrids
[0].
GSglob®
[
_z_
];

910 
TÙ®NP
 = ()
MyGrids
[0].
GSglob®
[
_x_
] * ()MyGrids[0].GSglob®[
_y_
] * ()MyGrids[0].GSglob®[
_z_
];

911 
TÙ®NP_³¹ask
 = 
TÙ®NP
/()
NTasks
;

913 
F¿gP_BPP
 = ()(
´oduù_d©a
);

914 
F¿gG_BPP
 = 3.0*()()+()((
group_d©a
è+(
hi¡Ü›s_d©a
))/10.0;

915 #ifdeà
PLC


916 
F¿gG_BPP
 +ğ()(
¶cgroup_d©a
)/10.;

919 
sm®Ë¡
=1.e10;

920 
NSliûs
=0;

924 ++
NSliûs
;

926 
By‹sP”P¬tişe
=1.e10;

927 
k
=1; k<=
NTasks
; k++)

928 
j
=1; j<=
NTasks
/
k
; j++)

929 
i
=1; i<=
NTasks
/
k
/
j
; i++)

931 ià(
i
*
j
*
k
==
NTasks
)

934 
N1
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],
i
,0);

935 
N2
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],
j
,0);

936 
N3
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],
k
*
NSliûs
,0);

937 ià(
N1
<
s§ã
 || 
N2
<s§ã || 
N3
<ssafe)

939 
NN
 = (
N1
 + (
i
==1? 0 : 
s§ã
))

940 * (
N2
 + (
j
==1? 0 : 
s§ã
))

941 * (
N3
 + (
k
*
NSliûs
==1? 0 : 
s§ã
));

943 
¿tio
 = ()
NN
/
TÙ®NP_³¹ask
;

944 ià(
NSliûs
>1)

945 
this
=()(
´oduù_d©a
è+ 
¿tio
 * (
F¿gP_BPP
 + 
F¿gG_BPP
);

947 
this
=Ğ()(
´oduù_d©a
è> 
¿tio
 * 
F¿gG_BPP
 ?

948 ()(
´oduù_d©a
è: 
¿tio
 * 
F¿gG_BPP
) +

949 
¿tio
 * 
F¿gP_BPP
;

950 ià(
this
<
FmaxBPP
)

951 
this
=
FmaxBPP
;

953 ià(
this
<
sm®Ë¡
)

955 
sm®Ë¡
=
this
;

956 
i2
=
i
; 
j2
=
j
; 
k2
=
k
; 
NS2
=
NSliûs
;

959 ià(
this
 < 
By‹sP”P¬tişe
)

961 
By‹sP”P¬tişe
=
this
;

962 
NN1
=
NN
;

963 
i1
=
i
;

964 
j1
=
j
;

965 
k1
=
k
;

968 ià(
By‹sP”P¬tişe
>1000.)

971 
By‹sP”P¬tişe
>
·¿ms
.
MaxMemP”P¬tişe
);

974 ià(
By‹sP”P¬tişe
>1000.)

976 ià(!
ThisTask
)

978 
	`d´štf
(
VXERR
, 
ThisTask
, "ERROR:‚o…ossible division of sub-boxes found upo Nslices=%d\n",

979 
NSliûs
);

980 
	`d´štf
(
VXERR
, 
ThisTask
, "lowe¡…ossibË v®uoàmemÜy…”…¬tişi %à", 
sm®Ë¡
);

981 
	`d´štf
(
VXERR
, 
ThisTask
, "found oÀ¨subdivisiÚ %d-%d-%d oÀ%d sliûs\n", 
i2
, 
j2
, 
k2
, 
NS2
);

982 
	`d´štf
(
VXERR
, 
ThisTask
, "please decrease BoundaryLayerFactor or increase MaxMemPerParticle\n");

983 
	`fæush
(
¡dout
);

988 
subbox
.
nbox_x
=
i1
;

989 
subbox
.
nbox_y
=
j1
;

990 
subbox
.
nbox_z_this¦iû
=
k1
;

991 
subbox
.
nbox_z_®l¦iûs
=
k1
*
NSliûs
;

993 
subbox
.
§ã_x
 = (subbox.
nbox_x
>1 ? subbox.
§ã
 : 0);

994 
subbox
.
§ã_y
 = (subbox.
nbox_y
>1 ? subbox.
§ã
 : 0);

995 
subbox
.
§ã_z
 = (subbox.
nbox_z_®l¦iûs
>1 ? subbox.
§ã
 : 0);

997 
subbox
.
pbc_x
 = (subbox.
nbox_x
==1);

998 
subbox
.
pbc_y
 = (subbox.
nbox_y
==1);

999 
subbox
.
pbc_z
 = (subbox.
nbox_z_®l¦iûs
==1);

1002 
NN
=
subbox
.
nbox_y
*subbox.
nbox_z_this¦iû
;

1003 
subbox
.
mybox_x
=
ThisTask
/
NN
;

1004 
NN1
=
ThisTask
-
subbox
.
mybox_x
*
NN
;

1005 
subbox
.
mybox_y
=
NN1
/subbox.
nbox_z_this¦iû
;

1006 
subbox
.
mybox_z
=
NN1
-subbox.
mybox_y
*subbox.
nbox_z_this¦iû
;

1008 
subbox
.
Lgrid_x
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],subbox.
nbox_x
,subbox.
mybox_x
);

1009 
subbox
.
Lgrid_y
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],subbox.
nbox_y
,subbox.
mybox_y
);

1010 
subbox
.
Lgrid_z
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

1012 
subbox
.
Lgwbl_x
 = subbox.
Lgrid_x
 + 2*subbox.
§ã_x
;

1013 
subbox
.
Lgwbl_y
 = subbox.
Lgrid_y
 + 2*subbox.
§ã_y
;

1014 
subbox
.
Lgwbl_z
 = subbox.
Lgrid_z
 + 2*subbox.
§ã_z
;

1016 
subbox
.
N·¹
 = subbox.
Lgwbl_x
 * subbox.
Lgwbl_y
 * subbox.
Lgwbl_z
;

1018 
subbox
.
¡¬t_x
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_x_
] ,subbox.
nbox_x
,subbox.
mybox_x
);

1019 
subbox
.
¡¬t_y
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_y_
],subbox.
nbox_y
,subbox.
mybox_y
);

1020 
subbox
.
¡¬t_z
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

1022 
subbox
.
¡abl_x
 = subbox.
¡¬t_x
 - subbox.
§ã_x
;

1023 
subbox
.
¡abl_y
 = subbox.
¡¬t_y
 - subbox.
§ã_y
;

1024 
subbox
.
¡abl_z
 = subbox.
¡¬t_z
 - subbox.
§ã_z
;

1026 
subbox
.
ov”h—d
=()subbox.
N·¹
/()(subbox.
Lgrid_x
 * subbox.
Lgrid_y
 * subbox.
Lgrid_z
);

1028 
MemP”Task
 = 
By‹sP”P¬tişe
 * 
TÙ®NP_³¹ask
 / 1024. / 1024. / 1024.;

1031 ià(
NSliûs
>1 && 
·¿ms
.
Wr™eSÇpshÙ
)

1033 
·¿ms
.
Wr™eSÇpshÙ
=0;

1034 ià(!
ThisTask
)

1035 
	`´štf
("Sorry, but snapshots cannot be written if fragmentation is done in slices\n");

1039 ià(
·¿ms
.
OuutInH100
)

1040 
mf
.
hçùÜ
=
·¿ms
.
HubbË100
;

1042 
mf
.
hçùÜ
=1.0;

1043 
mf
.
hçùÜ4
=
	`pow
(mf.
hçùÜ
,4.);

1044 
mf
.
vŞ
=()
MyGrids
[0].
GSglob®
[
_x_
]*()MyGrids[0].GSglob®[
_y_
] *

1045 ()
MyGrids
[0].
GSglob®
[
_z_
]*
	`pow
(
·¿ms
.
IÁ”P¬tDi¡
,3.0);

1046 
mf
.
mmš
=
	`log10
(
·¿ms
.
MšH®oMass
*·¿ms.
P¬tişeMass
)-0.001*
DELTAM
;

1047 
mf
.
mmax
=
	`log10
(
·¿ms
.
L¬ge¡
)+3.0*
DELTAM
;

1048 
mf
.
NBIN
 = ()((mf.
mmax
-mf.
mmš
)/
DELTAM
) +1;

1049 
mf
.
nšbš
=(*)
	`ÿÎoc
(mf.
NBIN
,());

1050 
mf
.
nšbš_loÿl
=(*)
	`ÿÎoc
(mf.
NBIN
,());

1051 
mf
.
massšbš
=(*)
	`ÿÎoc
(mf.
NBIN
,());

1052 
mf
.
massšbš_loÿl
=(*)
	`ÿÎoc
(mf.
NBIN
,());

1055 ià(!
ThisTask
)

1057 
	`´štf
("\n");

1058 
	`´štf
("FRAGMENTATION:\n");

1059 ià(
NSliûs
>1)

1060 
	`´štf
("Thbox wÈbäagm’‹d iÀ%d sliûs\n",
NSliûs
);

1062 
	`´štf
("The box will be fragmented in one go\n");

1063 
	`´štf
("Numb” oàsub-boxe ³¸dim’siÚ: %d %d %d\n",
subbox
.
nbox_x
,subbox.
nbox_y
,subbox.
nbox_z_®l¦iûs
);

1064 
	`´štf
("Bound¬y†ay” (ŒuMpc): %f\n",
subbox
.
SaãtyBÜd”
);

1065 
	`´štf
("Bound¬y†ay” (gridpošts): %d\n",
subbox
.
§ã
);

1066 
	`´štf
("CÜ0 wÈwÜk oÀ¨grid: %d %d %d\n",
subbox
.
Lgwbl_x
,subbox.
Lgwbl_y
,subbox.
Lgwbl_z
);

1067 
	`´štf
("Numb” oà·¹işe fÜ cÜ0: %d\n",
subbox
.
N·¹
);

1068 
	`´štf
("Th»sŞved box wÈbe: %d %d %d\n",
subbox
.
Lgrid_x
,subbox.
Lgrid_y
,subbox.
Lgrid_z
);

1069 
	`´štf
("P”iodiøbound¬y cÚd™iÚs: %d %d %d\n",
subbox
.
pbc_x
,subbox.
pbc_y
,subbox.
pbc_z
);

1070 
	`´štf
("Requœed by‹ ³¸fá…¬tişe: %f\n",
By‹sP”P¬tişe
);

1071 
	`´štf
("Thov”h—d fÜ f¿gm’tiÚ is: %f\n",
subbox
.
ov”h—d
);

1072 
	`´štf
("Requœed memÜy…”ask: %4.0fMb - Maxmem=%dMb\n", 
MemP”Task
*1024.,
·¿ms
.
MaxMem
);

1073 
	`´štf
("\nThe mass function will be computed from Log M=%fo Log M=%f (%d bins)\n",

1074 
mf
.
mmš
, mf.
mmax
, mf.
NBIN
);

1075 
	`´štf
("\n");

1078 ià(
MemP”Task
 > 
·¿ms
.
MaxMem
/1024.0)

1080 ià(!
ThisTask
)

1081 
	`´štf
("ERROR: your„equirements overshoothe‡vailable memory…er MPIask\n");

1086 
	}
}

1089 
	$fšd_¡¬t
(
L
,
n
,
ibox
)

1091 
LL
,
MM
;

1093 ià(
n
==1)

1097 
LL
=
L
/
n
;

1098 
MM
=
L
%
n
;

1099 ià(
ibox
==0)

1101 ià(
ibox
<=
MM
)

1102  
ibox
*(
LL
+1);

1104  
ibox
*
LL
+
MM
;

1107 
	}
}

1110 
	$fšd_Ëngth
(
L
, 
n
, 
ibox
)

1115 
LL
,
MM
;

1117 ià(
n
==1)

1118  
L
;

1121 
LL
=
L
/
n
;

1122 
MM
=
L
%
n
;

1123 ià(
ibox
<
MM
)

1124  
LL
+1;

1126  
LL
;

1128 
	}
}

1133 
	$gcd
(
u
, 
v
)

1138 
shiá
;

1139 ià(
u
 =ğ0è 
v
;

1140 ià(
v
 =ğ0è 
u
;

1141 
shiá
 = 
	`__butš_ùz
(
u
 | 
v
);

1142 
u
 >>ğ
	`__butš_ùz
(u);

1144 
v
 >>ğ
	`__butš_ùz
(v);

1145 ià(
u
 > 
v
) {

1146 
t
 = 
v
;

1147 
v
 = 
u
;

1148 
u
 = 
t
;

1150 
v
 = v - 
u
;

1151 } 
v
 != 0);

1152  
u
 << 
shiá
;

1153 
	}
}

1156 
	$£t_fá_decompos™iÚ
()

1162 
decompos™iÚ_dÚe
 = 0;

1164 ifĞ
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0] +

1165 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[1] +

1166 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[2] > 0)

1172 iàĞ
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0] < 0 ||

1173 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[1] < 0 ||

1174 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[2] < 0 )

1176 
	`d´štf
(
VXERR
, 0, "you can't constraint FFt decomposition with‚egative values\n");

1180 iàĞ
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0] == 0 )

1182 
	`d´štf
(
VXERR
, 0, "you can't constraint FFt decomposition†eaving first dimensiono 0\n");

1188 
š‹º®
.
sks_subdivisiÚ_3D
[0] = iÁ”Çl.
cÚ¡¿š_sk_decompos™iÚ
[0];

1189 
š‹º®
.
sks_subdivisiÚ_3D
[1] = internal.tasks_subdivision_3D[2] = 1;

1190 
decompos™iÚ_dÚe
 = 1;

1192 ifĞ
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0] =ğ
NTasks
 )

1195 
š‹º®
.
sks_subdivisiÚ_dim
 = 1;

1196 
decompos™iÚ_dÚe
 = 3;

1199 ifĞ
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[1] > 0 )

1202 if(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0]*š‹º®.cÚ¡¿š_sk_decompos™iÚ[1] > 
NTasks
 )

1204 
	`d´štf
(
VXERR
, 0, "you specified‡ wrong fft decomposition: Dim0 x Dim1 = %d > %dasks\n",

1205 
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0]*š‹º®.cÚ¡¿š_sk_decompos™iÚ[1], 
NTasks
);

1210 
š‹º®
.
sks_subdivisiÚ_3D
[1] = iÁ”Çl.
cÚ¡¿š_sk_decompos™iÚ
[1];

1212 if(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[0]*š‹º®.cÚ¡¿š_sk_decompos™iÚ[1] =ğ
NTasks
)

1215 
š‹º®
.
sks_subdivisiÚ_dim
 = 2;

1216 
š‹º®
.
sks_subdivisiÚ_3D
[2] = 1;

1217 
decompos™iÚ_dÚe
 = 3;

1221 
š‹º®
.
sks_subdivisiÚ_dim
 = 3;

1222 
decompos™iÚ_dÚe
 = 3;

1224 
š‹º®
.
sks_subdivisiÚ_3D
[2] = 
NTasks
 /(internal.tasks_subdivision_3D[0] * internal.tasks_subdivision_3D[1]);

1226 if(
š‹º®
.
cÚ¡¿š_sk_decompos™iÚ
[2] > 0 &&

1227 
š‹º®
.
sks_subdivisiÚ_3D
[2] !ğš‹º®.
cÚ¡¿š_sk_decompos™iÚ
[2])

1229 
	`d´štf
(
VXERR
, 0, "you s³cif›d‡ wrÚg fá decompos™iÚ: dim2 should b%d in¡—d oà%d\n", 
š‹º®
.
sks_subdivisiÚ_3D
[2], iÁ”Çl.
cÚ¡¿š_sk_decompos™iÚ
[2]);

1235 
decompos™iÚ_dÚe
 = 1;

1242 if(
decompos™iÚ_dÚe
 < 3)

1248 if(
decompos™iÚ_dÚe
 == 1)

1252 
š‹º®
.
sks_subdivisiÚ_3D
[1] = 
NTasks
 / internal.tasks_subdivision_3D[0];

1253 
š‹º®
.
sks_subdivisiÚ_3D
[2] = 1;

1254 
š‹º®
.
sks_subdivisiÚ_dim
 = 2;

1256 if(
NTasks
 % 
š‹º®
.
sks_subdivisiÚ_3D
[0])

1258 
	`d´štf
(
VXERR
, 0, "you specified‡ wrong fft decomposition\n");

1267 
Ngrid
 = 
·¿ms
.
GridSize
[0];

1269 ifĞ
NTasks
 <ğ
Ngrid
 )

1273 
š‹º®
.
sks_subdivisiÚ_dim
 = 1;

1274 
š‹º®
.
sks_subdivisiÚ_3D
[0] = 
NTasks
;

1275 
š‹º®
.
sks_subdivisiÚ_3D
[2] = internal.tasks_subdivision_3D[1] = 1;

1279 
Ngrid2
 = 
Ngrid
 * Ngrid / (
DECOMPOSITION_LIMIT_FACTOR_2D
 * DECOMPOSITION_LIMIT_FACTOR_2D);

1281 ifĞ
NTasks
 <ğ
Ngrid2
)

1284 
GCD
 = 
	`gcd
Ğ
Ngrid
, 
NTasks
 );

1285 
GCD_2
 = 
	`gcd
Ğ
Ngrid
, (
NTasks
 / 
GCD
) );

1287 ifĞ
GCD
 * 
GCD_2
 !ğ
NTasks
)

1291 
š‹º®
.
sks_subdivisiÚ_dim
 = 1;

1292 
š‹º®
.
sks_subdivisiÚ_3D
[0] = 
NTasks
;

1293 
š‹º®
.
sks_subdivisiÚ_3D
[2] = internal.tasks_subdivision_3D[1] = 1;

1298 
š‹º®
.
sks_subdivisiÚ_dim
 = 2;

1299 
š‹º®
.
sks_subdivisiÚ_3D
[0] = 
GCD
;

1300 
š‹º®
.
sks_subdivisiÚ_3D
[1] = 
GCD_2
;

1309 
Ngrid_lim™
 = 
Ngrid
 / 
DECOMPOSITION_LIMIT_FACTOR_2D
;

1311 
GCD
 = 
	`gcd
Ğ
Ngrid_lim™
, 
NTasks
 );

1312 
GCD_2
 = 
	`gcd
Ğ
Ngrid_lim™
, (
NTasks
 / 
GCD
) );

1314 ifĞ
NTasks
 % (
GCD
 * 
GCD_2
) )

1316 
	`d´štf
(
VXERR
, 0, "3D decomposition is‚ot…ossible\n");

1320 
š‹º®
.
sks_subdivisiÚ_dim
 = 3;

1321 
š‹º®
.
sks_subdivisiÚ_3D
[0] = 
GCD
;

1322 
š‹º®
.
sks_subdivisiÚ_3D
[1] = 
GCD_2
;

1324 
š‹º®
.
sks_subdivisiÚ_3D
[2] = 
NTasks
 / (
GCD
 * 
GCD_2
);

1374 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/memorytest.c

27 
	~"pšocchio.h
"

31 
abÜt_code
();

32 
my_š™Ÿliz©iÚ
();

34 
	$maš
(
¬gc
, **
¬gv
)

37 
i
,
j
,
k
, 
i1
,
j1
,
k1
, 
i2
,
j2
,
k2
,
NS2
, 
NN
,
NN1
,
N1
,
N2
,
N3
,
s§ã
;

38 
tdis
,
size
,
this
,
By‹sP”P¬tişe
,
FmaxBPP
,
F¿gG_BPP
,
F¿gP_BPP
,

39 
TÙ®NP
,
TÙ®NP_³¹ask
,
¿tio
,
sm®Ë¡
,
cc
,
MemP”Task
;

41 #ifdeà
SCALE_DEPENDENT_GROWTH


42 
SDGM
.
æag
=-1;

45 
NSliûs
=0, 
N¶ªes
;

48 
	`MPI_In™
(&
¬gc
, &
¬gv
);

49 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
ThisTask
);

50 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
NTasks
);

52 ià(
NTasks
>1)

54 
	`´štf
("Please„unhis code on 1ask only\n");

55 
	`MPI_Fš®ize
();

60 ià(
¬gc
<3)

62 
	`´štf
("Usage: memorytest…aramfile NTasks\n");

63 
	`MPI_Fš®ize
();

68 
	`¡rıy
(
·¿ms
.
P¬am‘”Fe
,
¬gv
[1]);

69 ià(
	`my_š™Ÿliz©iÚ
())

70 
	`abÜt_code
();

72 
NTasks
 = 
	`©oi
(
¬gv
[2]);

74 
	`´štf
("Numb” oàMPIask u£d fÜhrun: %d\n",
NTasks
);

76 
N¶ªes
=
MyGrids
[0].
GSglob®
[
_x_
]/
NTasks
;

77 ià(
N¶ªes
*
NTasks
<
MyGrids
[0].
GSglob®
[
_x_
])

78 ++
N¶ªes
;

79 
	`´štf
("N¶ªes=%d\n",
N¶ªes
);

83 
tdis
 = 
	`GrowšgMode
(
ouuts
.
zÏ¡
è* 
	`sq¹
Ğ
	`Di¥lV¬Ÿnû
(
·¿ms
.
IÁ”P¬tDi¡
) );

86 
·¿ms
.
L¬ge¡
=1.e18;

87 
cc
=1./
	`pow
(
·¿ms
.
BoxSize_hŒue
,3.0);

89 
¯
=
	`AÇlyticMassFunùiÚ
(
·¿ms
.
L¬ge¡
,
ouuts
.
zÏ¡
);

90 
¯
*
·¿ms
.
L¬ge¡
<
cc
)

92 
·¿ms
.
L¬ge¡
*=0.99;

93 
¯
=
	`AÇlyticMassFunùiÚ
(
·¿ms
.
L¬ge¡
,
ouuts
.
zÏ¡
);

97 
size
=
	`SizeFÜMass
(
·¿ms
.
L¬ge¡
);

98 
subbox
.
SaãtyBÜd”
 = 
·¿ms
.
Bound¬yLay”FaùÜ
 * 
size
;

99 
subbox
.
§ã
 = ()(subbox.
SaãtyBÜd”
/
·¿ms
.
IÁ”P¬tDi¡
)+1;

101 ià(!
ThisTask
)

103 
	`´štf
("\n");

104 
	`´štf
("Determination ofhe boundary†ayer\n");

105 
	`´štf
(" growšg mod© z=%f: %f\n",
ouuts
.
zÏ¡
, 
	`GrowšgMode
( outputs.zlast ));

106 
	`´štf
("†argest haloƒxpected inhis box‡t z=%f: %e Msun\n",

107 
ouuts
.
zÏ¡
, 
·¿ms
.
L¬ge¡
);

108 
	`´štf
(" it Lag¿ngŸÀsize: %àMpc\n",
size
);

109 
	`´štf
("ypiÿÈdi¥Ïûm’t: %à\n",
tdis
);

110 
	`´štf
("he boundary†ayer will be %f,‡ factor of %f with„espectoheypical displacement\n",

111 
subbox
.
SaãtyBÜd”
, subbox.SaãtyBÜd”/
tdis
);

115 
s§ã
=2.*
subbox
.
§ã
;

116 
FmaxBPP
 = ()(
´oduù_d©a
) + 10.0*()() +

117 ()(è* ()
NTasks
 / ()
MyGrids
[0].
GSglob®
[
_z_
];

118 
TÙ®NP
 = ()
MyGrids
[0].
GSglob®
[
_x_
] * ()MyGrids[0].GSglob®[
_y_
] * ()MyGrids[0].GSglob®[
_z_
];

119 
TÙ®NP_³¹ask
 = 
TÙ®NP
/()
NTasks
;

121 
F¿gP_BPP
=()(
´oduù_d©a
);

122 
F¿gG_BPP
=3.0*()()+()((
group_d©a
è+(
hi¡Ü›s_d©a
))/10.0;

123 #ifdeà
PLC


124 
F¿gG_BPP
+=()(
¶cgroup_d©a
)/10.;

127 
	`´štf
("Numb” oà·¹işe ³¸sk: %àmliÚs\n", 
TÙ®NP_³¹ask
/1.e6);

128 
	`´štf
("TÙ®‚umb” oà·¹işes: %àmliÚs\n", 
TÙ®NP
/1.e6);

130 
sm®Ë¡
=1.e10;

131 
NSliûs
=0;

135 ++
NSliûs
;

137 
By‹sP”P¬tişe
=1.e10;

138 
	`´štf
("I‹¿tiÚ w™h NSliûs=%d:\n",
NSliûs
);

139 
k
=1; k<=
NTasks
; k++)

140 
j
=1; j<=
NTasks
/
k
; j++)

141 
i
=1; i<=
NTasks
/
k
/
j
; i++)

143 ià(
i
*
j
*
k
==
NTasks
)

146 
N1
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],
i
,0);

147 
N2
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],
j
,0);

148 
N3
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],
k
*
NSliûs
,0);

149 ià(
N1
<
s§ã
 || 
N2
<s§ã || 
N3
<ssafe)

151 
NN
 = (
N1
 + (
i
==1? 0 : 
s§ã
))

152 * (
N2
 + (
j
==1? 0 : 
s§ã
))

153 * (
N3
 + (
k
*
NSliûs
==1? 0 : 
s§ã
));

155 
¿tio
 = ()
NN
/
TÙ®NP_³¹ask
;

156 ià(
NSliûs
>1)

157 
this
=()(
´oduù_d©a
è+ 
¿tio
 * (
F¿gP_BPP
 + 
F¿gG_BPP
);

159 
this
=Ğ()(
´oduù_d©a
è> 
¿tio
 * 
F¿gG_BPP
 ?

160 ()(
´oduù_d©a
è: 
¿tio
 * 
F¿gG_BPP
) +

161 
¿tio
 * 
F¿gP_BPP
;

162 ià(
this
<
FmaxBPP
)

163 
this
=
FmaxBPP
;

165 ià(
this
<
sm®Ë¡
)

167 
sm®Ë¡
=
this
;

168 
i2
=
i
; 
j2
=
j
; 
k2
=
k
; 
NS2
=
NSliûs
;

171 #ifdeà
VERBOSE


172 
	`´štf
 (" case %d %d %d: N1=%d, N2=%d, N3=%d, NN=(%d * %d * %d)=%d - %f (overhead=%f)\n",

173 
i
,
j
,
k
,
N1
,
N2
,
N3
,

174 (
N1
 + (
i
==1? 0 : 
s§ã
)),

175 (
N2
 + (
j
==1? 0 : 
s§ã
)),

176 (
N3
 + (
k
==1? 0 : 
s§ã
)),
NN
,
this
,()NN/()(
N1
*
N2
*N3));

179 ià(
this
 < 
By‹sP”P¬tişe
)

181 
By‹sP”P¬tişe
=
this
;

182 
NN1
=
NN
;

183 
i1
=
i
;

184 
j1
=
j
;

185 
k1
=
k
;

189 
	`´štf
("subboxes: %d %d %d\n",
i1
,
j1
,
k1
);

190 
	`´štf
("by‹ ³¸·¹işe: %f\n",
By‹sP”P¬tişe
);

192 ià(
By‹sP”P¬tişe
>1000.)

195 
By‹sP”P¬tişe
>
·¿ms
.
MaxMemP”P¬tişe
);

198 ià(
By‹sP”P¬tişe
>1000.)

200 
	`´štf
("ERROR:‚o…ossible division of sub-boxes found upo Nslices=%d\n",

201 
NSliûs
);

202 
	`´štf
("lowe¡…ossibË v®uoàmemÜy…”…¬tişi %à",
sm®Ë¡
);

203 
	`´štf
("found oÀ¨subdivisiÚ %d-%d-%d oÀ%d sliûs\n",
i2
,
j2
,
k2
,
NS2
);

204 
	`´štf
("please decrease BoundaryLayerFactor or increase MaxMemPerParticle\n");

206 
	`MPI_Fš®ize
();

207  
NSliûs
;

211 
subbox
.
nbox_x
=
i1
;

212 
subbox
.
nbox_y
=
j1
;

213 
subbox
.
nbox_z_this¦iû
=
k1
;

214 
subbox
.
nbox_z_®l¦iûs
=
k1
*
NSliûs
;

216 
subbox
.
§ã_x
 = (subbox.
nbox_x
>1 ? subbox.
§ã
 : 0);

217 
subbox
.
§ã_y
 = (subbox.
nbox_y
>1 ? subbox.
§ã
 : 0);

218 
subbox
.
§ã_z
 = (subbox.
nbox_z_®l¦iûs
>1 ? subbox.
§ã
 : 0);

220 
subbox
.
pbc_x
 = (subbox.
nbox_x
==1);

221 
subbox
.
pbc_y
 = (subbox.
nbox_y
==1);

222 
subbox
.
pbc_z
 = (subbox.
nbox_z_®l¦iûs
==1);

225 
NN
=
subbox
.
nbox_y
*subbox.
nbox_z_this¦iû
;

226 
subbox
.
mybox_x
=
ThisTask
/
NN
;

227 
NN1
=
ThisTask
-
subbox
.
mybox_x
*
NN
;

228 
subbox
.
mybox_y
=
NN1
/subbox.
nbox_z_this¦iû
;

229 
subbox
.
mybox_z
=
NN1
-subbox.
mybox_y
*subbox.
nbox_z_this¦iû
;

231 
subbox
.
Lgrid_x
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_x_
],subbox.
nbox_x
,subbox.
mybox_x
);

232 
subbox
.
Lgrid_y
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_y_
],subbox.
nbox_y
,subbox.
mybox_y
);

233 
subbox
.
Lgrid_z
 = 
	`fšd_Ëngth
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

235 
subbox
.
Lgwbl_x
 = subbox.
Lgrid_x
 + 2*subbox.
§ã_x
;

236 
subbox
.
Lgwbl_y
 = subbox.
Lgrid_y
 + 2*subbox.
§ã_y
;

237 
subbox
.
Lgwbl_z
 = subbox.
Lgrid_z
 + 2*subbox.
§ã_z
;

239 
subbox
.
N·¹
 = subbox.
Lgwbl_x
 * subbox.
Lgwbl_y
 * subbox.
Lgwbl_z
;

241 
subbox
.
¡¬t_x
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_x_
],subbox.
nbox_x
,subbox.
mybox_x
);

242 
subbox
.
¡¬t_y
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_y_
],subbox.
nbox_y
,subbox.
mybox_y
);

243 
subbox
.
¡¬t_z
 = 
	`fšd_¡¬t
(
MyGrids
[0].
GSglob®
[
_z_
],subbox.
nbox_z_®l¦iûs
,subbox.
mybox_z
);

245 
subbox
.
¡abl_x
 = subbox.
¡¬t_x
 - subbox.
§ã_x
;

246 
subbox
.
¡abl_y
 = subbox.
¡¬t_y
 - subbox.
§ã_y
;

247 
subbox
.
¡abl_z
 = subbox.
¡¬t_z
 - subbox.
§ã_z
;

249 
subbox
.
ov”h—d
=()subbox.
N·¹
/()(subbox.
Lgrid_x
 * subbox.
Lgrid_y
 * subbox.
Lgrid_z
);

251 
MemP”PÏÃ
 = 
By‹sP”P¬tişe
 * ()
MyGrids
[0].
GSglob®
[
_x_
] * ()MyGrids[0].GSglobal[_x_] / 1024. / 1024. / 1024.;

252 
MemP”Task
 = 
By‹sP”P¬tişe
 * 
TÙ®NP_³¹ask
 / 1024. / 1024. / 1024.;

253 
NPÏÃsP”Task
 = ()(
·¿ms
.
MaxMem
/1024.0/
MemP”PÏÃ
);

255 
	`d´štf
(
VXX
, "\n");

256 
	`d´štf
(
VXX
, "FRAGMENTATION:\n");

257 ià(
NSliûs
>1)

258 
	`d´štf
(
VXX
, "Thbox wÈbäagm’‹d iÀ%d sliûs\n",
NSliûs
);

260 
	`d´štf
(
VXX
, "The box will be fragmented in one go\n");

261 
	`d´štf
(
VMSG
, "Numb” oàsub-boxe ³¸dim’siÚ: %d %d %d\n",
subbox
.
nbox_x
,subbox.
nbox_y
,subbox.
nbox_z_®l¦iûs
);

262 
	`d´štf
(
VMSG
, "Bound¬y†ay” (ŒuMpc): %f\n",
subbox
.
SaãtyBÜd”
);

263 
	`d´štf
(
VMSG
, "Bound¬y†ay” (gridpošts): %d\n",
subbox
.
§ã
);

264 
	`d´štf
(
VMSG
, "CÜe wÈwÜk oÀ¨grid: %d %d %d\n",
subbox
.
Lgwbl_x
,subbox.
Lgwbl_y
,subbox.
Lgwbl_z
);

265 
	`d´štf
(
VMSG
, "Numb” oà·¹işe ³¸cÜe: %d\n",
subbox
.
N·¹
);

266 
	`d´štf
(
VMSG
, "Th»sŞved box wÈbe: %d %d %d\n",
subbox
.
Lgrid_x
,subbox.
Lgrid_y
,subbox.
Lgrid_z
);

267 
	`d´štf
(
VMSG
, "P”iodiøbound¬y cÚd™iÚs: %d %d %d\n",
subbox
.
pbc_x
,subbox.
pbc_y
,subbox.
pbc_z
);

268 
	`d´štf
(
VMSG
, "Requœed by‹ ³¸fá…¬tişe: %f\n",
By‹sP”P¬tişe
);

269 
	`d´štf
(
VMSG
, "Thov”h—d fÜ f¿gm’tiÚ is: %f\n",
subbox
.
ov”h—d
);

270 
	`d´štf
(
VMSG
, "Requœed memÜy…”ask: %4.0fMb - Maxmem=%dMb\n", 
MemP”Task
*1024.,
·¿ms
.
MaxMem
);

271 
	`d´štf
(
VMSG
, "\n");

272 
	`d´štf
(
VMSG
, "\n");

274 ià(
MemP”Task
 > 
·¿ms
.
MaxMem
/1024.0)

275 
	`´štf
("FATAL ERROR: your„equirements overshoothe‡vailable memory…er MPIask,he„un will fail\n");

276 
	`´štf
("Requœed memÜy…”…ÏÃ: %fGb\n", 
MemP”PÏÃ
);

277 
	`´štf
("You will be‡bleo†oad‡t most %d…lanes…er MPIask (%d inotal over %d„equired)\n",

278 
NPÏÃsP”Task
,NPÏÃsP”Task * 
NTasks
,
MyGrids
[0].
GSglob®
[
_x_
]);

279 ià(
NPÏÃsP”Task
 * 
NTasks
 < 
MyGrids
[0].
GSglob®
[
_x_
])

280 
	`´štf
("FATAL ERROR: you wÈnÙ babËØlßd‡Îh¶ªe Ú‡ask,hruÀwÈç (%d)\n",
NPÏÃsP”Task
 * 
NTasks
);

281 
	`´štf
("Total„equired memory: %fGb\n",

282 
By‹sP”P¬tişe
 * 
TÙ®NP
 / 1024. / 1024. / 1024.);

285 
	`MPI_Fš®ize
();

286  
NSliûs
;

287 
	}
}

289 
	$abÜt_code
()

291 
	`´štf
("Task %d‡bÜtšg...\n",
ThisTask
);

292 
	`MPI_AbÜt
(
MPI_COMM_WORLD
,1);

293 
	}
}

297 
	$my_š™Ÿliz©iÚ
()

299 
wÜk¥aû
 = 
	`g¦_š‹g¿tiÚ_wÜk¥aû_®loc
(
NWINT
);

301 ià(
	`£t_·¿m‘”s
())

304 #ifdeà
SCALE_DEPENDENT_GROWTH


306 ià(
	`»ad_pow”_bË_äom_CAMB
())

310 ià(
	`š™Ÿlize_cosmŞogy
())

313 ià(
	`£t_grids
())

317 
WšdowFunùiÚTy³
=2;

318 ià(
	`š™Ÿlize_MassV¬Ÿnû
())

321 #ifdeà
SCALE_DEPENDENT_GROWTH


323 ià(
	`š™Ÿlize_SÿËD•’d’tGrowth
())

328 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/pinocchio.c

27 
	~"pšocchio.h
"

29 
abÜt_code
();

30 
wr™e_ıutimes
();

32 
	$maš
(
¬gc
, **
¬gv
, **
’vp
)

34 
time
;

35 
ThisGrid
;

37 #ifdeà
USE_GPERFTOOLS


38 
	`Prof”S¹
("pinocchio_gprofile.log");

42 
	`MPI_In™
(&
¬gc
, &
¬gv
);

43 
	`MPI_Comm_¿nk
(
MPI_COMM_WORLD
, &
ThisTask
);

44 
	`MPI_Comm_size
(
MPI_COMM_WORLD
, &
NTasks
);

47 
	`pfá_š™
();

50 
	`fáw_mpi_š™
();

53 
ıutime
.
tÙ®
=
	`MPI_Wtime
();

55 ià(!
ThisTask
)

57 
	`´štf
("[%s] Thi i pšocchiØV4.1,„uÂšg oÀ%d MPIasks\n\n",
	`fd©e
(),
NTasks
);

58 #ifdeà
TWO_LPT


59 #iâdeà
THREE_LPT


60 
	`´štf
("This version uses 2LPT displacements\n");

62 
	`´štf
("This version uses 3LPT displacements\n");

65 
	`´štf
("This version uses Zeldovich displacements\n");

67 #ifdeà
ROTATE_BOX


68 
	`´štf
("The output will be„otatedo„eproduce N-GenIC‡nd 2LPTic orientation\n");

70 #ifdeà
WHITENOISE


71 
	`´štf
("Initial conditions will be„ead from‡ white‚oise file\n");

73 #ifdeà
SCALE_DEPENDENT_GROWTH


74 
	`´štf
("This version ofhe code works with scale-dependent growing modes.\n");

75 
	`´štf
("These will be computed from CAMBables\n");

76 #ifdeà
THREE_LPT


77 ià(!
ThisTask
)

79 
	`´štf
("********************************************************\n");

80 
	`´štf
("Scale-dependent growth…resently does‚ot work with 3LPT\n");

81 
	`´štf
("Please„ecompile withouthe THREE_LPT directive\n");

82 
	`´štf
("********************************************************\n");

86 #ifdeà
NO_RANDOM_MODULES


87 
	`´štf
("Initial conditions will be generated with‚on-random modules ofhe Fourier modes\n");

89 #ifdeà
LIST_OF_FRAGMENT_PARAMETERS


90 
	`´štf
("Fragmentation will be„epeated manyimes,„eading…arameters from†ist_of_fragment_parameters.txt\n");

91 
	`´štf
("NB: THIS OPTION IS USEFUL ONLY TO FINE-TUNE THE MASS FUNCTION\n");

93 #ifdeà
SMOOTH_VELOCITIES


94 
	`´štf
("Velocities will be computed‡the same smoothing„adius‡she collapseime.\n");

95 
	`´štf
("NB: THIS IS NOT A RECOMMENDED OPTION, USE IT IF YOU KNOW WHAT YOU ARE DOING!\n");

101 ià(
¬gc
<2)

103 ià(!
ThisTask
)

104 
	`´štf
("Usage:…inocchio.x…arameterfile\n");

105 
	`MPI_Fš®ize
();

106 
	`ex™
(1);

111 
	`mem£t
(&
·¿ms
, 0, (
·¿m_d©a
));

112 
	`¡rıy
(
·¿ms
.
P¬am‘”Fe
,
¬gv
[1]);

113 ià(
	`š™Ÿliz©iÚ
())

114 
	`abÜt_code
();

117 
	`fæush
(
¡dout
);

118 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

120 ià(
¬gc
>=3 && 
	`©oi
(
¬gv
[2]) == 0 )

122 ià(!
ThisTask
)

124 
	`´štf
("Pinocchio done!\n");

125 
	`wr™e_ıutimes
();

127 
	`MPI_Fš®ize
();

129 #ifdeà
USE_GPERFTOOLS


130 
	`Prof”Stİ
();

139 ià(
¬gc
>=3 && 
	`©oi
(
¬gv
[2])==1)

141 ià(!
ThisTask
)

143 
	`´štf
("Inhis configuration…inocchio will only writehe†inear density field\n");

144 
	`´štf
("inhe Data/ directory\n");

147 
ThisGrid
=0; ThisGrid<
Ngrids
; ThisGrid++)

149 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

150 
time
=
	`»v”£_ŒªsfÜm
(
ThisGrid
);

151 ià(!
ThisTask
)

152 
	`´štf
("[%s] compu‹_d”iv©ive: dÚfá, cpuimğ%f\n",
	`fd©e
(),
time
);

153 
	`wr™e_äom_rveùÜ
(
ThisGrid
, 
d’s™y
[ThisGrid]);

154 ià(
	`wr™e_d’s™y
(
ThisGrid
))

155 
	`abÜt_code
();

171 
ThisGrid
 = 0;

172 if(
ThisTask
 == 0) {

173 
	`´štf
("now compu‹ fœ¡ d”iv©ive %d\n", 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
); 
	`fæush
(
¡dout
); }

174 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

176 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

177 
	`dump_cveùÜ
((*)
kd’s™y
[
ThisGrid
], 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
,

178 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

179 
MyGrids
[
ThisGrid
].
GSloÿl_k
,

180 
MyGrids
[
ThisGrid
].
GS¡¬t_k
, "kdensity.check", 0);

183 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

184 if(
ThisTask
 == 0) {

185 
	`´štf
("now compu‹‡ùu® x-d”iv©ives\n"); 
	`fæush
(
¡dout
); }

186 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

187 
	`compu‹_d”iv©ive
(0, 1, 0);

188 
	`dump_cveùÜ
((*)
cveùÜ_fá
[
ThisGrid
], 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
,

189 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

190 
MyGrids
[
ThisGrid
].
GSloÿl_k
,

191 
MyGrids
[
ThisGrid
].
GS¡¬t_k
, "cderivative.1.x", 0);

192 
	`dump_rveùÜ
((*)
rveùÜ_fá
[
ThisGrid
],

193 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

194 
MyGrids
[
ThisGrid
].
GSloÿl
,

195 
MyGrids
[
ThisGrid
].
GS¡¬t
, "derivative.1.x", 0);

197 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

198 if(
ThisTask
 == 0) {

199 
	`´štf
("now compu‹‡ùu® y-d”iv©ives\n"); 
	`fæush
(
¡dout
); }

200 
	`compu‹_d”iv©ive
(0, 2, 0);

201 
	`dump_cveùÜ
((*)
cveùÜ_fá
[
ThisGrid
], 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
,

202 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

203 
MyGrids
[
ThisGrid
].
GSloÿl_k
,

204 
MyGrids
[
ThisGrid
].
GS¡¬t_k
, "cderivative.1.y", 0);

205 
	`dump_rveùÜ
((*)
rveùÜ_fá
[
ThisGrid
],

206 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

207 
MyGrids
[
ThisGrid
].
GSloÿl
,

208 
MyGrids
[
ThisGrid
].
GS¡¬t
, "derivative.1.y", 0);

211 
	`wr™e_š_cveùÜ
(
ThisGrid
, 
kd’s™y
[ThisGrid]);

212 if(
ThisTask
 == 0) {

213 
	`´štf
("now compu‹‡ùu® z-d”iv©ives\n"); 
	`fæush
(
¡dout
); }

214 
	`compu‹_d”iv©ive
(0, 3, 0);

215 
	`dump_cveùÜ
((*)
cveùÜ_fá
[
ThisGrid
], 
·¿ms
.
u£_Œª¥o£d_fá
*
š‹º®
.
sks_subdivisiÚ_dim
,

216 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

217 
MyGrids
[
ThisGrid
].
GSloÿl_k
,

218 
MyGrids
[
ThisGrid
].
GS¡¬t_k
, "cderivative.1.z", 0);

219 
	`dump_rveùÜ
((*)
rveùÜ_fá
[
ThisGrid
],

220 
MyGrids
[
ThisGrid
].
GSglob®
[
_x_
],

221 
MyGrids
[
ThisGrid
].
GSloÿl
,

222 
MyGrids
[
ThisGrid
].
GS¡¬t
, "derivative.1.z", 0);

229 ià(!
ThisTask
)

231 
	`´štf
("Pinocchio done!\n");

232 
	`wr™e_ıutimes
();

234 
	`MPI_Fš®ize
();

236 #ifdeà
USE_GPERFTOOLS


237 
	`Prof”Stİ
();

244 ià(
¬gc
>=3 && 
	`©oi
(
¬gv
[2])==2)

246 ià(!
ThisTask
)

248 
	`´štf
("Inhis configuration…inocchio will only…roduce‡ GADGET snapshot\n");

249 
	`´štf
("athe first„edshift specified byhe %s file (z=%f)\n",

250 
·¿ms
.
OuutLi¡
,
ouuts
.
z
[0]);

254 #ifdeà
THREE_LPT


255 ià(!
ThisTask
)

257 
	`´štf
("*********************************************************\n");

258 
	`´štf
("Writing of LPT snapshot…resently does‚ot work with 3LPT\n");

259 
	`´štf
("Please„ecompile withouthe THREE_LPT directive\n");

260 
	`´štf
("*********************************************************\n");

264 ià(
	`compu‹_di¥Ïûm’ts
())

265 
	`abÜt_code
();

267 ià(
	`wr™e_LPT_¢­shÙ
(
ouuts
.
z
[0]))

268 
	`abÜt_code
();

272 ià(!
ThisTask
)

273 
	`´štf
("Pinocchio done!\n");

275 ià(!
ThisTask
)

276 
	`wr™e_ıutimes
();

278 
	`MPI_Fš®ize
();

280 #ifdeà
USE_GPERFTOOLS


281 
	`Prof”Stİ
();

288 ià(
	`compu‹_fmax
())

289 
	`abÜt_code
();

291 
	`fæush
(
¡dout
);

292 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

294 #ifdeà
TEST_ONLY


295 
	`d´štf
(
VMSG
, 0, "Testƒnd…oint„eached. Au„evoir.\n");

296 if(
ThisTask
 == 0)

297 
	`wr™e_ıutimes
();

298 
	`MPI_Fš®ize
();

299 
	`ex™
(0);

303 ià(
	`äagm’t
())

304 
	`abÜt_code
();

306 
	`fæush
(
¡dout
);

307 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

310 
ıutime
.
tÙ®
 = 
	`MPI_Wtime
() - cputime.total;

311 ià(!
ThisTask
)

312 
	`wr™e_ıutimes
();

315 ià(!
ThisTask
)

316 
	`´štf
("Pinocchio done!\n");

317 
	`MPI_Fš®ize
();

319 #ifdeà
USE_GPERFTOOLS


320 
	`Prof”Stİ
();

324 
	}
}

327 
	$abÜt_code
()

329 
	`´štf
("Task %d‡bÜtšg...\n",
ThisTask
);

330 
	`MPI_AbÜt
(
MPI_COMM_WORLD
,1);

331 
	}
}

334 
	$wr™e_ıutimes
()

336 
	`´štf
("TÙ®: %14.6f\n", 
ıutime
.
tÙ®
);

337 
	`´štf
("In™Ÿliz©iÚ: %14.6à(%5.2f%%)\n", 
ıutime
.
š™
, 100.*ıutime.š™/ıutime.
tÙ®
);

338 
	`´štf
(" D’s™y iÀFS: %14.6à(%5.2f%%)\n", 
ıutime
.
d’s
, 100.*ıutime.d’s/ıutime.
tÙ®
);

339 
	`´štf
("fmax: %14.6à(%5.2f%%)\n", 
ıutime
.
fmax
, 100.*ıutime.fmax /ıutime.
tÙ®
);

340 #ifdeà
TWO_LPT


341 
	`´štf
(" LPT: %14.6à(%5.2f%%)\n", 
ıutime
.
Ít
, 100.*ıutime.Íˆ/ıutime.
tÙ®
);

343 
	`´štf
(" D”iv©ives: %14.6à(%5.2f%%)\n", 
ıutime
.
d”iv
, 100.*ıutime.d”iv /ıutime.
tÙ®
);

344 
	`´štf
(" Mem¿nsãr: %14.6à(%5.2f%%)\n", 
ıutime
.
mem_Œªsf
, 100.*ıutime.mem_Œªsà/ıutime.
tÙ®
);

345 
	`´štf
(" FFTs: %14.6à(%5.2f%%)\n", 
ıutime
.
fá
, 100.*ıutime.fá /ıutime.
tÙ®
);

346 
	`´štf
(" CŞÏp£imes: %14.6à(%5.2f%%)\n", 
ıutime
.
cŞl
, 100.*ıutime.cŞÈ/ıutime.
tÙ®
);

347 
	`´štf
(" inv.cŞÏp£: %14.6à(%5.2f%%)\n", 
ıutime
.
švcŞl
, 100.*ıutime.švcŞÈ/ıutime.
tÙ®
);

348 
	`´štf
("ƒÎsoid: %14.6à(%5.2f%%)\n", 
ıutime
.
–l
, 100.*ıutime.–È/ıutime.
tÙ®
);

349 
	`´štf
(" V–oc™›s: %14.6à(%5.2f%%)\n", 
ıutime
.
v–
, 100.*ıutime.v– /ıutime.
tÙ®
);

350 
	`´štf
("F¿gm’tiÚ: %14.6à(%5.2f%%)\n", 
ıutime
.
äag
, 100.*ıutime.äag /ıutime.
tÙ®
);

351 
	`´štf
(" Redi¡ributiÚ: %14.6à(%5.2f%%)\n", 
ıutime
.
di¡r
,100.*ıutime.di¡r/ıutime.
tÙ®
);

352 
	`´štf
(" SÜtšg: %14.6à(%5.2f%%)\n", 
ıutime
.
sÜt
, 100.*ıutime.sÜˆ/ıutime.
tÙ®
);

353 #ifdeà
PLC


354 
	`´štf
(" Group tÙ®: %14.6à(%5.2f%%)\n", 
ıutime
.
group
,100.*ıutime.group/ıutime.
tÙ®
);

355 
	`´štf
(" Group PLC: %14.6à(%5.2f%%)\n", 
ıutime
.
¶c
,100.*ıutime.¶c/ıutime.
tÙ®
);

357 
	`´štf
(" Groups: %14.6à(%5.2f%%)\n", 
ıutime
.
group
,100.*ıutime.group/ıutime.
tÙ®
);

359 
	`´štf
("TÙ® I/O: %14.6à(%5.2f%%)\n", 
ıutime
.
io
, 100.*ıutime.iØ/ıutime.
tÙ®
);

360 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/pinocchio.h

27 
	~<¡dlib.h
>

28 
	~<¡dio.h
>

29 
	~<m©h.h
>

30 
	~<mpi.h
>

31 
	~<¡ršg.h
>

32 
	~<time.h
>

33 
	~<g¦/g¦_”ºo.h
>

34 
	~<g¦/g¦_m©h.h
>

35 
	~<g¦/g¦_ºg.h
>

36 
	~<g¦/g¦_¿ndi¡.h
>

37 
	~<g¦/g¦_roÙs.h
>

38 
	~<g¦/g¦_š‹g¿tiÚ.h
>

39 
	~<g¦/g¦_odeiv.h
>

40 
	~<g¦/g¦_¥lše.h
>

41 
	~<fáw3-mpi.h
>

42 
	~<pfá.h
>

43 #ifdeà
USE_GPERFTOOLS


44 
	~<g³ráoŞs/´of”.h
>

46 
	~<immšŒš.h
>

48 
	#ALIGN
 32

	)

50 
	#NYQUIST
 1.

	)

51 
	#PI
 3.14159265358979323846

	)

52 
	#BLENGTH
 300

	)

53 
	#GBYTE
 1073741824.0

	)

54 
	#MBYTE
 1048576.0

	)

55 
	#®loc_v”bo£
 0

	)

56 
	#MAXOUTPUTS
 100

	)

57 
	#SPEEDOFLIGHT
 (()299792.458)

	)

58 
	#GRAVITY
 (()4.30200e-9è

	)

60 #ià
defšed
(
THREE_LPT
è&& !defšed(
TWO_LPT
)

61 
	#TWO_LPT


	)

64 
	#_x_
 0

	)

65 
	#_y_
 1

	)

66 
	#_z_
 2

	)

68 
	#DECOMPOSITION_LIMIT_FACTOR_2D
 1

70 

	)

71 
	#d´štf
(
LEVEL
, 
TASK
, ...èdo{ifĞ((LEVELè<ğ
š‹º®
.
v”bo£_Ëv–
è&& (
ThisTask
 =ğ(TASK))è
	`årštf
(
¡dout
, 
__VA_ARGS__
);} 1 =ğ0)

	)

72 
	#VDBG
 4

73 
	#VDIAG
 2

74 
	#VMSG
 1

75 
	#VXX
 0

76 
	#VERR
 
VXX


77 
	#VXERR
 -1

78 

	)

79 
	#SWAP_INT
Ğ
A
, 
B
 ) (Aè^ğ(B), (Bè^ğ(A), (Aè^ğ(B);

	)

81 
ThisTask
,
NTasks
;

85 
MPI_Comm
 
FFT_Comm
;

87 
	#DVEC_SIZE
 4

	)

89 
	tdvec
 
	t__©Œibu‹__
 ((
	tveùÜ_size
 (
	tDVEC_SIZE
*())));

90 
	tivec
 
	t__©Œibu‹__
 ((
	tveùÜ_size
 (
	tDVEC_SIZE
*())));

93 
dvec
 
	mV
;

94 
	mv
[
DVEC_SIZE
];

95 } 
	tdvec_u
;

99 
ivec
 
	mV
;

100 
	mv
[
DVEC_SIZE
];

101 } 
	tivec_u
;

107 
	msks_subdivisiÚ_dim
;

108 
	msks_subdivisiÚ_3D
[4];

109 
	mcÚ¡¿š_sk_decompos™iÚ
[3];

110 
	mv”bo£_Ëv–
;

111 
	mmimic_Üigš®_£edbË
;

112 
	mdump_veùÜs
;

113 
	mdump_£ed¶ªe
;

114 
	mdump_kd’s™y
;

115 
	mÏrge_¶ªe
;

117 } 
	tš‹º®_d©a
;

118 
š‹º®_d©a
 
š‹º®
;

120 
	tušt
;

121 
	tUL
;

125 
	mRmax
;

126 
	mFmax
, 
	mVmax
[3];

127 #ifdeà
TWO_LPT


128 
	mVmax_2LPT
[3];

129 #ifdeà
THREE_LPT


130 
	mVmax_3LPT_1
[3],
	mVmax_3LPT_2
[3];

133 } 
	t´oduù_d©a
 
	t__©Œibu‹__
((
	t®igÃd
 (
	tALIGN
)));

135 *
maš_memÜy
, *
wh”‘İÏû_myÿt
;

137 
´oduù_d©a
 *
´oduùs
, *
äag
;

139 *
cubes_Üd”šg
;

141 **
kd’s™y
;

142 **
d’s™y
;

143 ***
fœ¡_d”iv©ives
;

144 ***
£cÚd_d”iv©ives
;

146 **
VEL_fÜ_di¥l
;

148 #ifdeà
TWO_LPT


149 *
kveùÜ_2LPT
;

150 *
sourû_2LPT
;

151 **
VEL2_fÜ_di¥l
;

152 #ifdeà
THREE_LPT


153 *
kveùÜ_3LPT_1
,*
kveùÜ_3LPT_2
;

154 *
sourû_3LPT_1
,*
sourû_3LPT_2
;

158 
RsmoÙh
;

161 
	mNsmoÙh
;

162 *
	mRadius
, *
	mV¬Ÿnû
, *
	mTrueV¬Ÿnû
;

163 } 
	tsmoÙhšg_d©a
;

164 
smoÙhšg_d©a
 
SmoÙhšg
;

166 
Ngrids
;

169 
	mtÙ®_loÿl_size
, 
	mtÙ®_loÿl_size_fá
;

170 
	moff
;

171 
±rdiff_t
 
	mGSglob®
[3];

172 
±rdiff_t
 
	mGSloÿl
[3];

173 
±rdiff_t
 
	mGS¡¬t
[3];

174 
±rdiff_t
 
	mGSloÿl_k
[3];

175 
±rdiff_t
 
	mGS¡¬t_k
[3];

176 
	mlow”_k_cutoff
, 
	muµ”_k_cutoff
, 
	mnÜm
, 
	mBoxSize
, 
	mC–lSize
;

177 
pfá_¶ª
 
	mfÜw¬d_¶ª
, 
	m»v”£_¶ª
;

178 } 
	tgrid_d©a
;

179 
grid_d©a
 *
MyGrids
;

181 
pfá_com¶ex
 **
cveùÜ_fá
;

182 **
rveùÜ_fá
;

184 #ifdeà
SCALE_DEPENDENT_GROWTH


187 
	mReã»nûRedshiá
;

188 
	mReã»nûOuut
,
	mNkbšs
, 
	mNCAMB
, 
	mReã»nûSÿË
;

189 
	mM©‹rFe
[
BLENGTH
], 
	mT¿nsãrFe
[BLENGTH], 
	mRunName
[BLENGTH], 
	mRedshiásFe
[BLENGTH];

190 *
	mLogk
, *
	mLogPk»f
, 
	mD2»f
, *
	mSÿËf
, *
	mRefGM
;

191 } 
	tÿmb_d©a
;

196 
	mOmega0
, 
	mOmegaLambda
, 
	mHubbË100
, 
	mSigma8
, 
	mOmegaB¬yÚ
, 
	mDEw0
, 
	mDEwa
,

197 
	mPrimÜdŸlIndex
, 
	mIÁ”P¬tDi¡
, 
	mBoxSize
, 
	mBoxSize_hŒue
, 
	mBoxSize_h100
, 
	mP¬tişeMass
,

198 
	mS¹šgzFÜPLC
, 
	mLa¡zFÜPLC
, 
	mIÅutS³ùrum_Un™L’gth_š_cm
, 
	mWDM_P¬tMass_š_kev
,

199 
	mBound¬yLay”FaùÜ
, 
	mL¬ge¡
, 
	mMaxMemP”P¬tişe
, 
	mPLCA³¹u»
,

200 
	mPLCC’‹r
[3], 
	mPLCAxis
[3];

201 
	mRunFÏg
[
BLENGTH
-50],
	mD©aDœ
[BLENGTH],
	mTabuÏ‹dEoSfe
[BLENGTH],
	mP¬am‘”Fe
[BLENGTH],

202 
	mOuutLi¡
[
BLENGTH
],
	mFeW™hIÅutS³ùrum
[BLENGTH];

203 
	mGridSize
[3],
	mWr™eRmax
, 
	mWr™eFmax
, 
	mWr™eVmax
,

204 
	mC©®ogInAscii
, 
	mDoNÙWr™eC©®ogs
, 
	mDoNÙWr™eHi¡Ü›s
, 
	mWr™eSÇpshÙ
,

205 
	mOuutInH100
, 
	mRªdomS“d
, 
	mMaxMem
, 
	mNumFes
, 
	mMšMassFÜC©
,

206 
	mBoxInH100
, 
	msim¶eLambda
, 
	mAÇlyticMassFunùiÚ
, 
	mMšH®oMass
, 
	mPLCProvideCÚeD©a
,

207 
	mu£_Œª¥o£d_fá
, 
	mu£_š¶aû_fá
;

208 #ifdeà
SCALE_DEPENDENT_GROWTH


209 
ÿmb_d©a
 
	mÿmb
;

211 } 
	t·¿m_d©a
;

212 
·¿m_d©a
 
·¿ms
;

216 
	mn
;

217 
	mF
[
MAXOUTPUTS
],
	mz
[MAXOUTPUTS],
	mzÏ¡
,
	mFÏ¡
;

218 } 
	touut_d©a
;

219 
ouut_d©a
 
ouuts
;

224 
	m§ã
, 
	mN·¹
;

225 
	mnbox_x
, 
	mnbox_y
, 
	mnbox_z_this¦iû
, 
	mnbox_z_®l¦iûs
;

226 
	mmybox_x
, 
	mmybox_y
, 
	mmybox_z
;

227 
	mLgrid_x
, 
	mLgrid_y
, 
	mLgrid_z
;

228 
	mLgwbl_x
, 
	mLgwbl_y
, 
	mLgwbl_z
;

229 
	m¡¬t_x
, 
	m¡¬t_y
, 
	m¡¬t_z
;

230 
	m¡abl_x
, 
	m¡abl_y
, 
	m¡abl_z
;

231 
	m§ã_x
, 
	m§ã_y
, 
	m§ã_z
;

232 
	mpbc_x
, 
	mpbc_y
, 
	mpbc_z
;

233 
	mSaãtyBÜd”
,
	mov”h—d
;

234 } 
	tsubbox_d©a
;

235 
subbox_d©a
 
subbox
;

239 
	mš™
,
	mtÙ®
, 
	md’s
, 
	mfá
, 
	mcŞl
, 
	mšvcŞl
, 
	m–l
, 
	mv–
, 
	mÍt
, 
	mfmax
, 
	mdi¡r
, 
	msÜt
, 
	mgroup
, 
	mäag
, 
	mio
,

240 
	md”iv
, 
	mmem_Œªsf
, 
	m·¹Ÿl
, 
	m£t_subboxes
, 
	m£t_¶c
, 
	mmemÜy_®loÿtiÚ
, 
	mfá_š™Ÿliz©iÚ


241 #ifdeà
PLC


242 ,
	m¶c


245 } 
	tıutime_d©a
;

246 
ıutime_d©a
 
ıutime
;

248 
WšdowFunùiÚTy³
;

252 
	mMass
;

253 
	mPos
[3],
	mV–
[3];

254 #ifdeà
TWO_LPT


255 
	mV–_2LPT
[3];

256 #ifdeà
THREE_LPT


257 
	mV–_3LPT_1
[3], 
	mV–_3LPT_2
[3];

260 
	mÎ
, 
	mh®o_­p
, 
	mmass_©_m”g”
, 
	mm”ged_w™h
, 
	mpošt
, 
	mbÙtom
, 
	mgood
;

261 
	mt_­³¬
, 
	mt_³ak
, 
	mt_m”ge
;

262 
	mÇme
;

263 
	mŒackT
,
	mŒackC
;

264 #ifdeà
PLC


265 
	mFÏ¡
;

267 } 
	tgroup_d©a
;

268 
group_d©a
 *
groups
;

270 #ifdeà
PLC


273 
	mi
,
	mj
,
	mk
;

274 
	mF1
,
	mF2
;

275 } 
	t»¶iÿtiÚ_d©a
;

279 
	mN»¶iÿtiÚs
, 
	mNmax
, 
	mN¡Üed
, 
	mNh®ÙÙ
;

280 
	mF¡¬t
,
	mF¡İ
,
	mûÁ”
[3];

281 
	mxv”s
[3],
	myv”s
[3],
	mzv”s
[3];

282 
»¶iÿtiÚ_d©a
 *
	m»¶s
;

283 } 
	t¶c_d©a
;

284 
¶c_d©a
 
¶c
;

288 
	mMass
;

289 
	mÇme
;

290 
	mz
,
	mx
[3],
	mv
[3],
	mrhÜ
,
	mth‘a
,
	mphi
;

291 } 
	t¶cgroup_d©a
;

292 
¶cgroup_d©a
 *
¶cgroups
;

295 
d©e_¡ršg
[25];

297 *
šdiûs
,*
group_ID
,*
lškšg_li¡
;

298 
NSliûs
,
ThisSliû
;

301 
f_m
, 
f_rm
, 
e¥o
, 
f_a
, 
f_¿
, 
f_200
, 
sigmaD0
;

303 #ifdeà
SCALE_DEPENDENT_GROWTH


306 
	mæag
, 
	mismoÙh
;

307 
	m¿dius
;

308 } 
	tSDGM_d©a
;

309 
SDGM_d©a
 
SDGM
;

312 
	#NWINT
 1000

	)

313 
g¦_š‹g¿tiÚ_wÜk¥aû
 *
wÜk¥aû
;

314 
g¦_ºg
 *
¿ndom_g’”©Ü
;

318 
	mÇme
;

319 
	mnick
, 
	mÎ
, 
	mmw
, 
	mmass
, 
	mmam
;

320 
	mzme
, 
	mz³
, 
	mz­
;

321 } 
	thi¡Ü›s_d©a
;

323 
	#DELTAM
 0.05

	)

327 
	mNBIN
;

328 
	mmmš
,
	mmmax
,
	mvŞ
,
	mhçùÜ
,
	mhçùÜ4
;

329 *
	mnšbš
,*
	mnšbš_loÿl
;

330 *
	mmassšbš
,*
	mmassšbš_loÿl
;

331 } 
	tmf_d©a
;

332 
mf_d©a
 
mf
;

335 
çùÜ
(, );

338 
compu‹_cŞÏp£_times
();

339 
compu‹_v–oc™›s
();

342 
£t_Úe_grid
();

343 
š™Ÿlize_fá
();

344 
fÜw¬d_ŒªsfÜm
();

345 
»v”£_ŒªsfÜm
();

346 
fš®ize_fá
();

347 
compu‹_d”iv©ive
(, , );

348 
wr™e_š_cveùÜ
(, *);

349 
wr™e_äom_cveùÜ
(, *);

350 
wr™e_š_rveùÜ
(, *);

351 
wr™e_äom_rveùÜ
(, *);

353 
dump_cveùÜ
(*, , , 
±rdiff_t
 *,…trdiff_t *, *, );

354 
dump_rveùÜ
(*, , 
±rdiff_t
 *,…trdiff_t *, *, );

357 
®loÿ‹_maš_memÜy
();

358 
d—Îoÿ‹_fá_veùÜs
();

359 
»®loÿ‹_memÜy_fÜ_äagm’tiÚ_1
();

360 
»®loÿ‹_memÜy_fÜ_äagm’tiÚ_2
();

364 
G’IC
();

365 
G’IC_Ïrge
();

368 
š™Ÿliz©iÚ
();

369 
fšd_¡¬t
(, , );

370 
fšd_Ëngth
(, , );

371 
£t_·¿m‘”s
();

372 
£t_grids
();

375 
wr™e_f›lds
();

376 
wr™e_d’s™y
();

379 
wr™e_¢­shÙ
();

380 
wr™e_LPT_¢­shÙ
();

383 
š™Ÿlize_cosmŞogy
();

384 
š™Ÿlize_MassV¬Ÿnû
();

385 
Omega
();

386 
HubbË
();

387 
HubbË_Gyr
();

388 
fomega
();

389 
fomega_2LPT
();

390 
fomega_3LPT_2
();

391 
fomega_3LPT_1
();

392 
CosmicTime
();

393 
Inv”£CosmicTime
();

394 
GrowšgMode
();

395 
GrowšgMode_2LPT
();

396 
GrowšgMode_3LPT_1
();

397 
GrowšgMode_3LPT_2
();

398 
Inv”£GrowšgMode
();

399 
Prİ”Di¡ªû
();

400 
Inv”£Prİ”Di¡ªû
();

401 
dPrİ”Di¡ªû_dz
();

402 
Pow”S³ùrum
();

403 
MassV¬Ÿnû
();

404 
dMassV¬Ÿnû_dr
();

405 
Di¥lV¬Ÿnû
();

406 
Radius
();

407 
SizeFÜMass
();

408 
MassFÜSize
();

409 
TypiÿlCŞÏpsšgMass
();

410 
dOmega_dV¬Ÿnû
(, );

411 
AÇlyticMassFunùiÚ
(, );

412 
WšdowFunùiÚ
();

413 
my_¥lše_ev®
(
g¦_¥lše
 *, , 
g¦_š‹½_acûl
 *);

416 
»ad_·¿m‘”_fe
();

419 
compu‹_fmax
();

420 
compu‹_di¥Ïûm’ts
();

421 *
fd©e
();

423 #ifdeà
TWO_LPT


425 
compu‹_LPT_di¥Ïûm’ts
();

429 
di¡ribu‹
();

432 
äagm’t
();

435 
bud_groups
();

437 #ifdeà
SCALE_DEPENDENT_GROWTH


438 
»ad_pow”_bË_äom_CAMB
();

439 
š™Ÿlize_SÿËD•’d’tGrowth
();

440 
M©‹rGrowšgMode
();

441 
V–GrowšgMode
();

442 
Inv”£M©‹rGrowšgMode
();

443 
V–fOmega
();

444 
V–fOmega2
();

447 #ifdeà
WHITENOISE


448 
»ad_wh™e_noi£
();

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/read_pinocchio_binary.c

39 
	~<¡dlib.h
>

40 
	~<¡dio.h
>

41 
	~<¡ršg.h
>

44 
	$maš
(
¬gc
, **
¬gv
)

48 
id
;

49 
M
;

50 
q
[3], 
x
[3], 
v
[3];

51 
N
, 
·d
;

52 } 
	tÿt
;

53 
ÿt
 
ÿtd©a
;

57 
id
;

58 
z
;

59 
x
[3], 
v
[3];

60 
M
, 
th
, 
ph
, 
vl
, 
zo
;

61 } 
	t¶c
;

62 
¶c
 
¶cd©a
;

66 
Çme
;

67 
nick
, 
Î
, 
mw
, 
mass
, 
mam
;

68 
zme
, 
z³
, 
z­
;

69 } 
	thi¡
;

70 
hi¡
 
hi¡d©a
;

73 
id
,
n
,
Á»es_tÙ
,
nb¿nch_tÙ
;

74 
Åroc
,
roc
,
ngood
,
igood
,
i
,
dummy
,
nšh—d
,
NSliûs
,
ThisSliû
,
Á»es
,
nb¿nch
,

75 
nb¿nch_Œ“
,
™»e
,
ib¿nch
,
thi¡»e
,
u
,
nblocks
,
´št
=0,
Fœ¡
=1;

76 
ruÂame
[100],
f’ame
[100],
»dshiá
[100];

77 
FILE
 *
fd
;

78 
FILE
 *
fout
;

79 
ouutf
[100];

82 
	`´štf
("This is‡nƒxample codeo„ead…inocchio catalogs in binary format\n");

83 
	`´štf
("Pinocchio generates catalogs‡t fixed„edshift in files\n");

84 
	`´štf
("like…inocchio.0.0000.SecondEuclidMocks0001.catalog.out,\n");

85 
	`´štf
("where SecondEuclidMocks0001 ishe„un‚ame\n");

86 
	`´štf
("and files†ike…inocchio.SecondEuclidMocks0001.plc.out\n");

87 
	`´štf
("forhe catalog onhe…ast-light-cone\n");

88 
	`´štf
("or…inocchio.SecondEuclidMocks0001.histories.out\n");

89 
	`´štf
("forhe halo mergerrees\n");

90 
	`´štf
("\n");

91 
	`´štf
("Usage:„ead_pinocchio_binary„unname„edshift [ascii]\n");

92 
	`´štf
("„unname ishe‚ame ofhe„un for‡llhe files\n");

93 
	`´štf
("„edshift must beƒqualohe„edshift given inhe file‚ame\n");

94 
	`´štf
("o„eadhe…ast-light-coneƒnterhe string 'plc' in…lace of„edshift\n");

95 
	`´štf
("o„eadhe histories fileƒnter string 'hist' in…lace of„edshift\n");

96 
	`´štf
("\n");

97 
	`´štf
("To…rint‡n‡scii version ofhe file,‡ddhe string‡scii‡s‡ further‡rgument\n");

98 
	`´štf
("but BEWARE,he‚umber of halos inhe catalog can be†arge‡nd‡scii is‚ot\n");

99 
	`´štf
("a„ecommended formato store catalogs\n\n");

101 ià(
¬gc
<3)

104 
	`¡rıy
(
ruÂame
,
¬gv
[1]);

105 
	`¡rıy
(
»dshiá
,
¬gv
[2]);

106 ià(
¬gc
>=4 && !
	`¡rcmp
(
¬gv
[3],"ascii"))

107 
´št
=1;

109 ià(!
	`¡rcmp
(
»dshiá
,"plc"))

112 
	`¥rštf
(
f’ame
,"pšocchio.%s.¶c.out",
ruÂame
);

113 
	`´štf
("O³nšg f%s\n",
f’ame
);

114 
	`´štf
("I will write outhe firsten halos\n");

116 
fd
=
	`fİ’
(
f’ame
,"r");

117 ià(
fd
==0x0)

119 
	`´štf
("E¼Ü:…løf% nÙ found\n",
f’ame
);

123 ià(
´št
)

125 
	`¥rštf
(
ouutf
,"pšocchio.%s.¶c.out.ascii",
ruÂame
);

126 
	`´štf
("I wÈwr™thasci˜ÿlog iÀthf%s\n",
ouutf
);

127 
fout
=
	`fİ’
(
ouutf
,"w");

128 
	`årštf
(
fout
,"# Group catalog onhe Past Light Cone\n");

129 
	`årštf
(
fout
,"# 1) group ID\n");

130 
	`årštf
(
fout
,"# 2)rue„edshift\n");

131 
	`årštf
(
fout
,"# 3-5) comoving…osition\n");

132 
	`årštf
(
fout
,"# 6-8) velocity\n");

133 
	`årštf
(
fout
,"# 9) group mass\n");

134 
	`årštf
(
fout
,"# 10)heta\n");

135 
	`årštf
(
fout
,"# 11)…hi\n");

136 
	`årštf
(
fout
,"# 12)…eculiar velocity‡longhe†ine-of-sight\n");

137 
	`årštf
(
fout
,"# 13) observed„edshift\n");

138 
	`årštf
(
fout
,"#\n");

141 
n
=0;

144 ià(!
	`ä—d
(&
dummy
,(),1,
fd
))

146 
u
=
	`ä—d
(&
¶cd©a
,
dummy
,1,
fd
);

147 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

149 ià(
n
<10)

150 
	`´štf
(" %12Ld %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %15.8e %16.6f %16.6f %16.6f %16.6f\n",

151 
¶cd©a
.
id
,¶cd©a.
z
,

152 
¶cd©a
.
x
[0],…lcdata.x[1],…lcdata.x[2],

153 
¶cd©a
.
v
[0],…lcdata.v[1],…lcdata.v[2],

154 
¶cd©a
.
M
,…lcd©a.
th
,…lcd©a.
ph
,…lcd©a.
vl
,…lcd©a.
zo
);

155 
n
++;

157 ià(
´št
)

158 
	`årštf
(
fout
," %12Lu %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %15.8e %16.6f %16.6f %16.6f %16.6f\n",

159 
¶cd©a
.
id
,

160 
¶cd©a
.
z
,

161 
¶cd©a
.
x
[0],plcdata.x[1],plcdata.x[2],

162 
¶cd©a
.
v
[0],plcdata.v[1],plcdata.v[2],

163 
¶cd©a
.
M
,

164 
¶cd©a
.
th
,

165 
¶cd©a
.
ph
,

166 
¶cd©a
.
vl
,

167 
¶cd©a
.
zo
);

170 
	`fşo£
(
fd
);

171 ià(
´št
)

172 
	`fşo£
(
fout
);

175 
	`´štf
("I found %Ld h®o šhfe\n",
n
);

176 
	`´štf
("This ishe†ast halo inhe catalog:\n");

177 
	`´štf
(" %12Ld %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %15.8e %16.6f %16.6f %16.6f %16.6f\n",

178 
¶cd©a
.
id
,¶cd©a.
z
,

179 
¶cd©a
.
x
[0],…lcdata.x[1],…lcdata.x[2],

180 
¶cd©a
.
v
[0],…lcdata.v[1],…lcdata.v[2],

181 
¶cd©a
.
M
,…lcd©a.
th
,…lcd©a.
ph
,…lcd©a.
vl
,…lcd©a.
zo
);

183 ià(!
	`¡rcmp
(
»dshiá
,"hist"))

186 
	`¥rštf
(
f’ame
,"pšocchio.%s.hi¡Ü›s.out",
ruÂame
);

187 
	`´štf
("O³nšg f%s\n",
f’ame
);

188 
	`´štf
("I will write outhe firstree\n");

190 
fd
=
	`fİ’
(
f’ame
,"r");

191 ià(
fd
==0x0)

193 
	`´štf
("E¼Ü: hi¡Üy f% nÙ found\n",
f’ame
);

197 ià(
´št
)

199 
	`¥rštf
(
ouutf
,"pšocchio.%s.hi¡Ü›s.out.ascii",
ruÂame
);

200 
	`´štf
("I wÈwr™thasci˜ÿlog iÀthf%s\n",
ouutf
);

201 
fout
=
	`fİ’
(
ouutf
,"w");

203 
	`årštf
(
fout
,"# Merger histories\n");

204 
	`årštf
(
fout
,"# 1) group ID\n");

205 
	`årštf
(
fout
,"# 2) index withinheree\n");

206 
	`årštf
(
fout
,"# 3)†inking†ist\n");

207 
	`årštf
(
fout
,"# 4) merged with\n");

208 
	`årštf
(
fout
,"# 5) mass of halo‡t merger (particles)\n");

209 
	`årštf
(
fout
,"# 6) mass of main halo it merges with,‡t merger (particles)\n");

210 
	`årštf
(
fout
,"# 7) merger„edshift\n");

211 
	`årštf
(
fout
,"# 8)„edshift of…eak collapse\n");

212 
	`årštf
(
fout
,"# 9)„edshift‡t whichhe halo overtakeshe minimal mass\n");

213 
	`årštf
(
fout
,"#\n");

216 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

217 
u
=
	`ä—d
(&
NSliûs
,(),1,
fd
);

218 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

220 ià(
´št
)

222 
	`årštf
(
fout
,"# Nslices: \n");

223 
	`årštf
(
fout
," %d\n",
NSliûs
);

226 
	`´štf
("ThruÀu£d %d sliûs\n",
NSliûs
);

228 
Á»es_tÙ
=
nb¿nch_tÙ
=0;

229 
ThisSliû
=0; ThisSliû<
NSliûs
; ThisSlice++)

231 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

232 
u
=
	`ä—d
(&
Á»es
,(),1,
fd
);

233 
u
=
	`ä—d
(&
nb¿nch
,(),1,
fd
);

234 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

235 
Á»es_tÙ
+=
Á»es
;

236 
nb¿nch_tÙ
+=
nb¿nch
;

238 ià(
´št
)

240 
	`årštf
(
fout
,"# Ntrees & Nbranches: \n");

241 
	`årštf
(
fout
," %d %d\n",
Á»es
, 
nb¿nch
);

245 
™»e
=0; iŒ“<
Á»es
; itree++)

248 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

249 
u
=
	`ä—d
(&
thi¡»e
,(),1,
fd
);

250 
u
=
	`ä—d
(&
nb¿nch_Œ“
,(),1,
fd
);

251 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

253 ià(
´št
)

254 
	`årštf
(
fout
,"#T»%d, Nb¿nches=%d\n", 
thi¡»e
, 
nb¿nch_Œ“
);

256 
ib¿nch
=0; ib¿nch<
nb¿nch_Œ“
; ibranch++)

258 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

259 
u
=
	`ä—d
(&
hi¡d©a
,(
hi¡
),1,
fd
);

260 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

262 ià(
Fœ¡
)

263 
	`´štf
(" %12Ld %6d %6d %6d %9d %9d %9.4f %9.4f %9.4f\n",

264 
hi¡d©a
.
Çme
,

265 
hi¡d©a
.
nick
,

266 
hi¡d©a
.
Î
,

267 
hi¡d©a
.
mw
,

268 
hi¡d©a
.
mass
,

269 
hi¡d©a
.
mam
,

270 
hi¡d©a
.
zme
,

271 
hi¡d©a
.
z³
,

272 
hi¡d©a
.
z­
);

274 ià(
´št
)

275 
	`årštf
(
fout
," %12Ld %6d %6d %6d %9d %9d %9.4f %9.4f %9.4f\n",

276 
hi¡d©a
.
Çme
,

277 
hi¡d©a
.
nick
,

278 
hi¡d©a
.
Î
,

279 
hi¡d©a
.
mw
,

280 
hi¡d©a
.
mass
,

281 
hi¡d©a
.
mam
,

282 
hi¡d©a
.
zme
,

283 
hi¡d©a
.
z³
,

284 
hi¡d©a
.
z­
);

288 
Fœ¡
=0;

292 
	`´štf
("I found %Ld»e ªd %Ld b¿nche šhfe\n",
Á»es_tÙ
,
nb¿nch_tÙ
);

293 
	`´štf
("This ishe†ast branch inhe catalog:\n");

294 
	`´štf
(" %12Ld %6d %6d %6d %9d %9d %9.4f %9.4f %9.4f\n",

295 
hi¡d©a
.
Çme
,

296 
hi¡d©a
.
nick
,

297 
hi¡d©a
.
Î
,

298 
hi¡d©a
.
mw
,

299 
hi¡d©a
.
mass
,

300 
hi¡d©a
.
mam
,

301 
hi¡d©a
.
zme
,

302 
hi¡d©a
.
z³
,

303 
hi¡d©a
.
z­
);

305 ià(
´št
)

306 
	`fşo£
(
fout
);

312 
	`¥rštf
(
f’ame
,"pšocchio.%s.%s.ÿlog.out",
»dshiá
,
ruÂame
);

313 
	`´štf
("O³nšg f%s\n",
f’ame
);

314 
	`´štf
("I will write outhe firsten halos\n");

316 
fd
=
	`fİ’
(
f’ame
,"r");

317 ià(
fd
==0x0)

319 
	`´štf
("E¼Ü: c©®og f% nÙ found\n",
f’ame
);

323 ià(
´št
)

325 
	`¥rštf
(
ouutf
,"pšocchio.%s.%s.ÿlog.out.ascii",
»dshiá
,
ruÂame
);

326 
	`´štf
("I wÈwr™thasci˜ÿlog iÀthf%s\n",
ouutf
);

327 
fout
=
	`fİ’
(
ouutf
,"w");

330 
n
=0;

331 
u
=
	`ä—d
(&
nšh—d
,(),1,
fd
);

332 
nšh—d
/=();

333 
u
=
	`ä—d
(&
Åroc
,(),1,
fd
);

334 ià(
nšh—d
==2)

335 
u
=
	`ä—d
(&
NSliûs
,(),1,
fd
);

336 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

337 
	`´štf
("Thfha b“Àwr™‹Àby %dasks\n",
Åroc
);

338 ià(
nšh—d
==2)

339 
	`´štf
("Thbox ha b“Àäagm’‹d iÀ%d sliûs\n",
NSliûs
);

341 
	`´štf
("This old version catalog does‚ot givehe‚umber of slices used\n");

343 ià(
´št
)

345 
	`årštf
(
fout
,"# Grou°ÿlog fÜ„edshiá %s\n",
»dshiá
);

346 
	`årštf
(
fout
,"# 1) group ID\n");

347 
	`årštf
(
fout
,"# 2) group mass\n");

348 
	`årštf
(
fout
,"# 3- 5) initial…osition\n");

349 
	`årštf
(
fout
,"# 6- 8) final…osition\n");

350 
	`årštf
(
fout
,"# 9-11) velocity\n");

351 
	`årštf
(
fout
,"# 12)‚umber of…articles\n");

352 
	`årštf
(
fout
,"#\n");

355 
nblocks
=0;

356 !
	`ãof
(
fd
))

358 ià(!
	`ä—d
(&
dummy
,(),1,
fd
))

360 ++
nblocks
;

361 
u
=
	`ä—d
(&
ngood
,(),1,
fd
);

362 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

363 
n
+=
ngood
;

364 
	`´štf
(" found %d h®o š block N. %d\n",
ngood
,
nblocks
);

365 
igood
=0; igood<
ngood
; igood++)

367 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

368 
u
=
	`ä—d
(&
ÿtd©a
,
dummy
,1,
fd
);

369 
u
=
	`ä—d
(&
dummy
,(),1,
fd
);

371 ià(
nblocks
==1 && 
igood
<10)

372 
	`´štf
(" %12Ld %13.6e %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %12d\n",

373 
ÿtd©a
.
id
, c©d©a.
M
,

374 
ÿtd©a
.
q
[0], catdata.q[1], catdata.q[2],

375 
ÿtd©a
.
x
[0], catdata.x[1], catdata.x[2],

376 
ÿtd©a
.
v
[0], catdata.v[1], catdata.v[2],

377 
ÿtd©a
.
N
);

379 ià(
´št
)

380 
	`årštf
(
fout
," %12Lu %13.6e %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %12d\n",

381 
ÿtd©a
.
id
,

382 
ÿtd©a
.
M
,

383 
ÿtd©a
.
q
[0],catdata.q[1],catdata.q[2],

384 
ÿtd©a
.
x
[0],catdata.x[1],catdata.x[2],

385 
ÿtd©a
.
v
[0],catdata.v[1],catdata.v[2],

386 
ÿtd©a
.
N
);

389 
	`fşo£
(
fd
);

390 ià(
´št
)

391 
	`fşo£
(
fout
);

393 
	`´štf
("I found %Ld h®o šhfe\n",
n
);

394 
	`´štf
("This ishe†ast halo inhe catalog:\n");

395 
	`´štf
(" %12Ld %13.6e %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %12d\n",

396 
ÿtd©a
.
id
, c©d©a.
M
,

397 
ÿtd©a
.
q
[0], catdata.q[1], catdata.q[2],

398 
ÿtd©a
.
x
[0], catdata.x[1], catdata.x[2],

399 
ÿtd©a
.
v
[0], catdata.v[1], catdata.v[2],

400 
ÿtd©a
.
N
);

402 ià(
nšh—d
==1)

404 
	`´štf
("‚´oc=%d,‚blocks=%d,„ecÚ¡ruùed‚¦iûs=%d\n",
Åroc
,
nblocks
,nblocks/nproc);

405 ià(
nblocks
%
Åroc
)

406 
	`´štf
("WARNING:he‚umbers of blocks‡ndasks‡re‚ot consistent!\n");

411 
	`´štf
("‚´oc=%d,‚blocks=%d,„—d‚¦iûs=%d\n",
Åroc
,
nblocks
,
NSliûs
);

412 ià(
nblocks
 !ğ
Åroc
*
NSliûs
)

413 
	`´štf
("WARNING:he‚umber of blocks is‚ot‡sƒxpected:‚proc *‚slices = %d\n",

414 
Åroc
*
NSliûs
);

420 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/variables.c

27 
	~"pšocchio.h
"

29 
	gThisTask
,
	gNTasks
;

32 
MPI_Comm
 
	gFFT_Comm
;

33 
š‹º®_d©a
 
	gš‹º®
;

36 *
	gmaš_memÜy
, *
	gwh”‘İÏû_myÿt
;

37 
´oduù_d©a
 *
	g´oduùs
, *
	gäag
;

39 *
	gcubes_Üd”šg
;

40 **
	gkd’s™y
;

41 **
	gd’s™y
;

42 ***
	gfœ¡_d”iv©ives
;

43 ***
	g£cÚd_d”iv©ives
;

44 **
	gVEL_fÜ_di¥l
;

46 #ifdeà
TWO_LPT


47 *
	gkveùÜ_2LPT
;

48 *
	gsourû_2LPT
;

49 **
	gVEL2_fÜ_di¥l
;

50 #ifdeà
THREE_LPT


51 *
	gkveùÜ_3LPT_1
,*
	gkveùÜ_3LPT_2
;

52 *
	gsourû_3LPT_1
,*
	gsourû_3LPT_2
;

56 
	gRsmoÙh
;

57 
smoÙhšg_d©a
 
	gSmoÙhšg
;

59 
grid_d©a
 *
	gMyGrids
;

60 
	gNgrids
;

62 
pfá_com¶ex
 **
	gcveùÜ_fá
;

63 **
	grveùÜ_fá
;

65 
·¿m_d©a
 
	g·¿ms
 = {0};

66 
ouut_d©a
 
	gouuts
;

67 
subbox_d©a
 
	gsubbox
;

68 #ifdeà
PLC


69 
¶c_d©a
 
	g¶c
;

70 
¶cgroup_d©a
 *
	g¶cgroups
;

73 
ıutime_d©a
 
	gıutime
 = {0.0};

75 
	gWšdowFunùiÚTy³
;

77 
group_d©a
 *
	ggroups
;

79 
	gd©e_¡ršg
[25];

81 *
	gšdiûs
,*
	ggroup_ID
,*
	glškšg_li¡
;

82 
	gf_m
, 
	gf_rm
, 
	ge¥o
, 
	gf_a
, 
	gf_¿
, 
	gf_200
, 
	gsigmaD0
;

83 
	gNSliûs
,
	gThisSliû
;

85 #ifdeà
SCALE_DEPENDENT_GROWTH


86 
SDGM_d©a
 
	gSDGM
;

89 
g¦_š‹g¿tiÚ_wÜk¥aû
 * 
	gwÜk¥aû
;

90 
g¦_ºg
 *
	g¿ndom_g’”©Ü
;

92 
mf_d©a
 
	gmf
;

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_fields.c

27 
	~"pšocchio.h
"

28 
	~<sys/ty³s.h
>

29 
	~<sys/¡©.h
>

31 
	#FORTRAN


	)

34 
	#GRID
 
MyGrids
[
ThisGrid
]

	)

36 
check_D©aDœ
();

37 
wr™e_´oduù
(, );

38 
wr™e_fmax
();

39 
	gMyGrid
;

41 
	$wr™e_f›lds
()

44 
MyGrid
=0;

46 ià(
·¿ms
.
Wr™eFmax
)

47 
	`wr™e_fmax
(0);

51 ià(
·¿ms
.
Wr™eRmax
)

52 ià(
	`wr™e_´oduù
(4, 
MyGrid
))

55 ià(
·¿ms
.
Wr™eVmax
)

57 ià(
	`wr™e_´oduù
(1, 
MyGrid
))

59 ià(
	`wr™e_´oduù
(2, 
MyGrid
))

61 ià(
	`wr™e_´oduù
(3, 
MyGrid
))

63 #ifdeà
TWO_LPT


64 ià(
	`wr™e_´oduù
(5, 
MyGrid
))

66 ià(
	`wr™e_´oduù
(6, 
MyGrid
))

68 ià(
	`wr™e_´oduù
(7, 
MyGrid
))

70 #ifdeà
THREE_LPT


71 ià(
	`wr™e_´oduù
(8, 
MyGrid
))

73 ià(
	`wr™e_´oduù
(9, 
MyGrid
))

75 ià(
	`wr™e_´oduù
(10, 
MyGrid
))

77 ià(
	`wr™e_´oduù
(11, 
MyGrid
))

79 ià(
	`wr™e_´oduù
(12, 
MyGrid
))

81 ià(
	`wr™e_´oduù
(13, 
MyGrid
))

88 
	}
}

90 
	$wr™e_d’s™y
(
ThisGrid
)

97 
T
, 
i
, 
j
, 
k
;

98 
šdex
, 
šdex_i
, 
šdex_j
;

99 
lšdex
, 
lšdex_i
, 
lšdex_j
;

100 
f’ame
[200];

101 
FILE
 *
fe
;

104 
	`¥rštf
(
f’ame
, "·¹Ÿl_d’s™y.%4d", 
ThisTask
);

106 
T
 = 0; T < 
NTasks
; T++)

108 if(
ThisTask
 =ğ
T
)

110 
fe
 = 
	`fİ’
(
f’ame
, "w");

112 
i
 = 0; i < 
GRID
.
GSloÿl
[
_x_
]; i++)

114 
lšdex_i
 = 
i
 * 
GRID
.
GSloÿl
[
_y_
];

115 
šdex_i
 = (
i
 + 
GRID
.
GS¡¬t
[
_x_
]è* GRID.
GSglob®
[
_y_
];

117 
j
 = 0; j < 
GRID
.
GSloÿl
[
_y_
]; j++)

119 
lšdex_j
 = (
lšdex_i
 + 
j
è* 
GRID
.
GSloÿl
[
_z_
];

120 
šdex_j
 = (
šdex_i
 + 
j
 + 
GRID
.
GS¡¬t
[
_y_
]è* GRID.
GSglob®
[
_z_
];

122 
k
 = 0; k < 
GRID
.
GSloÿl
[
_z_
]; k++)

124 
lšdex
 = 
lšdex_j
 + 
k
;

125 
šdex
 = 
šdex_j
 + (
k
 + 
GRID
.
GS¡¬t
[
_z_
]);

127 
	`årštf
(
fe
, "%u %g\n", 
šdex
, 
d’s™y
[
ThisGrid
][
lšdex
]);

132 
	`fşo£
(
fe
);

135 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

138 if(
ThisTask
 == 0)

140 
”r
;

141 
”r
 = 
	`sy¡em
("cat…artial_density* | sort -k1 -n > my.density");

142 
”r
 = 
	`sy¡em
("rm -f…artial_*");

143 if(
”r
 != 0)

144 
	`d´štf
(
VXX
, 0, "something got wrong while writing density files\n");

148 
	}
}

151 
	$wr™e_fmax
(
ThisGrid
)

158 
T
, 
i
, 
j
, 
k
;

159 
šdex
, 
šdex_i
, 
šdex_j
, 
šdex_»v”£
;

160 
lšdex
, 
lšdex_i
, 
lšdex_j
;

161 
f’ame
[200];

162 
FILE
 *
fe
;

164 
loÿl
[3], 
¡¬t
[3], 
C
[3];

170 
C
[
_x_
] = _x_;

171 
C
[
_y_
] = _y_;

172 
C
[
_z_
] = _z_;

174 
i
 = 0; i < 3; i++)

176 
loÿl
[
i
] = 
GRID
.
GSloÿl
[
C
[i]];

177 
¡¬t
[
i
] = 
GRID
.
GS¡¬t
[
C
[i]];

181 
	`¥rštf
(
f’ame
, "·¹Ÿl_fmax.%4d", 
ThisTask
);

183 
T
 = 0; T < 
NTasks
; T++)

185 if(
ThisTask
 =ğ
T
)

187 
fe
 = 
	`fİ’
(
f’ame
, "w");

189 
i
 = 0; i < 
GRID
.
GSloÿl
[
_x_
]; i++)

191 
lšdex_i
 = 
i
 * 
GRID
.
GSloÿl
[
_y_
];

192 
šdex_i
 = (
i
 + 
GRID
.
GS¡¬t
[
_x_
]è* GRID.
GSglob®
[
_y_
];

194 
j
 = 0; j < 
GRID
.
GSloÿl
[
_y_
]; j++)

196 
lšdex_j
 = (
lšdex_i
 + 
j
è* 
GRID
.
GSloÿl
[
_z_
];

197 
šdex_j
 = (
šdex_i
 + 
j
 + 
GRID
.
GS¡¬t
[
_y_
]è* GRID.
GSglob®
[
_z_
];

199 
k
 = 0; k < 
GRID
.
GSloÿl
[
_z_
]; k++)

201 
lšdex
 = 
lšdex_j
 + 
k
;

202 
šdex
 = 
šdex_j
 + 
k
 + 
GRID
.
GS¡¬t
[
_z_
];

204 
šdex_»v”£
 = ((
j
+
¡¬t
[
_y_
]è* 
GRID
.
GSglob®
[
_x_
] + (
i
 + s¹[_x_])è* GRID.GSglob®[
_z_
] + 
k
 + start[_z_];

206 
	`årštf
(
fe
, "%u %g\n", 
šdex_»v”£
, 
´oduùs
[
lšdex
].
Fmax
);

211 
	`fşo£
(
fe
);

214 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

217 if(
ThisTask
 == 0)

219 
”r
;

220 
”r
 = 
	`sy¡em
("cat…artial_fmax* | sort -k1 -n > my.fmax");

221 
”r
 = 
	`sy¡em
("rm -f…artial_*");

222 if(
”r
 != 0)

223 
	`d´štf
(
VXX
, 0, "something got wrong while writing density files\n");

227 
	}
}

230 
	$wr™e_´oduù
(
æag
, 
ThisGrid
)

232 
C
, 
ix
, 
iy
, 
loÿl_z
, 
glob®_z
;

233 
size_t
 
cubesize
;

234 
f’ame
[
BLENGTH
];

235 *
cube
;

236 
FILE
 *
fe
;

237 #ifdeà
FORTRAN


238 
idummy
;

240 #ifdeà
ASCII_WRITE


241 
Ï¡
;

243 
MPI_Stus
 
¡©us
;

247 ià(
	`check_D©aDœ
())

251 
xsize
, 
ysize
, 
zsize
;

252 
xsize
 = 
GRID
.
GSloÿl
[
_x_
];

253 
ysize
 = 
GRID
.
GSloÿl
[
_y_
];

254 
zsize
 = 
GRID
.
GSloÿl
[
_z_
];

255 
cubesize
ğ
xsize
 * 
ysize
 * 
zsize
;

257  (
cube
=(*)
	`m®loc
(
cubesize
*())) == 0x0 )

259 if(
xsize
 > 2)

260 
xsize
 *= 0.8;

261 if(
ysize
 > 2)

262 
ysize
 *= 0.8;

263 if(
zsize
 > 2)

264 
zsize
 *= 0.8;

266 if(
xsize
 * 
ysize
 * 
zsize
 == 1)

268 
	`d´štf
(
VXERR
, 
ThisTask
,

271 
ThisTask
, 
xsize
, 
ysize
, 
zsize
);

272 
	`fæush
(
¡dout
);

276 
cubesize
 = 
xsize
 * 
ysize
 * 
zsize
;

279 
	`ä“
(
cube
);

282 ià(!
ThisTask
)

285 
æag
)

288 
	`¥rštf
(
f’ame
,"D©a/d’s™y.grid%d.%s.d",
MyGrid
,
·¿ms
.
RunFÏg
);

291 
	`¥rštf
(
f’ame
,"D©a/Fmax.%s.d",
·¿ms
.
RunFÏg
);

294 
	`¥rštf
(
f’ame
,"D©a/V–x.%s.d",
·¿ms
.
RunFÏg
);

297 
	`¥rštf
(
f’ame
,"D©a/V–y.%s.d",
·¿ms
.
RunFÏg
);

300 
	`¥rštf
(
f’ame
,"D©a/V–z.%s.d",
·¿ms
.
RunFÏg
);

303 
	`¥rštf
(
f’ame
,"D©a/Rmax.%s.d",
·¿ms
.
RunFÏg
);

305 #ifdeà
TWO_LPT


307 
	`¥rštf
(
f’ame
,"D©a/V–x_2LPT.%s.d",
·¿ms
.
RunFÏg
);

310 
	`¥rštf
(
f’ame
,"D©a/V–y_2LPT.%s.d",
·¿ms
.
RunFÏg
);

313 
	`¥rštf
(
f’ame
,"D©a/V–z_2LPT.%s.d",
·¿ms
.
RunFÏg
);

315 #ifdeà
THREE_LPT


317 
	`¥rštf
(
f’ame
,"D©a/V–x_3LPT_1.%s.d",
·¿ms
.
RunFÏg
);

320 
	`¥rštf
(
f’ame
,"D©a/V–y_3LPT_1.%s.d",
·¿ms
.
RunFÏg
);

323 
	`¥rštf
(
f’ame
,"D©a/V–z_3LPT_1.%s.d",
·¿ms
.
RunFÏg
);

326 
	`¥rštf
(
f’ame
,"D©a/V–x_3LPT_2.%s.d",
·¿ms
.
RunFÏg
);

329 
	`¥rštf
(
f’ame
,"D©a/V–y_3LPT_2.%s.d",
·¿ms
.
RunFÏg
);

332 
	`¥rštf
(
f’ame
,"D©a/V–z_3LPT_2.%s.d",
·¿ms
.
RunFÏg
);

341 iàĞ(
fe
=
	`fİ’
(
f’ame
,"w")) == 0x0 )

343 
	`´štf
("ERROR oÀsk %d: cªnÙ o³Àf%s\n",
ThisTask
, 
f’ame
);

344 
	`fæush
(
¡dout
);

348 
	`´štf
("Wr™šg f›ld iÀf%s\n",
f’ame
);

351 #ifdeà
ASCII_WRITE


352 
	`årštf
(
fe
,"%ld %ld %ld\n", 
MyGrids
[
MyGrid
].
GSglob®
[
_x_
], MyGrids[MyGrid].GSglob®[
_y_
], MyGrids[MyGrid].GSglob®[
_z_
]);

354 #ifdeà
FORTRAN


355 
idummy
=3*();

356 
	`fwr™e
(&
idummy
,(),1,
fe
);

358 
	`fwr™e
(&
MyGrids
[
MyGrid
].
GSglob®
[
_x_
],(),1,
fe
);

359 
	`fwr™e
(&
MyGrids
[
MyGrid
].
GSglob®
[
_y_
],(),1,
fe
);

360 
	`fwr™e
(&
MyGrids
[
MyGrid
].
GSglob®
[
_z_
],(),1,
fe
);

361 #ifdeà
FORTRAN


362 
	`fwr™e
(&
idummy
,(),1,
fe
);

526 
	`MPI_B¬r›r
(
MPI_COMM_WORLD
);

528 ià(!
ThisTask
)

530 
	`fşo£
(
fe
);

531 
	`´štf
("Wr™‹Àf%s\n",
f’ame
);

536 
	}
}

538 
	$check_D©aDœ
()

540 
¡©
 
dr
;

542 ià(!
ThisTask
)

544 if(
	`¡©
(
·¿ms
.
D©aDœ
,&
dr
))

546 
	`´štf
("C»©šg dœeùÜy %s\n",
·¿ms
.
D©aDœ
);

547 ià(
	`mkdœ
(
·¿ms
.
D©aDœ
,0755))

549 
	`´štf
("ERROR IN CREATING DIRECTORY % Ñask 0)\n",
·¿ms
.
D©aDœ
);

550 
	`fæush
(
¡dout
);

557 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_halos.c

27 
	~"pšocchio.h
"

28 
	~"äagm’t.h
"

32 
	#FTOZ
(
A
è(A>0.0 ? A-1 : A);

	)

34 
	#FORTRAN


	)

36 
	$compu‹_mf
(
iout
)

40 
i
,
ibš
,
idummy
;

41 
f’ame
[
BLENGTH
],
Ïb1
[10],
Ïb2
[10];

42 
amass
,
x
,
dm
,
a
,
a1
,
a2
,
a3
,
m
,
D
,
mx
,
r
,
massv¬
,
sigma
,
ni
,
fdummy
;

43 
FILE
 *
fe
;

45 #ifdeà
SCALE_DEPENDENT_GROWTH


47 
SDGM
.
æag
=-1;

49 
D
=
	`GrowšgMode
(
ouuts
.
z
[
iout
]);

52 
i
=0; i<
mf
.
NBIN
; i++)

54 
mf
.
nšbš_loÿl
[
i
]=0;

55 
mf
.
massšbš_loÿl
[
i
]=0.0;

56 
mf
.
nšbš
[
i
]=0;

57 
mf
.
massšbš
[
i
]=0.0;

61 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

62 ià(
groups
[
i
].
pošt
>0 && groups[i].
good
 && groups[i].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

64 
amass
=
groups
[
i
].
Mass
*
·¿ms
.
P¬tişeMass
;

65 
ibš
=()((
	`log10
(
amass
)-
mf
.
mmš
)/
DELTAM
);

66 ià(
ibš
 < 0 || ibš >ğ
mf
.
NBIN
)

68 
mf
.
nšbš_loÿl
[
ibš
]++;

69 
mf
.
massšbš_loÿl
[
ibš
]+=
amass
;

73 
	`MPI_Reduû
(
mf
.
nšbš_loÿl
, mf.
nšbš
, mf.
NBIN
, 
MPI_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

74 
	`MPI_Reduû
(
mf
.
massšbš_loÿl
, mf.
massšbš
, mf.
NBIN
, 
MPI_DOUBLE
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

77 ià(!
ThisTask
)

80 ià(
ThisSliû
)

82 
	`¥rštf
(
f’ame
,"pšocchio.%6.4f.%s.mf.§ve",
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
);

83 
	`´štf
("[%s] R—dšg d©¨äom f %s\n",
	`fd©e
(),
f’ame
);

84 
fe
=
	`fİ’
(
f’ame
,"r");

85 
i
=0; i<
mf
.
NBIN
; i++)

87 ()
	`ä—d
(&
idummy
,(),1,
fe
);

88 ()
	`ä—d
(&
fdummy
,(),1,
fe
);

89 
mf
.
nšbš
[
i
]+=
idummy
;

90 
mf
.
massšbš
[
i
]+=
fdummy
;

92 
	`fşo£
(
fe
);

94 ià(
ThisSliû
==
NSliûs
-1)

95 ià(
	`»move
(
f’ame
)!=0)

96 
	`´štf
("WARNING: Task %d could‚Ù„emovf%s\n",
ThisTask
,
f’ame
);

100 ià(
ThisSliû
<
NSliûs
-1)

102 
	`¥rštf
(
f’ame
,"pšocchio.%6.4f.%s.mf.§ve",
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
);

103 
	`´štf
("[%s] StÜšg d©¨fÜ sliû %d iÁØf%s\n",
	`fd©e
(),
ThisSliû
,
f’ame
);

104 
fe
=
	`fİ’
(
f’ame
,"w");

105 
i
=0; i<
mf
.
NBIN
; i++)

107 
	`fwr™e
(&
mf
.
nšbš
[
i
],(),1,
fe
);

108 
	`fwr™e
(&
mf
.
massšbš
[
i
],(),1,
fe
);

110 
	`fşo£
(
fe
);

114 ià(
ThisSliû
==
NSliûs
-1)

116 
	`¥rštf
(
f’ame
,"pšocchio.%6.4f.%s.mf.out",
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
);

117 
	`´štf
("[%s] Wr™šg mas funùiÚ iÁØf %s\n",
	`fd©e
(),
f’ame
);

118 
fe
=
	`fİ’
(
f’ame
,"w");

120 
	`årštf
(
fe
,"# Mas funùiÚ fÜ„edshiá %f\n",
ouuts
.
z
[
iout
]);

121 ià(
·¿ms
.
OuutInH100
)

123 
	`¡rıy
(
Ïb1
,"/h");

124 
	`¡rıy
(
Ïb2
,"h^4");

128 
	`¡rıy
(
Ïb1
,"");

129 
	`¡rıy
(
Ïb2
,"");

132 
	`årštf
(
fe
,"# 1èmas (Msun%s)\n",
Ïb1
);

133 
	`årštf
(
fe
,"# 2èn(mè(Mpc^-3 Msun^-1 %s)\n",
Ïb2
);

134 
	`årštf
(
fe
,"# 3èuµ” +1-sigm¨lim™ fÜ‚(mè(Mpc^-3 Msun^-1 %s)\n",
Ïb2
);

135 
	`årštf
(
fe
,"# 4èlow” -1-sigm¨lim™ fÜ‚(mè(Mpc^-3 Msun^-1 %s)\n",
Ïb2
);

136 
	`årštf
(
fe
,"# 5)‚umber of halos inhe bin\n");

137 
·¿ms
.
AÇlyticMassFunùiÚ
)

140 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Press & Schechter 1974\n");

143 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Sheth & Tormen 2001\n");

146 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Jenkinsƒt‡l. 2001\n");

149 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Warrenƒt‡l. 2006\n");

152 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Reedƒt‡l. 2007\n");

155 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Crocceƒt‡l. 2010\n");

158 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Tinkerƒt‡l. 2010\n");

161 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Courtinƒt‡l. 2010\n");

164 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Anguloƒt‡l. 2012\n");

167 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Watsonƒt‡l. 2013\n");

170 
	`årštf
(
fe
,"# 6)‡nalytical‚(m) from Crocceƒt‡l. 2010, universal\n");

175 
	`årštf
(
fe
,"#\n");

177 
i
=0; i<
mf
.
NBIN
; i++)

179 
x
=
mf
.
mmš
+(
i
+0.5)*
DELTAM
;

180 
m
=
	`pow
(10.,
x
);

181 
dm
 = 
·¿ms
.
P¬tişeMass
 *

182 ()Ğ(èĞ
	`pow
(10.,
mf
.
mmš
+(
i
+1)*
DELTAM
)/
·¿ms
.
P¬tişeMass
 ) -

183 (èĞ
	`pow
(10.,
mf
.
mmš
+ 
i
 *
DELTAM
)/
·¿ms
.
P¬tişeMass
 ) );

184 ià(
dm
>0.0)

186 
a
=()
mf
.
nšbš
[
i
]/mf.
vŞ
/
dm
;

187 
a1
=(()
mf
.
nšbš
[
i
]+
	`sq¹
(()mf.nšbš[i]))/mf.
vŞ
/
dm
;

188 
a2
=(()
mf
.
nšbš
[
i
]-
	`sq¹
(()mf.nšbš[i]))/mf.
vŞ
/
dm
;

191 
a
=
a1
=
a2
=0.0;

193 ià(
mf
.
nšbš
[
i
] > 1)

194 
mx
=
mf
.
massšbš
[
i
]/()mf.
nšbš
[i];

196 
mx
=
m
;

197 
a3
=
	`AÇlyticMassFunùiÚ
(
mx
,
ouuts
.
z
[
iout
]);

199 
r
=
	`SizeFÜMass
(
mx
);

200 
massv¬
=
	`MassV¬Ÿnû
(
r
)*
D
*D;

201 
sigma
=
	`sq¹
(
massv¬
);

202 
ni
=1.686/
sigma
;

204 
	`årštf
(
fe
,

206 
mx
*
mf
.
hçùÜ
,

207 
a
/
mf
.
hçùÜ4
,

208 
a1
/
mf
.
hçùÜ4
,

209 
a2
/
mf
.
hçùÜ4
,

210 
mf
.
nšbš
[
i
],

211 
a3
/
mf
.
hçùÜ4
,

212 
ni
);

214 
	`fşo£
(
fe
);

220 
	}
}

257 
	$wr™e_ÿlog
(
iout
)

261 
igood
,
i
,
ngood
,
nh®os
,
j
;

262 
hçùÜ
,
GGrid
[3],
SGrid
[3];

263 
f’ame
[
BLENGTH
],
Ïbh
[3];

264 
NTasksP”Fe
,
cŞËùÜ
,
™ask
,
Ãxt
,
ThisFe
;

265 
ÿlog_d©a
 *
myÿt
;

266 
FILE
 *
fe
;

267 
MPI_Stus
 
¡©us
;

268 #ifdeà
FORTRAN


269 
idummy
;

273 #ifdeà
ROTATE_BOX


274 
rÙ
[3]={1,2,0};

276 
rÙ
[3]={0,1,2};

279 ià(
·¿ms
.
DoNÙWr™eC©®ogs
)

281 ià(!
ThisTask
)

282 
	`´štf
("H®Øÿlog‡ˆz=%àwÈnÙ bwr™‹n\n",
ouuts
.
z
[
iout
]);

286 
GGrid
[0]=()
MyGrids
[0].
GSglob®
[
_x_
];

287 
GGrid
[1]=()
MyGrids
[0].
GSglob®
[
_y_
];

288 
GGrid
[2]=()
MyGrids
[0].
GSglob®
[
_z_
];

289 
SGrid
[0]=()
subbox
.
¡abl_x
;

290 
SGrid
[1]=()
subbox
.
¡abl_y
;

291 
SGrid
[2]=()
subbox
.
¡abl_z
;

293 
NTasksP”Fe
=
NTasks
/
·¿ms
.
NumFes
;

294 
ThisFe
=
ThisTask
/
NTasksP”Fe
;

295 
cŞËùÜ
=
ThisFe
*
NTasksP”Fe
;

298 ià(
·¿ms
.
OuutInH100
)

299 
hçùÜ
=
·¿ms
.
HubbË100
;

301 
hçùÜ
=1.0;

304 
nh®os
=0;

305 
i
=
FILAMENT
+1, 
ngood
=0; i<=
ngroups
; i++)

306 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
 &&

307 
groups
[
i
].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

308 
ngood
++;

311 
myÿt
 = (
ÿlog_d©a
 *)
wh”‘İÏû_myÿt
;

312 ià(
ngood
 * (
ÿlog_d©a
è> 
subbox
.
N·¹
/10*(
hi¡Ü›s_d©a
))

314 
	`´štf
("ERROR oÀsk %d: su½risšgly, memÜy„e£rvedØmyÿˆi šsuffic›Á iÀwr™e_ÿlog\n",
ThisTask
);

315 
	`fæush
(
¡dout
);

319 ià(
ngood
)

321 
i
=
FILAMENT
+1, 
igood
=0; i<=
ngroups
; i++)

322 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
 &&

323 
groups
[
i
].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

325 
	`£t_obj
(
i
,
ouuts
.
F
[
iout
],&
obj1
);

326 
myÿt
[
igood
].
Çme
=
groups
[
i
].name;

327 
myÿt
[
igood
].
n
=
groups
[
i
].
Mass
;

328 
myÿt
[
igood
].
M
=
groups
[
i
].
Mass
*
·¿ms
.
P¬tişeMass
*
hçùÜ
;

329 
j
=0; j<3; j++)

333 
myÿt
[
igood
].
q
[
j
] = 
groups
[
i
].
Pos
[
rÙ
[j]] + 
SGrid
[rot[j]];

334 ià(
myÿt
[
igood
].
q
[
j
]<0)

335 
myÿt
[
igood
].
q
[
j
]+=
GGrid
[j];

336 ià(
myÿt
[
igood
].
q
[
j
]>=
GGrid
[j])

337 
myÿt
[
igood
].
q
[
j
]-=
GGrid
[j];

338 
myÿt
[
igood
].
q
[
j
] *ğ
·¿ms
.
IÁ”P¬tDi¡
*
hçùÜ
;

340 
myÿt
[
igood
].
x
[
j
] = 
	`q2x
(
rÙ
[j],&
obj1
,
ORDER_FOR_CATALOG
è+ 
SGrid
[rot[j]];

341 ià(
myÿt
[
igood
].
x
[
j
]<0)

342 
myÿt
[
igood
].
x
[
j
]+=
GGrid
[j];

343 ià(
myÿt
[
igood
].
x
[
j
]>=
GGrid
[j])

344 
myÿt
[
igood
].
x
[
j
]-=
GGrid
[j];

345 
myÿt
[
igood
].
x
[
j
]*=
·¿ms
.
IÁ”P¬tDi¡
*
hçùÜ
;

346 
myÿt
[
igood
].
v
[
j
] = 
	`v–
(
rÙ
[j],&
obj1
);

348 
igood
++;

353 ià(
ThisTask
==
cŞËùÜ
)

355 ià(
·¿ms
.
NumFes
>1)

356 
	`¥rštf
(
f’ame
,"pinocchio.%6.4f.%s.catalog.out.%d",

357 
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
,
ThisFe
);

359 
	`¥rštf
(
f’ame
,"pinocchio.%6.4f.%s.catalog.out",

360 
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
);

362 ià(!
ThisTask
)

364 ià(
ThisSliû
)

365 
	`´štf
("[%s] Upd©šg f%s\n",
	`fd©e
(),
f’ame
);

367 
	`´štf
("[%s] O³nšg f%s\n",
	`fd©e
(),
f’ame
);

370 ià(
ThisSliû
)

371 
fe
=
	`fİ’
(
f’ame
,"a");

373 
fe
=
	`fİ’
(
f’ame
,"w");

375 ià(
·¿ms
.
C©®ogInAscii
)

377 ià(!
ThisSliû
)

379 
	`årštf
(
fe
,"# Group catalog for„edshift %f‡nd minimal mass of %d…article%s\n",

380 
ouuts
.
z
[
iout
],
·¿ms
.
MšH®oMass
,(params.MinHaloMass==1?"":"s"));

382 ià(
·¿ms
.
OuutInH100
)

383 
	`¡rıy
(
Ïbh
,"/h");

385 
	`¡rıy
(
Ïbh
,"");

387 
	`årštf
(
fe
,"# 1) group ID\n");

388 
	`årštf
(
fe
,"# 2ègrou°mas (Msun%s)\n",
Ïbh
);

389 
	`årštf
(
fe
,"# 3- 5èš™ŸÈpos™iÚ (Mpc%s)\n",
Ïbh
);

390 
	`årštf
(
fe
,"# 6- 8èfš®…os™iÚ (Mpc%s)\n",
Ïbh
);

391 
	`årštf
(
fe
,"# 9-11) velocity (km/s)\n");

392 
	`årštf
(
fe
,"# 12)‚umber of…articles\n");

393 
	`årštf
(
fe
,"#\n");

395 ià(
ngood
)

396 
igood
=0; igood<
ngood
; igood++)

397 
	`årštf
(
fe
," %12Lu %13.6e %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %12d\n",

398 
myÿt
[
igood
].
Çme
,

399 
myÿt
[
igood
].
M
,

400 
myÿt
[
igood
].
q
[0],mycat[igood].q[1],mycat[igood].q[2],

401 
myÿt
[
igood
].
x
[0],mycat[igood].x[1],mycat[igood].x[2],

402 
myÿt
[
igood
].
v
[0],mycat[igood].v[1],mycat[igood].v[2],

403 
myÿt
[
igood
].
n
);

407 ià(!
ThisSliû
)

409 #ifdeà
FORTRAN


410 
idummy
=2*();

411 
	`fwr™e
(&
idummy
,(),1,
fe
);

413 
	`fwr™e
(&
NTasksP”Fe
,(),1,
fe
);

414 
	`fwr™e
(&
NSliûs
,(),1,
fe
);

415 #ifdeà
FORTRAN


416 
	`fwr™e
(&
idummy
,(),1,
fe
);

419 #ifdeà
FORTRAN


420 
idummy
=();

421 
	`fwr™e
(&
idummy
,(),1,
fe
);

423 
	`fwr™e
(&
ngood
,(),1,
fe
);

424 #ifdeà
FORTRAN


425 
	`fwr™e
(&
idummy
,(),1,
fe
);

428 #ifdeà
FORTRAN


429 
idummy
=(
ÿlog_d©a
);

431 ià(
ngood
)

432 
igood
=0; igood<
ngood
; igood++)

434 #ifdeà
FORTRAN


435 
	`fwr™e
(&
idummy
,(),1,
fe
);

437 
	`fwr™e
(
myÿt
+
igood
,(
ÿlog_d©a
),1,
fe
);

438 #ifdeà
FORTRAN


439 
	`fwr™e
(&
idummy
,(),1,
fe
);

444 
nh®os
+=
ngood
;

454 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

456 
™ask
=
cŞËùÜ
+
Ãxt
;

458 ià(
ThisTask
==
cŞËùÜ
)

460 
ngood
=0;

461 
	`MPI_Recv
(&
ngood
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

463 ià(!
·¿ms
.
C©®ogInAscii
)

465 #ifdeà
FORTRAN


466 
idummy
=();

467 
	`fwr™e
(&
idummy
,(),1,
fe
);

469 
	`fwr™e
(&
ngood
,(),1,
fe
);

470 #ifdeà
FORTRAN


471 
	`fwr™e
(&
idummy
,(),1,
fe
);

475 ià(
ngood
)

477 
	`MPI_Recv
(
myÿt
, 
ngood
*(
ÿlog_d©a
), 
MPI_CHAR
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

479 ià(
·¿ms
.
C©®ogInAscii
)

481 
igood
=0; igood<
ngood
; igood++)

482 
	`årštf
(
fe
," %12Lu %13.6e %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %10.2f %12d\n",

483 
myÿt
[
igood
].
Çme
,

484 
myÿt
[
igood
].
M
,

485 
myÿt
[
igood
].
q
[0],mycat[igood].q[1],mycat[igood].q[2],

486 
myÿt
[
igood
].
x
[0],mycat[igood].x[1],mycat[igood].x[2],

487 
myÿt
[
igood
].
v
[0],mycat[igood].v[1],mycat[igood].v[2],

488 
myÿt
[
igood
].
n
);

492 #ifdeà
FORTRAN


493 
idummy
=(
ÿlog_d©a
);

495 
igood
=0; igood<
ngood
; igood++)

497 #ifdeà
FORTRAN


498 
	`fwr™e
(&
idummy
,(),1,
fe
);

500 
	`fwr™e
(
myÿt
+
igood
,(
ÿlog_d©a
),1,
fe
);

501 #ifdeà
FORTRAN


502 
	`fwr™e
(&
idummy
,(),1,
fe
);

507 
nh®os
+=
ngood
;

510 ià(
ThisTask
==
™ask
)

512 
	`MPI_S’d
(&
ngood
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

513 ià(
ngood
)

515 
	`MPI_S’d
(
myÿt
, 
ngood
*(
ÿlog_d©a
), 
MPI_CHAR
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

521 ià(
ThisTask
==
cŞËùÜ
)

523 
	`fşo£
(
fe
);

524 
	`´štf
("[%s] Task %d ha wr™‹À%d h®o Ú f%s\n",
	`fd©e
(),
ThisTask
,
nh®os
,
f’ame
);

525 
	`fæush
(
¡dout
);

530 
	}
}

532 #ifdeà
PLC


533 
	$wr™e_PLC
()

537 
i
,
nh®os
,
n¡Üed
;

538 
hçùÜ
;

539 
f’ame
[
BLENGTH
],
Ïbh
[3];

540 
NTasksP”Fe
,
cŞËùÜ
,
™ask
,
Ãxt
,
ThisFe
;

541 
FILE
 *
fe
;

542 
MPI_Stus
 
¡©us
;

543 
Fœ¡C®l
=1;

544 
	stowr™e


546 
Çme
;

547 
»d
,
x
,
y
,
z
,
vx
,
vy
,
vz
,
Mass
,
th‘a
,
phi
,
v_los
,
obsz
;

548 } 
wr™‘his
;

549 #ifdeà
FORTRAN


550 
idummy
;

554 ià(
·¿ms
.
DoNÙWr™eC©®ogs
)

556 ià(!
ThisTask
 && 
Fœ¡C®l
)

557 
	`´štf
("PLC catalog will‚ot be written\n");

561 
NTasksP”Fe
=
NTasks
/
·¿ms
.
NumFes
;

562 
ThisFe
=
ThisTask
/
NTasksP”Fe
;

563 
cŞËùÜ
=
ThisFe
*
NTasksP”Fe
;

566 ià(
·¿ms
.
OuutInH100
)

567 
hçùÜ
=
·¿ms
.
HubbË100
;

569 
hçùÜ
=1.0;

570 
nh®os
=0;

573 ià(
ThisTask
==
cŞËùÜ
)

575 ià(
·¿ms
.
NumFes
>1)

576 
	`¥rštf
(
f’ame
,"pšocchio.%s.¶c.out.%d",
·¿ms
.
RunFÏg
,
ThisFe
);

578 
	`¥rštf
(
f’ame
,"pšocchio.%s.¶c.out",
·¿ms
.
RunFÏg
);

580 ià(!
ThisTask
)

582 ià(
Fœ¡C®l
)

583 
	`´štf
("[%s] O³nšg f%s\n",
	`fd©e
(),
f’ame
);

585 
	`´štf
("[%s] Upd©šg f%s\n",
	`fd©e
(),
f’ame
);

588 ià(
Fœ¡C®l
)

589 
fe
=
	`fİ’
(
f’ame
,"w");

591 
fe
=
	`fİ’
(
f’ame
,"a");

593 ià(
·¿ms
.
C©®ogInAscii
)

595 ià(
Fœ¡C®l
)

597 
	`årštf
(
fe
,"# Group catalog onhe Past Light Cone for‡ minimal mass of %d…article%s\n",

598 
·¿ms
.
MšH®oMass
,(params.MinHaloMass==1?"":"s"));

600 ià(
·¿ms
.
OuutInH100
)

601 
	`¡rıy
(
Ïbh
,"/h");

603 
	`¡rıy
(
Ïbh
,"");

605 
	`årštf
(
fe
,"# 1) group ID\n");

606 
	`årštf
(
fe
,"# 2)rue„edshift\n");

607 
	`årštf
(
fe
,"# 3-5ècomovšg…os™iÚ (Mpc%s)\n",
Ïbh
);

608 
	`årštf
(
fe
,"# 6-8) velocity (km/s)\n");

609 
	`årštf
(
fe
,"# 9ègrou°mas (Msun%s)\n",
Ïbh
);

610 
	`årštf
(
fe
,"# 10)heta (degree)\n");

611 
	`årštf
(
fe
,"# 11)…hi (degree)\n");

612 
	`årštf
(
fe
,"# 12)…eculiar velocity‡longhe†ine-of-sight (km/s)\n");

613 
	`årštf
(
fe
,"# 13) observed„edshift\n");

614 
	`årštf
(
fe
,"#\n");

617 
i
=0; i<
¶c
.
N¡Üed
; i++)

619 
wr™‘his
.
Çme
=
¶cgroups
[
i
].name;

620 
wr™‘his
.
»d
=
¶cgroups
[
i
].
z
;

621 
wr™‘his
.
x
=
¶cgroups
[
i
].x[0]*
hçùÜ
;

622 
wr™‘his
.
y
=
¶cgroups
[
i
].
x
[1]*
hçùÜ
;

623 
wr™‘his
.
z
=
¶cgroups
[
i
].
x
[2]*
hçùÜ
;

624 
wr™‘his
.
vx
=
¶cgroups
[
i
].
v
[0];

625 
wr™‘his
.
vy
=
¶cgroups
[
i
].
v
[1];

626 
wr™‘his
.
vz
=
¶cgroups
[
i
].
v
[2];

627 
wr™‘his
.
Mass
=
¶cgroups
[
i
].Mass*
·¿ms
.
P¬tişeMass
*
hçùÜ
;

628 
wr™‘his
.
th‘a
=
¶cgroups
[
i
].theta;

629 
wr™‘his
.
phi
=
¶cgroups
[
i
].phi;

630 
wr™‘his
.
v_los
=(
¶cgroups
[
i
].
x
[0]*¶cgroups[i].
v
[0]+

631 
¶cgroups
[
i
].
x
[1]*¶cgroups[i].
v
[1]+

632 
¶cgroups
[
i
].
x
[2]*¶cgroups[i].
v
[2])/¶cgroups[i].
rhÜ
;

633 
wr™‘his
.
obsz
=
¶cgroups
[
i
].
z
+wr™‘his.
v_los
/
SPEEDOFLIGHT
*(1.0+plcgroups[i].z);

635 
	`årštf
(
fe
," %12Lu %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %15.8e %16.6f %16.6f %16.6f %16.6f\n",

636 
wr™‘his
.
Çme
,

637 
wr™‘his
.
»d
,

638 
wr™‘his
.
x
,wr™‘his.
y
,wr™‘his.
z
,

639 
wr™‘his
.
vx
,wr™‘his.
vy
,wr™‘his.
vz
,

640 
wr™‘his
.
Mass
,

641 
wr™‘his
.
th‘a
,

642 
wr™‘his
.
phi
,

643 
wr™‘his
.
v_los
,

644 
wr™‘his
.
obsz
);

645 
nh®os
++;

651 
i
=0; i<
¶c
.
N¡Üed
; i++)

653 
wr™‘his
.
Çme
=
¶cgroups
[
i
].name;

654 
wr™‘his
.
»d
=
¶cgroups
[
i
].
z
;

655 
wr™‘his
.
x
=
¶cgroups
[
i
].x[0]*
hçùÜ
;

656 
wr™‘his
.
y
=
¶cgroups
[
i
].
x
[1]*
hçùÜ
;

657 
wr™‘his
.
z
=
¶cgroups
[
i
].
x
[2]*
hçùÜ
;

658 
wr™‘his
.
vx
=
¶cgroups
[
i
].
v
[0];

659 
wr™‘his
.
vy
=
¶cgroups
[
i
].
v
[1];

660 
wr™‘his
.
vz
=
¶cgroups
[
i
].
v
[2];

661 
wr™‘his
.
Mass
=
¶cgroups
[
i
].Mass*
·¿ms
.
P¬tişeMass
*
hçùÜ
;

662 
wr™‘his
.
th‘a
=
¶cgroups
[
i
].theta;

663 
wr™‘his
.
phi
=
¶cgroups
[
i
].phi;

664 
wr™‘his
.
v_los
=(
¶cgroups
[
i
].
x
[0]*¶cgroups[i].
v
[0]+

665 
¶cgroups
[
i
].
x
[1]*¶cgroups[i].
v
[1]+

666 
¶cgroups
[
i
].
x
[2]*¶cgroups[i].
v
[2])/¶cgroups[i].
rhÜ
;

667 
wr™‘his
.
obsz
=
¶cgroups
[
i
].
z
+wr™‘his.
v_los
/
SPEEDOFLIGHT
*(1.0+plcgroups[i].z);

669 #ifdeà
FORTRAN


670 
idummy
=(
towr™e
);

671 
	`fwr™e
(&
idummy
,(),1,
fe
);

673 
	`fwr™e
(&
wr™‘his
,(
towr™e
),1,
fe
);

674 #ifdeà
FORTRAN


675 
	`fwr™e
(&
idummy
,(),1,
fe
);

677 
nh®os
++;

689 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

691 
™ask
=
cŞËùÜ
+
Ãxt
;

693 ià(
ThisTask
==
cŞËùÜ
)

695 
n¡Üed
=0;

696 
	`MPI_Recv
(&
n¡Üed
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

698 ià(
n¡Üed
)

701 
	`MPI_Recv
(
¶cgroups
, 
n¡Üed
*(
ÿlog_d©a
), 
MPI_CHAR
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

703 ià(
·¿ms
.
C©®ogInAscii
)

705 
i
=0; i<
n¡Üed
; i++)

707 
wr™‘his
.
Çme
=
¶cgroups
[
i
].name;

708 
wr™‘his
.
»d
=
¶cgroups
[
i
].
z
;

709 
wr™‘his
.
x
=
¶cgroups
[
i
].x[0]*
hçùÜ
;

710 
wr™‘his
.
y
=
¶cgroups
[
i
].
x
[1]*
hçùÜ
;

711 
wr™‘his
.
z
=
¶cgroups
[
i
].
x
[2]*
hçùÜ
;

712 
wr™‘his
.
vx
=
¶cgroups
[
i
].
v
[0];

713 
wr™‘his
.
vy
=
¶cgroups
[
i
].
v
[1];

714 
wr™‘his
.
vz
=
¶cgroups
[
i
].
v
[2];

715 
wr™‘his
.
Mass
=
¶cgroups
[
i
].Mass*
·¿ms
.
P¬tişeMass
*
hçùÜ
;

716 
wr™‘his
.
th‘a
=
¶cgroups
[
i
].theta;

717 
wr™‘his
.
phi
=
¶cgroups
[
i
].phi;

718 
wr™‘his
.
v_los
=(
¶cgroups
[
i
].
x
[0]*¶cgroups[i].
v
[0]+

719 
¶cgroups
[
i
].
x
[1]*¶cgroups[i].
v
[1]+

720 
¶cgroups
[
i
].
x
[2]*¶cgroups[i].
v
[2])/¶cgroups[i].
rhÜ
;

721 
wr™‘his
.
obsz
=
¶cgroups
[
i
].
z
+wr™‘his.
v_los
/
SPEEDOFLIGHT
*(1.0+plcgroups[i].z);

723 
	`årštf
(
fe
," %12Lu %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %16.6f %15.8e %16.6f %16.6f %16.6f %16.6f\n",

724 
wr™‘his
.
Çme
,

725 
wr™‘his
.
»d
,

726 
wr™‘his
.
x
,wr™‘his.
y
,wr™‘his.
z
,

727 
wr™‘his
.
vx
,wr™‘his.
vy
,wr™‘his.
vz
,

728 
wr™‘his
.
Mass
,

729 
wr™‘his
.
th‘a
,

730 
wr™‘his
.
phi
,

731 
wr™‘his
.
v_los
,

732 
wr™‘his
.
obsz
);

733 
nh®os
++;

738 
i
=0; i<
n¡Üed
; i++)

740 
wr™‘his
.
Çme
=
¶cgroups
[
i
].name;

741 
wr™‘his
.
»d
=
¶cgroups
[
i
].
z
;

742 
wr™‘his
.
x
=
¶cgroups
[
i
].x[0]*
hçùÜ
;

743 
wr™‘his
.
y
=
¶cgroups
[
i
].
x
[1]*
hçùÜ
;

744 
wr™‘his
.
z
=
¶cgroups
[
i
].
x
[2]*
hçùÜ
;

745 
wr™‘his
.
vx
=
¶cgroups
[
i
].
v
[0];

746 
wr™‘his
.
vy
=
¶cgroups
[
i
].
v
[1];

747 
wr™‘his
.
vz
=
¶cgroups
[
i
].
v
[2];

748 
wr™‘his
.
Mass
=
¶cgroups
[
i
].Mass*
·¿ms
.
P¬tişeMass
*
hçùÜ
;

749 
wr™‘his
.
th‘a
=
¶cgroups
[
i
].theta;

750 
wr™‘his
.
phi
=
¶cgroups
[
i
].phi;

751 
wr™‘his
.
v_los
=(
¶cgroups
[
i
].
x
[0]*¶cgroups[i].
v
[0]+

752 
¶cgroups
[
i
].
x
[1]*¶cgroups[i].
v
[1]+

753 
¶cgroups
[
i
].
x
[2]*¶cgroups[i].
v
[2])/¶cgroups[i].
rhÜ
;

754 
wr™‘his
.
obsz
=
¶cgroups
[
i
].
z
+wr™‘his.
v_los
/
SPEEDOFLIGHT
*(1.0+plcgroups[i].z);

756 #ifdeà
FORTRAN


757 
idummy
=(
towr™e
);

758 
	`fwr™e
(&
idummy
,(),1,
fe
);

760 
	`fwr™e
(&
wr™‘his
,(
towr™e
),1,
fe
);

761 #ifdeà
FORTRAN


762 
	`fwr™e
(&
idummy
,(),1,
fe
);

764 
nh®os
++;

769 ià(
ThisTask
==
™ask
)

771 
	`MPI_S’d
(&
¶c
.
N¡Üed
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

772 ià(
¶c
.
N¡Üed
)

774 
	`MPI_S’d
(
¶cgroups
, 
¶c
.
N¡Üed
*(
ÿlog_d©a
), 
MPI_CHAR
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

780 ià(
ThisTask
==
cŞËùÜ
)

782 
	`fşo£
(
fe
);

783 
	`´štf
("[%s] Task %d ha wr™‹À%d h®o Ú f%s\n",
	`fd©e
(),
ThisTask
,
nh®os
,
f’ame
);

784 
	`fæush
(
¡dout
);

787 
Fœ¡C®l
=0;

790 
	}
}

794 
	$wr™e_hi¡Ü›s
()

798 
i
, 
commšt
[2], 
Á»es
, 
nb¿nch_®l
, 
nb¿nch_Œ“
, 
Á»es_glob®
, 
nb¿nch_glob®
,

799 
ib¿nch
, 
thisb¿nch
, 
thi¡»e
, 
™»e
;

800 
f’ame
[
BLENGTH
];

801 
NTasksP”Fe
,
cŞËùÜ
,
™ask
,
Ãxt
,
ThisFe
;

802 
hi¡Ü›s_d©a
 *
myÿt
;

803 
FILE
 *
fe
;

804 
MPI_Stus
 
¡©us
;

805 #ifdeà
FORTRAN


806 
idummy
;

809 ià(
·¿ms
.
DoNÙWr™eHi¡Ü›s
)

811 ià(!
ThisTask
)

812 
	`´štf
("Merger histories will‚ot be written\n");

816 
NTasksP”Fe
=
NTasks
/
·¿ms
.
NumFes
;

817 
ThisFe
=
ThisTask
/
NTasksP”Fe
;

818 
cŞËùÜ
=
ThisFe
*
NTasksP”Fe
;

820 
i
=0; i<=
ngroups
; i++)

821 
groups
[
i
].
ŒackT
=0;

822 
i
=0; i<=
ngroups
; i++)

823 
groups
[
i
].
ŒackC
=0;

829 
nb¿nch_®l
=
Á»es
=0;

830 
i
=
FILAMENT
+1, 
nb¿nch_®l
=0; i<=
ngroups
; i++)

831 ià(
groups
[groups[
i
].
h®o_­p
].
good
 &&

832 
groups
[groups[
i
].
h®o_­p
].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

833 
nb¿nch_®l
++;

835 
myÿt
 = (
hi¡Ü›s_d©a
 *)
wh”‘İÏû_myÿt
;

836 ià(
nb¿nch_®l
 * (
hi¡Ü›s_d©a
è> 
subbox
.
N·¹
/10*(histories_data))

838 
	`´štf
("ERROR oÀsk %d: su½risšgly, memÜy„e£rvedØmyÿˆi šsuffic›Á iÀwr™e_hi¡Ü›s\n",
ThisTask
);

839 
	`fæush
(
¡dout
);

844 ià(
nb¿nch_®l
)

846 
Á»es
=0;

847 
thisb¿nch
=0;

850 
i
=
FILAMENT
+1, 
Á»es
=0; i<=
ngroups
; i++)

851 ià(
groups
[
i
].
h®o_­p
==i &&

852 
groups
[
i
].
good
 &&

853 
groups
[
i
].
Mass
 >ğ
·¿ms
.
MšH®oMass
)

855 ++
Á»es
;

858 
nb¿nch_Œ“
=0;

859 
Ãxt
=
i
;

862 ++
nb¿nch_Œ“
;

863 
Ãxt
=
groups
[Ãxt].
Î
;

865 
Ãxt
 !ğ
i
);

867 
ib¿nch
=0;

869 
Ãxt
=
i
;

875 
groups
[
thisb¿nch
].
ŒackT
 = 
Ãxt
;

876 
myÿt
[
thisb¿nch
].
nick
 = 
groups
[
Ãxt
].
ŒackC
 = (
ib¿nch
 ? ib¿nch : 
nb¿nch_Œ“
);

877 
myÿt
[
thisb¿nch
].
Î
 = ++
ib¿nch
;

878 
myÿt
[
thisb¿nch
].
mass
 = 
groups
[
Ãxt
].
Mass
;

879 
myÿt
[
thisb¿nch
].
Çme
 = 
groups
[
Ãxt
].name;

880 
myÿt
[
thisb¿nch
].
mam
 = 
groups
[
Ãxt
].
mass_©_m”g”
;

881 
myÿt
[
thisb¿nch
].
z­
 = 
	`FTOZ
(
groups
[
Ãxt
].
t_­³¬
);

882 
myÿt
[
thisb¿nch
].
z³
 = 
	`FTOZ
(
groups
[
Ãxt
].
t_³ak
);

883 
myÿt
[
thisb¿nch
].
zme
 = 
	`FTOZ
(
groups
[
Ãxt
].
t_m”ge
);

884 ++
thisb¿nch
;

886 
Ãxt
=
groups
[Ãxt].
Î
;

888 
Ãxt
 !ğ
i
);

891 
ib¿nch
=
thisb¿nch
-
nb¿nch_Œ“
; ibranch<thisbranch; ibranch++)

892 ià(
groups
[groups[
ib¿nch
].
ŒackT
].
m”ged_w™h
>
FILAMENT
)

893 
myÿt
[
ib¿nch
].
mw
 = 
groups
[groups[groups[ib¿nch].
ŒackT
].
m”ged_w™h
].
ŒackC
;

895 
myÿt
[
ib¿nch
].
mw
 = -1;

901 ià(
ThisTask
==
cŞËùÜ
)

903 
Á»es_glob®
=
Á»es
;

904 
nb¿nch_glob®
=
nb¿nch_®l
;

906 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

908 
™ask
=
cŞËùÜ
+
Ãxt
;

909 ià(
ThisTask
==
cŞËùÜ
)

911 
	`MPI_Recv
(
commšt
, 2, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

912 
Á»es_glob®
+=
commšt
[0];

913 
nb¿nch_glob®
+=
commšt
[1];

915 ià(
ThisTask
==
™ask
)

917 
commšt
[0]=
Á»es
;

918 
commšt
[1]=
nb¿nch_®l
;

919 
	`MPI_S’d
(
commšt
, 2, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

924 ià(
ThisTask
==
cŞËùÜ
)

926 ià(
·¿ms
.
NumFes
>1)

927 
	`¥rštf
(
f’ame
,"pšocchio.%s.hi¡Ü›s.out.%d",
·¿ms
.
RunFÏg
,
ThisFe
);

929 
	`¥rštf
(
f’ame
,"pšocchio.%s.hi¡Ü›s.out",
·¿ms
.
RunFÏg
);

931 ià(!
ThisTask
)

933 ià(
ThisSliû
)

934 
	`´štf
("[%s] Upd©šg f%s\n",
	`fd©e
(),
f’ame
);

936 
	`´štf
("[%s] O³nšg f%s\n",
	`fd©e
(),
f’ame
);

939 ià(
ThisSliû
)

940 
fe
=
	`fİ’
(
f’ame
,"a");

942 
fe
=
	`fİ’
(
f’ame
,"w");

943 
thi¡»e
=0;

945 ià(
·¿ms
.
C©®ogInAscii
)

947 ià(!
ThisSliû
)

949 
	`årštf
(
fe
,"# Merger histories for halos with minimal mass of %d…article%s\n",

950 
·¿ms
.
MšH®oMass
,(params.MinHaloMass==1?"":"s"));

952 
	`årštf
(
fe
,"# 1) group ID\n");

953 
	`årštf
(
fe
,"# 2) index withinheree\n");

954 
	`årštf
(
fe
,"# 3)†inking†ist\n");

955 
	`årštf
(
fe
,"# 4) merged with\n");

956 
	`årštf
(
fe
,"# 5) mass of halo‡t merger (particles)\n");

957 
	`årštf
(
fe
,"# 6) mass of main halo it merges with,‡t merger (particles)\n");

958 
	`årštf
(
fe
,"# 7) merger„edshift\n");

959 
	`årštf
(
fe
,"# 8)„edshift of…eak collapse\n");

960 
	`årštf
(
fe
,"# 9)„edshift‡t whichhe halo overtakeshe minimal mass\n");

961 
	`årštf
(
fe
,"#\n");

962 
	`årštf
(
fe
,"# Nslices: \n");

963 
	`årštf
(
fe
," %d\n",
NSliûs
);

965 
	`årštf
(
fe
,"# Ntrees & Nbranches: \n");

966 
	`årštf
(
fe
," %d %d\n",
Á»es_glob®
, 
nb¿nch_glob®
);

970 ià(!
ThisSliû
)

972 #ifdeà
FORTRAN


973 
idummy
=();

974 
	`fwr™e
(&
idummy
,(),1,
fe
);

976 
	`fwr™e
(&
NSliûs
,(),1,
fe
);

977 #ifdeà
FORTRAN


978 
	`fwr™e
(&
idummy
,(),1,
fe
);

981 #ifdeà
FORTRAN


982 
idummy
=2*();

983 
	`fwr™e
(&
idummy
,(),1,
fe
);

985 
	`fwr™e
(&
Á»es_glob®
,(),1,
fe
);

986 
	`fwr™e
(&
nb¿nch_glob®
,(),1,
fe
);

987 #ifdeà
FORTRAN


988 
	`fwr™e
(&
idummy
,(),1,
fe
);

994 ià(
ThisTask
==
cŞËùÜ
)

996 ià(
nb¿nch_®l
)

998 
thisb¿nch
=0;

999 ià(
·¿ms
.
C©®ogInAscii
)

1001 
™»e
=0; iŒ“<
Á»es
; itree++)

1003 
nb¿nch_Œ“
=
myÿt
[
thisb¿nch
].
nick
;

1004 
	`årštf
(
fe
,"#T»%d, Nb¿nches=%d\n", 
thi¡»e
++, 
nb¿nch_Œ“
);

1005 
ib¿nch
=0; ib¿nch<
nb¿nch_Œ“
; ibranch++)

1007 
	`årštf
(
fe
," %12Ld %6d %6d %6d %9d %9d %9.4f %9.4f %9.4f\n",

1008 
myÿt
[
thisb¿nch
].
Çme
,

1009 
myÿt
[
thisb¿nch
].
nick
,

1010 
myÿt
[
thisb¿nch
].
Î
,

1011 
myÿt
[
thisb¿nch
].
mw
,

1012 
myÿt
[
thisb¿nch
].
mass
,

1013 
myÿt
[
thisb¿nch
].
mam
,

1014 
myÿt
[
thisb¿nch
].
zme
,

1015 
myÿt
[
thisb¿nch
].
z³
,

1016 
myÿt
[
thisb¿nch
].
z­
);

1017 ++
thisb¿nch
;

1023 
™»e
=0; iŒ“<
Á»es
; itree++)

1025 
nb¿nch_Œ“
=
myÿt
[
thisb¿nch
].
nick
;

1026 #ifdeà
FORTRAN


1027 
idummy
=2*();

1028 
	`fwr™e
(&
idummy
,(),1,
fe
);

1030 
	`fwr™e
(&
thi¡»e
,(),1,
fe
);

1031 
	`fwr™e
(&
nb¿nch_Œ“
,(),1,
fe
);

1032 ++
thi¡»e
;

1033 #ifdeà
FORTRAN


1034 
	`fwr™e
(&
idummy
,(),1,
fe
);

1036 
ib¿nch
=0; ib¿nch<
nb¿nch_Œ“
; ibranch++)

1038 #ifdeà
FORTRAN


1039 
idummy
=(
hi¡Ü›s_d©a
);

1040 
	`fwr™e
(&
idummy
,(),1,
fe
);

1042 
	`fwr™e
(
myÿt
+
thisb¿nch
++,(
hi¡Ü›s_d©a
),1,
fe
);

1043 #ifdeà
FORTRAN


1044 
	`fwr™e
(&
idummy
,(),1,
fe
);

1060 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

1062 
™ask
=
cŞËùÜ
+
Ãxt
;

1064 ià(
ThisTask
==
cŞËùÜ
)

1066 
	`MPI_Recv
(
commšt
, 2, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1067 
nb¿nch_®l
=
commšt
[0];

1068 
Á»es
=
commšt
[1];

1070 ià(
nb¿nch_®l
)

1072 ià(
nb¿nch_®l
 * (
hi¡Ü›s_d©a
è> 
subbox
.
N·¹
/10*(histories_data))

1074 
	`´štf
("ERROR ASSURDO oÀsk %d: wr™e_hi¡Ü›s,‚Ú ba¡¨lØ¥aziØ³¸myÿˆÔecv)\n",
ThisTask
);

1075 
	`fæush
(
¡dout
);

1079 
	`MPI_Recv
(
myÿt
, 
nb¿nch_®l
*(
hi¡Ü›s_d©a
), 
MPI_CHAR
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1082 
thisb¿nch
=0;

1083 ià(
·¿ms
.
C©®ogInAscii
)

1085 
™»e
=0; iŒ“<
Á»es
; itree++)

1087 
nb¿nch_Œ“
=
myÿt
[
thisb¿nch
].
nick
;

1088 
	`årštf
(
fe
,"#T»%d, Nb¿nches=%d\n", 
thi¡»e
++, 
nb¿nch_Œ“
);

1089 
ib¿nch
=0; ib¿nch<
nb¿nch_Œ“
; ibranch++)

1091 
	`årštf
(
fe
," %12Ld %6d %6d %6d %9d %9d %9.4f %9.4f %9.4f\n",

1092 
myÿt
[
thisb¿nch
].
Çme
,

1093 
myÿt
[
thisb¿nch
].
nick
,

1094 
myÿt
[
thisb¿nch
].
Î
,

1095 
myÿt
[
thisb¿nch
].
mw
,

1096 
myÿt
[
thisb¿nch
].
mass
,

1097 
myÿt
[
thisb¿nch
].
mam
,

1098 
myÿt
[
thisb¿nch
].
zme
,

1099 
myÿt
[
thisb¿nch
].
z³
,

1100 
myÿt
[
thisb¿nch
].
z­
);

1101 ++
thisb¿nch
;

1107 
™»e
=0; iŒ“<
Á»es
; itree++)

1109 
nb¿nch_Œ“
=
myÿt
[
thisb¿nch
].
nick
;

1110 #ifdeà
FORTRAN


1111 
idummy
=2*();

1112 
	`fwr™e
(&
idummy
,(),1,
fe
);

1114 
	`fwr™e
(&
thi¡»e
,(),1,
fe
);

1115 
	`fwr™e
(&
nb¿nch_Œ“
,(),1,
fe
);

1116 ++
thi¡»e
;

1117 #ifdeà
FORTRAN


1118 
	`fwr™e
(&
idummy
,(),1,
fe
);

1120 
ib¿nch
=0; ib¿nch<
nb¿nch_Œ“
; ibranch++)

1122 #ifdeà
FORTRAN


1123 
idummy
=(
hi¡Ü›s_d©a
);

1124 
	`fwr™e
(&
idummy
,(),1,
fe
);

1126 
	`fwr™e
(
myÿt
+
thisb¿nch
++,(
hi¡Ü›s_d©a
),1,
fe
);

1127 #ifdeà
FORTRAN


1128 
	`fwr™e
(&
idummy
,(),1,
fe
);

1135 ià(
ThisTask
==
™ask
)

1138 
commšt
[0]=
nb¿nch_®l
;

1139 
commšt
[1]=
Á»es
;

1140 
	`MPI_S’d
(
commšt
, 2, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1142 ià(
nb¿nch_®l
)

1144 
	`MPI_S’d
(
myÿt
, 
nb¿nch_®l
*(
hi¡Ü›s_d©a
), 
MPI_CHAR
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1151 ià(
ThisTask
==
cŞËùÜ
)

1153 
	`fşo£
(
fe
);

1154 
	`´štf
("[%s] Task %d ha wr™‹À%d»e ªd %d b¿nche Ú f%s\n",
	`fd©e
(),
ThisTask
,
Á»es_glob®
,
nb¿nch_glob®
,
f’ame
);

1155 
	`fæush
(
¡dout
);

1159 
	}
}

	@/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_snapshot.c

27 
	~"pšocchio.h
"

28 
	~"äagm’t.h
"

30 
Wr™eBlockName
(
FILE
 *,, *);

31 
my_¡rıy
(*,*, );

34 
	#WRITE_INFO_BLOCK


	)

36 
	#FORCE_PARTICLE_NUMBER


	)

38 
	#WRITE_FMAX_TO_SNAPSHOT


	)

40 #ià
defšed
(
FORCE_PARTICLE_NUMBER
è&& defšed(
ONLY_LPT_DISPLACEMENTS
)

41 #”rÜ 
Tryšg
 
to
 
compe
 
w™h
 
FORCE_PARTICLE_NUMBER
 
ªd
 
ONLY_LPT_DISPLACEMENTS
 
tog‘h”


44 #ifdeà
LONGIDS


45 
	#MYIDTYPE
 

	)

47 
	#MYIDTYPE
 

	)

52 
	mNP¬t
[6];

53 
	mMass
[6];

54 
	mTime
;

55 
	mRedShiá
;

56 
	mæag_sä
;

57 
	mæag_ãedback
;

58 
	mNP¬tTÙ®
[6];

59 
	mæag_coŞšg
;

60 
	mnum_fes
;

61 
	mBoxSize
;

62 
	mOmega0
;

63 
	mOmegaLambda
;

64 
	mHubbËP¬am
;

65 
	mæag_¡–Ï¿ge
;

66 
	mæag_m‘®s
;

67 
	mÅ¬tTÙ®HighWÜd
[6];

68 
	mæag_’Œİy_š¡—d_u
;

69 
	mæag_m‘®coŞšg
;

70 
	mæag_¡–Ï»vŞutiÚ
;

71 
	mfl
[52];

72 } 
	tSÇpshÙH—d”_d©a
;

74 #ifdeà
WRITE_INFO_BLOCK


77 
	mÇme
[4], 
	mty³
[8];

78 
	mndim
, 
	maùive
[6];

79 } 
	tInfoBlock_d©a
;

87 
	$wr™e_¢­shÙ
(
iout
)

93 
NTasksP”Fe
,
cŞËùÜ
,
™ask
,
Ãxt
,
ThisFe
,
šdex
,
Å¬t
,
i
,
j
,
dummy
,
myN·¹
,
NInFe
,

94 
good_·¹işe
;

95 
SGrid
[3],
Lgridxy
,
ibox
,
jbox
,
kbox
,
kk
,
glob®_x
,
glob®_y
,
glob®_z
, 
·¹
;

96 
myNtÙ®
, 
lÚgdummy
, 
NP¬tTÙ
;

97 
vçù
, 
rvœ
, 
MyPos
[3], *
MyV–
, 
Dz
, 
cÚc
, 
ºd
, 
nfwçc
, 
¬—
, 
xºd
, 
yºd
,

98 
´obfunc
, 
u
, 
th‘a
, 
sigma
;

99 
MyV–
=
MyPos
;

100 
f’ame
[
BLENGTH
];

101 
FILE
 *
fe
;

102 
SÇpshÙH—d”_d©a
 
H—d”
;

103 
MYIDTYPE
 *
ID
,*
GRID
;

104 
MPI_Stus
 
¡©us
;

107 
axis
[3];

108 } 
	tAuxSŒuù
;

110 
AuxSŒuù
 *
Pos
,*
V–
;

111 #ifdeà
WRITE_FMAX_TO_SNAPSHOT


112 *
FMAX
;

113 *
RMAX
;

116 #ifdeà
WRITE_INFO_BLOCK


117 #iâdeà
ONLY_LPT_DISPLACEMENTS


118 #iâdeà
WRITE_FMAX_TO_SNAPSHOT


119 
	#NBLOCKS
 4

	)

121 
	#NBLOCKS
 6

	)

124 
	#NBLOCKS
 3

	)

126 
InfoBlock_d©a
 
InfoBlock
[
NBLOCKS
];

129 #ifdeà
ROTATE_BOX


130 
rÙ
[3]={1,2,0};

132 
rÙ
[3]={0,1,2};

136 #ifdeà
ONLY_LPT_DISPLACEMENTS


137 ià(!
ThisTask
)

139 
	`´štf
("directive ONLY_LPT_DISPLACEMENTS is…resent\n");

140 
	`´štf
("the code will use LPT displacements for‡ll…articles\n");

144 #ifdeà
FORCE_PARTICLE_NUMBER


145 ià(!
ThisTask
)

147 
	`´štf
("directive FORCE_PARTICLE_NUMBER is…resent\n");

148 
	`´štf
("the code will conservehe‚umber of…articles‡nd will‚ot check for group consistency\n");

155 ià(
NSliûs
>1)

158 
NTasksP”Fe
=
NTasks
/
·¿ms
.
NumFes
;

159 
ThisFe
=
ThisTask
/
NTasksP”Fe
;

160 
cŞËùÜ
=
ThisFe
*
NTasksP”Fe
;

162 #ifdeà
SCALE_DEPENDENT_GROWTH


163 
SDGM
.
æag
=1;

164 
SDGM
.
ismoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

167 
SGrid
[0]=()
subbox
.
¡abl_x
;

168 
SGrid
[1]=()
subbox
.
¡abl_y
;

169 
SGrid
[2]=()
subbox
.
¡abl_z
;

170 
NP¬tTÙ
 =

171 ()
MyGrids
[0].
GSglob®
[
_x_
] *

172 ()
MyGrids
[0].
GSglob®
[
_y_
] *

173 ()
MyGrids
[0].
GSglob®
[
_z_
];

174 
Lgridxy
 = 
subbox
.
Lgwbl_x
 * subbox.
Lgwbl_y
;

176 
Dz
 = 
	`GrowšgMode
(
ouuts
.
z
[
iout
]);

180 
i
=0, 
myN·¹
=0; i<
subbox
.
N·¹
; i++)

183 
kbox
=
i
/
Lgridxy
;

184 
kk
=
i
-
kbox
*
Lgridxy
;

185 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

186 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

187 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

188 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

189 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

190 ià(
good_·¹işe


191 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

192 && 
group_ID
[
i
]<=
FILAMENT


195 
myN·¹
++;

198 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

200 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

201 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

202 
myN·¹
+=
groups
[
i
].
Mass
;

207 
lÚgdummy
=()
myN·¹
;

208 
	`MPI_Reduû
(&
lÚgdummy
, &
myNtÙ®
, 1, 
MPI_LONG_LONG_INT
, 
MPI_SUM
, 0, 
MPI_COMM_WORLD
);

210 ià(!
ThisTask
)

211 
	`´štf
("[%s] The snapshot will contain‡otal of %Ld…articles (trueotal‚umber: %Ld, duplication: %f)\n",

212 
	`fd©e
(), 
myNtÙ®
, 
NP¬tTÙ
, ()(myNtotal-NPartTot)/()NPartTot);

215 
Ãxt
=0;‚ext<
NTasksP”Fe
;‚ext++)

217 
™ask
=
cŞËùÜ
+
Ãxt
;

218 ià(!
Ãxt
)

220 ià(
ThisTask
==
cŞËùÜ
)

221 
NInFe
=
myN·¹
;

225 ià(
ThisTask
==
cŞËùÜ
)

227 
Å¬t
=0;

228 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

229 
NInFe
+=
Å¬t
;

231 ià(
ThisTask
==
™ask
)

232 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

237 ià(
ThisTask
==
cŞËùÜ
)

239 ià(
·¿ms
.
NumFes
>1)

240 
	`¥rštf
(
f’ame
,"pinocchio.%6.4f.%s.snapshot.out.%d",

241 
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
,
ThisFe
);

243 
	`¥rštf
(
f’ame
,"pinocchio.%6.4f.%s.snapshot.out",

244 
ouuts
.
z
[
iout
],
·¿ms
.
RunFÏg
);

246 ià(!
ThisTask
)

247 
	`´štf
("[%s] Task 0 wÈwr™%d…¬tişe š sÇpshÙ f%s\n",
	`fd©e
(),
NInFe
,
f’ame
);

249 iàĞ(
fe
=
	`fİ’
(
f’ame
,"w"))==0x0)

251 
	`´štf
("E¼Ü oÀTask 0: cªnÙ o³Àf%s\n",
f’ame
);

256 
	`mem£t
(&
H—d”
, 0, (
SÇpshÙH—d”_d©a
));

258 
H—d”
.
NP¬t
[1]=
NInFe
;

259 
H—d”
.
Mass
[1]=
·¿ms
.
P¬tişeMass
*·¿ms.
HubbË100
*1e-10;

260 
H—d”
.
NP¬tTÙ®
[1]=()Ğ(
myNtÙ®
<<32) >>32 );

261 
H—d”
.
Å¬tTÙ®HighWÜd
[1]=()(
myNtÙ®
>>32);

262 
H—d”
.
Time
=1./(1+
ouuts
.
z
[
iout
]);

263 
H—d”
.
RedShiá
=
ouuts
.
z
[
iout
];

264 
H—d”
.
æag_sä
=0;

265 
H—d”
.
æag_ãedback
=0;

266 
H—d”
.
æag_coŞšg
=0;

267 
H—d”
.
num_fes
=
·¿ms
.
NumFes
;

268 
H—d”
.
BoxSize
=
·¿ms
.
BoxSize_h100
;

269 #ifdeà
POS_IN_KPC


270 
H—d”
.
BoxSize
*=1000.;

272 
H—d”
.
Omega0
=
·¿ms
.Omega0;

273 
H—d”
.
OmegaLambda
=
·¿ms
.OmegaLambda;

274 
H—d”
.
HubbËP¬am
=
·¿ms
.
HubbË100
;

275 
H—d”
.
æag_¡–Ï¿ge
=0;

276 
H—d”
.
æag_m‘®s
=0;

277 
H—d”
.
æag_’Œİy_š¡—d_u
=0;

278 
H—d”
.
æag_m‘®coŞšg
=0;

279 
H—d”
.
æag_¡–Ï»vŞutiÚ
=0;

281 
dummy
=(
SÇpshÙH—d”_d©a
);

282 
	`Wr™eBlockName
(
fe
,
dummy
,"HEAD");

283 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

284 
	`fwr™e
(&
H—d”
, 
dummy
, 1, 
fe
);

285 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

287 #ifdeà
WRITE_INFO_BLOCK


289 
	`mem£t
(&
InfoBlock
, 0, 
NBLOCKS
*(
InfoBlock_d©a
));

291 
tb
=0;

292 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"ID ",4);

293 #ifdeà
LONGIDS


294 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"LLONG ",8);

296 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"LONG ",8);

298 
InfoBlock
[
tb
].
ndim
=1;

299 
i
=0; i<6; i++)

300 
InfoBlock
[
tb
].
aùive
[
i
]=1;

301 ià(!
ThisTask
)

302 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

303 
InfoBlock
[
tb
].
Çme
,

304 
InfoBlock
[
tb
].
ty³
,

305 
InfoBlock
[
tb
].
ndim
,

306 
InfoBlock
[
tb
].
aùive
[0],

307 
InfoBlock
[
tb
].
aùive
[1],

308 
InfoBlock
[
tb
].
aùive
[2],

309 
InfoBlock
[
tb
].
aùive
[3],

310 
InfoBlock
[
tb
].
aùive
[4],

311 
InfoBlock
[
tb
].
aùive
[5]);

312 ++
tb
;

314 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"POS ",4);

315 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"FLOATN ",8);

316 
InfoBlock
[
tb
].
ndim
=3;

317 
i
=0; i<6; i++)

318 
InfoBlock
[
tb
].
aùive
[
i
]=1;

319 ià(!
ThisTask
)

320 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

321 
InfoBlock
[
tb
].
Çme
,

322 
InfoBlock
[
tb
].
ty³
,

323 
InfoBlock
[
tb
].
ndim
,

324 
InfoBlock
[
tb
].
aùive
[0],

325 
InfoBlock
[
tb
].
aùive
[1],

326 
InfoBlock
[
tb
].
aùive
[2],

327 
InfoBlock
[
tb
].
aùive
[3],

328 
InfoBlock
[
tb
].
aùive
[4],

329 
InfoBlock
[
tb
].
aùive
[5]);

330 ++
tb
;

332 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"VEL ",4);

333 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"FLOATN ",8);

334 
InfoBlock
[
tb
].
ndim
=3;

335 
i
=0; i<6; i++)

336 
InfoBlock
[
tb
].
aùive
[
i
]=1;

337 ià(!
ThisTask
)

338 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

339 
InfoBlock
[
tb
].
Çme
,

340 
InfoBlock
[
tb
].
ty³
,

341 
InfoBlock
[
tb
].
ndim
,

342 
InfoBlock
[
tb
].
aùive
[0],

343 
InfoBlock
[
tb
].
aùive
[1],

344 
InfoBlock
[
tb
].
aùive
[2],

345 
InfoBlock
[
tb
].
aùive
[3],

346 
InfoBlock
[
tb
].
aùive
[4],

347 
InfoBlock
[
tb
].
aùive
[5]);

348 ++
tb
;

350 #iâdeà
ONLY_LPT_DISPLACEMENTS


351 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"GRID",4);

352 #ifdeà
LONGIDS


353 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"LLONG ",8);

355 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"LONG ",8);

357 
InfoBlock
[
tb
].
ndim
=1;

358 
i
=0; i<6; i++)

359 
InfoBlock
[
tb
].
aùive
[
i
]=1;

360 ià(!
ThisTask
)

361 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

362 
InfoBlock
[
tb
].
Çme
,

363 
InfoBlock
[
tb
].
ty³
,

364 
InfoBlock
[
tb
].
ndim
,

365 
InfoBlock
[
tb
].
aùive
[0],

366 
InfoBlock
[
tb
].
aùive
[1],

367 
InfoBlock
[
tb
].
aùive
[2],

368 
InfoBlock
[
tb
].
aùive
[3],

369 
InfoBlock
[
tb
].
aùive
[4],

370 
InfoBlock
[
tb
].
aùive
[5]);

371 ++
tb
;

373 #ifdeà
WRITE_FMAX_TO_SNAPSHOT


374 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"FMAX",4);

375 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"FLOAT ",8);

376 
InfoBlock
[
tb
].
ndim
=1;

377 
i
=0; i<6; i++)

378 
InfoBlock
[
tb
].
aùive
[
i
]=1;

379 ià(!
ThisTask
)

380 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

381 
InfoBlock
[
tb
].
Çme
,

382 
InfoBlock
[
tb
].
ty³
,

383 
InfoBlock
[
tb
].
ndim
,

384 
InfoBlock
[
tb
].
aùive
[0],

385 
InfoBlock
[
tb
].
aùive
[1],

386 
InfoBlock
[
tb
].
aùive
[2],

387 
InfoBlock
[
tb
].
aùive
[3],

388 
InfoBlock
[
tb
].
aùive
[4],

389 
InfoBlock
[
tb
].
aùive
[5]);

390 ++
tb
;

392 
	`my_¡rıy
(
InfoBlock
[
tb
].
Çme
,"RMAX",4);

393 
	`my_¡rıy
(
InfoBlock
[
tb
].
ty³
,"LONG ",8);

394 
InfoBlock
[
tb
].
ndim
=1;

395 
i
=0; i<6; i++)

396 
InfoBlock
[
tb
].
aùive
[
i
]=1;

397 ià(!
ThisTask
)

398 
	`´štf
("name=%s,ype=%s,‚dim=%d,‡ctive=[%d,%d,%d,%d,%d,%d]\n",

399 
InfoBlock
[
tb
].
Çme
,

400 
InfoBlock
[
tb
].
ty³
,

401 
InfoBlock
[
tb
].
ndim
,

402 
InfoBlock
[
tb
].
aùive
[0],

403 
InfoBlock
[
tb
].
aùive
[1],

404 
InfoBlock
[
tb
].
aùive
[2],

405 
InfoBlock
[
tb
].
aùive
[3],

406 
InfoBlock
[
tb
].
aùive
[4],

407 
InfoBlock
[
tb
].
aùive
[5]);

408 ++
tb
;

413 
dummy
=
NBLOCKS
*(
InfoBlock_d©a
);

414 
	`Wr™eBlockName
(
fe
,
dummy
,"INFO");

415 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

416 
	`fwr™e
(&
InfoBlock
, 
dummy
, 1, 
fe
);

417 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

423 
ID
 = (
MYIDTYPE
*)
	`m®loc
(
myN·¹
 * (MYIDTYPE));

425 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

428 
kbox
=
i
/
Lgridxy
;

429 
kk
=
i
-
kbox
*
Lgridxy
;

430 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

431 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

432 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

433 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

434 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

435 ià(
good_·¹işe


436 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

437 && 
group_ID
[
i
]<=
FILAMENT


442 
glob®_x
 = 
ibox
 + 
subbox
.
¡abl_x
;

443 ià(
glob®_x
<0èglob®_x+=
MyGrids
[0].
GSglob®
[
_x_
];

444 ià(
glob®_x
>=
MyGrids
[0].
GSglob®
[
_x_
]) global_x-=MyGrids[0].GSglobal[_x_];

445 
glob®_y
 = 
jbox
 + 
subbox
.
¡abl_y
;

446 ià(
glob®_y
<0èglob®_y+=
MyGrids
[0].
GSglob®
[
_y_
];

447 ià(
glob®_y
>=
MyGrids
[0].
GSglob®
[
_y_
]) global_y-=MyGrids[0].GSglobal[_y_];

448 
glob®_z
 = 
kbox
 + 
subbox
.
¡abl_z
;

449 ià(
glob®_z
<0èglob®_z+=
MyGrids
[0].
GSglob®
[
_z_
];

450 ià(
glob®_z
>=
MyGrids
[0].
GSglob®
[
_z_
]) global_z-=MyGrids[0].GSglobal[_z_];

451 #ifdeà
ROTATE_BOX


452 
ID
[
šdex
]=1+(
MYIDTYPE
)
glob®_x
 +

453 Ğ(
MYIDTYPE
)
glob®_z
 +

454 (
MYIDTYPE
)
glob®_y
 * (MYIDTYPE)
MyGrids
[0].
GSglob®
[
_z_
] ) *

455 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

457 
ID
[
šdex
]=1+(
MYIDTYPE
)
glob®_x
 +

458 Ğ(
MYIDTYPE
)
glob®_y
 +

459 (
MYIDTYPE
)
glob®_z
 * (MYIDTYPE)
MyGrids
[0].
GSglob®
[
_y_
] ) *

460 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

462 ++
šdex
;

466 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

468 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

469 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

471 
Ãxt
=
groups
[
i
].
pošt
;

472 
Å¬t
=0;‚·¹<
groups
[
i
].
Mass
;‚part++)

474 
kbox
=
Ãxt
/
Lgridxy
;

475 
kk
=
Ãxt
-
kbox
*
Lgridxy
;

476 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

477 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

479 
glob®_x
 = 
ibox
 + 
subbox
.
¡abl_x
;

480 ià(
glob®_x
<0èglob®_x+=
MyGrids
[0].
GSglob®
[
_x_
];

481 ià(
glob®_x
>=
MyGrids
[0].
GSglob®
[
_x_
]) global_x-=MyGrids[0].GSglobal[_x_];

482 
glob®_y
 = 
jbox
 + 
subbox
.
¡abl_y
;

483 ià(
glob®_y
<0èglob®_y+=
MyGrids
[0].
GSglob®
[
_y_
];

484 ià(
glob®_y
>=
MyGrids
[0].
GSglob®
[
_y_
]) global_y-=MyGrids[0].GSglobal[_y_];

485 
glob®_z
 = 
kbox
 + 
subbox
.
¡abl_z
;

486 ià(
glob®_z
<0èglob®_z+=
MyGrids
[0].
GSglob®
[
_z_
];

487 ià(
glob®_z
>=
MyGrids
[0].
GSglob®
[
_z_
]) global_z-=MyGrids[0].GSglobal[_z_];

488 #ifdeà
ROTATE_BOX


489 
ID
[
šdex
]=1+(
MYIDTYPE
)
glob®_x
 +

490 Ğ(
MYIDTYPE
)
glob®_z
 +

491 (
MYIDTYPE
)
glob®_y
 * (MYIDTYPE)
MyGrids
[0].
GSglob®
[
_z_
] ) *

492 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

494 
ID
[
šdex
]=1+(
MYIDTYPE
)
glob®_x
 +

495 Ğ(
MYIDTYPE
)
glob®_y
 +

496 (
MYIDTYPE
)
glob®_z
 * (MYIDTYPE)
MyGrids
[0].
GSglob®
[
_y_
] ) *

497 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

499 ++
šdex
;

500 
Ãxt
=
lškšg_li¡
[next];

507 ià(
ThisTask
==
cŞËùÜ
)

509 
dummy
=
NInFe
*(
MYIDTYPE
);

510 
	`Wr™eBlockName
(
fe
,
dummy
,"ID ");

511 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

512 
	`fwr™e
(
ID
, (
MYIDTYPE
), 
myN·¹
, 
fe
);

513 
	`ä“
(
ID
);

516 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

518 
™ask
=
cŞËùÜ
+
Ãxt
;

519 ià(
ThisTask
==
cŞËùÜ
)

521 
Å¬t
=0;

522 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

523 
ID
=(
MYIDTYPE
*)
	`m®loc
(
Å¬t
 * (MYIDTYPE));

524 
	`MPI_Recv
(
ID
, 
Å¬t
*(
MYIDTYPE
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

525 
	`fwr™e
(
ID
, (
MYIDTYPE
), 
Å¬t
, 
fe
);

526 
	`ä“
(
ID
);

528 ià(
ThisTask
==
™ask
)

530 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

531 
	`MPI_S’d
(
ID
, 
myN·¹
*(
MYIDTYPE
), 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

532 
	`ä“
(
ID
);

537 ià(
ThisTask
==
cŞËùÜ
)

538 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

542 
Pos
 = (
AuxSŒuù
 *)
	`ÿÎoc
(
myN·¹
 , (AuxStruct));

545 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

548 
kbox
=
i
/
Lgridxy
;

549 
kk
=
i
-
kbox
*
Lgridxy
;

550 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

551 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

552 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

553 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

554 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

555 ià(
good_·¹işe


556 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

557 && 
group_ID
[
i
]<=
FILAMENT


562 
glob®_x
 = 
ibox
 + 
subbox
.
¡abl_x
;

563 ià(
glob®_x
<0èglob®_x+=
MyGrids
[0].
GSglob®
[
_x_
];

564 ià(
glob®_x
>=
MyGrids
[0].
GSglob®
[
_x_
]) global_x-=MyGrids[0].GSglobal[_x_];

565 
glob®_y
 = 
jbox
 + 
subbox
.
¡abl_y
;

566 ià(
glob®_y
<0èglob®_y+=
MyGrids
[0].
GSglob®
[
_y_
];

567 ià(
glob®_y
>=
MyGrids
[0].
GSglob®
[
_y_
]) global_y-=MyGrids[0].GSglobal[_y_];

568 
glob®_z
 = 
kbox
 + 
subbox
.
¡abl_z
;

569 ià(
glob®_z
<0èglob®_z+=
MyGrids
[0].
GSglob®
[
_z_
];

570 ià(
glob®_z
>=
MyGrids
[0].
GSglob®
[
_z_
]) global_z-=MyGrids[0].GSglobal[_z_];

574 #ifdeà
FORCE_PARTICLE_NUMBER


575 ià(
group_ID
[
i
]<=
FILAMENT
)

578 
	`£t_pošt
(
glob®_x
,
glob®_y
,
glob®_z
,
i
,
ouuts
.
F
[
iout
],&
obj
);

579 
j
=0; j<3; j++)

581 
Pos
[
šdex
].
axis
[
j
]=()(
	`q2x
(
rÙ
[j], &
obj
, 
ORDER_FOR_CATALOG
) *

582 
·¿ms
.
IÁ”P¬tDi¡
 *…¬ams.
HubbË100
);

583 ià(
Pos
[
šdex
].
axis
[
j
] >ğ
·¿ms
.
BoxSize_h100
)

584 
Pos
[
šdex
].
axis
[
j
] -ğ()
·¿ms
.
BoxSize_h100
;

585 ià(
Pos
[
šdex
].
axis
[
j
] < 0.0)

586 
Pos
[
šdex
].
axis
[
j
] +ğ()
·¿ms
.
BoxSize_h100
;

587 #ifdeà
POS_IN_KPC


588 
Pos
[
šdex
].
axis
[
j
] *= 1000.;

591 #ifdeà
FORCE_PARTICLE_NUMBER


595 
	`£t_obj
(
group_ID
[
i
], 
ouuts
.
F
[
iout
], &
obj
);

596 
j
=0; j<3; j++)

597 
MyPos
[
j
]=()((
	`q2x
(
rÙ
[j], &
obj
, 
ORDER_FOR_CATALOG
è+ 
SGrid
[rot[j]]) *

598 
·¿ms
.
IÁ”P¬tDi¡
 *…¬ams.
HubbË100
);

601 
cÚc
 = 
	`pow
(
Dz
,0.54) * 5.9

602 * 
	`pow
Ğ(1.12*pow(
groups
[
group_ID
[
i
]].
Mass
*
·¿ms
.
P¬tişeMass
*·¿ms.
HubbË100


603 /5.e13,0.3è+ 0.53)/
Dz
 , -0.35);

604 
rvœ
 = 
	`pow
(0.01 * 
GRAVITY
 * 
groups
[
group_ID
[
i
]].
Mass
*
·¿ms
.
P¬tişeMass
 /

605 
	`pow
(
	`HubbË
(
ouuts
.
z
[
iout
]),2.0), 1./3.è* (1. + ouuts.z[iout]è* 
·¿ms
.
HubbË100
;

607 
·¹
=0;

610 
ºd
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

611 
nfwçc
 = 
	`log
(1.+
cÚc
)-conc/(1.+conc);

612 
¬—
 = 1.1*
cÚc
/(4.*
nfwçc
);

613 
xºd
 = 
ºd
*
¬—
/(1.1*
cÚc
/(4.*
nfwçc
));

614 
ºd
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

615 
yºd
 = 
ºd
*1.1*
cÚc
*
xºd
/(4.*
nfwçc
);

616 
´obfunc
 = 
cÚc
*cÚc*
xºd
/
	`pow
(1.+cÚc*xºd,2)/
nfwçc
;

617 ià(
yºd
 <ğ
´obfunc
)

620 
u
 = -1.+2.*
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

621 
th‘a
 = 2.*
PI
*
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

623 
Pos
[
šdex
].
axis
[0] = 
MyPos
[0] + ()(
xºd
 * 
rvœ
 * 
	`sq¹
(1.-
u
*u)*
	`cos
(
th‘a
));

624 
Pos
[
šdex
].
axis
[1] = 
MyPos
[1] + ()(
xºd
 * 
rvœ
 * 
	`sq¹
(1.-
u
*u)*
	`sš
(
th‘a
));

625 
Pos
[
šdex
].
axis
[2] = 
MyPos
[2] + ()(
xºd
 * 
rvœ
 * 
u
);

627 
j
=0; j<3; j++)

629 ià(
Pos
[
šdex
].
axis
[
j
] >ğ
·¿ms
.
BoxSize_h100
)

630 
Pos
[
šdex
].
axis
[
j
] -ğ()
·¿ms
.
BoxSize_h100
;

631 ià(
Pos
[
šdex
].
axis
[
j
] < 0.0)

632 
Pos
[
šdex
].
axis
[
j
] +ğ()
·¿ms
.
BoxSize_h100
;

633 #ifdeà
POS_IN_KPC


634 
Pos
[
šdex
].
axis
[
j
] *= 1000.;

637 
·¹
=1;

640 
·¹
==0);

644 ++
šdex
;

649 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

651 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

652 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

655 
	`£t_obj
(
i
, 
ouuts
.
F
[
iout
], &
obj
);

656 
j
=0; j<3; j++)

657 
MyPos
[
j
]=()((
	`q2x
(
rÙ
[j], &
obj
, 
ORDER_FOR_CATALOG
è+ 
SGrid
[rot[j]]) *

658 
·¿ms
.
IÁ”P¬tDi¡
 *…¬ams.
HubbË100
);

662 
cÚc
 = 
	`pow
(
Dz
,0.54) * 5.9

663 * 
	`pow
Ğ(1.12*pow(
groups
[
i
].
Mass
*
·¿ms
.
P¬tişeMass
*·¿ms.
HubbË100
 /5.e13,0.3)+ 0.53)/
Dz
 ,

665 
rvœ
 = 
	`pow
(0.01 * 
GRAVITY
 * 
groups
[
i
].
Mass
*
·¿ms
.
P¬tişeMass
 /

666 
	`pow
(
	`HubbË
(
ouuts
.
z
[
iout
]),2.0), 1./3.è* (1. + ouuts.z[iout]è* 
·¿ms
.
HubbË100
;

669 
·¹
=0;

672 
ºd
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

673 
nfwçc
 = 
	`log
(1.+
cÚc
)-conc/(1.+conc);

674 
¬—
 = 1.1*
cÚc
/(4.*
nfwçc
);

675 
xºd
 = 
ºd
*
¬—
/(1.1*
cÚc
/(4.*
nfwçc
));

676 
ºd
 = 
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

677 
yºd
 = 
ºd
*1.1*
cÚc
*
xºd
/(4.*
nfwçc
);

678 
´obfunc
 = 
cÚc
*cÚc*
xºd
/
	`pow
(1.+cÚc*xºd,2)/
nfwçc
;

679 ià(
yºd
 <ğ
´obfunc
)

682 
u
 = -1.+2.*
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

683 
th‘a
 = 2.*
PI
*
	`g¦_ºg_unifÜm
(
¿ndom_g’”©Ü
);

685 
Pos
[
šdex
].
axis
[0] = 
MyPos
[0] + ()(
xºd
 * 
rvœ
 * 
	`sq¹
(1.-
u
*u)*
	`cos
(
th‘a
));

686 
Pos
[
šdex
].
axis
[1] = 
MyPos
[1] + ()(
xºd
 * 
rvœ
 * 
	`sq¹
(1.-
u
*u)*
	`sš
(
th‘a
));

687 
Pos
[
šdex
].
axis
[2] = 
MyPos
[2] + ()(
xºd
 * 
rvœ
 * 
u
);

689 
j
=0; j<3; j++)

691 ià(
Pos
[
šdex
].
axis
[
j
] >ğ
·¿ms
.
BoxSize_h100
)

692 
Pos
[
šdex
].
axis
[
j
] -ğ()
·¿ms
.
BoxSize_h100
;

693 ià(
Pos
[
šdex
].
axis
[
j
] < 0.0)

694 
Pos
[
šdex
].
axis
[
j
] +ğ()
·¿ms
.
BoxSize_h100
;

695 #ifdeà
POS_IN_KPC


696 
Pos
[
šdex
].
axis
[
j
] *= 1000.;

699 
šdex
++;

700 
·¹
++;

703 
·¹
<
groups
[
i
].
Mass
);

708 ià(
ThisTask
==
cŞËùÜ
)

710 
dummy
=
NInFe
*(
AuxSŒuù
);

711 
	`Wr™eBlockName
(
fe
,
dummy
,"POS ");

712 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

713 
	`fwr™e
(
Pos
, (
AuxSŒuù
), 
myN·¹
, 
fe
);

714 
	`ä“
(
Pos
);

717 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

719 
™ask
=
cŞËùÜ
+
Ãxt
;

720 ià(
ThisTask
==
cŞËùÜ
)

722 
Å¬t
=0;

723 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

724 
Pos
 = (
AuxSŒuù
 *)
	`m®loc
(
Å¬t
 * (AuxStruct));

725 
	`MPI_Recv
(
Pos
, 
Å¬t
*(
AuxSŒuù
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

726 
	`fwr™e
(
Pos
, (
AuxSŒuù
), 
Å¬t
, 
fe
);

727 
	`ä“
(
Pos
);

729 ià(
ThisTask
==
™ask
)

731 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

732 
	`MPI_S’d
(
Pos
, (
AuxSŒuù
)*
myN·¹
, 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

733 
	`ä“
(
Pos
);

738 ià(
ThisTask
==
cŞËùÜ
)

739 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

743 
V–
 = (
AuxSŒuù
 *)
	`m®loc
(
myN·¹
 * (AuxStruct));

744 
vçù
=
	`sq¹
(1.+
ouuts
.
z
[
iout
]);

746 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

749 
kbox
=
i
/
Lgridxy
;

750 
kk
=
i
-
kbox
*
Lgridxy
;

751 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

752 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

753 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

754 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

755 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

756 ià(
good_·¹işe


757 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

758 && 
group_ID
[
i
]<=
FILAMENT


763 
glob®_x
 = 
ibox
 + 
subbox
.
¡abl_x
;

764 ià(
glob®_x
<0èglob®_x+=
MyGrids
[0].
GSglob®
[
_x_
];

765 ià(
glob®_x
>=
MyGrids
[0].
GSglob®
[
_x_
]) global_x-=MyGrids[0].GSglobal[_x_];

766 
glob®_y
 = 
jbox
 + 
subbox
.
¡abl_y
;

767 ià(
glob®_y
<0èglob®_y+=
MyGrids
[0].
GSglob®
[
_y_
];

768 ià(
glob®_y
>=
MyGrids
[0].
GSglob®
[
_y_
]) global_y-=MyGrids[0].GSglobal[_y_];

769 
glob®_z
 = 
kbox
 + 
subbox
.
¡abl_z
;

770 ià(
glob®_z
<0èglob®_z+=
MyGrids
[0].
GSglob®
[
_z_
];

771 ià(
glob®_z
>=
MyGrids
[0].
GSglob®
[
_z_
]) global_z-=MyGrids[0].GSglobal[_z_];

775 #ifdeà
FORCE_PARTICLE_NUMBER


776 ià(
group_ID
[
i
]<=
FILAMENT
)

779 
	`£t_pošt
(
glob®_x
,
glob®_y
,
glob®_z
,
i
,
ouuts
.
F
[
iout
],&
obj
);

780 
j
=0; j<3; j++)

782 
V–
[
šdex
].
axis
[
j
]=()(
	`v–
(
rÙ
[j], &
obj
)*
vçù
);

783 #ifdeà
FORCE_PARTICLE_NUMBER


788 
	`£t_obj
(
group_ID
[
i
], 
ouuts
.
F
[
iout
], &
obj
);

789 
j
=0; j<3; j++)

790 
MyV–
[
j
]=()(
	`v–
(
rÙ
[j], &
obj
)*
vçù
);

792 
sigma
 = 
	`sq¹
(
GRAVITY
 * 
groups
[
group_ID
[
i
]].
Mass
 * 
·¿ms
.
P¬tişeMass
 / 3./ 
rvœ
);

794 
j
=0; j<3; j++)

795 
V–
[
šdex
].
axis
[
j
]=
MyV–
[j] + 
	`g¦_¿n_gaussŸn
(
¿ndom_g’”©Ü
, 
sigma
è* 
vçù
;

798 ++
šdex
;

803 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

805 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

806 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

809 
	`£t_obj
(
i
, 
ouuts
.
F
[
iout
], &
obj
);

810 
j
=0; j<3; j++)

811 
MyV–
[
j
]=()(
	`v–
(
rÙ
[j], &
obj
)*
vçù
);

818 
sigma
 = 
	`sq¹
(
GRAVITY
 * 
groups
[
i
].
Mass
 * 
·¿ms
.
P¬tişeMass
 / 3./ 
rvœ
);

820 
Å¬t
=0;‚·¹<
groups
[
i
].
Mass
;‚part++)

822 
j
=0; j<3; j++)

823 
V–
[
šdex
].
axis
[
j
]=
MyV–
[j] + 
	`g¦_¿n_gaussŸn
(
¿ndom_g’”©Ü
, 
sigma
è* 
vçù
;

824 ++
šdex
;

830 ià(
ThisTask
==
cŞËùÜ
)

832 
dummy
=
NInFe
*(
AuxSŒuù
);

833 
	`Wr™eBlockName
(
fe
,
dummy
,"VEL ");

834 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

835 
	`fwr™e
(
V–
, (
AuxSŒuù
), 
myN·¹
, 
fe
);

836 
	`ä“
(
V–
);

839 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

841 
™ask
=
cŞËùÜ
+
Ãxt
;

842 ià(
ThisTask
==
cŞËùÜ
)

844 
Å¬t
=0;

845 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

846 
V–
 = (
AuxSŒuù
 *)
	`m®loc
(
Å¬t
 * (AuxStruct));

847 
	`MPI_Recv
(
V–
, 
Å¬t
*(
AuxSŒuù
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

848 
	`fwr™e
(
V–
, (
AuxSŒuù
), 
Å¬t
, 
fe
);

849 
	`ä“
(
V–
);

851 ià(
ThisTask
==
™ask
)

853 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

854 
	`MPI_S’d
(
V–
, (
AuxSŒuù
)*
myN·¹
, 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

855 
	`ä“
(
V–
);

860 ià(
ThisTask
==
cŞËùÜ
)

861 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

864 #iâdeà
ONLY_LPT_DISPLACEMENTS


866 
GRID
 = (
MYIDTYPE
*)
	`m®loc
(
myN·¹
 * (MYIDTYPE));

868 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

871 
kbox
=
i
/
Lgridxy
;

872 
kk
=
i
-
kbox
*
Lgridxy
;

873 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

874 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

875 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

876 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

877 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

878 #iâdeà
FORCE_PARTICLE_NUMBER


879 ià(
group_ID
[
i
]<=
FILAMENT
 && 
good_·¹işe
)

880 
GRID
[
šdex
++]=
group_ID
[
i
];

882 ià(
good_·¹işe
)

884 ià(
group_ID
[
i
]<=
FILAMENT
)

885 
GRID
[
šdex
++]=
group_ID
[
i
];

887 
GRID
[
šdex
++]=
groups
[
group_ID
[
i
]].
Çme
;

893 #iâdeà
FORCE_PARTICLE_NUMBER


895 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

896 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

898 
Ãxt
=
groups
[
i
].
pošt
;

899 
Å¬t
=0;‚·¹<
groups
[
i
].
Mass
;‚part++)

901 
GRID
[
šdex
++]=
groups
[
i
].
Çme
;

902 
Ãxt
=
lškšg_li¡
[next];

908 ià(
ThisTask
==
cŞËùÜ
)

910 
dummy
=
NInFe
*(
MYIDTYPE
);

911 
	`Wr™eBlockName
(
fe
,
dummy
,"GRID");

912 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

913 
	`fwr™e
(
GRID
, (
MYIDTYPE
), 
myN·¹
, 
fe
);

914 
	`ä“
(
GRID
);

917 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

919 
™ask
=
cŞËùÜ
+
Ãxt
;

920 ià(
ThisTask
==
cŞËùÜ
)

922 
Å¬t
=0;

923 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

924 
GRID
=(
MYIDTYPE
*)
	`m®loc
(
Å¬t
 * (MYIDTYPE));

925 
	`MPI_Recv
(
GRID
, 
Å¬t
*(
MYIDTYPE
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

926 
	`fwr™e
(
GRID
, (
MYIDTYPE
), 
Å¬t
, 
fe
);

927 
	`ä“
(
GRID
);

929 ià(
ThisTask
==
™ask
)

931 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

932 
	`MPI_S’d
(
GRID
, 
myN·¹
*(
MYIDTYPE
), 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

933 
	`ä“
(
GRID
);

938 ià(
ThisTask
==
cŞËùÜ
)

939 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

941 #ifdeà
WRITE_FMAX_TO_SNAPSHOT


944 
FMAX
 = (*)
	`m®loc
(
myN·¹
 * ());

946 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

949 
kbox
=
i
/
Lgridxy
;

950 
kk
=
i
-
kbox
*
Lgridxy
;

951 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

952 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

953 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

954 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

955 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

956 ià(
good_·¹işe


957 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

958 && 
group_ID
[
i
]<=
FILAMENT


961 
FMAX
[
šdex
++]=
äag
[
i
].
Fmax
;

964 #iâdeà
FORCE_PARTICLE_NUMBER


966 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

967 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

969 
Ãxt
=
groups
[
i
].
pošt
;

970 
Å¬t
=0;‚·¹<
groups
[
i
].
Mass
;‚part++)

972 
FMAX
[
šdex
++]=
äag
[
Ãxt
].
Fmax
;

973 
Ãxt
=
lškšg_li¡
[next];

979 ià(
ThisTask
==
cŞËùÜ
)

981 
dummy
=
NInFe
*();

982 
	`Wr™eBlockName
(
fe
,
dummy
,"FMAX");

983 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

984 
	`fwr™e
(
FMAX
, (), 
myN·¹
, 
fe
);

985 
	`ä“
(
FMAX
);

988 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

990 
™ask
=
cŞËùÜ
+
Ãxt
;

991 ià(
ThisTask
==
cŞËùÜ
)

993 
Å¬t
=0;

994 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

995 
FMAX
=(*)
	`m®loc
(
Å¬t
 * ());

996 
	`MPI_Recv
(
FMAX
, 
Å¬t
*(), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

997 
	`fwr™e
(
FMAX
, (), 
Å¬t
, 
fe
);

998 
	`ä“
(
FMAX
);

1000 ià(
ThisTask
==
™ask
)

1002 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1003 
	`MPI_S’d
(
FMAX
, 
myN·¹
*(), 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1004 
	`ä“
(
FMAX
);

1009 ià(
ThisTask
==
cŞËùÜ
)

1010 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1015 
RMAX
 = (*)
	`m®loc
(
myN·¹
 * ());

1017 
i
=0, 
šdex
=0; i<
subbox
.
N·¹
; i++)

1020 
kbox
=
i
/
Lgridxy
;

1021 
kk
=
i
-
kbox
*
Lgridxy
;

1022 
jbox
=
kk
/
subbox
.
Lgwbl_x
;

1023 
ibox
=
kk
-
jbox
*
subbox
.
Lgwbl_x
;

1024 
good_·¹işe
 = ( 
ibox
>=
subbox
.
§ã_x
 && ibox<subbox.
Lgwbl_x
-subbox.safe_x &&

1025 
jbox
>=
subbox
.
§ã_y
 && jbox<subbox.
Lgwbl_y
-subbox.safe_y &&

1026 
kbox
>=
subbox
.
§ã_z
 && kbox<subbox.
Lgwbl_z
-subbox.safe_z );

1027 ià(
good_·¹işe


1028 #ià!
	`defšed
(
ONLY_LPT_DISPLACEMENTS
è&& !defšed(
FORCE_PARTICLE_NUMBER
)

1029 && 
group_ID
[
i
]<=
FILAMENT


1032 
RMAX
[
šdex
++]=
äag
[
i
].
Rmax
;

1035 #iâdeà
FORCE_PARTICLE_NUMBER


1037 
i
=
FILAMENT
+1; i<=
ngroups
; i++)

1038 ià(
groups
[
i
].
pošt
 > 0 && groups[i].
good
)

1040 
Ãxt
=
groups
[
i
].
pošt
;

1041 
Å¬t
=0;‚·¹<
groups
[
i
].
Mass
;‚part++)

1043 
RMAX
[
šdex
++]=
äag
[
Ãxt
].
Rmax
;

1044 
Ãxt
=
lškšg_li¡
[next];

1050 ià(
ThisTask
==
cŞËùÜ
)

1052 
dummy
=
NInFe
*();

1053 
	`Wr™eBlockName
(
fe
,
dummy
,"RMAX");

1054 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1055 
	`fwr™e
(
RMAX
, (), 
myN·¹
, 
fe
);

1056 
	`ä“
(
RMAX
);

1059 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

1061 
™ask
=
cŞËùÜ
+
Ãxt
;

1062 ià(
ThisTask
==
cŞËùÜ
)

1064 
Å¬t
=0;

1065 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1066 
RMAX
=(*)
	`m®loc
(
Å¬t
 * ());

1067 
	`MPI_Recv
(
RMAX
, 
Å¬t
*(), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1068 
	`fwr™e
(
RMAX
, (), 
Å¬t
, 
fe
);

1069 
	`ä“
(
RMAX
);

1071 ià(
ThisTask
==
™ask
)

1073 
	`MPI_S’d
(&
myN·¹
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1074 
	`MPI_S’d
(
RMAX
, 
myN·¹
*(), 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1075 
	`ä“
(
RMAX
);

1080 ià(
ThisTask
==
cŞËùÜ
)

1081 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1089 ià(
ThisTask
==
cŞËùÜ
)

1090 
	`fşo£
(
fe
);

1093 
	}
}

1095 
	$wr™e_LPT_¢­shÙ
(
»dshiá
)

1099 
NTasksP”Fe
,
cŞËùÜ
,
™ask
,
Ãxt
,
ThisFe
,
šdex
,
x
,
y
,
z
,
NInFe
,
Å¬t
,
i
,
dummy
;

1100 
SGrid
[3],
Q
[3];

1101 
NP¬tTÙ
;

1102 
vf
, 
G
;

1103 
f’ame
[
BLENGTH
];

1104 
FILE
 *
fe
;

1105 
SÇpshÙH—d”_d©a
 
H—d”
;

1106 
MYIDTYPE
 *
ID
;

1107 
MPI_Stus
 
¡©us
;

1110 
axis
[3];

1111 } 
	tAuxSŒuù
;

1113 
AuxSŒuù
 *
Pos
,*
V–
;

1115 #ifdeà
WRITE_INFO_BLOCK


1116 
InfoBlock_d©a
 
InfoBlock
[3];

1119 #ifdeà
TWO_LPT


1120 
vf2
,
G2
;

1121 #ifdeà
THREE_LPT


1122 
G31
,
G32
;

1125 #ifdeà
ROTATE_BOX


1126 
rÙ
[3]={1,2,0};

1128 
rÙ
[3]={0,1,2};

1131 
NTasksP”Fe
=
NTasks
/
·¿ms
.
NumFes
;

1132 
ThisFe
=
ThisTask
/
NTasksP”Fe
;

1133 
cŞËùÜ
=
ThisFe
*
NTasksP”Fe
;

1135 #ifdeà
SCALE_DEPENDENT_GROWTH


1136 
SDGM
.
æag
=1;

1137 
SDGM
.
ismoÙh
=
SmoÙhšg
.
NsmoÙh
-1;

1141 
G
=
	`GrowšgMode
(
»dshiá
);

1142 
vf
 = 
·¿ms
.
IÁ”P¬tDi¡
*
	`fomega
(
»dshiá
)*
	`HubbË
Ôedshiá)/
	`sq¹
(1.+»dshiáè* 
G
;

1143 #ifdeà
TWO_LPT


1144 
G2
 = 
	`GrowšgMode_2LPT
(
»dshiá
);

1145 
vf2
 = 
·¿ms
.
IÁ”P¬tDi¡
*
	`fomega_2LPT
(
»dshiá
)*
	`HubbË
Ôedshiá)/
	`sq¹
(1.+»dshiáè* 
G2
;

1146 #ifdeà
THREE_LPT


1147 
G31
 = 
	`GrowšgMode_3LPT_1
(
»dshiá
);

1148 
G32
 = 
	`GrowšgMode_3LPT_2
(
»dshiá
);

1151 
SGrid
[0]=()
MyGrids
[0].
GS¡¬t
[
_x_
];

1152 
SGrid
[1]=()
MyGrids
[0].
GS¡¬t
[
_y_
];

1153 
SGrid
[2]=()
MyGrids
[0].
GS¡¬t
[
_z_
];

1155 
NP¬tTÙ
 = ()
MyGrids
[0].
GSglob®
[
_x_
] *

1156 ()
MyGrids
[0].
GSglob®
[
_y_
] *

1157 ()
MyGrids
[0].
GSglob®
[
_z_
];

1160 
Ãxt
=0;‚ext<
NTasksP”Fe
;‚ext++)

1162 
™ask
=
cŞËùÜ
+
Ãxt
;

1163 ià(!
Ãxt
)

1165 ià(
ThisTask
==
cŞËùÜ
)

1166 
NInFe
=
MyGrids
[0].
tÙ®_loÿl_size
;

1170 ià(
ThisTask
==
cŞËùÜ
)

1172 
Å¬t
=0;

1173 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1174 
NInFe
+=
Å¬t
;

1176 ià(
ThisTask
==
™ask
)

1177 
	`MPI_S’d
(&
MyGrids
[0].
tÙ®_loÿl_size
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1183 ià(
ThisTask
==
cŞËùÜ
)

1185 ià(
·¿ms
.
NumFes
>1)

1186 
	`¥rštf
(
f’ame
,"pinocchioICs.%6.4f.%s.%d",

1187 
»dshiá
,
·¿ms
.
RunFÏg
,
ThisFe
);

1189 
	`¥rštf
(
f’ame
,"pinocchioICs.%6.4f.%s",

1190 
»dshiá
,
·¿ms
.
RunFÏg
);

1192 ià(!
ThisTask
)

1193 
	`´štf
("[%s] Wr™šg f%s\n",
	`fd©e
(),
f’ame
);

1195 iàĞ(
fe
=
	`fİ’
(
f’ame
,"w"))==0x0)

1197 
	`´štf
("E¼Ü oÀTask 0: cªnÙ o³Àf%s\n",
f’ame
);

1202 
	`mem£t
(&
H—d”
, 0, (
SÇpshÙH—d”_d©a
));

1204 
H—d”
.
NP¬t
[1]=
NInFe
;

1205 
H—d”
.
Mass
[1]=
·¿ms
.
P¬tişeMass
*·¿ms.
HubbË100
*1e-10;

1206 
H—d”
.
NP¬tTÙ®
[1]=()Ğ(
NP¬tTÙ
<<32) >>32 );

1207 
H—d”
.
Å¬tTÙ®HighWÜd
[1]=()(
NP¬tTÙ
>>32);

1208 
H—d”
.
Time
=1./(1+
»dshiá
);

1209 
H—d”
.
RedShiá
=
»dshiá
;

1210 
H—d”
.
æag_sä
=0;

1211 
H—d”
.
æag_ãedback
=0;

1212 
H—d”
.
æag_coŞšg
=0;

1213 
H—d”
.
num_fes
=
·¿ms
.
NumFes
;

1214 
H—d”
.
BoxSize
=
·¿ms
.
BoxSize_h100
;

1215 
H—d”
.
Omega0
=
·¿ms
.Omega0;

1216 
H—d”
.
OmegaLambda
=
·¿ms
.OmegaLambda;

1217 
H—d”
.
HubbËP¬am
=
·¿ms
.
HubbË100
;

1218 
H—d”
.
æag_¡–Ï¿ge
=0;

1219 
H—d”
.
æag_m‘®s
=0;

1220 
H—d”
.
æag_’Œİy_š¡—d_u
=0;

1221 
H—d”
.
æag_m‘®coŞšg
=0;

1222 
H—d”
.
æag_¡–Ï»vŞutiÚ
=0;

1224 
dummy
=(
SÇpshÙH—d”_d©a
);

1225 
	`Wr™eBlockName
(
fe
,
dummy
,"HEAD");

1226 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1227 
	`fwr™e
(&
H—d”
, 
dummy
, 1, 
fe
);

1228 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1229 #ifdeà
WRITE_INFO_BLOCK


1231 
	`mem£t
(&
InfoBlock
, 0, 3*(
InfoBlock_d©a
));

1233 
	`my_¡rıy
(
InfoBlock
[0].
Çme
,"POS ",4);

1234 
	`my_¡rıy
(
InfoBlock
[0].
ty³
,"FLOATN ",8);

1235 
InfoBlock
[0].
ndim
=3;

1236 
i
=0; i<6; i++)

1237 
InfoBlock
[0].
aùive
[
i
]=1;

1239 
	`my_¡rıy
(
InfoBlock
[1].
Çme
,"VEL ",4);

1240 
	`my_¡rıy
(
InfoBlock
[1].
ty³
,"FLOATN ",8);

1241 
InfoBlock
[1].
ndim
=3;

1242 
i
=0; i<6; i++)

1243 
InfoBlock
[1].
aùive
[
i
]=1;

1245 
	`my_¡rıy
(
InfoBlock
[2].
Çme
,"ID ",4);

1246 #ifdeà
LONGIDS


1247 
	`my_¡rıy
(
InfoBlock
[2].
ty³
,"LLONG ",8);

1249 
	`my_¡rıy
(
InfoBlock
[2].
ty³
,"LONG ",8);

1251 
InfoBlock
[2].
ndim
=1;

1252 
i
=0; i<6; i++)

1253 
InfoBlock
[2].
aùive
[
i
]=1;

1255 
dummy
=3*(
InfoBlock_d©a
);

1256 
	`Wr™eBlockName
(
fe
,
dummy
,"INFO");

1257 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1258 
	`fwr™e
(&
InfoBlock
, 
dummy
, 1, 
fe
);

1259 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1266 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1268 
Pos
 = (
AuxSŒuù
 *)
	`m®loc
(
MyGrids
[0].
tÙ®_loÿl_size
 * (AuxStruct));

1270 
z
=0; z<
MyGrids
[0].
GSloÿl
[
_z_
]; z++)

1272 
Q
[2]=
z
;

1273 
y
=0; y<
MyGrids
[0].
GSloÿl
[
_y_
]; y++)

1275 
Q
[1]=
y
;

1276 
x
=0; x<
MyGrids
[0].
GSloÿl
[
_x_
]; x++)

1278 
Q
[0]=
x
;

1280 
šdex
 = 
x
 + 
MyGrids
[0].
GSloÿl
[
_x_
] *(
y
 + 
z
* MyGrids[0].GSloÿl[
_y_
]);

1282 
i
=0; i<3; i++)

1285 
Pos
[
šdex
].
axis
[
i
] = ()(Ğ()(
Q
[
rÙ
[i]]+
SGrid
[rÙ[i]]è+ 
G
*
VEL_fÜ_di¥l
[rot[i]][index] )

1286 * 
·¿ms
.
IÁ”P¬tDi¡
 *…¬ams.
HubbË100
)

1287 #ifdeà
TWO_LPT


1288 + ()(
G2
 * 
VEL2_fÜ_di¥l
[
rÙ
[
i
]][
šdex
] * 
·¿ms
.
IÁ”P¬tDi¡
 *…¬ams.
HubbË100
)

1289 #ifdeà
THREE_LPT


1295 ià(
Pos
[
šdex
].
axis
[
i
] < 0èPos[šdex].axis[i] +ğ()
·¿ms
.
BoxSize_h100
;

1296 ià(
Pos
[
šdex
].
axis
[
i
] >ğ
·¿ms
.
BoxSize_h100
) Pos[index].axis[i] -= ()params.BoxSize_h100;

1304 ià(
ThisTask
==
cŞËùÜ
)

1306 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1308 
dummy
=
NInFe
*(
AuxSŒuù
);

1309 
	`Wr™eBlockName
(
fe
,
dummy
,"POS ");

1310 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1311 
	`fwr™e
(
Pos
, (
AuxSŒuù
), 
MyGrids
[0].
tÙ®_loÿl_size
, 
fe
);

1312 
	`ä“
(
Pos
);

1316 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

1318 
™ask
=
cŞËùÜ
+
Ãxt
;

1319 ià(
ThisTask
==
cŞËùÜ
)

1321 
Å¬t
=0;

1322 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1323 ià(
Å¬t
)

1325 
Pos
 = (
AuxSŒuù
 *)
	`m®loc
(
Å¬t
 * (AuxStruct));

1326 
	`MPI_Recv
(
Pos
, 
Å¬t
*(
AuxSŒuù
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1327 
	`fwr™e
(
Pos
, (
AuxSŒuù
), 
Å¬t
, 
fe
);

1328 
	`ä“
(
Pos
);

1331 ià(
ThisTask
==
™ask
)

1333 
	`MPI_S’d
(&
MyGrids
[0].
tÙ®_loÿl_size
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1334 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1336 
	`MPI_S’d
(
Pos
, (
AuxSŒuù
)*
MyGrids
[0].
tÙ®_loÿl_size
, 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1337 
	`ä“
(
Pos
);

1343 ià(
ThisTask
==
cŞËùÜ
)

1344 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1347 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1349 
V–
 = (
AuxSŒuù
 *)
	`m®loc
(
MyGrids
[0].
tÙ®_loÿl_size
 * (AuxStruct));

1351 
z
=0; z<
MyGrids
[0].
GSloÿl
[
_z_
]; z++)

1352 
y
=0; y<
MyGrids
[0].
GSloÿl
[
_y_
]; y++)

1353 
x
=0; x<
MyGrids
[0].
GSloÿl
[
_x_
]; x++)

1355 
šdex
 = 
x
 + 
MyGrids
[0].
GSloÿl
[
_x_
] *(
y
 + 
z
* MyGrids[0].GSloÿl[
_y_
]);

1357 
i
=0; i<3; i++)

1359 
V–
[
šdex
].
axis
[
i
] = ()(
vf
*
VEL_fÜ_di¥l
[
rÙ
[i]][index])

1360 #ifdeà
TWO_LPT


1361 + ()(
vf2
*
VEL2_fÜ_di¥l
[
rÙ
[
i
]][
šdex
])

1362 #ifdeà
THREE_LPT


1372 ià(
ThisTask
==
cŞËùÜ
)

1374 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1376 
dummy
=
NInFe
*(
AuxSŒuù
);

1377 
	`Wr™eBlockName
(
fe
,
dummy
,"VEL ");

1378 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1379 
	`fwr™e
(
V–
, (
AuxSŒuù
), 
MyGrids
[0].
tÙ®_loÿl_size
, 
fe
);

1380 
	`ä“
(
V–
);

1384 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

1386 
™ask
=
cŞËùÜ
+
Ãxt
;

1387 ià(
ThisTask
==
cŞËùÜ
)

1389 
Å¬t
=0;

1390 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1391 ià(
Å¬t
)

1393 
V–
 = (
AuxSŒuù
 *)
	`m®loc
(
Å¬t
 * (AuxStruct));

1394 
	`MPI_Recv
(
V–
, 
Å¬t
*(
AuxSŒuù
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1395 
	`fwr™e
(
V–
, (
AuxSŒuù
), 
Å¬t
, 
fe
);

1396 
	`ä“
(
V–
);

1399 ià(
ThisTask
==
™ask
)

1401 
	`MPI_S’d
(&
MyGrids
[0].
tÙ®_loÿl_size
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1402 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1404 
	`MPI_S’d
(
V–
, (
AuxSŒuù
)*
MyGrids
[0].
tÙ®_loÿl_size
, 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1405 
	`ä“
(
V–
);

1411 ià(
ThisTask
==
cŞËùÜ
)

1413 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1418 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1420 
ID
 = (
MYIDTYPE
*)
	`m®loc
(
MyGrids
[0].
tÙ®_loÿl_size
 * (MYIDTYPE));

1422 
z
=0; z<
MyGrids
[0].
GSloÿl
[
_z_
]; z++)

1423 
y
=0; y<
MyGrids
[0].
GSloÿl
[
_y_
]; y++)

1424 
x
=0; x<
MyGrids
[0].
GSloÿl
[
_x_
]; x++)

1426 
šdex
 = 
x
 + 
MyGrids
[0].
GSloÿl
[
_x_
] *(
y
 + 
z
* MyGrids[0].GSloÿl[
_y_
]);

1428 #ifdeà
ROTATE_BOX


1429 
ID
[
šdex
]=1+(
MYIDTYPE
)(
x
+
MyGrids
[0].
GS¡¬t
[
_x_
]) +

1430 Ğ(
MYIDTYPE
)(
z
+
MyGrids
[0].
GS¡¬t
[
_z_
]) +

1431 (
MYIDTYPE
)(
y
+
MyGrids
[0].
GS¡¬t
[
_y_
]è* (MYIDTYPE)MyGrids[0].
GSglob®
[
_z_
] ) *

1432 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

1434 
ID
[
šdex
]=1+(
MYIDTYPE
)(
x
+
MyGrids
[0].
GS¡¬t
[
_x_
]) +

1435 Ğ(
MYIDTYPE
)(
y
+
MyGrids
[0].
GS¡¬t
[
_y_
]) +

1436 (
MYIDTYPE
)(
z
+
MyGrids
[0].
GS¡¬t
[
_z_
]è* (MYIDTYPE)MyGrids[0].
GSglob®
[
_y_
] ) *

1437 (
MYIDTYPE
)
MyGrids
[0].
GSglob®
[
_x_
];

1454 ià(
ThisTask
==
cŞËùÜ
)

1456 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1458 
dummy
=
NInFe
*(
MYIDTYPE
);

1459 
	`Wr™eBlockName
(
fe
,
dummy
,"ID ");

1460 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1461 
	`fwr™e
(
ID
, (
MYIDTYPE
), 
MyGrids
[0].
tÙ®_loÿl_size
, 
fe
);

1462 
	`ä“
(
ID
);

1467 
Ãxt
=1;‚ext<
NTasksP”Fe
;‚ext++)

1469 
™ask
=
cŞËùÜ
+
Ãxt
;

1470 ià(
ThisTask
==
cŞËùÜ
)

1472 
Å¬t
=0;

1473 
	`MPI_Recv
(&
Å¬t
, 1, 
MPI_INT
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1474 ià(
Å¬t
)

1476 
ID
=(
MYIDTYPE
*)
	`m®loc
(
Å¬t
 * (MYIDTYPE));

1477 
	`MPI_Recv
(
ID
, 
Å¬t
*(
MYIDTYPE
), 
MPI_BYTE
, 
™ask
, 0, 
MPI_COMM_WORLD
, &
¡©us
);

1478 
	`fwr™e
(
ID
, (
MYIDTYPE
), 
Å¬t
, 
fe
);

1479 
	`ä“
(
ID
);

1482 ià(
ThisTask
==
™ask
)

1484 
	`MPI_S’d
(&
MyGrids
[0].
tÙ®_loÿl_size
, 1, 
MPI_INT
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1485 ià(
MyGrids
[0].
tÙ®_loÿl_size
)

1487 
	`MPI_S’d
(
ID
, 
MyGrids
[0].
tÙ®_loÿl_size
*(
MYIDTYPE
), 
MPI_BYTE
, 
cŞËùÜ
, 0, 
MPI_COMM_WORLD
);

1488 
	`ä“
(
ID
);

1494 ià(
ThisTask
==
cŞËùÜ
)

1496 
	`fwr™e
(&
dummy
, (dummy), 1, 
fe
);

1497 
	`fşo£
(
fe
);

1501 
	}
}

1507 
	$Wr™eBlockName
(
FILE
 *
fd
,
dummy
, * 
LABEL
)

1509 
dummy2
;

1511 
dummy2
=8;

1512 
	`fwr™e
(&
dummy2
,(dummy2),1,
fd
);

1513 
	`fwr™e
(
LABEL
,4,1,
fd
);

1514 
dummy2
=
dummy
+8;

1515 
	`fwr™e
(&
dummy2
,(dummy2),1,
fd
);

1516 
dummy2
=8;

1517 
	`fwr™e
(&
dummy2
,(dummy2),1,
fd
);

1518 
	}
}

1521 
	$my_¡rıy
(*
to
, *
äom
, 
n
)

1523 
i
;

1524 
i
=0; i<
n
; i++)

1525 *(
to
+
i
)=*(
äom
+i);

1526 
	}
}

	@fragment.h

27 
	#NV
 6

	)

28 
	#FILAMENT
 1

	)

29 
	#SHIFT
 0.5

	)

31 
	#ORDER_FOR_GROUPS
 2

	)

32 
	#ORDER_FOR_CATALOG
 3

	)

34 
ngroups
;

38 
	mM
,
	mi
;

39 
	mq
[3],
	mv
[3],
	mD
,
	mz
;

40 #ifdeà
TWO_LPT


41 
	mD2
,
	mv2
[3];

42 #ifdeà
THREE_LPT


43 
	mD31
,
	mv31
[3],
	mD32
,
	mv32
[3];

46 } 
	tpos_d©a
;

47 
pos_d©a
 
	gobj
, 
	gobj1
, 
	gobj2
;

51 
	mÇme
;

52 
	mM
,
	mq
[3],
	mx
[3],
	mv
[3];

53 
	mn
, 
	m·d
;

54 } 
	tÿlog_d©a
;

56 
cÚd™iÚ_fÜ_acü‘iÚ
(, , , , , , *, *);

57 
cÚd™iÚ_fÜ_m”gšg
(, , , *);

58 
£t_obj
(, , 
pos_d©a
 *);

59 
£t_pošt
(, , , , , 
pos_d©a
 *);

60 
£t_group
(, 
pos_d©a
 *);

61 
q2x
(, 
pos_d©a
 *, );

62 
v–
(, 
pos_d©a
 *);

63 
di¡ªû
(, 
pos_d©a
 *,…os_data *);

64 
ş—n_li¡
(*);

65 
vœŸl
(, , );

66 
m”ge_groups
(, , );

67 
upd©e_hi¡Üy
(, , );

68 
acü‘iÚ
(, , , , , );

69 
upd©e
(
pos_d©a
 *,…os_data *);

70 
wr™e_ÿlog
();

71 
wr™e_hi¡Ü›s
();

72 
compu‹_mf
();

73 #ifdeà
PLC


74 
wr™e_PLC
();

	@pinocchio.h

27 
	~<¡dlib.h
>

28 
	~<¡dio.h
>

29 
	~<m©h.h
>

30 
	~<mpi.h
>

31 
	~<¡ršg.h
>

32 
	~<time.h
>

33 
	~<g¦/g¦_”ºo.h
>

34 
	~<g¦/g¦_m©h.h
>

35 
	~<g¦/g¦_ºg.h
>

36 
	~<g¦/g¦_¿ndi¡.h
>

37 
	~<g¦/g¦_roÙs.h
>

38 
	~<g¦/g¦_š‹g¿tiÚ.h
>

39 
	~<g¦/g¦_odeiv.h
>

40 
	~<g¦/g¦_¥lše.h
>

41 
	~<fáw3-mpi.h
>

42 
	~<pfá.h
>

43 #ifdeà
USE_GPERFTOOLS


44 
	~<g³ráoŞs/´of”.h
>

46 
	~<immšŒš.h
>

48 
	#ALIGN
 32

	)

50 
	#NYQUIST
 1.

	)

51 
	#PI
 3.14159265358979323846

	)

52 
	#BLENGTH
 300

	)

53 
	#GBYTE
 1073741824.0

	)

54 
	#MBYTE
 1048576.0

	)

55 
	#®loc_v”bo£
 0

	)

56 
	#MAXOUTPUTS
 100

	)

57 
	#SPEEDOFLIGHT
 (()299792.458)

	)

58 
	#GRAVITY
 (()4.30200e-9è

	)

60 #ià
defšed
(
THREE_LPT
è&& !defšed(
TWO_LPT
)

61 
	#TWO_LPT


	)

64 
	#_x_
 0

	)

65 
	#_y_
 1

	)

66 
	#_z_
 2

	)

68 
	#DECOMPOSITION_LIMIT_FACTOR_2D
 1

70 

	)

71 
	#d´štf
(
LEVEL
, 
TASK
, ...èdo{ifĞ((LEVELè<ğ
š‹º®
.
v”bo£_Ëv–
è&& (
ThisTask
 =ğ(TASK))è
	`årštf
(
¡dout
, 
__VA_ARGS__
);} 1 =ğ0)

	)

72 
	#VDBG
 4

73 
	#VDIAG
 2

74 
	#VMSG
 1

75 
	#VXX
 0

76 
	#VERR
 
VXX


77 
	#VXERR
 -1

78 

	)

79 
	#SWAP_INT
Ğ
A
, 
B
 ) (Aè^ğ(B), (Bè^ğ(A), (Aè^ğ(B);

	)

81 
ThisTask
,
NTasks
;

85 
MPI_Comm
 
FFT_Comm
;

87 
	#DVEC_SIZE
 4

	)

89 
	tdvec
 
	t__©Œibu‹__
 ((
	tveùÜ_size
 (
	tDVEC_SIZE
*())));

90 
	tivec
 
	t__©Œibu‹__
 ((
	tveùÜ_size
 (
	tDVEC_SIZE
*())));

93 
dvec
 
	mV
;

94 
	mv
[
DVEC_SIZE
];

95 } 
	tdvec_u
;

99 
ivec
 
	mV
;

100 
	mv
[
DVEC_SIZE
];

101 } 
	tivec_u
;

107 
	msks_subdivisiÚ_dim
;

108 
	msks_subdivisiÚ_3D
[4];

109 
	mcÚ¡¿š_sk_decompos™iÚ
[3];

110 
	mv”bo£_Ëv–
;

111 
	mmimic_Üigš®_£edbË
;

112 
	mdump_veùÜs
;

113 
	mdump_£ed¶ªe
;

114 
	mdump_kd’s™y
;

115 
	mÏrge_¶ªe
;

117 } 
	tš‹º®_d©a
;

118 
š‹º®_d©a
 
š‹º®
;

120 
	tušt
;

121 
	tUL
;

125 
	mRmax
;

126 
	mFmax
, 
	mVmax
[3];

127 #ifdeà
TWO_LPT


128 
	mVmax_2LPT
[3];

129 #ifdeà
THREE_LPT


130 
	mVmax_3LPT_1
[3],
	mVmax_3LPT_2
[3];

133 } 
	t´oduù_d©a
 
	t__©Œibu‹__
((
	t®igÃd
 (
	tALIGN
)));

135 *
maš_memÜy
, *
wh”‘İÏû_myÿt
;

137 
´oduù_d©a
 *
´oduùs
, *
äag
;

139 *
cubes_Üd”šg
;

141 **
kd’s™y
;

142 **
d’s™y
;

143 ***
fœ¡_d”iv©ives
;

144 ***
£cÚd_d”iv©ives
;

146 **
VEL_fÜ_di¥l
;

148 #ifdeà
TWO_LPT


149 *
kveùÜ_2LPT
;

150 *
sourû_2LPT
;

151 **
VEL2_fÜ_di¥l
;

152 #ifdeà
THREE_LPT


153 *
kveùÜ_3LPT_1
,*
kveùÜ_3LPT_2
;

154 *
sourû_3LPT_1
,*
sourû_3LPT_2
;

158 
RsmoÙh
;

161 
	mNsmoÙh
;

162 *
	mRadius
, *
	mV¬Ÿnû
, *
	mTrueV¬Ÿnû
;

163 } 
	tsmoÙhšg_d©a
;

164 
smoÙhšg_d©a
 
SmoÙhšg
;

166 
Ngrids
;

169 
	mtÙ®_loÿl_size
, 
	mtÙ®_loÿl_size_fá
;

170 
	moff
;

171 
±rdiff_t
 
	mGSglob®
[3];

172 
±rdiff_t
 
	mGSloÿl
[3];

173 
±rdiff_t
 
	mGS¡¬t
[3];

174 
±rdiff_t
 
	mGSloÿl_k
[3];

175 
±rdiff_t
 
	mGS¡¬t_k
[3];

176 
	mlow”_k_cutoff
, 
	muµ”_k_cutoff
, 
	mnÜm
, 
	mBoxSize
, 
	mC–lSize
;

177 
pfá_¶ª
 
	mfÜw¬d_¶ª
, 
	m»v”£_¶ª
;

178 } 
	tgrid_d©a
;

179 
grid_d©a
 *
MyGrids
;

181 
pfá_com¶ex
 **
cveùÜ_fá
;

182 **
rveùÜ_fá
;

184 #ifdeà
SCALE_DEPENDENT_GROWTH


187 
	mReã»nûRedshiá
;

188 
	mReã»nûOuut
,
	mNkbšs
, 
	mNCAMB
, 
	mReã»nûSÿË
;

189 
	mM©‹rFe
[
BLENGTH
], 
	mT¿nsãrFe
[BLENGTH], 
	mRunName
[BLENGTH], 
	mRedshiásFe
[BLENGTH];

190 *
	mLogk
, *
	mLogPk»f
, 
	mD2»f
, *
	mSÿËf
, *
	mRefGM
;

191 } 
	tÿmb_d©a
;

196 
	mOmega0
, 
	mOmegaLambda
, 
	mHubbË100
, 
	mSigma8
, 
	mOmegaB¬yÚ
, 
	mDEw0
, 
	mDEwa
,

197 
	mPrimÜdŸlIndex
, 
	mIÁ”P¬tDi¡
, 
	mBoxSize
, 
	mBoxSize_hŒue
, 
	mBoxSize_h100
, 
	mP¬tişeMass
,

198 
	mS¹šgzFÜPLC
, 
	mLa¡zFÜPLC
, 
	mIÅutS³ùrum_Un™L’gth_š_cm
, 
	mWDM_P¬tMass_š_kev
,

199 
	mBound¬yLay”FaùÜ
, 
	mL¬ge¡
, 
	mMaxMemP”P¬tişe
, 
	mPLCA³¹u»
,

200 
	mPLCC’‹r
[3], 
	mPLCAxis
[3];

201 
	mRunFÏg
[
BLENGTH
-50],
	mD©aDœ
[BLENGTH],
	mTabuÏ‹dEoSfe
[BLENGTH],
	mP¬am‘”Fe
[BLENGTH],

202 
	mOuutLi¡
[
BLENGTH
],
	mFeW™hIÅutS³ùrum
[BLENGTH];

203 
	mGridSize
[3],
	mWr™eRmax
, 
	mWr™eFmax
, 
	mWr™eVmax
,

204 
	mC©®ogInAscii
, 
	mDoNÙWr™eC©®ogs
, 
	mDoNÙWr™eHi¡Ü›s
, 
	mWr™eSÇpshÙ
,

205 
	mOuutInH100
, 
	mRªdomS“d
, 
	mMaxMem
, 
	mNumFes
, 
	mMšMassFÜC©
,

206 
	mBoxInH100
, 
	msim¶eLambda
, 
	mAÇlyticMassFunùiÚ
, 
	mMšH®oMass
, 
	mPLCProvideCÚeD©a
,

207 
	mu£_Œª¥o£d_fá
, 
	mu£_š¶aû_fá
;

208 #ifdeà
SCALE_DEPENDENT_GROWTH


209 
ÿmb_d©a
 
	mÿmb
;

211 } 
	t·¿m_d©a
;

212 
·¿m_d©a
 
·¿ms
;

216 
	mn
;

217 
	mF
[
MAXOUTPUTS
],
	mz
[MAXOUTPUTS],
	mzÏ¡
,
	mFÏ¡
;

218 } 
	touut_d©a
;

219 
ouut_d©a
 
ouuts
;

224 
	m§ã
, 
	mN·¹
;

225 
	mnbox_x
, 
	mnbox_y
, 
	mnbox_z_this¦iû
, 
	mnbox_z_®l¦iûs
;

226 
	mmybox_x
, 
	mmybox_y
, 
	mmybox_z
;

227 
	mLgrid_x
, 
	mLgrid_y
, 
	mLgrid_z
;

228 
	mLgwbl_x
, 
	mLgwbl_y
, 
	mLgwbl_z
;

229 
	m¡¬t_x
, 
	m¡¬t_y
, 
	m¡¬t_z
;

230 
	m¡abl_x
, 
	m¡abl_y
, 
	m¡abl_z
;

231 
	m§ã_x
, 
	m§ã_y
, 
	m§ã_z
;

232 
	mpbc_x
, 
	mpbc_y
, 
	mpbc_z
;

233 
	mSaãtyBÜd”
,
	mov”h—d
;

234 } 
	tsubbox_d©a
;

235 
subbox_d©a
 
subbox
;

239 
	mš™
,
	mtÙ®
, 
	md’s
, 
	mfá
, 
	mcŞl
, 
	mšvcŞl
, 
	m–l
, 
	mv–
, 
	mÍt
, 
	mfmax
, 
	mdi¡r
, 
	msÜt
, 
	mgroup
, 
	mäag
, 
	mio
,

240 
	md”iv
, 
	mmem_Œªsf
, 
	m·¹Ÿl
, 
	m£t_subboxes
, 
	m£t_¶c
, 
	mmemÜy_®loÿtiÚ
, 
	mfá_š™Ÿliz©iÚ


241 #ifdeà
PLC


242 ,
	m¶c


245 } 
	tıutime_d©a
;

246 
ıutime_d©a
 
ıutime
;

248 
WšdowFunùiÚTy³
;

252 
	mMass
;

253 
	mPos
[3],
	mV–
[3];

254 #ifdeà
TWO_LPT


255 
	mV–_2LPT
[3];

256 #ifdeà
THREE_LPT


257 
	mV–_3LPT_1
[3], 
	mV–_3LPT_2
[3];

260 
	mÎ
, 
	mh®o_­p
, 
	mmass_©_m”g”
, 
	mm”ged_w™h
, 
	mpošt
, 
	mbÙtom
, 
	mgood
;

261 
	mt_­³¬
, 
	mt_³ak
, 
	mt_m”ge
;

262 
	mÇme
;

263 
	mŒackT
,
	mŒackC
;

264 #ifdeà
PLC


265 
	mFÏ¡
;

267 } 
	tgroup_d©a
;

268 
group_d©a
 *
groups
;

270 #ifdeà
PLC


273 
	mi
,
	mj
,
	mk
;

274 
	mF1
,
	mF2
;

275 } 
	t»¶iÿtiÚ_d©a
;

279 
	mN»¶iÿtiÚs
, 
	mNmax
, 
	mN¡Üed
, 
	mNh®ÙÙ
;

280 
	mF¡¬t
,
	mF¡İ
,
	mûÁ”
[3];

281 
	mxv”s
[3],
	myv”s
[3],
	mzv”s
[3];

282 
»¶iÿtiÚ_d©a
 *
	m»¶s
;

283 } 
	t¶c_d©a
;

284 
¶c_d©a
 
¶c
;

288 
	mMass
;

289 
	mÇme
;

290 
	mz
,
	mx
[3],
	mv
[3],
	mrhÜ
,
	mth‘a
,
	mphi
;

291 } 
	t¶cgroup_d©a
;

292 
¶cgroup_d©a
 *
¶cgroups
;

295 
d©e_¡ršg
[25];

297 *
šdiûs
,*
group_ID
,*
lškšg_li¡
;

298 
NSliûs
,
ThisSliû
;

301 
f_m
, 
f_rm
, 
e¥o
, 
f_a
, 
f_¿
, 
f_200
, 
sigmaD0
;

303 #ifdeà
SCALE_DEPENDENT_GROWTH


306 
	mæag
, 
	mismoÙh
;

307 
	m¿dius
;

308 } 
	tSDGM_d©a
;

309 
SDGM_d©a
 
SDGM
;

312 
	#NWINT
 1000

	)

313 
g¦_š‹g¿tiÚ_wÜk¥aû
 *
wÜk¥aû
;

314 
g¦_ºg
 *
¿ndom_g’”©Ü
;

318 
	mÇme
;

319 
	mnick
, 
	mÎ
, 
	mmw
, 
	mmass
, 
	mmam
;

320 
	mzme
, 
	mz³
, 
	mz­
;

321 } 
	thi¡Ü›s_d©a
;

323 
	#DELTAM
 0.05

	)

327 
	mNBIN
;

328 
	mmmš
,
	mmmax
,
	mvŞ
,
	mhçùÜ
,
	mhçùÜ4
;

329 *
	mnšbš
,*
	mnšbš_loÿl
;

330 *
	mmassšbš
,*
	mmassšbš_loÿl
;

331 } 
	tmf_d©a
;

332 
mf_d©a
 
mf
;

335 
çùÜ
(, );

338 
compu‹_cŞÏp£_times
();

339 
compu‹_v–oc™›s
();

342 
£t_Úe_grid
();

343 
š™Ÿlize_fá
();

344 
fÜw¬d_ŒªsfÜm
();

345 
»v”£_ŒªsfÜm
();

346 
fš®ize_fá
();

347 
compu‹_d”iv©ive
(, , );

348 
wr™e_š_cveùÜ
(, *);

349 
wr™e_äom_cveùÜ
(, *);

350 
wr™e_š_rveùÜ
(, *);

351 
wr™e_äom_rveùÜ
(, *);

353 
dump_cveùÜ
(*, , , 
±rdiff_t
 *,…trdiff_t *, *, );

354 
dump_rveùÜ
(*, , 
±rdiff_t
 *,…trdiff_t *, *, );

357 
®loÿ‹_maš_memÜy
();

358 
d—Îoÿ‹_fá_veùÜs
();

359 
»®loÿ‹_memÜy_fÜ_äagm’tiÚ_1
();

360 
»®loÿ‹_memÜy_fÜ_äagm’tiÚ_2
();

364 
G’IC
();

365 
G’IC_Ïrge
();

368 
š™Ÿliz©iÚ
();

369 
fšd_¡¬t
(, , );

370 
fšd_Ëngth
(, , );

371 
£t_·¿m‘”s
();

372 
£t_grids
();

375 
wr™e_f›lds
();

376 
wr™e_d’s™y
();

379 
wr™e_¢­shÙ
();

380 
wr™e_LPT_¢­shÙ
();

383 
š™Ÿlize_cosmŞogy
();

384 
š™Ÿlize_MassV¬Ÿnû
();

385 
Omega
();

386 
HubbË
();

387 
HubbË_Gyr
();

388 
fomega
();

389 
fomega_2LPT
();

390 
fomega_3LPT_2
();

391 
fomega_3LPT_1
();

392 
CosmicTime
();

393 
Inv”£CosmicTime
();

394 
GrowšgMode
();

395 
GrowšgMode_2LPT
();

396 
GrowšgMode_3LPT_1
();

397 
GrowšgMode_3LPT_2
();

398 
Inv”£GrowšgMode
();

399 
Prİ”Di¡ªû
();

400 
Inv”£Prİ”Di¡ªû
();

401 
dPrİ”Di¡ªû_dz
();

402 
Pow”S³ùrum
();

403 
MassV¬Ÿnû
();

404 
dMassV¬Ÿnû_dr
();

405 
Di¥lV¬Ÿnû
();

406 
Radius
();

407 
SizeFÜMass
();

408 
MassFÜSize
();

409 
TypiÿlCŞÏpsšgMass
();

410 
dOmega_dV¬Ÿnû
(, );

411 
AÇlyticMassFunùiÚ
(, );

412 
WšdowFunùiÚ
();

413 
my_¥lše_ev®
(
g¦_¥lše
 *, , 
g¦_š‹½_acûl
 *);

416 
»ad_·¿m‘”_fe
();

419 
compu‹_fmax
();

420 
compu‹_di¥Ïûm’ts
();

421 *
fd©e
();

423 #ifdeà
TWO_LPT


425 
compu‹_LPT_di¥Ïûm’ts
();

429 
di¡ribu‹
();

432 
äagm’t
();

435 
bud_groups
();

437 #ifdeà
SCALE_DEPENDENT_GROWTH


438 
»ad_pow”_bË_äom_CAMB
();

439 
š™Ÿlize_SÿËD•’d’tGrowth
();

440 
M©‹rGrowšgMode
();

441 
V–GrowšgMode
();

442 
Inv”£M©‹rGrowšgMode
();

443 
V–fOmega
();

444 
V–fOmega2
();

447 #ifdeà
WHITENOISE


448 
»ad_wh™e_noi£
();

	@
1
.
0
27
2043
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/GenIC.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/LPT.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/Pk_from_CAMB.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/ReadParamfile.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/ReadWhiteNoise.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/allocations.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/alternatives/GenIC_large.work.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/alternatives/collapse_times.vector.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/build_groups.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/cosmo.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/distribute.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax-fftw.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax-pfft.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fmax.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fragment.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/fragment.h
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/initialization.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/memorytest.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/pinocchio.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/pinocchio.h
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/read_pinocchio_binary.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/variables.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_fields.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_halos.c
/home/luca/code/Pinocchio/Pinocchio-4.1.1-pfft-2017-Dec-5/src/src/write_snapshot.c
fragment.h
pinocchio.h
